<style>
    .client-filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        align-items: flex-start;
    }

    .rooms-filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .price-filter-row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: nowrap;
    }

    .price-filter-row input {
        min-width: 0;
        flex: 1;
    }

    @media (max-width: 600px) {
        .rooms-filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }
        
        .price-filter-row {
            flex-direction: column;
            align-items: stretch;
        }

        .price-filter-row input {
            width: 100%;
        }

        .price-filter-row span {
            text-align: center;
        }
    }
</style>
{% extends 'base.html' %}
{% load static %}

{% block title %}Каталог квартир — CENTURY 21{% endblock %}

{% block extra_css %}
<style>
/* Стили для каталога квартир */
.client-catalog-section {
    margin-bottom: 30px !important;
    padding: 40px 0;
}

.client-catalog-header {
    margin-bottom: 40px;
    text-align: center;
}

.client-catalog-header h1 {
    font-size: 36px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 12px;
}

.client-catalog-header p {
    font-size: 18px;
    color: #6b7280;
}

.apartments-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin-bottom: 30px;
}

/* Карточка квартиры в стиле каталога ЖК */
.apartment-card-compact {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    cursor: pointer;
}

.apartment-card-compact:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.apartment-card-image {
    position: relative;
    width: 100%;
    height: 240px;
    overflow: hidden;
    background: #f3f4f6;
}

.apartment-card-image img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.3s ease;
}

.apartment-card-compact:hover .apartment-card-image img {
    transform: scale(1.05);
}

.apartment-card-content {
    padding: 20px;
}

.apartment-card-header {
    margin-bottom: 12px;
}

.apartment-card-complex {
    font-size: 14px;
    color: #d4a574;
    font-weight: 600;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.apartment-card-title {
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 8px;
    line-height: 1.4;
}

.apartment-card-location {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 12px;
}

.apartment-card-location i {
    color: #9ca3af;
}

.apartment-card-details {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 16px;
    font-size: 14px;
    color: #6b7280;
}

.apartment-detail-item {
    display: flex;
    align-items: center;
    gap: 6px;
}

.apartment-detail-item i {
    color: #9ca3af;
    font-size: 12px;
}

.apartment-card-price {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.apartment-price-text {
    font-size: 24px;
    font-weight: 700;
    color: #2563eb;
}

.apartment-price-per-sqm {
    font-size: 14px;
    color: #6b7280;
    margin-top: 4px;
}

.no-apartments {
    text-align: center;
    padding: 80px 20px;
    color: #6b7280;
}

.no-apartments p {
    font-size: 18px;
    margin-bottom: 8px;
}

.no-apartments p:last-child {
    font-size: 14px;
    color: #9ca3af;
}

.loading-state {
    text-align: center;
    padding: 80px 20px;
    color: #6b7280;
}

.loading-state i {
    font-size: 48px;
    margin-bottom: 16px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Стили для фильтров */
.filter-btn[data-active="true"] {
    background: #d4a574 !important;
    color: #fff !important;
    border-color: #d4a574 !important;
}

.filter-btn:hover {
    border-color: #d4a574 !important;
    color: #d4a574 !important;
}

.catalog-filters {
    margin-bottom: 30px;
}

/* Мобильная версия */
@media (max-width: 768px) {
    .apartments-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .apartment-card-image {
        height: 200px;
    }
    
    .client-catalog-header h1 {
        font-size: 28px;
    }
    
    .client-catalog-header p {
        font-size: 16px;
    }
    
    .catalog-filters > div {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <section class="client-catalog-section">
        <div class="client-catalog-header">
            <h1 id="catalog-title">Каталог квартир</h1>
            <p id="catalog-subtitle">Выбранные предложения для вас</p>
        </div>
        
        <!-- Хлебные крошки -->
        <div class="breadcrumbs">
            <a href="{% url 'main:home' %}" class="breadcrumb-link">Главная</a>
            <span class="breadcrumb-separator">•</span>
            <span class="breadcrumb-current">Каталог квартир</span>
        </div>
        
        <!-- Фильтры -->
        <div class="catalog-filters" style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px;">
        <div class="client-filters-grid">
                <!-- Фильтр по комнатам -->
                <div class="filter-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Количество комнат</label>
                    <div class="button-filter rooms-filter-row">
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="" data-active="true" style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s;">Любое</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="studio" data-active="false" style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s;">Студия</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="1" data-active="false" style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s;">1</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="2" data-active="false" style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s;">2</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="3" data-active="false" style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s;">3</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="4" data-active="false" style="padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.2s;">4+</button>
                    </div>
                </div>
                
                <!-- Фильтр по цене -->
                <div class="filter-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Цена, ₽</label>
                    <div class="price-filter-row">
                        <input type="text" id="price-from" placeholder="От" inputmode="numeric" style="flex: 1; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        <span style="color: #9ca3af;">—</span>
                        <input type="text" id="price-to" placeholder="До" inputmode="numeric" style="flex: 1; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                
                <!-- Фильтр по ЖК -->
                <div class="filter-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 14px;">Жилой комплекс</label>
                    <select id="complex-filter" style="width: 100%; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: #fff; cursor: pointer;">
                        <option value="">Все ЖК</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Сетка квартир -->
        <div class="apartments-grid" id="apartmentsGrid">
            <div class="loading-state">
                <i class="fas fa-spinner"></i>
                <p>Загрузка квартир...</p>
            </div>
        </div>
    </section>
</div>

<script>
// Получаем параметры из URL
const urlParams = new URLSearchParams(window.location.search);
const complexesParam = urlParams.get('complexes') || '';
const apartmentsParam = urlParams.get('apartments') || '';
const isSelection = urlParams.get('is_selection') === 'true' || document.referrer.includes('/selection/');

// Обновляем заголовок если это подборка
if (isSelection) {
    const titleEl = document.getElementById('catalog-title');
    const subtitleEl = document.getElementById('catalog-subtitle');
    if (titleEl) titleEl.textContent = 'Подборка квартир';
    if (subtitleEl) subtitleEl.textContent = 'Выбранные квартиры из подборки';
}

// Переменные для фильтров
let currentRoomsFilter = '';
let currentPriceFrom = '';
let currentPriceTo = '';
let currentComplexFilter = '';
let allApartments = []; // Сохраняем все квартиры для фильтрации на клиенте
let allComplexes = []; // Сохраняем список ЖК

// Загружаем квартиры
async function loadApartments() {
    const grid = document.getElementById('apartmentsGrid');
    
    if (!complexesParam) {
        grid.innerHTML = `
            <div class="no-apartments">
                <p>Не указаны ЖК для отображения</p>
                <p>Пожалуйста, используйте корректную ссылку</p>
            </div>
        `;
        return;
    }
    
    try {
        // Формируем URL для API
        let apiUrl = `/api/client-catalog/apartments/?complexes=${encodeURIComponent(complexesParam)}`;
        if (apartmentsParam) {
            apiUrl += `&apartments=${encodeURIComponent(apartmentsParam)}`;
        }
        
        // Добавляем фильтры
        if (currentRoomsFilter) {
            const roomsParam = currentRoomsFilter === 'studio' ? 'Студия' : currentRoomsFilter;
            apiUrl += `&rooms=${encodeURIComponent(roomsParam)}`;
        }
        if (currentPriceFrom) {
            apiUrl += `&price_from=${encodeURIComponent(currentPriceFrom)}`;
        }
        if (currentPriceTo) {
            apiUrl += `&price_to=${encodeURIComponent(currentPriceTo)}`;
        }
        if (currentComplexFilter) {
            apiUrl += `&filter_complex=${encodeURIComponent(currentComplexFilter)}`;
        }
        
        const response = await fetch(apiUrl);
        const result = await response.json();
        
        if (!result.success) {
            grid.innerHTML = `
                <div class="no-apartments">
                    <p>Ошибка загрузки данных</p>
                    <p>${result.error || 'Неизвестная ошибка'}</p>
                </div>
            `;
            return;
        }
        
        const apartments = result.apartments || [];
        
        // Сохраняем все квартиры для фильтрации
        allApartments = apartments;
        
        // Заполняем список ЖК
        const complexSet = new Set();
        apartments.forEach(apt => {
            if (apt.complex_id && apt.complex_name) {
                complexSet.add(JSON.stringify({id: apt.complex_id, name: apt.complex_name}));
            }
        });
        allComplexes = Array.from(complexSet).map(s => JSON.parse(s));
        
        // Обновляем селект ЖК
        const complexSelect = document.getElementById('complex-filter');
        if (complexSelect) {
            const currentValue = complexSelect.value;
            complexSelect.innerHTML = '<option value="">Все ЖК</option>';
            allComplexes.forEach(complex => {
                const option = document.createElement('option');
                option.value = complex.id;
                option.textContent = complex.name;
                if (complex.id === currentValue) {
                    option.selected = true;
                }
                complexSelect.appendChild(option);
            });
        }
        
        // Применяем фильтры и рендерим
        const filteredApartments = applyFilters(apartments);
        renderApartments(filteredApartments);
        
    } catch (error) {
        console.error('Ошибка загрузки квартир:', error);
        grid.innerHTML = `
            <div class="no-apartments">
                <p>Ошибка загрузки данных</p>
                <p>Попробуйте обновить страницу</p>
            </div>
        `;
    }
}

// Функция экранирования HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Функция применения фильтров
function applyFilters(apartments) {
    let filtered = [...apartments];
    
    // Фильтр по комнатам
    if (currentRoomsFilter) {
        filtered = filtered.filter(apt => {
            const roomsRaw = apt.rooms;
            const rooms = String(roomsRaw || '').trim();
            if (currentRoomsFilter === 'studio') {
                const normalized = rooms.toLowerCase();
                return normalized === 'студия' || normalized === 'studio' || rooms === '0';
            }
            if (currentRoomsFilter === '4') {
                // 4+ означает 4 и более
                const roomsNum = parseInt(rooms) || 0;
                return roomsNum >= 4;
            }
            return rooms === currentRoomsFilter;
        });
    }
    
    // Фильтр по цене
    if (currentPriceFrom || currentPriceTo) {
        filtered = filtered.filter(apt => {
            if (!apt.price) return false;
            let priceNum = parseFloat(String(apt.price).replace(/\s/g, '').replace(/₽/g, '').replace(/руб/g, '').replace(/,/g, '')) || 0;
            
            // Убираем пробелы из значений фильтров на всякий случай
            const priceFromNum = currentPriceFrom ? parseFloat(String(currentPriceFrom).replace(/\s/g, '')) : null;
            const priceToNum = currentPriceTo ? parseFloat(String(currentPriceTo).replace(/\s/g, '')) : null;
            
            if (priceFromNum !== null && priceNum < priceFromNum) {
                return false;
            }
            if (priceToNum !== null && priceNum > priceToNum) {
                return false;
            }
            return true;
        });
    }
    
    // Фильтр по ЖК
    if (currentComplexFilter) {
        filtered = filtered.filter(apt => String(apt.complex_id) === String(currentComplexFilter));
    }
    
    return filtered;
}

// Функция рендеринга квартир
function renderApartments(apartments) {
    const grid = document.getElementById('apartmentsGrid');
    if (!grid) return;
    
    if (apartments.length === 0) {
        grid.innerHTML = `
            <div class="no-apartments">
                <p>Квартиры не найдены</p>
                <p>Попробуйте выбрать другие параметры</p>
            </div>
        `;
        return;
    }
    
    function formatPrice(price) {
        if (!price) return '';
        let priceStr = String(price).trim();
        priceStr = priceStr.replace(/₽/g, '').replace(/руб/g, '').replace(/руб\./g, '').trim();
        const priceClean = priceStr.replace(/\s/g, '').replace(/,/g, '').replace(/\./g, '').trim();
        if (!/^\d+$/.test(priceClean)) {
            return priceStr;
        }
        try {
            const priceNum = parseFloat(priceStr.replace(/\s/g, '').replace(/,/g, '.').trim());
            if (priceNum <= 0) return '';
            const formatted = priceNum.toLocaleString('ru-RU', {maximumFractionDigits: 0});
            return `${formatted} ₽`;
        } catch (e) {
            return priceStr;
        }
    }
    
    grid.innerHTML = apartments.map(apt => {
        const imageUrl = apt.image || '/static/images/placeholder.png';
        let title = apt.title || '';
        if (!title) {
            if (apt.rooms) {
                title = `${apt.rooms}-комнатная квартира`;
            } else {
                title = 'Квартира';
            }
        }
        
        const details = [];
        if (apt.area) {
            details.push(`<div class="apartment-detail-item"><i class="fas fa-ruler-combined"></i><span>${apt.area} м²</span></div>`);
        }
        if (apt.floor) {
            details.push(`<div class="apartment-detail-item"><i class="fas fa-building"></i><span>${apt.floor} эт.</span></div>`);
        }
        if (apt.rooms) {
            details.push(`<div class="apartment-detail-item"><i class="fas fa-home"></i><span>${apt.rooms}-комн.</span></div>`);
        }
        
        let priceHtml = '<div class="apartment-price-text">Цена по запросу</div>';
        if (apt.price) {
            const formattedPrice = formatPrice(apt.price);
            priceHtml = `
                <div class="apartment-price-text">${formattedPrice || apt.price}</div>
                ${apt.price_per_sqm ? `<div class="apartment-price-per-sqm">${formatPrice(apt.price_per_sqm) || apt.price_per_sqm} ₽/м²</div>` : ''}
            `;
        }
        
        let apartmentId = apt.id;
        if (apartmentId) {
            const parts = String(apartmentId).split('_');
            if (parts.length >= 3 && parts[0] === apt.complex_id) {
                apartmentId = `${parts[1]}_${parts[2]}`;
            } else if (parts.length >= 2 && parts[0] === apt.complex_id) {
                apartmentId = parts.slice(1).join('_');
            }
        } else if (apt.type !== undefined && apt.index !== undefined) {
            apartmentId = `${apt.type}_${apt.index}`;
        } else {
            apartmentId = '0_0';
        }
        const detailUrl = `/apartment/${apt.complex_id}/${apartmentId}/`;
        
        return `
            <div class="apartment-card-compact" onclick="window.location.href='${detailUrl}'">
                <div class="apartment-card-image">
                    <img src="${imageUrl}" alt="${escapeHtml(title)}" loading="lazy" onerror="this.src='/static/images/placeholder.png'">
                </div>
                <div class="apartment-card-content">
                    <div class="apartment-card-header">
                        <div class="apartment-card-complex">${escapeHtml(apt.complex_name || 'ЖК')}</div>
                        <h3 class="apartment-card-title">${escapeHtml(title)}</h3>
                        ${apt.complex_address ? `
                            <div class="apartment-card-location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${escapeHtml(apt.complex_address)}</span>
                            </div>
                        ` : ''}
                    </div>
                    ${details.length > 0 ? `
                        <div class="apartment-card-details">
                            ${details.join('')}
                        </div>
                    ` : ''}
                    <div class="apartment-card-price">
                        ${priceHtml}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Обработчики фильтров
document.addEventListener('DOMContentLoaded', function() {
    // Обработчики кнопок комнат
    document.querySelectorAll('.rooms-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.rooms-filter-btn').forEach(b => {
                b.setAttribute('data-active', 'false');
            });
            this.setAttribute('data-active', 'true');
            currentRoomsFilter = this.getAttribute('data-value') || '';
            if (allApartments.length > 0) {
                const filtered = applyFilters(allApartments);
                renderApartments(filtered);
            }
        });
    });
    
    // Функция форматирования цены с пробелами
    function formatPriceInput(value) {
        // Убираем все нецифровые символы
        const numbers = value.replace(/\D/g, '');
        if (!numbers) return '';
        // Форматируем с пробелами для разделения тысяч
        return numbers.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }
    
    // Функция получения числового значения из отформатированной строки
    function getPriceNumber(value) {
        return value.replace(/\s/g, '').trim();
    }
    
    // Обработчики полей цены
    const priceFrom = document.getElementById('price-from');
    const priceTo = document.getElementById('price-to');
    
    if (priceFrom) {
        priceFrom.addEventListener('input', function(e) {
            const cursorPosition = this.selectionStart;
            const oldValue = this.value;
            const oldLength = oldValue.length;
            
            // Форматируем значение
            const formatted = formatPriceInput(this.value);
            this.value = formatted;
            
            // Восстанавливаем позицию курсора
            const newLength = formatted.length;
            const lengthDiff = newLength - oldLength;
            const newPosition = Math.max(0, cursorPosition + lengthDiff);
            this.setSelectionRange(newPosition, newPosition);
            
            // Сохраняем числовое значение для фильтрации
            currentPriceFrom = getPriceNumber(formatted);
            if (allApartments.length > 0) {
                const filtered = applyFilters(allApartments);
                renderApartments(filtered);
            }
        });
    }
    
    if (priceTo) {
        priceTo.addEventListener('input', function(e) {
            const cursorPosition = this.selectionStart;
            const oldValue = this.value;
            const oldLength = oldValue.length;
            
            // Форматируем значение
            const formatted = formatPriceInput(this.value);
            this.value = formatted;
            
            // Восстанавливаем позицию курсора
            const newLength = formatted.length;
            const lengthDiff = newLength - oldLength;
            const newPosition = Math.max(0, cursorPosition + lengthDiff);
            this.setSelectionRange(newPosition, newPosition);
            
            // Сохраняем числовое значение для фильтрации
            currentPriceTo = getPriceNumber(formatted);
            if (allApartments.length > 0) {
                const filtered = applyFilters(allApartments);
                renderApartments(filtered);
            }
        });
    }
    
    // Обработчик селекта ЖК
    const complexFilter = document.getElementById('complex-filter');
    if (complexFilter) {
        complexFilter.addEventListener('change', function() {
            currentComplexFilter = this.value || '';
            if (allApartments.length > 0) {
                const filtered = applyFilters(allApartments);
                renderApartments(filtered);
            }
        });
    }
    
    // Загружаем квартиры
    loadApartments();
});
</script>
{% endblock %}


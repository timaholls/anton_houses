{% extends 'base.html' %}
{% load static %}

{% block title %}Подборка квартир — CENTURY 21{% endblock %}

{% block extra_css %}
<style>
/* Стили для каталога квартир */
.client-catalog-section {
    margin-bottom: 30px !important;
    padding: 40px 0;
}

.client-catalog-header {
    margin-bottom: 40px;
}

.client-catalog-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--c21-dark);
    margin: 0 0 8px 0;
}

.client-catalog-header p {
    color: #666;
    font-size: 16px;
    margin: 0;
}

/* Стили фильтров как в избранном */
.catalog-filters-box {
    padding: 24px;
    background: #f8f9fa;
    border-radius: 12px;
    margin-bottom: 30px;
}

.filters-row-rooms {
    margin-bottom: 20px;
}

.filters-row-inputs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

.filter-group {
    width: 100%;
    min-width: 0;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #1f2937;
    font-size: 14px;
}

/* Кнопки фильтра комнат */
.filter-btn {
    padding: 8px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 20px;
    background: #fff;
    color: #374151;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-btn[data-active="true"] {
    background: #d4a574 !important;
    color: #ffffff !important;
    border-color: #d4a574 !important;
}

.filter-btn[data-active="false"]:hover {
    border-color: #d4a574;
    color: #d4a574;
    background: #fff;
}

.filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

/* Стили для range-inputs */
.range-container {
    padding: 0;
    border: none;
    background: transparent;
}

.range-input-group {
    display: flex;
    gap: 12px;
}

.range-input-wrapper {
    flex: 1;
}

.range-input {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
    padding: 12px 14px;
    font-size: 14px;
    color: #111827;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    box-sizing: border-box;
}

.range-input:focus {
    outline: none;
    border-color: #bcaf87;
    box-shadow: 0 0 0 3px rgba(188, 175, 135, 0.15);
}

.range-input::placeholder {
    color: #9ca3af;
}

.filter-select {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    font-size: 14px;
    background: #fff;
    cursor: pointer;
    color: #111827;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.filter-select:focus {
    outline: none;
    border-color: #bcaf87;
    box-shadow: 0 0 0 3px rgba(188, 175, 135, 0.15);
}

/* Кнопки действий фильтров */
.filters-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.reset-btn {
    padding: 12px 20px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #1f2937;
    font-weight: 600;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.reset-btn:hover {
    border-color: #bcaf87;
    background: #fff;
    color: #111827;
    box-shadow: 0 0 0 3px rgba(188, 175, 135, 0.15);
}

.apply-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--c21-gold) 0%, var(--c21-gold-dark) 100%);
    color: var(--c21-dark);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(190, 175, 135, 0.3);
}

.apply-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(190, 175, 135, 0.4);
}

/* Сетка карточек */
.apartments-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 24px;
}

/* Карточка квартиры как в избранном */
.apartment-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    display: block;
}

.apartment-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
}

/* Галерея изображений */
.card-gallery {
    position: relative;
    width: 100%;
    height: 280px;
    overflow: hidden;
    background: #f3f4f6;
}

.card-gallery .gallery-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: opacity 0.3s ease;
}

.card-gallery .gallery-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    opacity: 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card-gallery:hover .gallery-nav {
    opacity: 1;
}

.card-gallery .gallery-nav:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: translateY(-50%) scale(1.1);
}

.card-gallery .gallery-prev {
    left: 10px;
}

.card-gallery .gallery-next {
    right: 10px;
}

.card-gallery .gallery-dots {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    padding: 4px 8px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 12px;
}

.card-gallery .gallery-dots .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.2s ease;
}

.card-gallery .gallery-dots .dot.active {
    background: rgba(255, 255, 255, 1);
    width: 24px;
    border-radius: 4px;
}

.card-gallery .gallery-dots .dot:hover {
    background: rgba(255, 255, 255, 0.8);
}

.card-favorite-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    background: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    color: #ccc;
    transition: all 0.2s ease;
}

.card-favorite-btn:hover {
    transform: scale(1.1);
}

.card-favorite-btn.active {
    color: #ef4444;
}

.card-content {
    padding: 16px;
}

.card-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 8px 0;
}

.card-location {
    color: #6b7280;
    font-size: 14px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.card-location i {
    color: var(--c21-gold);
    font-size: 12px;
}

.card-price {
    font-size: 24px;
    font-weight: 700;
    color: #2563eb;
    margin-bottom: 4px;
}

.card-price-per-m {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 8px;
}

.card-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px 16px;
    margin: 12px 0;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
}

.card-detail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.card-detail-item .detail-label {
    font-size: 11px;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card-detail-item .detail-value {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
}

.card-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.card-actions .card-link {
    width: 100%;
}

.card-link {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    background: linear-gradient(135deg, #beaf87 0%, #d4af37 100%);
    color: #1f2937;
    text-decoration: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(190, 175, 135, 0.3);
    border: none;
    cursor: pointer;
}

.card-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(190, 175, 135, 0.4);
}

.card-add-favorite {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    background: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.card-add-favorite:hover {
    background: #fef2f2;
    border-color: #ef4444;
    color: #ef4444;
}

.card-add-favorite.active {
    background: #fef2f2;
    border-color: #ef4444;
    color: #ef4444;
}

.no-apartments {
    text-align: center;
    padding: 80px 20px;
    color: #6b7280;
    grid-column: 1 / -1;
}

.no-apartments p {
    font-size: 18px;
    margin-bottom: 8px;
}

.no-apartments p:last-child {
    font-size: 14px;
    color: #9ca3af;
}

.loading-state {
    text-align: center;
    padding: 80px 20px;
    color: #6b7280;
    grid-column: 1 / -1;
}

.loading-state i {
    font-size: 48px;
    margin-bottom: 16px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Адаптивность */
@media (max-width: 992px) {
    .filters-row-inputs {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .client-catalog-header h1 {
        font-size: 1.75rem;
    }
    
    .catalog-filters-box {
        border-radius: 0;
        margin: 0 -16px 24px;
        padding: 16px;
    }
    
    .filters-row-inputs {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .filter-buttons {
        justify-content: flex-start;
    }
    
    .filters-actions {
        flex-direction: column;
    }
    
    .reset-btn,
    .apply-btn {
        width: 100%;
        justify-content: center;
    }
    
    .apartments-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .card-gallery {
        height: 240px;
    }
    
    .card-gallery .gallery-nav {
        opacity: 1;
        width: 32px;
        height: 32px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <section class="client-catalog-section">
        <div class="client-catalog-header">
            <h1 id="catalog-title">Подборка квартир</h1>
            <p id="catalog-subtitle">Выбранные квартиры из подборки</p>
        </div>
        
        <!-- Фильтры -->
        <div class="catalog-filters-box" id="catalog-filters">
            <!-- Первая строка: комнаты -->
            <div class="filters-row-rooms">
                <div class="filter-group">
                    <label>Количество комнат</label>
                    <div class="filter-buttons">
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="" data-active="true">Любое</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="studio" data-active="false">Студия</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="1" data-active="false">1</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="2" data-active="false">2</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="3" data-active="false">3</button>
                        <button type="button" class="filter-btn rooms-filter-btn" data-value="4" data-active="false">4+</button>
                    </div>
                </div>
            </div>
            
            <!-- Вторая строка: этаж, цена, жк -->
            <div class="filters-row-inputs">
                <!-- Фильтр по этажу -->
                <div class="filter-group">
                    <label>Этаж</label>
                    <div class="range-container">
                        <div class="range-input-group">
                            <div class="range-input-wrapper">
                                <input type="number" 
                                       id="floor-from" 
                                       class="range-input"
                                       placeholder="От" 
                                       min="1" 
                                       step="1" 
                                       inputmode="numeric">
                            </div>
                            <div class="range-input-wrapper">
                                <input type="number" 
                                       id="floor-to" 
                                       class="range-input"
                                       placeholder="До" 
                                       min="1" 
                                       step="1" 
                                       inputmode="numeric">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Фильтр по цене -->
                <div class="filter-group">
                    <label>Цена, ₽</label>
                    <div class="range-container">
                        <div class="range-input-group">
                            <div class="range-input-wrapper">
                                <input type="text" 
                                       id="price-from" 
                                       class="range-input"
                                       placeholder="От" 
                                       inputmode="numeric">
                            </div>
                            <div class="range-input-wrapper">
                                <input type="text" 
                                       id="price-to" 
                                       class="range-input"
                                       placeholder="До" 
                                       inputmode="numeric">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Фильтр по ЖК -->
                <div class="filter-group">
                    <label>Жилой комплекс</label>
                    <select id="complex-filter" class="filter-select">
                        <option value="">Все ЖК</option>
                    </select>
                </div>
            </div>
            
            <!-- Кнопки действий -->
            <div class="filters-actions">
                <button type="button" class="reset-btn" id="reset-btn">
                    Сбросить
                </button>
                <button type="button" class="apply-btn" id="apply-btn">
                    <i class="fas fa-check"></i>
                    Применить
                </button>
            </div>
        </div>
        
        <!-- Сетка квартир -->
        <div class="apartments-grid" id="apartmentsGrid">
            <div class="loading-state">
                <i class="fas fa-spinner"></i>
                <p>Загрузка квартир...</p>
            </div>
        </div>
    </section>
</div>

<script>
// Получаем параметры из URL
const urlParams = new URLSearchParams(window.location.search);
const complexesParam = urlParams.get('complexes') || '';
const apartmentsParam = urlParams.get('apartments') || '';
const isSelection = urlParams.get('is_selection') === 'true' || document.referrer.includes('/selection/');

// Обновляем заголовок если это подборка
if (isSelection) {
    const titleEl = document.getElementById('catalog-title');
    const subtitleEl = document.getElementById('catalog-subtitle');
    if (titleEl) titleEl.textContent = 'Подборка квартир';
    if (subtitleEl) subtitleEl.textContent = 'Выбранные квартиры из подборки';
}

// Переменные для фильтров
let currentRoomsFilter = []; // Массив выбранных типов комнат
let currentFloorFrom = '';
let currentFloorTo = '';
let currentPriceFrom = '';
let currentPriceTo = '';
let currentComplexFilter = '';
let allApartments = [];
let allComplexes = [];

// Загружаем квартиры
async function loadApartments() {
    const grid = document.getElementById('apartmentsGrid');
    
    if (!complexesParam) {
        grid.innerHTML = `
            <div class="no-apartments">
                <p>Не указаны ЖК для отображения</p>
                <p>Пожалуйста, используйте корректную ссылку</p>
            </div>
        `;
        return;
    }
    
    try {
        let apiUrl = `/api/client-catalog/apartments/?complexes=${encodeURIComponent(complexesParam)}`;
        if (apartmentsParam) {
            apiUrl += `&apartments=${encodeURIComponent(apartmentsParam)}`;
        }
        
        const response = await fetch(apiUrl);
        const result = await response.json();
        
        if (!result.success) {
            grid.innerHTML = `
                <div class="no-apartments">
                    <p>Ошибка загрузки данных</p>
                    <p>${result.error || 'Неизвестная ошибка'}</p>
                </div>
            `;
            return;
        }
        
        const apartments = result.apartments || [];
        allApartments = apartments;
        
        // Заполняем список ЖК
        const complexSet = new Set();
        apartments.forEach(apt => {
            if (apt.complex_id && apt.complex_name) {
                complexSet.add(JSON.stringify({id: apt.complex_id, name: apt.complex_name}));
            }
        });
        allComplexes = Array.from(complexSet).map(s => JSON.parse(s));
        
        // Обновляем селект ЖК
        const complexSelect = document.getElementById('complex-filter');
        if (complexSelect) {
            complexSelect.innerHTML = '<option value="">Все ЖК</option>';
            allComplexes.forEach(complex => {
                const option = document.createElement('option');
                option.value = complex.id;
                option.textContent = complex.name;
                complexSelect.appendChild(option);
            });
        }
        
        // Применяем фильтры и рендерим
        const filteredApartments = applyFilters(apartments);
        renderApartments(filteredApartments);
        
    } catch (error) {
        console.error('Ошибка загрузки квартир:', error);
        grid.innerHTML = `
            <div class="no-apartments">
                <p>Ошибка загрузки данных</p>
                <p>Попробуйте обновить страницу</p>
            </div>
        `;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPrice(price) {
    if (!price) return '';
    let priceStr = String(price).trim();
    priceStr = priceStr.replace(/₽/g, '').replace(/руб/g, '').trim();
    const priceClean = priceStr.replace(/\s/g, '').replace(/,/g, '').replace(/\./g, '').trim();
    if (!/^\d+$/.test(priceClean)) return priceStr;
    try {
        const priceNum = parseFloat(priceStr.replace(/\s/g, '').replace(/,/g, '.').trim());
        if (priceNum <= 0) return '';
        const formatted = priceNum.toLocaleString('ru-RU', {maximumFractionDigits: 0});
        return `${formatted} ₽`;
    } catch (e) {
        return priceStr;
    }
}

// Функция нормализации комнат (такая же как в избранном)
function normalizeRooms(apt) {
    const title = apt.title || '';
    let rooms = apt.rooms;
    
    const isStudioValue = (value) => {
        if (!value && value !== 0) return false;
        const normalized = String(value).trim().toLowerCase();
        return normalized === 'студия' || normalized === 'studio' || normalized === '0';
    };
    
    if (typeof rooms === 'number') {
        rooms = String(rooms);
    } else if (rooms) {
        rooms = String(rooms).trim();
    } else {
        rooms = '';
    }
    
    if (isStudioValue(rooms)) {
        return 'studio';
    }
    
    // Если rooms пустое, пытаемся извлечь из других полей
    if (!rooms) {
        const typeValue = apt.type || apt.room_type || '';
        if (isStudioValue(typeValue)) {
            return 'studio';
        }
    }
    
    if (!rooms && title) {
        const titleLower = title.toLowerCase();
        if (titleLower.includes('студия') || titleLower.includes('studio')) {
            return 'studio';
        }
        
        if (title.includes('-комн')) {
            rooms = title.split('-комн')[0].trim();
        } else if (title.includes('-к.')) {
            rooms = title.split('-к.')[0].trim();
        } else if (title.includes(' ком.')) {
            rooms = title.split(' ком.')[0].trim();
        } else {
            // Пытаемся найти число в начале title
            const match = title.match(/^(\d+)/);
            if (match) {
                rooms = match[1];
            }
        }
    }
    
    if (isStudioValue(rooms)) {
        return 'studio';
    }
    
    // Извлекаем только число из строки (убираем "-комн", "-к." и т.д.)
    const roomsMatch = rooms ? rooms.match(/^(\d+)/) : null;
    return roomsMatch ? roomsMatch[1] : '';
}

// Функция применения фильтров (такая же логика как в избранном)
function applyFilters(apartments) {
    let filtered = [...apartments];
    
    // Фильтр по комнатам - множественный выбор
    if (currentRoomsFilter.length > 0) {
        filtered = filtered.filter(apt => {
            const rooms = normalizeRooms(apt);
            
            if (!rooms) return false;
            
            // Проверяем, входит ли квартира в список выбранных типов
            return currentRoomsFilter.some(filterValue => {
                if (filterValue === 'studio') {
                    return rooms === 'studio';
                }
                if (filterValue === '4') {
                    const roomsNum = parseInt(rooms) || 0;
                    return roomsNum >= 4;
                }
                return rooms === filterValue;
            });
        });
    }
    
    // Фильтр по этажу
    // floorMin = этаж квартиры (например 8 в "8/23")
    // "от X" = этаж квартиры >= X
    // "до Y" = этаж квартиры <= Y
    if (currentFloorFrom || currentFloorTo) {
        filtered = filtered.filter(apt => {
            let floorNum = null;
            
            // Проверяем floorMin
            if (apt.floorMin !== undefined && apt.floorMin !== null) {
                floorNum = parseInt(apt.floorMin);
            } else if (apt.floor) {
                // Парсим формат "8/23" или "8-23" или просто "8"
                const floorStr = String(apt.floor);
                const match = floorStr.match(/^(\d+)/);
                if (match) {
                    floorNum = parseInt(match[1]);
                }
            }
            
            if (floorNum === null || isNaN(floorNum)) return false;
            
            const floorFromNum = currentFloorFrom ? parseInt(currentFloorFrom) : null;
            const floorToNum = currentFloorTo ? parseInt(currentFloorTo) : null;
            
            if (floorFromNum !== null && floorNum < floorFromNum) return false;
            if (floorToNum !== null && floorNum > floorToNum) return false;
            return true;
        });
    }
    
    // Фильтр по цене
    if (currentPriceFrom || currentPriceTo) {
        filtered = filtered.filter(apt => {
            if (!apt.price) return false;
            let priceNum = parseFloat(String(apt.price).replace(/\s/g, '').replace(/₽/g, '').replace(/руб/g, '').replace(/,/g, '')) || 0;
            
            const priceFromNum = currentPriceFrom ? parseFloat(String(currentPriceFrom).replace(/\s/g, '')) : null;
            const priceToNum = currentPriceTo ? parseFloat(String(currentPriceTo).replace(/\s/g, '')) : null;
            
            if (priceFromNum !== null && priceNum < priceFromNum) return false;
            if (priceToNum !== null && priceNum > priceToNum) return false;
            return true;
        });
    }
    
    // Фильтр по ЖК
    if (currentComplexFilter) {
        filtered = filtered.filter(apt => String(apt.complex_id) === String(currentComplexFilter));
    }
    
    return filtered;
}

// Функции для галереи
function changeImage(btn, direction) {
    const gallery = btn.closest('.card-gallery');
    const images = gallery.querySelectorAll('.gallery-image');
    const dots = gallery.querySelectorAll('.dot');
    
    let currentIndex = 0;
    images.forEach((img, idx) => {
        if (img.style.display !== 'none') {
            currentIndex = idx;
        }
    });
    
    let newIndex = currentIndex + direction;
    if (newIndex < 0) newIndex = images.length - 1;
    if (newIndex >= images.length) newIndex = 0;
    
    images.forEach((img, idx) => {
        img.style.display = idx === newIndex ? 'block' : 'none';
    });
    
    dots.forEach((dot, idx) => {
        dot.classList.toggle('active', idx === newIndex);
    });
}

function setImage(dot, index) {
    const gallery = dot.closest('.card-gallery');
    const images = gallery.querySelectorAll('.gallery-image');
    const dots = gallery.querySelectorAll('.dot');
    
    images.forEach((img, idx) => {
        img.style.display = idx === index ? 'block' : 'none';
    });
    
    dots.forEach((d, idx) => {
        d.classList.toggle('active', idx === index);
    });
}

// Функция рендеринга квартир
function renderApartments(apartments) {
    const grid = document.getElementById('apartmentsGrid');
    if (!grid) return;
    
    if (apartments.length === 0) {
        grid.innerHTML = `
            <div class="no-apartments">
                <p>Квартиры не найдены</p>
                <p>Попробуйте выбрать другие параметры</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = apartments.map(apt => {
        // Получаем все фото (API возвращает images и image)
        let photos = [];
        if (apt.images && Array.isArray(apt.images) && apt.images.length > 0) {
            photos = apt.images;
        } else if (apt.layout_photos && Array.isArray(apt.layout_photos) && apt.layout_photos.length > 0) {
            photos = apt.layout_photos;
        } else if (apt.photos && Array.isArray(apt.photos) && apt.photos.length > 0) {
            photos = apt.photos;
        } else if (apt.image) {
            photos = Array.isArray(apt.image) ? apt.image : [apt.image];
        }
        if (photos.length === 0) {
            photos = ['/static/images/placeholder.png'];
        }
        
        // Заголовок
        let title = apt.title || '';
        if (!title && apt.rooms) {
            const roomsStr = String(apt.rooms).toLowerCase();
            if (roomsStr === 'студия' || roomsStr === 'studio' || roomsStr === '0') {
                title = 'Студия';
            } else {
                title = `${apt.rooms}-комнатная квартира`;
            }
            if (apt.area) {
                title += `, ${apt.area} м²`;
            }
        } else if (!title && apt.area) {
            title = `Квартира, ${apt.area} м²`;
        } else if (!title) {
            title = 'Квартира';
        }
        
        // Цена за м²
        let pricePerSqm = '';
        if (apt.price_per_sqm) {
            pricePerSqm = formatPrice(apt.price_per_sqm) + '/м²';
        }
        
        // Этаж - проверяем поле floor (API возвращает его)
        let floor = apt.floor || '';
        if (floor) {
            floor = String(floor);
        }
        // Если floor пустой, пробуем floorMin
        if (!floor && apt.floorMin !== undefined && apt.floorMin !== null) {
            if (apt.floorMax && apt.floorMax !== apt.floorMin) {
                floor = `${apt.floorMin}/${apt.floorMax}`;
            } else {
                floor = String(apt.floorMin);
            }
        }
        
        // Срок сдачи - API возвращает completion_date
        const completionDate = apt.completion_date || apt.completionDate || apt.delivery_date || '';
        
        // URL
        let apartmentId = apt.id;
        if (apartmentId) {
            const parts = String(apartmentId).split('_');
            if (parts.length >= 3 && parts[0] === apt.complex_id) {
                apartmentId = `${parts[1]}_${parts[2]}`;
            } else if (parts.length >= 2 && parts[0] === apt.complex_id) {
                apartmentId = parts.slice(1).join('_');
            }
        } else if (apt.type !== undefined && apt.index !== undefined) {
            apartmentId = `${apt.type}_${apt.index}`;
        } else {
            apartmentId = '0_0';
        }
        const detailUrl = `/apartment/${apt.complex_id}/${apartmentId}/`;
        
        // Генерируем галерею
        let galleryHtml = photos.map((photo, idx) => `
            <img src="${photo}" 
                 alt="${escapeHtml(title)}" 
                 class="gallery-image" 
                 style="display: ${idx === 0 ? 'block' : 'none'};"
                 onerror="this.src='/static/images/placeholder.png'">
        `).join('');
        
        if (photos.length > 1) {
            galleryHtml += `
                <button class="gallery-nav gallery-prev" onclick="event.stopPropagation(); changeImage(this, -1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="gallery-nav gallery-next" onclick="event.stopPropagation(); changeImage(this, 1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="gallery-dots">
                    ${photos.map((_, idx) => `<span class="dot ${idx === 0 ? 'active' : ''}" onclick="event.stopPropagation(); setImage(this, ${idx})"></span>`).join('')}
                </div>
            `;
        }
        
        // Детали
        let detailsHtml = '';
        if (apt.area || floor || completionDate) {
            detailsHtml = '<div class="card-details">';
            if (apt.area) {
                detailsHtml += `
                    <div class="card-detail-item">
                        <span class="detail-label">Площадь</span>
                        <span class="detail-value">${escapeHtml(String(apt.area))} м²</span>
                    </div>
                `;
            }
            if (floor) {
                detailsHtml += `
                    <div class="card-detail-item">
                        <span class="detail-label">Этаж</span>
                        <span class="detail-value">${escapeHtml(String(floor))}</span>
                    </div>
                `;
            }
            if (completionDate) {
                detailsHtml += `
                    <div class="card-detail-item" style="grid-column: span 2;">
                        <span class="detail-label">Срок сдачи</span>
                        <span class="detail-value">${escapeHtml(String(completionDate))}</span>
                    </div>
                `;
            }
            detailsHtml += '</div>';
        }
        
        // Проверяем, есть ли в избранном
        const fullAptId = `${apt.complex_id}_${apartmentId}`;
        const isInFavorites = typeof isApartmentFavorite === 'function' ? isApartmentFavorite(apt.complex_id, apartmentId) : false;
        
        return `
            <div class="apartment-card" onclick="window.open('${detailUrl}', '_blank')">
                <div class="card-gallery">
                    <button class="card-favorite-btn ${isInFavorites ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleFavorite(this, '${apt.complex_id}', '${apartmentId}')" 
                            title="${isInFavorites ? 'Удалить из избранного' : 'Добавить в избранное'}">
                        <i class="${isInFavorites ? 'fas' : 'far'} fa-heart"></i>
                    </button>
                    ${galleryHtml}
                </div>
                <div class="card-content">
                    <h3 class="card-title">${escapeHtml(title)}</h3>
                    <div class="card-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${escapeHtml(apt.complex_name || 'ЖК')}</span>
                    </div>
                    ${apt.price ? `<div class="card-price">${escapeHtml(formatPrice(apt.price))}</div>` : ''}
                    ${pricePerSqm ? `<div class="card-price-per-m">${escapeHtml(pricePerSqm)}</div>` : ''}
                    ${detailsHtml}
                    <div class="card-actions">
                        <button class="card-link" onclick="event.stopPropagation(); window.open('${detailUrl}', '_blank')">
                            <i class="fas fa-eye"></i>
                            Подробнее
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Функция добавления/удаления из избранного
function toggleFavorite(btn, complexId, apartmentId) {
    const isActive = btn.classList.contains('active');
    
    if (isActive) {
        if (typeof removeApartmentFromFavorites === 'function') {
            removeApartmentFromFavorites(complexId, apartmentId);
        }
    } else {
        if (typeof addApartmentToFavorites === 'function') {
            addApartmentToFavorites(complexId, apartmentId);
        }
    }
    
    // Обновляем кнопку в углу фото
    const card = btn.closest('.apartment-card');
    if (card) {
        const favBtn = card.querySelector('.card-favorite-btn');
        if (favBtn) {
            favBtn.classList.toggle('active', !isActive);
            const icon = favBtn.querySelector('i');
            if (icon) {
                icon.className = !isActive ? 'fas fa-heart' : 'far fa-heart';
            }
        }
    }
    
    if (typeof updateFavoritesCount === 'function') {
        updateFavoritesCount();
    }
}

// Обработчики фильтров
document.addEventListener('DOMContentLoaded', function() {
    // Обработчики кнопок комнат - множественный выбор (toggle)
    document.querySelectorAll('.rooms-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            const isActive = this.getAttribute('data-active') === 'true';
            
            // Кнопка "Любое" - снимает все выборы
            if (value === '') {
                if (!isActive) {
                    // Снимаем все выборы
                    document.querySelectorAll('.rooms-filter-btn').forEach(b => {
                        b.setAttribute('data-active', 'false');
                    });
                    this.setAttribute('data-active', 'true');
                    currentRoomsFilter = [];
                }
            } else {
                // Для остальных кнопок - toggle
                if (isActive) {
                    // Снимаем выбор
                    this.setAttribute('data-active', 'false');
                    currentRoomsFilter = currentRoomsFilter.filter(v => v !== value);
                } else {
                    // Добавляем выбор
                    this.setAttribute('data-active', 'true');
                    if (!currentRoomsFilter.includes(value)) {
                        currentRoomsFilter.push(value);
                    }
                    // Снимаем "Любое", если выбрана конкретная опция
                    const anyBtn = document.querySelector('.rooms-filter-btn[data-value=""]');
                    if (anyBtn) {
                        anyBtn.setAttribute('data-active', 'false');
                    }
                }
            }
        });
    });
    
    // Обработчики полей этажа
    const floorFrom = document.getElementById('floor-from');
    const floorTo = document.getElementById('floor-to');
    
    if (floorFrom) {
        floorFrom.addEventListener('input', function() {
            currentFloorFrom = this.value.trim();
        });
    }
    
    if (floorTo) {
        floorTo.addEventListener('input', function() {
            currentFloorTo = this.value.trim();
        });
    }
    
    // Функция форматирования цены
    function formatPriceInput(value) {
        const numbers = value.replace(/\D/g, '');
        if (!numbers) return '';
        return numbers.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }
    
    function getPriceNumber(value) {
        return value.replace(/\s/g, '').trim();
    }
    
    // Обработчики полей цены
    const priceFrom = document.getElementById('price-from');
    const priceTo = document.getElementById('price-to');
    
    if (priceFrom) {
        priceFrom.addEventListener('input', function() {
            const formatted = formatPriceInput(this.value);
            this.value = formatted;
            currentPriceFrom = getPriceNumber(formatted);
        });
    }
    
    if (priceTo) {
        priceTo.addEventListener('input', function() {
            const formatted = formatPriceInput(this.value);
            this.value = formatted;
            currentPriceTo = getPriceNumber(formatted);
        });
    }
    
    // Обработчик селекта ЖК
    const complexFilter = document.getElementById('complex-filter');
    if (complexFilter) {
        complexFilter.addEventListener('change', function() {
            currentComplexFilter = this.value || '';
        });
    }
    
    // Кнопка "Сбросить"
    const resetBtn = document.getElementById('reset-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            // Сбрасываем все фильтры
            currentRoomsFilter = [];
            currentFloorFrom = '';
            currentFloorTo = '';
            currentPriceFrom = '';
            currentPriceTo = '';
            currentComplexFilter = '';
            
            // Сбрасываем UI - только "Любое" активна
            document.querySelectorAll('.rooms-filter-btn').forEach(b => {
                b.setAttribute('data-active', b.getAttribute('data-value') === '' ? 'true' : 'false');
            });
            
            if (floorFrom) floorFrom.value = '';
            if (floorTo) floorTo.value = '';
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            if (complexFilter) complexFilter.value = '';
            
            // Применяем
            if (allApartments.length > 0) {
                const filtered = applyFilters(allApartments);
                renderApartments(filtered);
            }
        });
    }
    
    // Кнопка "Применить"
    const applyBtn = document.getElementById('apply-btn');
    if (applyBtn) {
        applyBtn.addEventListener('click', function() {
            if (allApartments.length > 0) {
                const filtered = applyFilters(allApartments);
                renderApartments(filtered);
            }
        });
    }
    
    // Загружаем квартиры
    loadApartments();
});
</script>
{% endblock %}


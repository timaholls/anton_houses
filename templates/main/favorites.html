{% extends 'base.html' %}

{% block title %}–ò–∑–±—Ä–∞–Ω–Ω–æ–µ ‚Äî CENTURY 21{% endblock %}

{% block extra_css %}
<style>
.favorites-page {
    padding: 40px 0;
    min-height: 60vh;
}

.favorites-header {
    margin-bottom: 32px;
}

.favorites-header h1 {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--c21-dark);
    margin: 0 0 8px 0;
}

.favorites-header p {
    color: #666;
    font-size: 16px;
    margin: 0;
}

.favorites-empty {
    text-align: center;
    padding: 80px 20px;
    background: #f8f9fa;
    border-radius: 16px;
}

.favorites-empty i {
    font-size: 64px;
    color: #ccc;
    margin-bottom: 24px;
}

.favorites-empty h2 {
    font-size: 1.5rem;
    color: #666;
    margin: 0 0 12px 0;
}

.favorites-empty p {
    color: #999;
    margin: 0 0 24px 0;
}

.favorites-empty .btn {
    display: inline-block;
    padding: 12px 24px;
    background: var(--c21-gold);
    color: var(--c21-dark);
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.favorites-empty .btn:hover {
    background: var(--c21-gold-dark);
    transform: translateY(-2px);
}

.favorites-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 24px;
}

.favorite-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
    display: block;
}

.favorite-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    text-decoration: none;
    color: inherit;
}

/* –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
.favorite-card-gallery {
    position: relative;
    width: 100%;
    height: 280px;
    overflow: hidden;
    background: #f3f4f6;
}

.favorite-card-gallery .gallery-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: opacity 0.3s ease;
}

.favorite-card-gallery .gallery-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    opacity: 0;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.favorite-card-gallery:hover .gallery-nav {
    opacity: 1;
}

.favorite-card-gallery .gallery-nav:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: translateY(-50%) scale(1.1);
}

.favorite-card-gallery .gallery-prev {
    left: 10px;
}

.favorite-card-gallery .gallery-next {
    right: 10px;
}

.favorite-card-gallery .gallery-dots {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
    padding: 4px 8px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 12px;
}

.favorite-card-gallery .gallery-dots .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.2s ease;
}

.favorite-card-gallery .gallery-dots .dot.active {
    background: rgba(255, 255, 255, 1);
    width: 24px;
    border-radius: 4px;
}

.favorite-card-gallery .gallery-dots .dot:hover {
    background: rgba(255, 255, 255, 0.8);
}

.favorite-card-remove-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
    background: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    color: #ef4444;
    transition: all 0.2s ease;
}

.favorite-card-remove-btn:hover {
    background: #fee;
    transform: scale(1.1);
}

.favorite-card-content {
    padding: 16px;
}

.favorite-card-title {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 8px 0;
}

.favorite-card-price {
    font-size: 24px;
    font-weight: 700;
    color: #2563eb;
    margin-bottom: 4px;
}

.favorite-card-price-per-m {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 8px;
}

.favorite-card-details {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px 16px;
    margin: 12px 0;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
}

.favorite-card-detail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.favorite-card-detail-item .detail-label {
    font-size: 11px;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.favorite-card-detail-item .detail-value {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
}

.favorite-card-location {
    color: #6b7280;
    font-size: 14px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.favorite-card-location i {
    color: var(--c21-gold);
    font-size: 12px;
}

.favorite-card-link {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    background: linear-gradient(135deg, #beaf87 0%, #d4af37 100%);
    color: #1f2937;
    text-decoration: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(190, 175, 135, 0.3);
    border: none;
    cursor: pointer;
    width: 100%;
}

.favorite-card-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(190, 175, 135, 0.4);
}

.favorite-card-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.favorite-card-actions .favorite-card-link {
    flex: 1;
}

.favorite-card-remove {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    background: #f8f9fa;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.favorite-card-remove:hover {
    background: #fef2f2;
    border-color: #ef4444;
    color: #ef4444;
}

@media (max-width: 768px) {
    .favorite-card-gallery {
        height: 240px;
    }
    
    .favorite-card-gallery .gallery-nav {
        opacity: 1;
        width: 32px;
        height: 32px;
    }
}

@media (max-width: 768px) {
    .favorites-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .favorites-header h1 {
        font-size: 1.75rem;
    }
}

/* –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è */
.share-favorites-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark));
    color: var(--c21-dark);
    border: none;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(190, 175, 135, 0.3);
    transition: all 0.3s ease;
}

.share-favorites-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(190, 175, 135, 0.4);
}

.share-favorites-btn i {
    font-size: 18px;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è */
.share-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.share-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.share-modal-content {
    position: relative;
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    z-index: 10001;
}

.share-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid #e9ecef;
}

.share-modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--c21-dark);
}

.share-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #666;
    cursor: pointer;
    padding: 4px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.share-modal-close:hover {
    background: #f8f9fa;
    color: var(--c21-dark);
}

.share-modal-body {
    padding: 24px;
}

.share-link-container {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
}

.share-link-input {
    flex: 1;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    background: #f8f9fa;
    color: var(--c21-dark);
}

.share-link-input:focus {
    outline: none;
    border-color: var(--c21-gold);
}

.copy-link-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark));
    color: var(--c21-dark);
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.copy-link-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(190, 175, 135, 0.3);
}

.copy-success-message {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: #d4edda;
    color: #155724;
    border-radius: 8px;
    font-size: 14px;
}

.copy-success-message i {
    color: #28a745;
}

@media (max-width: 600px) {
    .share-link-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .share-link-input {
        width: 100%;
    }
    
    .copy-link-btn {
        width: 100%;
        justify-content: center;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.filter-btn {
    padding: 8px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 20px;
    background: #fff;
    color: #374151;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-btn[data-active="true"] {
    background: #d4a574 !important;
    color: #ffffff !important;
    border-color: #d4a574 !important;
}

.filter-btn[data-active="false"]:hover {
    border-color: #d4a574;
    color: #d4a574;
    background: #fff;
}

.catalog-filters {
    margin-bottom: 30px;
}

.favorites-filters-box {
    padding: 24px;
    background: #f8f9fa;
    border-radius: 12px;
}

/* –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –∫–æ–º–Ω–∞—Ç—ã */
.favorites-filters-row-rooms {
    margin-bottom: 20px;
}

/* –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: —ç—Ç–∞–∂, —Ü–µ–Ω–∞, –∂–∫ –≤ —Ç—Ä–∏ –∫–æ–ª–æ–Ω–∫–∏ */
.favorites-filters-row-inputs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
}

.favorites-filter-group {
    width: 100%;
    min-width: 0;
}

.favorites-filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #1f2937;
    font-size: 14px;
}

.favorites-filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è range-inputs –∫–∞–∫ –≤ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ */
.favorites-range-container {
    padding: 0;
    border: none;
    background: transparent;
}

.favorites-range-input-group {
    display: flex;
    gap: 12px;
}

.favorites-range-input-wrapper {
    flex: 1;
}

.favorites-range-input {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
    padding: 12px 14px;
    font-size: 14px;
    color: #111827;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    box-sizing: border-box;
}

.favorites-range-input:focus {
    outline: none;
    border-color: #bcaf87;
    box-shadow: 0 0 0 3px rgba(188, 175, 135, 0.15);
}

.favorites-range-input::placeholder {
    color: #9ca3af;
}

.favorites-select {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    font-size: 14px;
    background: #fff;
    cursor: pointer;
    color: #111827;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.favorites-select:focus {
    outline: none;
    border-color: #bcaf87;
    box-shadow: 0 0 0 3px rgba(188, 175, 135, 0.15);
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.favorites-filters-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.favorites-reset-btn {
    padding: 12px 20px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #1f2937;
    font-weight: 600;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.favorites-reset-btn:hover {
    border-color: #bcaf87;
    background: #fff;
    color: #111827;
    box-shadow: 0 0 0 3px rgba(188, 175, 135, 0.15);
}

.favorites-apply-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: linear-gradient(135deg, var(--c21-gold) 0%, var(--c21-gold-dark) 100%);
    color: var(--c21-dark);
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(190, 175, 135, 0.3);
}

.favorites-apply-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(190, 175, 135, 0.4);
}

@media (max-width: 992px) {
    .favorites-filters-row-inputs {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .catalog-filters {
        margin: 0 -16px 24px;
        border-radius: 0;
    }
    
    .favorites-filters-box {
        border-radius: 0;
        padding: 16px;
    }
    
    .favorites-filters-row-inputs {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .favorites-filter-buttons {
        justify-content: flex-start;
    }
    
    .favorites-filters-actions {
        flex-direction: column;
    }
    
    .favorites-reset-btn,
    .favorites-apply-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="favorites-page">
        <div class="favorites-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div>
            <h1>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</h1>
            <p>–í–∞—à–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</p>
                </div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button id="share-favorites-btn" class="share-favorites-btn" style="display: none;">
                        <i class="fas fa-share-alt"></i>
                        <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                    </button>
                    <button id="clear-favorites-btn" class="share-favorites-btn" style="display: none; background: #fff; color: #b91c1c; border: 1px solid #ef4444; box-shadow: none;">
                        <i class="fas fa-trash-alt"></i>
                        <span>–û—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="favorites-empty" class="favorites-empty" style="display: none;">
            <i class="far fa-heart"></i>
            <h2>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ</h2>
            <p>–î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∏–º –ø–æ–∑–∂–µ</p>
            <a href="{% url 'main:catalog' %}" class="btn">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a>
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="catalog-filters favorites-filters-box" id="favorites-filters" style="display: none;">
            <!-- –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: –∫–æ–º–Ω–∞—Ç—ã -->
            <div class="favorites-filters-row-rooms">
                <div class="filter-group favorites-filter-group">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç</label>
                    <div class="button-filter favorites-filter-buttons">
                        <button type="button" class="filter-btn favorites-rooms-filter-btn" data-value="" data-active="true">–õ—é–±–æ–µ</button>
                        <button type="button" class="filter-btn favorites-rooms-filter-btn" data-value="studio" data-active="false">–°—Ç—É–¥–∏—è</button>
                        <button type="button" class="filter-btn favorites-rooms-filter-btn" data-value="1" data-active="false">1</button>
                        <button type="button" class="filter-btn favorites-rooms-filter-btn" data-value="2" data-active="false">2</button>
                        <button type="button" class="filter-btn favorites-rooms-filter-btn" data-value="3" data-active="false">3</button>
                        <button type="button" class="filter-btn favorites-rooms-filter-btn" data-value="4" data-active="false">4+</button>
                    </div>
                </div>
            </div>
            
            <!-- –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞: —ç—Ç–∞–∂, —Ü–µ–Ω–∞, –∂–∫ -->
            <div class="favorites-filters-row-inputs">
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–∂—É -->
                <div class="filter-group favorites-filter-group">
                    <label>–≠—Ç–∞–∂</label>
                    <div class="favorites-range-container">
                        <div class="favorites-range-input-group">
                            <div class="favorites-range-input-wrapper">
                                <input type="number" 
                                       id="favorites-floor-from" 
                                       class="favorites-range-input"
                                       placeholder="–û—Ç" 
                                       min="1" 
                                       step="1" 
                                       inputmode="numeric">
                            </div>
                            <div class="favorites-range-input-wrapper">
                                <input type="number" 
                                       id="favorites-floor-to" 
                                       class="favorites-range-input"
                                       placeholder="–î–æ" 
                                       min="1" 
                                       step="1" 
                                       inputmode="numeric">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ -->
                <div class="filter-group favorites-filter-group">
                    <label>–¶–µ–Ω–∞, ‚ÇΩ</label>
                    <div class="favorites-range-container">
                        <div class="favorites-range-input-group">
                            <div class="favorites-range-input-wrapper">
                                <input type="text" 
                                       id="favorites-price-from" 
                                       class="favorites-range-input"
                                       placeholder="–û—Ç" 
                                       inputmode="numeric">
                            </div>
                            <div class="favorites-range-input-wrapper">
                                <input type="text" 
                                       id="favorites-price-to" 
                                       class="favorites-range-input"
                                       placeholder="–î–æ" 
                                       inputmode="numeric">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ñ–ö -->
                <div class="filter-group favorites-filter-group">
                    <label>–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å</label>
                    <select id="favorites-complex-filter" class="favorites-select">
                        <option value="">–í—Å–µ –ñ–ö</option>
                    </select>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="favorites-filters-actions">
                <button type="button" class="favorites-reset-btn" id="favorites-reset-btn">
                    –°–±—Ä–æ—Å–∏—Ç—å
                </button>
                <button type="button" class="favorites-apply-btn" id="favorites-apply-btn">
                    <i class="fas fa-check"></i>
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
        
        <div id="favorites-grid" class="favorites-grid">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è -->
<div id="share-modal" class="share-modal" style="display: none;">
    <div class="share-modal-overlay"></div>
    <div class="share-modal-content">
        <div class="share-modal-header">
            <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ–¥–±–æ—Ä–∫–æ–π</h3>
            <button class="share-modal-close" id="share-modal-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="share-modal-body">
            <p style="margin-bottom: 16px; color: #666;">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ–¥–±–æ—Ä–∫–æ–π:</p>
            <div class="share-link-container">
                <input type="text" id="share-link-input" class="share-link-input" readonly>
                <button id="copy-link-btn" class="copy-link-btn">
                    <i class="fas fa-copy"></i>
                    <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                </button>
            </div>
            <div id="copy-success-message" class="copy-success-message" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <span>–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!</span>
            </div>
        </div>
    </div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
let allFavoriteItems = [];
let favoritesRoomsFilter = []; // –ú–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–º–Ω–∞—Ç
let favoritesFloorFrom = '';
let favoritesFloorTo = '';
let favoritesPriceFrom = '';
let favoritesPriceTo = '';
let favoritesComplexFilter = '';

document.addEventListener('DOMContentLoaded', function() {
    loadFavorites();
    initFavoritesFilters();
    initClearFavoritesButton();
});

let clearFavoritesBtn;

function initClearFavoritesButton() {
    clearFavoritesBtn = document.getElementById('clear-favorites-btn');
    if (!clearFavoritesBtn) return;
    updateClearFavoritesBtnVisibility();
    clearFavoritesBtn.addEventListener('click', handleClearFavoritesClick);
}

function updateClearFavoritesBtnVisibility() {
    if (!clearFavoritesBtn) return;
    const favorites = getFavorites ? getFavorites() : { complexes: [], apartments: [] };
    const totalCount = favorites.complexes.length + favorites.apartments.length;
    clearFavoritesBtn.style.display = totalCount > 0 ? 'inline-flex' : 'none';
}

function handleClearFavoritesClick() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ?')) {
        clearAllFavoritesStorage();
        if (typeof showFavoriteNotification === 'function') {
            showFavoriteNotification('–ò–∑–±—Ä–∞–Ω–Ω–æ–µ –æ—á–∏—â–µ–Ω–æ');
        }
        refreshFavoritesPage();
    }
}

function clearAllFavoritesStorage() {
    try {
        if (typeof FAVORITES_STORAGE_KEY !== 'undefined') {
            localStorage.removeItem(FAVORITES_STORAGE_KEY);
        } else {
            localStorage.removeItem('century21_favorites');
        }
    } catch (e) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ', e);
    }
    updateFavoritesCount && updateFavoritesCount();
    updateFavoritesFloatingButton && updateFavoritesFloatingButton();
}

function refreshFavoritesPage() {
    loadFavorites();
    updateClearFavoritesBtnVisibility();
}

function loadFavorites() {
    const favorites = getFavorites();
    const grid = document.getElementById('favorites-grid');
    const empty = document.getElementById('favorites-empty');
    const shareBtn = document.getElementById('share-favorites-btn');
    const filtersDiv = document.getElementById('favorites-filters');
    
    const allIds = [...favorites.complexes, ...favorites.apartments];
    
    if (allIds.length === 0) {
        grid.style.display = 'none';
        empty.style.display = 'block';
        if (shareBtn) shareBtn.style.display = 'none';
        if (filtersDiv) filtersDiv.style.display = 'none';
        return;
    }
    
    grid.style.display = 'grid';
    empty.style.display = 'none';
    if (shareBtn) shareBtn.style.display = 'flex';
    if (filtersDiv) filtersDiv.style.display = 'block';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ñ–ö
    const complexPromises = favorites.complexes.map(id => 
        fetch(`/api/complex/${id}/`)
            .then(res => res.json())
            .then(result => result.success ? ({ type: 'complex', id, data: result }) : null)
            .catch(() => null)
    );
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–≤–∞—Ä—Ç–∏—Ä–∞—Ö
    console.log('üîç [FAVORITES] loadFavorites: –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–≤–∞—Ä—Ç–∏—Ä', { 
        totalApartments: favorites.apartments.length, 
        apartments: favorites.apartments 
    });
    
    const apartmentPromises = favorites.apartments.map(fullId => {
        console.log('üìã [FAVORITES] –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ID –∫–≤–∞—Ä—Ç–∏—Ä—ã:', fullId);
        
        const parts = fullId.split('_');
        if (parts.length < 2) {
            console.warn('‚ùå [FAVORITES] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –∫–≤–∞—Ä—Ç–∏—Ä—ã:', fullId, { parts, partsLength: parts.length });
            return Promise.resolve(null);
        }
        
        // ID –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ "complexId_apartmentId" –∏–ª–∏ "complexId_type_index"
        const complexId = parts[0];
        const apartmentId = parts.slice(1).join('_'); // –û—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ - —ç—Ç–æ ID –∫–≤–∞—Ä—Ç–∏—Ä—ã
        
        console.log('üîç [FAVORITES] –ü–∞—Ä—Å–∏–Ω–≥ ID:', { fullId, complexId, apartmentId, parts });
        
        return fetch(`/api/complex/${complexId}/`)
            .then(res => {
                if (!res.ok) {
                    console.warn(`‚ùå [FAVORITES] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ñ–ö ${complexId}:`, res.status, res.statusText);
                    return null;
                }
                return res.json();
            })
            .then(result => {
                console.log(`üì• [FAVORITES] –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –¥–ª—è –ñ–ö ${complexId}:`, { 
                    success: result?.success, 
                    hasApartmentTypes: !!result?.apartment_types,
                    apartmentTypesKeys: result?.apartment_types ? Object.keys(result.apartment_types) : []
                });
                
                if (!result || !result.success) {
                    console.warn('‚ùå [FAVORITES] –ñ–ö –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞:', result);
                    return null;
                }
                const complexData = result;
                // –ù–∞—Ö–æ–¥–∏–º –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ –¥–∞–Ω–Ω—ã—Ö –ñ–ö
                console.log(`üîç [FAVORITES] –ò—â–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—É ${apartmentId} –≤ –ñ–ö ${complexId}`);
                const apartmentResult = findApartmentInComplex(complexData, apartmentId);
                if (!apartmentResult) {
                    console.warn(`‚ùå [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ ${apartmentId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ñ–ö ${complexId}`, {
                        apartmentTypes: Object.keys(complexData.apartment_types || {}),
                        apartmentId: apartmentId,
                        complexId: complexId,
                        fullId: fullId
                    });
                    return null;
                }
                
                const apartment = apartmentResult.apartment;
                const apartmentType = apartmentResult.apartmentType;
                
                console.log(`‚úÖ [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞:`, { 
                    apartmentId, 
                    complexId,
                    apartmentTitle: apartment.title,
                    apartmentPrice: apartment.price,
                    apartmentType: apartmentType
                });
                
                return { type: 'apartment', complexId, apartmentId, complexData, apartment, apartmentType };
            })
            .catch(err => {
                console.error('‚ùå [FAVORITES] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã:', err, { fullId, complexId, apartmentId });
                return null;
            });
    });
    
    Promise.all([...complexPromises, ...apartmentPromises]).then(results => {
        const validResults = results.filter(r => r !== null);
        allFavoriteItems = validResults;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ñ–ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
        const complexSet = new Set();
        validResults.forEach(item => {
            if (item.type === 'apartment' && item.complexData) {
                const complexId = item.complexId;
                const complexName = item.complexData.name || '–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å';
                complexSet.add(JSON.stringify({id: complexId, name: complexName}));
            } else if (item.type === 'complex' && item.data) {
                const complexId = item.id;
                const complexName = item.data.name || '–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å';
                complexSet.add(JSON.stringify({id: complexId, name: complexName}));
            }
        });
        const allComplexes = Array.from(complexSet).map(s => JSON.parse(s));
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç –ñ–ö
        const complexSelect = document.getElementById('favorites-complex-filter');
        if (complexSelect) {
            const currentValue = complexSelect.value;
            complexSelect.innerHTML = '<option value="">–í—Å–µ –ñ–ö</option>';
            allComplexes.forEach(complex => {
                const option = document.createElement('option');
                option.value = complex.id;
                option.textContent = complex.name;
                if (complex.id === currentValue) {
                    option.selected = true;
                }
                complexSelect.appendChild(option);
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω)
        if (favoritesRoomsFilter.length === 0) {
            const activeBtns = document.querySelectorAll('.favorites-rooms-filter-btn[data-active="true"]');
            favoritesRoomsFilter = Array.from(activeBtns)
                .map(btn => btn.getAttribute('data-value'))
                .filter(val => val !== ''); // –ò—Å–∫–ª—é—á–∞–µ–º "–õ—é–±–æ–µ"
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º
        const filtered = applyFavoritesFilters(validResults);
        renderFavorites(filtered);
    });
}

function applyFavoritesFilters(items) {
    let filtered = [...items];
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç
    function normalizeRooms(apt, apartmentType = null) {
        const title = apt.title || '';
        let rooms = apt.rooms;
        
        const isStudioValue = (value) => {
            if (!value && value !== 0) return false;
            const normalized = String(value).trim().toLowerCase();
            return normalized === '—Å—Ç—É–¥–∏—è' || normalized === 'studio' || normalized === '0' || normalized === '—Å—Ç—É–¥–∏–æ';
        };
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏–∑ –∫–ª—é—á–∞ apartment_types (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
        if (apartmentType) {
            const typeLower = String(apartmentType).trim().toLowerCase();
            if (isStudioValue(apartmentType) || typeLower === '—Å—Ç—É–¥–∏—è' || typeLower === 'studio') {
                return 'studio';
            }
            // –ï—Å–ª–∏ —Ç–∏–ø - —á–∏—Å–ª–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
            const typeMatch = apartmentType.match(/^(\d+)/);
            if (typeMatch) {
                return typeMatch[1];
            }
        }
        
        if (typeof rooms === 'number') {
            rooms = String(rooms);
        } else if (rooms) {
            rooms = String(rooms).trim();
        } else {
            rooms = '';
        }
        
        if (isStudioValue(rooms)) {
            return 'studio';
        }
        
        // –ï—Å–ª–∏ rooms –ø—É—Å—Ç–æ–µ, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–∑ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
        if (!rooms) {
            const typeValue = apt.type || apt.room_type || '';
            if (isStudioValue(typeValue)) {
                return 'studio';
            }
        }
        
        if (!rooms && title) {
            const titleLower = title.toLowerCase();
            if (titleLower.includes('—Å—Ç—É–¥–∏—è') || titleLower.includes('studio')) {
                return 'studio';
            }
            
            if (title.includes('-–∫–æ–º–Ω')) {
                rooms = title.split('-–∫–æ–º–Ω')[0].trim();
            } else if (title.includes('-–∫.')) {
                rooms = title.split('-–∫.')[0].trim();
            } else if (title.includes(' –∫–æ–º.')) {
                rooms = title.split(' –∫–æ–º.')[0].trim();
            } else {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —á–∏—Å–ª–æ –≤ –Ω–∞—á–∞–ª–µ title
                const match = title.match(/^(\d+)/);
                if (match) {
                    rooms = match[1];
                }
            }
        }
        
        if (isStudioValue(rooms)) {
            return 'studio';
        }
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏ (—É–±–∏—Ä–∞–µ–º "-–∫–æ–º–Ω", "-–∫." –∏ —Ç.–¥.)
        const roomsMatch = rooms ? rooms.match(/^(\d+)/) : null;
        return roomsMatch ? roomsMatch[1] : '';
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä) - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
    if (favoritesRoomsFilter.length > 0) {
        filtered = filtered.filter(item => {
            if (item.type !== 'apartment') return true; // –ñ–ö –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            const apt = item.apartment;
            // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–∏–ø –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏–∑ –∫–ª—é—á–∞ apartment_types –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
            const rooms = normalizeRooms(apt, item.apartmentType);
            
            if (!rooms) return false; // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—ã, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏—Ç –ª–∏ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤
            return favoritesRoomsFilter.some(filterValue => {
                if (filterValue === 'studio') {
                    return rooms === 'studio';
                }
                if (filterValue === '4') {
                    const roomsNum = parseInt(rooms) || 0;
                    return roomsNum >= 4;
                }
                return rooms === filterValue;
            });
        });
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ —ç—Ç–∞–∂—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä)
    // floorMin = —ç—Ç–∞–∂ –∫–≤–∞—Ä—Ç–∏—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä 8 –≤ "8/23")
    // "–æ—Ç X" = —ç—Ç–∞–∂ –∫–≤–∞—Ä—Ç–∏—Ä—ã >= X
    // "–¥–æ Y" = —ç—Ç–∞–∂ –∫–≤–∞—Ä—Ç–∏—Ä—ã <= Y
    if (favoritesFloorFrom || favoritesFloorTo) {
        filtered = filtered.filter(item => {
            if (item.type !== 'apartment') return true; // –ñ–ö –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            const apt = item.apartment;
            
            // –ü–æ–ª—É—á–∞–µ–º —ç—Ç–∞–∂ –∫–≤–∞—Ä—Ç–∏—Ä—ã
            let floorNum = null;
            if (apt.floorMin !== undefined && apt.floorMin !== null) {
                floorNum = parseInt(apt.floorMin);
            } else if (apt.floor) {
                // –ü–∞—Ä—Å–∏–º —Ñ–æ—Ä–º–∞—Ç "8/23" –∏–ª–∏ "8-23" –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ "8"
                const floorStr = String(apt.floor);
                const match = floorStr.match(/^(\d+)/);
                if (match) {
                    floorNum = parseInt(match[1]);
                }
            }
            
            if (floorNum === null || isNaN(floorNum)) return false;
            
            const floorFromNum = favoritesFloorFrom ? parseInt(favoritesFloorFrom) : null;
            const floorToNum = favoritesFloorTo ? parseInt(favoritesFloorTo) : null;
            
            if (floorFromNum !== null && floorNum < floorFromNum) {
                return false;
            }
            if (floorToNum !== null && floorNum > floorToNum) {
                return false;
            }
            return true;
        });
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä)
    if (favoritesPriceFrom || favoritesPriceTo) {
        filtered = filtered.filter(item => {
            if (item.type !== 'apartment') return true; // –ñ–ö –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            const apt = item.apartment;
            if (!apt.price) return false;
            let priceNum = parseFloat(String(apt.price).replace(/\s/g, '').replace(/‚ÇΩ/g, '').replace(/—Ä—É–±/g, '').replace(/,/g, '')) || 0;
            
            // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏–∑ –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
            const priceFromNum = favoritesPriceFrom ? parseFloat(String(favoritesPriceFrom).replace(/\s/g, '')) : null;
            const priceToNum = favoritesPriceTo ? parseFloat(String(favoritesPriceTo).replace(/\s/g, '')) : null;
            
            if (priceFromNum !== null && priceNum < priceFromNum) {
                return false;
            }
            if (priceToNum !== null && priceNum > priceToNum) {
                return false;
            }
            return true;
        });
    }
    
    // –§–∏–ª—å—Ç—Ä –ø–æ –ñ–ö
    if (favoritesComplexFilter) {
        filtered = filtered.filter(item => {
            if (item.type === 'apartment') {
                return String(item.complexId) === String(favoritesComplexFilter);
            } else if (item.type === 'complex') {
                return String(item.id) === String(favoritesComplexFilter);
            }
            return false;
        });
    }
    
    return filtered;
}

function renderFavorites(items) {
    const grid = document.getElementById('favorites-grid');
    if (!grid) return;
    
    if (items.length === 0) {
        grid.innerHTML = '<div class="no-apartments"><p>–ö–≤–∞—Ä—Ç–∏—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p><p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</p></div>';
        return;
    }
    
    grid.innerHTML = items.map(item => renderFavoriteCard(item)).join('');
}

function initFavoritesFilters() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    const activeRoomsBtns = document.querySelectorAll('.favorites-rooms-filter-btn[data-active="true"]');
    if (activeRoomsBtns.length > 0) {
        favoritesRoomsFilter = Array.from(activeRoomsBtns)
            .map(btn => btn.getAttribute('data-value'))
            .filter(val => val !== ''); // –ò—Å–∫–ª—é—á–∞–µ–º "–õ—é–±–æ–µ"
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∫–æ–º–Ω–∞—Ç - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä (toggle)
    document.querySelectorAll('.favorites-rooms-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            const isActive = this.getAttribute('data-active') === 'true';
            
            // –ö–Ω–æ–ø–∫–∞ "–õ—é–±–æ–µ" - —Å–Ω–∏–º–∞–µ—Ç –≤—Å–µ –≤—ã–±–æ—Ä—ã
            if (value === '') {
                if (!isActive) {
                    // –°–Ω–∏–º–∞–µ–º –≤—Å–µ –≤—ã–±–æ—Ä—ã
                    document.querySelectorAll('.favorites-rooms-filter-btn').forEach(b => {
                        b.setAttribute('data-active', 'false');
                    });
                    this.setAttribute('data-active', 'true');
                    favoritesRoomsFilter = [];
                }
            } else {
                // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ - toggle
                if (isActive) {
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–±–æ—Ä
                    this.setAttribute('data-active', 'false');
                    favoritesRoomsFilter = favoritesRoomsFilter.filter(v => v !== value);
                } else {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä
                    this.setAttribute('data-active', 'true');
                    if (!favoritesRoomsFilter.includes(value)) {
                        favoritesRoomsFilter.push(value);
                    }
                    // –°–Ω–∏–º–∞–µ–º "–õ—é–±–æ–µ", –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ–ø—Ü–∏—è
                    const anyBtn = document.querySelector('.favorites-rooms-filter-btn[data-value=""]');
                    if (anyBtn) {
                        anyBtn.setAttribute('data-active', 'false');
                    }
                }
            }
            
            if (allFavoriteItems.length > 0) {
                const filtered = applyFavoritesFilters(allFavoriteItems);
                renderFavorites(filtered);
            }
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—ã —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
    function formatPriceInput(value) {
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
        const numbers = value.replace(/\D/g, '');
        if (!numbers) return '';
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —Ç—ã—Å—è—á
        return numbers.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∏—Å–ª–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    function getPriceNumber(value) {
        return value.replace(/\s/g, '').trim();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª–µ–π —ç—Ç–∞–∂–∞
    const floorFrom = document.getElementById('favorites-floor-from');
    const floorTo = document.getElementById('favorites-floor-to');
    
    if (floorFrom) {
        floorFrom.addEventListener('input', function() {
            favoritesFloorFrom = this.value.trim();
            if (allFavoriteItems.length > 0) {
                const filtered = applyFavoritesFilters(allFavoriteItems);
                renderFavorites(filtered);
            }
        });
    }
    
    if (floorTo) {
        floorTo.addEventListener('input', function() {
            favoritesFloorTo = this.value.trim();
            if (allFavoriteItems.length > 0) {
                const filtered = applyFavoritesFilters(allFavoriteItems);
                renderFavorites(filtered);
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª–µ–π —Ü–µ–Ω—ã
    const priceFrom = document.getElementById('favorites-price-from');
    const priceTo = document.getElementById('favorites-price-to');
    
    if (priceFrom) {
        priceFrom.addEventListener('input', function(e) {
            const cursorPosition = this.selectionStart;
            const oldValue = this.value;
            const oldLength = oldValue.length;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            const formatted = formatPriceInput(this.value);
            this.value = formatted;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
            const newLength = formatted.length;
            const lengthDiff = newLength - oldLength;
            const newPosition = Math.max(0, cursorPosition + lengthDiff);
            this.setSelectionRange(newPosition, newPosition);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            favoritesPriceFrom = getPriceNumber(formatted);
            if (allFavoriteItems.length > 0) {
                const filtered = applyFavoritesFilters(allFavoriteItems);
                renderFavorites(filtered);
            }
        });
    }
    
    if (priceTo) {
        priceTo.addEventListener('input', function(e) {
            const cursorPosition = this.selectionStart;
            const oldValue = this.value;
            const oldLength = oldValue.length;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            const formatted = formatPriceInput(this.value);
            this.value = formatted;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
            const newLength = formatted.length;
            const lengthDiff = newLength - oldLength;
            const newPosition = Math.max(0, cursorPosition + lengthDiff);
            this.setSelectionRange(newPosition, newPosition);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            favoritesPriceTo = getPriceNumber(formatted);
            if (allFavoriteItems.length > 0) {
                const filtered = applyFavoritesFilters(allFavoriteItems);
                renderFavorites(filtered);
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–µ–ª–µ–∫—Ç–∞ –ñ–ö
    const complexFilter = document.getElementById('favorites-complex-filter');
    if (complexFilter) {
        complexFilter.addEventListener('change', function() {
            favoritesComplexFilter = this.value || '';
            if (allFavoriteItems.length > 0) {
                const filtered = applyFavoritesFilters(allFavoriteItems);
                renderFavorites(filtered);
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–±—Ä–æ—Å–∏—Ç—å"
    const resetBtn = document.getElementById('favorites-reset-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
            favoritesRoomsFilter = [];
            favoritesFloorFrom = '';
            favoritesFloorTo = '';
            favoritesPriceFrom = '';
            favoritesPriceTo = '';
            favoritesComplexFilter = '';
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI –∫–Ω–æ–ø–æ–∫ –∫–æ–º–Ω–∞—Ç - —Ç–æ–ª—å–∫–æ "–õ—é–±–æ–µ" –∞–∫—Ç–∏–≤–Ω–∞
            document.querySelectorAll('.favorites-rooms-filter-btn').forEach(b => {
                b.setAttribute('data-active', b.getAttribute('data-value') === '' ? 'true' : 'false');
            });
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
            if (floorFrom) floorFrom.value = '';
            if (floorTo) floorTo.value = '';
            if (priceFrom) priceFrom.value = '';
            if (priceTo) priceTo.value = '';
            if (complexFilter) complexFilter.value = '';
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã (–ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ)
            if (allFavoriteItems.length > 0) {
                const filtered = applyFavoritesFilters(allFavoriteItems);
                renderFavorites(filtered);
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å"
    const applyBtn = document.getElementById('favorites-apply-btn');
    if (applyBtn) {
        applyBtn.addEventListener('click', function() {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            if (allFavoriteItems.length > 0) {
                const filtered = applyFavoritesFilters(allFavoriteItems);
                renderFavorites(filtered);
            }
        });
    }
}

function findApartmentInComplex(complexData, apartmentId) {
    console.log('üîç [FAVORITES] findApartmentInComplex –≤—ã–∑–≤–∞–Ω–∞:', { 
        apartmentId, 
        apartmentIdType: typeof apartmentId,
        hasComplexData: !!complexData,
        hasApartmentTypes: !!complexData?.apartment_types
    });
    
    if (!complexData || !apartmentId) {
        console.warn('‚ùå [FAVORITES] findApartmentInComplex: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ', { complexData: !!complexData, apartmentId });
        return null;
    }
    
    // –ò—â–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ apartment_types
    const apartmentTypes = complexData.apartment_types || {};
    console.log('üìã [FAVORITES] –¢–∏–ø—ã –∫–≤–∞—Ä—Ç–∏—Ä –≤ –ñ–ö:', Object.keys(apartmentTypes));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã ID –∫–≤–∞—Ä—Ç–∏—Ä—ã
    // –§–æ—Ä–º–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å: "1_0" (type_index), "68f08089b02e8b1ca002f26b_1_0", –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ "_id"
    const apartmentIdStr = String(apartmentId);
    const complexIdStr = String(complexData.id || '');
    
    console.log('üîç [FAVORITES] –ü–∞—Ä—Å–∏–Ω–≥ ID –∫–≤–∞—Ä—Ç–∏—Ä—ã:', { apartmentIdStr, complexIdStr });
    
    // –ï—Å–ª–∏ ID —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è, —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
    const parts = apartmentIdStr.split('_');
    let searchType = null;
    let searchIndex = null;
    
    if (parts.length >= 2) {
        // –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–≤–µ —á–∞—Å—Ç–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Ç–∏–ø –∏ –∏–Ω–¥–µ–∫—Å
        searchIndex = parseInt(parts[parts.length - 1], 10);
        searchType = parts[parts.length - 2];
        console.log('üîç [FAVORITES] –†–∞–∑–±–∏—Ç ID –Ω–∞ —á–∞—Å—Ç–∏:', { parts, searchType, searchIndex });
    }
    
    let checkedCount = 0;
    for (const aptType in apartmentTypes) {
        const apartments = apartmentTypes[aptType].apartments || [];
        console.log(`üìã [FAVORITES] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø "${aptType}": ${apartments.length} –∫–≤–∞—Ä—Ç–∏—Ä`);
        
        for (let idx = 0; idx < apartments.length; idx++) {
            const apt = apartments[idx];
            checkedCount++;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã ID
            const aptId = apt._id ? String(apt._id) : null;
            const aptIdField = apt.id ? String(apt.id) : null;
            const generatedId = `${complexIdStr}_${aptType}_${idx}`;
            const typeIndexId = `${aptType}_${idx}`;
            
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ ID
            if (aptId && (aptId === apartmentIdStr || aptId.endsWith(apartmentIdStr))) {
                console.log(`‚úÖ [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ apt._id:`, { aptId, apartmentIdStr, aptType, idx });
                return { apartment: apt, apartmentType: aptType };
            }
            
            if (aptIdField && (aptIdField === apartmentIdStr || aptIdField.endsWith(apartmentIdStr))) {
                console.log(`‚úÖ [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ apt.id:`, { aptIdField, apartmentIdStr, aptType, idx });
                return { apartment: apt, apartmentType: aptType };
            }
            
            if (generatedId === apartmentIdStr || generatedId.endsWith(`_${apartmentIdStr}`)) {
                console.log(`‚úÖ [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ generatedId:`, { generatedId, apartmentIdStr, aptType, idx });
                return { apartment: apt, apartmentType: aptType };
            }
            
            if (typeIndexId === apartmentIdStr) {
                console.log(`‚úÖ [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ typeIndexId:`, { typeIndexId, apartmentIdStr, aptType, idx });
                return { apartment: apt, apartmentType: aptType };
            }
            
            // –ï—Å–ª–∏ ID —Ä–∞–∑–±–∏—Ç –Ω–∞ —á–∞—Å—Ç–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Ç–∏–ø—É –∏ –∏–Ω–¥–µ–∫—Å—É
            if (searchType && searchIndex !== null && searchType === aptType && searchIndex === idx) {
                console.log(`‚úÖ [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ —Ç–∏–ø—É –∏ –∏–Ω–¥–µ–∫—Å—É:`, { searchType, searchIndex, aptType, idx });
                return { apartment: apt, apartmentType: aptType };
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ —Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å (–µ—Å–ª–∏ —Ç–∏–ø –Ω–µ —É–∫–∞–∑–∞–Ω)
            if (searchIndex !== null && searchIndex === idx && !searchType) {
                console.log(`‚úÖ [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É:`, { searchIndex, idx, aptType });
                return { apartment: apt, apartmentType: aptType };
            }
        }
    }
    
    console.warn(`‚ùå [FAVORITES] –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ ${checkedCount} –∫–≤–∞—Ä—Ç–∏—Ä:`, { 
        apartmentIdStr, 
        complexIdStr,
        apartmentTypesKeys: Object.keys(apartmentTypes)
    });
    return null;
}

function renderFavoriteCard(item) {
    if (item.type === 'complex') {
        const complex = item.data;
        const photos = complex.photos && complex.photos.length > 0 ? complex.photos : ['/static/images/placeholder.png'];
        const name = complex.name || '–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å';
        const address = complex.address || '';
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
        let galleryHtml = '';
        if (photos.length > 0) {
            galleryHtml = photos.map((photo, idx) => `
                <img src="${photo}" 
                     alt="${escapeHtml(name)}" 
                     class="gallery-image" 
                     style="display: ${idx === 0 ? 'block' : 'none'};"
                     onerror="this.src='/static/images/placeholder.png'">
            `).join('');
            
            if (photos.length > 1) {
                galleryHtml += `
                    <button class="gallery-nav gallery-prev" onclick="event.stopPropagation(); changeFavImage(this, -1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="gallery-nav gallery-next" onclick="event.stopPropagation(); changeFavImage(this, 1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="gallery-dots">
                        ${photos.map((_, idx) => `<span class="dot ${idx === 0 ? 'active' : ''}" onclick="event.stopPropagation(); setFavImage(this, ${idx})"></span>`).join('')}
                    </div>
                `;
            }
        }
        
        return `
            <div class="favorite-card" onclick="window.open('/complex/${item.id}/', '_blank');">
                <div class="favorite-card-gallery">
                    ${galleryHtml}
                </div>
                <div class="favorite-card-content">
                    <h3 class="favorite-card-title">${escapeHtml(name)}</h3>
                    ${address ? `
                        <div class="favorite-card-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${escapeHtml(address)}</span>
                        </div>
                    ` : ''}
                    <div class="favorite-card-actions">
                        <button class="favorite-card-link" onclick="event.stopPropagation(); window.open('/complex/${item.id}/', '_blank');">
                            <i class="fas fa-eye"></i>
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        <button class="favorite-card-remove" onclick="event.stopPropagation(); removeComplexFromFavorites('${item.id}'); loadFavorites(); updateFavoritesCount(); updateClearFavoritesBtnVisibility();">
                            <i class="far fa-trash-alt"></i>
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else if (item.type === 'apartment') {
        const apt = item.apartment;
        const complex = item.complexData;
        const complexName = complex.name || '–ñ–∏–ª–æ–π –∫–æ–º–ø–ª–µ–∫—Å';
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä—ã
        let photos = [];
        if (apt.layout_photos && Array.isArray(apt.layout_photos) && apt.layout_photos.length > 0) {
            photos = apt.layout_photos;
        } else if (apt.photos && Array.isArray(apt.photos) && apt.photos.length > 0) {
            photos = apt.photos;
        } else if (apt.image) {
            if (Array.isArray(apt.image) && apt.image.length > 0) {
                photos = apt.image;
            } else if (typeof apt.image === 'string') {
                photos = [apt.image];
            }
        }
        if (photos.length === 0) {
            photos = ['/static/images/placeholder.png'];
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        let title = apt.title || '';
        if (!title && apt.rooms) {
            const roomsStr = String(apt.rooms).toLowerCase();
            if (roomsStr === '—Å—Ç—É–¥–∏—è' || roomsStr === 'studio' || roomsStr === '0') {
                title = '–°—Ç—É–¥–∏—è';
            } else {
                title = `${apt.rooms}-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞`;
            }
            if (apt.area) {
                title += `, ${apt.area} –º¬≤`;
            }
        } else if (!title && apt.area) {
            title = `–ö–≤–∞—Ä—Ç–∏—Ä–∞, ${apt.area} –º¬≤`;
        } else if (!title) {
            title = '–ö–≤–∞—Ä—Ç–∏—Ä–∞';
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É
        const price = apt.price || '';
        
        // –¶–µ–Ω–∞ –∑–∞ –º¬≤
        let pricePerSqm = '';
        if (apt.formatted_price_per_sqm) {
            pricePerSqm = apt.formatted_price_per_sqm;
        } else if (apt.price_per_square) {
            pricePerSqm = apt.price_per_square;
        } else if (apt.pricePerSqm) {
            pricePerSqm = Math.round(apt.pricePerSqm).toLocaleString('ru-RU') + ' ‚ÇΩ/–º¬≤';
        }
        
        // –ü–ª–æ—â–∞–¥—å
        const area = apt.area || apt.totalArea || '';
        
        // –≠—Ç–∞–∂ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è
        let floor = apt.floor || apt.floorMin || '';
        if (!floor && apt.floorMin !== undefined) {
            floor = apt.floorMin;
            if (apt.floorMax && apt.floorMax !== apt.floorMin) {
                floor = `${apt.floorMin}-${apt.floorMax}`;
            }
        }
        
        // –°—Ä–æ–∫ —Å–¥–∞—á–∏ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è
        const completionDate = apt.completion_date || apt.completionDate || apt.delivery_date || apt.deliveryDate || complex.completion_date || '';
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏
        let galleryHtml = '';
        if (photos.length > 0) {
            galleryHtml = photos.map((photo, idx) => `
                <img src="${photo}" 
                     alt="${escapeHtml(title)}" 
                     class="gallery-image" 
                     style="display: ${idx === 0 ? 'block' : 'none'};"
                     onerror="this.src='/static/images/placeholder.png'">
            `).join('');
            
            if (photos.length > 1) {
                galleryHtml += `
                    <button class="gallery-nav gallery-prev" onclick="event.stopPropagation(); changeFavImage(this, -1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="gallery-nav gallery-next" onclick="event.stopPropagation(); changeFavImage(this, 1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="gallery-dots">
                        ${photos.map((_, idx) => `<span class="dot ${idx === 0 ? 'active' : ''}" onclick="event.stopPropagation(); setFavImage(this, ${idx})"></span>`).join('')}
                    </div>
                `;
            }
        }
        
        // –î–µ—Ç–∞–ª–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã
        let detailsHtml = '';
        if (area || floor || completionDate) {
            detailsHtml = '<div class="favorite-card-details">';
            if (area) {
                detailsHtml += `
                    <div class="favorite-card-detail-item">
                        <span class="detail-label">–ü–ª–æ—â–∞–¥—å</span>
                        <span class="detail-value">${escapeHtml(String(area))} –º¬≤</span>
                    </div>
                `;
            }
            if (floor) {
                detailsHtml += `
                    <div class="favorite-card-detail-item">
                        <span class="detail-label">–≠—Ç–∞–∂</span>
                        <span class="detail-value">${escapeHtml(String(floor))}</span>
                    </div>
                `;
            }
            if (completionDate) {
                detailsHtml += `
                    <div class="favorite-card-detail-item" style="grid-column: span 2;">
                        <span class="detail-label">–°—Ä–æ–∫ —Å–¥–∞—á–∏</span>
                        <span class="detail-value">${escapeHtml(String(completionDate))}</span>
                    </div>
                `;
            }
            detailsHtml += '</div>';
        }
        
        return `
            <div class="favorite-card" onclick="window.open('/apartment/${item.complexId}/${item.apartmentId}/?from=favorites', '_blank');">
                <div class="favorite-card-gallery">
                    ${galleryHtml}
                </div>
                <div class="favorite-card-content">
                    <h3 class="favorite-card-title">${escapeHtml(title)}</h3>
                    <div class="favorite-card-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${escapeHtml(complexName)}</span>
                    </div>
                    ${price ? `<div class="favorite-card-price">${escapeHtml(formatPrice(price))}</div>` : ''}
                    ${pricePerSqm ? `<div class="favorite-card-price-per-m">${escapeHtml(pricePerSqm)}</div>` : ''}
                    ${detailsHtml}
                    <div class="favorite-card-actions">
                        <button class="favorite-card-link" onclick="event.stopPropagation(); window.open('/apartment/${item.complexId}/${item.apartmentId}/?from=favorites', '_blank');">
                            <i class="fas fa-eye"></i>
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </button>
                        <button class="favorite-card-remove" onclick="event.stopPropagation(); removeApartmentFromFavorites('${item.complexId}', '${item.apartmentId}'); loadFavorites(); updateFavoritesCount(); updateClearFavoritesBtnVisibility();">
                            <i class="far fa-trash-alt"></i>
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    return '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function changeFavImage(btn, direction) {
    const gallery = btn.closest('.favorite-card-gallery');
    const images = gallery.querySelectorAll('.gallery-image');
    const dots = gallery.querySelectorAll('.dot');
    
    let currentIndex = 0;
    images.forEach((img, idx) => {
        if (img.style.display !== 'none') {
            currentIndex = idx;
        }
    });
    
    let newIndex = currentIndex + direction;
    if (newIndex < 0) newIndex = images.length - 1;
    if (newIndex >= images.length) newIndex = 0;
    
    images.forEach((img, idx) => {
        img.style.display = idx === newIndex ? 'block' : 'none';
    });
    
    dots.forEach((dot, idx) => {
        dot.classList.toggle('active', idx === newIndex);
    });
}

function setFavImage(dot, index) {
    const gallery = dot.closest('.favorite-card-gallery');
    const images = gallery.querySelectorAll('.gallery-image');
    const dots = gallery.querySelectorAll('.dot');
    
    images.forEach((img, idx) => {
        img.style.display = idx === index ? 'block' : 'none';
    });
    
    dots.forEach((d, idx) => {
        d.classList.toggle('active', idx === index);
    });
}

function formatPrice(price) {
    if (!price) return '';
    let priceStr = String(price).trim();
    priceStr = priceStr.replace(/‚ÇΩ/g, '').replace(/—Ä—É–±/g, '').trim();
    const priceClean = priceStr.replace(/\s/g, '').replace(/,/g, '').replace(/\./g, '').trim();
    if (!/^\d+$/.test(priceClean)) return priceStr;
    try {
        const priceNum = parseFloat(priceStr.replace(/\s/g, '').replace(/,/g, '.').trim());
        if (priceNum <= 0) return '';
        const formatted = priceNum.toLocaleString('ru-RU', {maximumFractionDigits: 0});
        return `${formatted} ‚ÇΩ`;
    } catch (e) {
        return priceStr;
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è
document.addEventListener('DOMContentLoaded', function() {
    const shareBtn = document.getElementById('share-favorites-btn');
    const shareModal = document.getElementById('share-modal');
    const shareModalClose = document.getElementById('share-modal-close');
    const copyBtn = document.getElementById('copy-link-btn');
    const shareLinkInput = document.getElementById('share-link-input');
    const copySuccessMessage = document.getElementById('copy-success-message');
    
    if (shareBtn) {
        shareBtn.addEventListener('click', async function() {
            const favorites = getFavorites();
            const allIds = [...favorites.complexes, ...favorites.apartments];
            
            if (allIds.length === 0) {
                alert('–î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ–¥–±–æ—Ä–∫–æ–π');
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏
            const complexes = [];
            const apartmentMap = {};
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã –ø–æ –ñ–ö
            favorites.apartments.forEach(fullId => {
                const parts = fullId.split('_');
                if (parts.length >= 2) {
                    const complexId = parts[0];
                    const apartmentId = parts.slice(1).join('_');
                    if (!apartmentMap[complexId]) {
                        apartmentMap[complexId] = [];
                    }
                    apartmentMap[complexId].push(apartmentId);
                }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ñ–ö —Å –∫–≤–∞—Ä—Ç–∏—Ä–∞–º–∏
            Object.keys(apartmentMap).forEach(complexId => {
                complexes.push({
                    complex_id: complexId,
                    apartment_ids: apartmentMap[complexId]
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ñ–ö –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–≤–∞—Ä—Ç–∏—Ä
            favorites.complexes.forEach(complexId => {
                if (!apartmentMap[complexId]) {
                    complexes.push({
                        complex_id: complexId,
                        apartment_ids: []
                    });
                }
            });
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–±–æ—Ä–∫—É
                const response = await fetch('/api/apartment-selections/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: '–ü–æ–¥–±–æ—Ä–∫–∞ –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ',
                        complexes: complexes
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.selection_id) {
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ—Ä–æ—Ç–∫—É—é —Å—Å—ã–ª–∫—É
                    const shortLink = `${window.location.origin}/selection/${result.selection_id}/`;
                    shareLinkInput.value = shortLink;
                    shareModal.style.display = 'flex';
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (shareModalClose) {
        shareModalClose.addEventListener('click', function() {
            shareModal.style.display = 'none';
            copySuccessMessage.style.display = 'none';
        });
    }
    
    if (shareModal) {
        shareModal.addEventListener('click', function(e) {
            if (e.target === shareModal || e.target.classList.contains('share-modal-overlay')) {
                shareModal.style.display = 'none';
                copySuccessMessage.style.display = 'none';
            }
        });
    }
    
    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
    if (copyBtn) {
        copyBtn.addEventListener('click', function() {
            shareLinkInput.select();
            shareLinkInput.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            
            try {
                document.execCommand('copy');
                copySuccessMessage.style.display = 'flex';
                setTimeout(() => {
                    copySuccessMessage.style.display = 'none';
                }, 3000);
            } catch (err) {
                // Fallback –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                navigator.clipboard.writeText(shareLinkInput.value).then(() => {
                    copySuccessMessage.style.display = 'flex';
                    setTimeout(() => {
                        copySuccessMessage.style.display = 'none';
                    }, 3000);
                }).catch(() => {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.');
                });
            }
        });
    }
});
</script>
{% endblock %}


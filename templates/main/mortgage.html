{% extends 'base.html' %}

{% block title %}Ипотека - CENTURY 21{% endblock %}

{% block content %}

<style>
/* Галерея фото в карточках ипотеки - точно как в каталоге */
.compact-card-image-gallery {
  position: relative;
  width: 100%;
  height: 240px;
  overflow: hidden;
  border-radius: 12px 12px 0 0;
}

.compact-card-image-gallery .gallery-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: opacity 0.3s ease;
}

.gallery-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 0, 0, 0.6);
  color: white;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  z-index: 10;
  opacity: 0;
}

.compact-card-image-gallery:hover .gallery-nav {
  opacity: 1;
}

.gallery-nav:hover {
  background: rgba(0, 0, 0, 0.8);
  transform: translateY(-50%) scale(1.1);
}

.gallery-prev {
  left: 10px;
}

.gallery-next {
  right: 10px;
}

.gallery-dots {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  z-index: 10;
}

.gallery-dots .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  transition: all 0.3s ease;
}

.gallery-dots .dot.active {
  background: rgba(255, 255, 255, 1);
  width: 24px;
  border-radius: 4px;
}

/* Адаптация галереи для мобильных */
@media (max-width: 768px) {
  .compact-card-image-gallery { 
    height: 180px; 
    border-radius: 10px 10px 0 0;
  }
  .gallery-nav { 
    opacity: 1; 
    width: 30px; 
    height: 30px; 
  }
  .gallery-nav i {
    font-size: 14px;
  }
  .gallery-prev { left: 8px; }
  .gallery-next { right: 8px; }
  .gallery-dots { bottom: 8px; gap: 4px; }
  .gallery-dots .dot {
    width: 6px;
    height: 6px;
  }
  .gallery-dots .dot.active {
    width: 18px;
  }
}

@media (max-width: 480px) {
  .compact-card-image-gallery { 
    height: 160px; 
  }
  .gallery-nav { 
    width: 28px; 
    height: 28px; 
  }
}
</style>
<div class="container mortgage-page">
    <!-- Заголовок страницы -->
    <section class="page-header">
        <div class="page-header-background">
            <img src="/media/uploads/ipoteka.jpg" alt="Ипотека" class="page-header-image">
            <div class="page-header-overlay"></div>
        </div>
        <div class="page-header-content">
            <h1 class="page-title">Ипотека</h1>
            <p class="page-subtitle">Получите выгодные условия ипотечного кредитования от ведущих банков России</p>
        </div>
    </section>

        <!-- Калькулятор ипотеки (новый дизайн) -->
    <div class="mortgage-section" id="mortgage">
        <div class="mortgage-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="mortgage-card" style="padding:20px 22px;">
                <h2 class="mortgage-title" style="margin-bottom:10px;">Ипотека онлайн <span style="color:#bfa760">*</span></h2>
                <!-- Скрытое поле с базовой ставкой -->
                <input id="mp-rate-fixed" type="hidden" value="{% if mortgage_programs %}{{ mortgage_programs.first.rate }}{% else %}11.4{% endif %}" />
                <div class="select-wrap" style="margin-top:6px;">
                    <label class="mortgage-label" style="display:block;margin-bottom:6px;">Тип программы</label>
                    <div class="select-box" style="position:relative;">
                        <select id="mp-program" class="mortgage-select" style="height:44px; padding-right:36px;">
                            {% for p in mortgage_programs %}
                            <option value="{{ p.rate }}" data-individual="{{ p.is_individual }}" data-complexes="{{ p.complexes|join:',' }}">{{ p.name }}{% if p.is_individual %} (индивидуальная){% endif %}</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-chevron-down" style="position:absolute; right:12px; top:50%; transform:translateY(-50%); color:#b8af95;"></i>
                    </div>
                </div>
                <div class="slider-block" style="margin-top:8px;">
                    <label class="mortgage-label" style="display:block;margin-bottom:6px;">Стоимость недвижимости</label>
                    <div class="inline-controls" style="margin-bottom:6px;">
                        <input id="mp-price-input" class="mini-input wide" type="text" inputmode="numeric" value="5 000 000"/>
                    </div>
                    <input id="mp-price" class="c21-range" type="range" min="800000" max="87500000" step="50000" value="5000000"/>
                </div>
                <div class="slider-block">
                    <label class="mortgage-label" style="display:block;margin-bottom:6px;">Первоначальный взнос</label>
                    <div class="inline-controls" style="margin-bottom:6px;">
                        <input id="mp-down-amt-input" class="mini-input wide" type="text" inputmode="numeric" value="1 000 000"/>
                    </div>
                    <div style="position:relative;">
                        <input id="mp-down" class="c21-range" type="range" min="10" max="80" step="1" value="20"/>
                        <span id="mp-down-pct-view" style="position:absolute; right:8px; top:-4px; color:#9a8f73; font-weight:700;">20%</span>
                    </div>
                </div>
                <div class="slider-block">
                    <label class="mortgage-label" style="display:block;margin-bottom:6px;">Срок кредита</label>
                    <div class="inline-controls" style="margin-bottom:6px;">
                        <input id="mp-years-input" class="mini-input narrow" type="number" min="3" max="30" step="1" value="30"/>
                    </div>
                    <input id="mp-years" class="c21-range" type="range" min="3" max="30" step="1" value="30"/>
                </div>
            </div>
            <div class="mortgage-card summary" style="padding:20px 22px;">
                <div class="summary-title" style="font-size:22px;">Одна заявка во все банки</div>
                <div class="summary-main" style="border-top:none;">
                    <span style="color:#666;">Ежемесячный платёж</span>
                    <span id="mp-month" class="summary-amount">—</span>
                </div>
                <div class="summary-row"><span>Процентная ставка</span><strong id="mp-rate-text" style="font-weight:500;">{% if mortgage_programs %}от {{ mortgage_programs.first.rate }} %{% else %}от 11.4 %{% endif %}</strong></div>
                <div class="summary-row" ><span>Сумма кредита</span><strong id="mp-loan" style="font-weight:500;">—</strong></div>
                <div class="mortgage-logos">
                    <img src="/media/logo/banks.png" alt="Банки" style="height:44px; width:auto;"/>
                </div>
                <div class="summary-actions" style="text-align:left;">
                    <a href="#feedback-title" class="btn btn-primary btn-large anchor-feedback-btn" style="width:100%;">Подать заявку</a>
                </div>
                <div style="color:#888; font-size:12px; margin-top:8px;">* Расчёт примерный. Уточняйте актуальную информацию у нашего специалиста, оставив заявку</div>
            </div>
        </div>
        
        <!-- Контейнер для отображения ЖК при выборе индивидуальной программы -->
        <div id="complexes-container" style="display:none; margin-top:20px;"></div>
        
        <style>
        .mortgage-section{margin:32px 0;font-weight:500; background:#fff;border:1px solid #eee;border-radius:16px;padding:0;box-shadow:0 6px 20px rgba(0,0,0,.06)}
        .mortgage-grid{display:grid;gap:0}
        .mortgage-card{background:#fff}
        .mortgage-card + .mortgage-card{border-left:1px solid #eee}
        .mortgage-title{margin:0 0 6px 0;font-size:24px; font-weight:500; color:#222; letter-spacing:.2px}
        .mortgage-label{color:#6b6453;font-size:20px}
        .inline-controls{display:flex;align-items:center;gap:6px}
        .mini-input{padding:10px 12px;border:1px solid #e6ddc6;border-radius:10px;background:#fff;color:#222; box-shadow:0 1px 0 rgba(0,0,0,.02) inset}
        .mini-input.narrow{width:72px}
        .mini-input.wide{flex:1; min-width:0}
        .mortgage-select{width:100%;padding:10px 12px;border:1px solid #e6ddc6;border-radius:10px;background:#fff;color:#222; appearance:none}
        .c21-range{width:100%;background:transparent}
        .c21-range::-webkit-slider-runnable-track{height:4px;background:#e9e2cf;border-radius:999px}
        .c21-range::-webkit-slider-thumb{appearance:none; width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #c3ad6f;margin-top:-7px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
        .c21-range::-moz-range-track{height:4px;background:#e9e2cf;border-radius:999px}
        .c21-range::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:#fff;border:3px solid #c3ad6f;box-shadow:0 1px 2px rgba(0,0,0,.05)}
        .summary-amount{font-size:28px;color:#222}
        .summary-main{padding:10px 0 16px 0}
        .summary-row{display:flex;justify-content:space-between;padding:14px 0;border-top:1px solid #f0f0f0}
        .mortgage-logos{display:flex;align-items:center;gap:22px;flex-wrap:wrap;margin:16px 0 16px 0}
        .summary-actions{margin-top:auto}
        @media (max-width: 900px){.mortgage-grid{grid-template-columns:1fr}.mortgage-card + .mortgage-card{border-left:none;border-top:1px solid #eee}}
        /* tighter gap between field and slider, and full-width controls */
        .slider-block .inline-controls{width:100%; margin-bottom:0}
        .slider-block .c21-range{margin-top:-12px}
        /* summary card fills height, no empty space at bottom */
        .mortgage-card.summary{display:flex; flex-direction:column}
        </style>
    </div>

    <!-- Ипотека с нами -->
    <section class="mortgage-with-us-section">
        <div class="section-header">
            <h2 class="section-title">Ипотека с нами</h2>
            <p class="section-subtitle">Почему стоит обратиться к профессионалам</p>
        </div>
        
                 <div class="benefits-grid">
             <div class="benefit-card">
                 <div class="benefit-icon">
                     <i class="fas fa-clock"></i>
                 </div>
                 <h3 class="benefit-title">Оперативно и без стресса</h3>
                 <p class="benefit-description">Экономим ваше время и берём на себя всю коммуникацию с банками и страховыми компаниями. Вы получаете готовое решение без лишних хлопот.</p>
             </div>
             
             <div class="benefit-card">
                 <div class="benefit-icon">
                     <i class="fas fa-search-dollar"></i>
                 </div>
                 <h3 class="benefit-title">Найдём лучшее предложение</h3>
                 <p class="benefit-description">Мы делаем запрос сразу в несколько банков и отбираем самые выгодные условия с учётом вашей конкретной ситуации и возможностей.</p>
             </div>
             
             <div class="benefit-card">
                 <div class="benefit-icon">
                     <i class="fas fa-shield-alt"></i>
                 </div>
                 <h3 class="benefit-title">Без скрытых платежей</h3>
                 <p class="benefit-description">Тщательно изучаем предложения банков на предмет скрытых комиссий и дополнительных платежей. Вы знаете полную стоимость кредита.</p>
             </div>
             
             <div class="benefit-card">
                 <div class="benefit-icon">
                     <i class="fas fa-handshake"></i>
                 </div>
                 <h3 class="benefit-title">Привилегии для клиентов</h3>
                 <p class="benefit-description">Наши клиенты могут пользоваться специальными условиями от партнёрских банков и страховых компаний, недоступными при самостоятельном обращении.</p>
             </div>
             
             <div class="benefit-card">
                 <div class="benefit-icon">
                     <i class="fas fa-user-tie"></i>
                 </div>
                 <h3 class="benefit-title">Персональный менеджер</h3>
                 <p class="benefit-description">За вами закрепляется персональный менеджер, который сопровождает весь процесс от подачи заявки до получения кредита и всегда на связи.</p>
             </div>
             
             <div class="benefit-card">
                 <div class="benefit-icon">
                     <i class="fas fa-chart-line"></i>
                 </div>
                 <h3 class="benefit-title">Анализ рынка</h3>
                 <p class="benefit-description">Постоянно отслеживаем изменения на ипотечном рынке и изменения в программах банков, чтобы предложить вам самые актуальные условия.</p>
             </div>
         </div>
    </section>

    <!-- Самостоятельная ипотека -->
    <section class="self-mortgage-section">
        <div class="section-header">
            <h2 class="section-title">Самостоятельная ипотека</h2>
            <p class="section-subtitle">Почему не стоит делать это самостоятельно</p>
        </div>
        
                 <div class="disadvantages-grid">
             <div class="disadvantage-card">
                 <div class="disadvantage-icon">
                     <i class="fas fa-hourglass-half"></i>
                 </div>
                 <h3 class="disadvantage-title">Долго и утомительно</h3>
                 <p class="disadvantage-description">Самостоятельный поиск ипотеки занимает недели и месяцы. Приходится обходить десятки банков, собирать документы многократно.</p>
             </div>
             
             <div class="disadvantage-card">
                 <div class="disadvantage-icon">
                     <i class="fas fa-exclamation-triangle"></i>
                 </div>
                 <h3 class="disadvantage-title">Риск отказа</h3>
                 <p class="disadvantage-description">Без опыта легко получить отказ в банке. Каждый отказ портит кредитную историю и снижает шансы на одобрение в других банках.</p>
             </div>
             
             <div class="disadvantage-card">
                 <div class="disadvantage-icon">
                     <i class="fas fa-coins"></i>
                 </div>
                 <h3 class="disadvantage-title">Переплата</h3>
                 <p class="disadvantage-description">Не зная всех нюансов, можно выбрать не самую выгодную программу и переплатить сотни тысяч рублей за весь срок кредита.</p>
             </div>
             
             <div class="disadvantage-card">
                 <div class="disadvantage-icon">
                     <i class="fas fa-file-contract"></i>
                 </div>
                 <h3 class="disadvantage-title">Сложность документов</h3>
                 <p class="disadvantage-description">Банки требуют множество документов, и каждый может иметь свои особенности. Ошибка в документах ведёт к задержкам и отказам.</p>
             </div>
             
             <div class="disadvantage-card">
                 <div class="disadvantage-icon">
                     <i class="fas fa-times-circle"></i>
                 </div>
                 <h3 class="disadvantage-title">Отсутствие поддержки</h3>
                 <p class="disadvantage-description">При самостоятельном обращении вы остаётесь один на один с банком. Никто не поможет разобраться в сложных вопросах и не защитит ваши интересы.</p>
             </div>
             
             <div class="disadvantage-card">
                 <div class="disadvantage-icon">
                     <i class="fas fa-calendar-times"></i>
                 </div>
                 <h3 class="disadvantage-title">Потеря времени</h3>
                 <p class="disadvantage-description">Самостоятельное изучение всех программ, условий и требований банков отнимает огромное количество времени, которое можно потратить на более важные дела.</p>
             </div>
         </div>
    </section>

</div>

<style>
/* Стили для страницы ипотеки */
.page-header {
    position: relative;
    padding: 80px 0 60px;
    margin-bottom: 60px;
    border-radius: 0 0 30px 30px;
    overflow: hidden;
}

.page-header-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
}

.page-header-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
}

.page-header-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(26, 26, 26, 0.7) 0%, rgba(51, 51, 51, 0.5) 100%);
    z-index: 2;
}

.page-header-content {
    position: relative;
    z-index: 3;
    text-align: center;
    max-width: 800px;
    margin: 0 auto;
}

.page-title {
    font-size: 48px;
    font-weight: 800;
    color: #ffffff;
    margin: 0 0 20px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.page-subtitle {
    font-size: 20px;
    color: #ffffff;
    margin: 0;
    line-height: 1.6;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}



/* Секции с преимуществами и недостатками */
.mortgage-with-us-section,
.self-mortgage-section {
    margin-bottom: 80px;
}

/* Форма обратной связи на странице ипотеки */
.mortgage-page .feedback-section {
    margin: 30px 0 100px 0;
}

@media (max-width: 1200px) {
    .mortgage-page .feedback-section {
        margin: 25px 0 80px 0;
    }
}

@media (max-width: 768px) {
    .mortgage-page .feedback-section {
        margin: 20px 0 60px 0;
    }
}

@media (max-width: 600px) {
    .mortgage-page .feedback-section {
        margin: 15px 0 50px 0;
    }
}

.section-header {
    text-align: center;
    margin-bottom: 50px;
}

.section-title {
    font-size: 36px;
    font-weight: 800;
    color: #1a1a1a;
    margin: 0 0 15px 0;
}

.section-subtitle {
    font-size: 18px;
    color: #666;
    margin: 0;
}

.benefits-grid,
.disadvantages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 30px;
}

.benefit-card,
.disadvantage-card {
    background: #fff;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    border: 1px solid #f0f0f0;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.benefit-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

.disadvantage-card {
    background: linear-gradient(135deg, #fff5f5 0%, #fef2f2 100%);
    border: 1px solid #fed7d7;
}

.disadvantage-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(254, 215, 215, 0.2);
}

.benefit-icon,
.disadvantage-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    font-size: 24px;
}

.benefit-icon {
    background: linear-gradient(135deg, rgba(190, 175, 135, 0.1) 0%, rgba(161, 146, 118, 0.1) 100%);
    color: #BEAF87;
}

.disadvantage-icon {
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
    color: #ef4444;
}

.benefit-title,
.disadvantage-title {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 15px 0;
}

.benefit-title {
    color: #1a1a1a;
}

.disadvantage-title {
    color: #dc2626;
}

.benefit-description,
.disadvantage-description {
    font-size: 16px;
    line-height: 1.6;
    margin: 0;
}

.benefit-description {
    color: #666;
}

.disadvantage-description {
    color: #7f1d1d;
}

/* Адаптивность */
@media (max-width: 1024px) {
    .benefits-grid,
    .disadvantages-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }
}

@media (max-width: 768px) {
    /* Заголовок страницы */
    .page-header {
        padding: 40px 0 30px;
        margin-bottom: 32px;
        border-radius: 0 0 20px 20px;
    }
    
    .page-title {
        font-size: 32px;
    }
    
    .page-subtitle {
        font-size: 16px;
    }
    
    /* Секции */
    .section-title {
        font-size: 24px;
        margin-bottom: 20px;
    }
    
    .section-subtitle {
        font-size: 16px;
    }
    
    .section-header {
        margin-bottom: 32px;
    }
    
    /* Калькулятор ипотеки */
    .mortgage-section {
        margin: 20px 0;
        border-radius: 12px;
    }
    
    .mortgage-card {
        padding: 16px !important;
    }
    
    .mortgage-title {
        font-size: 20px !important;
    }
    
    .mortgage-label {
        font-size: 16px !important;
    }
    
    .mini-input {
        padding: 8px 10px;
        font-size: 14px;
    }
    
    .summary-title {
        font-size: 18px !important;
    }
    
    .summary-amount {
        font-size: 22px !important;
    }
    
    .mortgage-logos img {
        height: 36px !important;
    }
    
    /* Преимущества и недостатки */
    .benefits-grid,
    .disadvantages-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .benefit-card,
    .disadvantage-card {
        padding: 20px;
        border-radius: 16px;
    }
    
    .benefit-icon,
    .disadvantage-icon {
        width: 50px;
        height: 50px;
        font-size: 20px;
        margin-bottom: 16px;
    }
    
    .benefit-title,
    .disadvantage-title {
        font-size: 18px;
        margin-bottom: 12px;
    }
    
    .benefit-description,
    .disadvantage-description {
        font-size: 15px;
    }
    
    /* Секции с отступами */
    .mortgage-with-us-section,
    .self-mortgage-section {
        margin-bottom: 40px;
    }
    
    /* Контейнер с ЖК */
    #complexes-container {
        margin-top: 16px !important;
    }
    
    .complexes-section h3 {
        font-size: 20px !important;
        margin-bottom: 16px !important;
    }
}

@media (max-width: 576px) {
    /* Заголовок */
    .page-header {
        padding: 30px 0 24px;
        margin-bottom: 24px;
    }
    
    .page-title {
        font-size: 28px;
    }
    
    .page-subtitle {
        font-size: 15px;
    }
    
    /* Калькулятор */
    .mortgage-card {
        padding: 14px !important;
    }
    
    .mortgage-title {
        font-size: 18px !important;
        margin-bottom: 8px !important;
    }
    
    .mortgage-label {
        font-size: 15px !important;
    }
    
    .summary-title {
        font-size: 16px !important;
    }
    
    .summary-main {
        padding: 8px 0 12px 0 !important;
    }
    
    /* Карточки преимуществ */
    .benefit-card,
    .disadvantage-card {
        padding: 16px;
    }
    
    .benefit-icon,
    .disadvantage-icon {
        width: 45px;
        height: 45px;
        font-size: 18px;
        margin-bottom: 14px;
    }
    
    .benefit-title,
    .disadvantage-title {
        font-size: 17px;
        margin-bottom: 10px;
    }
    
    .benefit-description,
    .disadvantage-description {
        font-size: 14px;
    }
}

@media (max-width: 480px) {
    /* Заголовок */
    .page-header {
        padding: 24px 0 20px;
        margin-bottom: 20px;
        border-radius: 0 0 16px 16px;
    }
    
    .page-header-content {
        padding: 0 16px;
    }
    
    .page-title {
        font-size: 24px;
        margin-bottom: 12px;
    }
    
    .page-subtitle {
        font-size: 14px;
    }
    
    /* Секции */
    .section-title {
        font-size: 20px;
    }
    
    .section-subtitle {
        font-size: 14px;
    }
    
    .section-header {
        margin-bottom: 24px;
    }
    
    /* Калькулятор - еще более компактный */
    .mortgage-section {
        margin: 16px 0;
        padding: 0;
    }
    
    .mortgage-card {
        padding: 12px !important;
    }
    
    .mortgage-title {
        font-size: 16px !important;
    }
    
    .mortgage-label {
        font-size: 14px !important;
        margin-bottom: 4px !important;
    }
    
    .mini-input {
        height: 38px;
        padding: 6px 10px;
        font-size: 13px;
    }
    
    .mortgage-select {
        height: 38px !important;
        font-size: 13px;
    }
    
    .summary-title {
        font-size: 15px !important;
    }
    
    .summary-amount {
        font-size: 20px !important;
    }
    
    .summary-row {
        padding: 10px 0;
        font-size: 13px;
    }
    
    .summary-row strong {
        font-size: 13px;
    }
    
    .mortgage-logos {
        margin: 12px 0 !important;
    }
    
    .mortgage-logos img {
        height: 32px !important;
    }
    
    .btn-large {
        padding: 12px 20px !important;
        font-size: 14px !important;
    }
    
    /* Карточки преимуществ - максимально компактно */
    .benefits-grid,
    .disadvantages-grid {
        gap: 12px;
    }
    
    .benefit-card,
    .disadvantage-card {
        padding: 14px;
        border-radius: 12px;
    }
    
    .benefit-icon,
    .disadvantage-icon {
        width: 40px;
        height: 40px;
        font-size: 16px;
        margin-bottom: 12px;
    }
    
    .benefit-title,
    .disadvantage-title {
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .benefit-description,
    .disadvantage-description {
        font-size: 13px;
        line-height: 1.5;
    }
    
    /* Секции с отступами */
    .mortgage-with-us-section,
    .self-mortgage-section {
        margin-bottom: 32px;
    }
    
    /* Форма обратной связи */
    .mortgage-page .feedback-section {
        margin: 12px 0 40px 0;
    }
}
</style>

<script>
// Ипотечный калькулятор (обновлён под новый дизайн)
(function(){
    const baseRateEl = document.getElementById('mp-rate-fixed');
    const program = document.getElementById('mp-program');
    const price = document.getElementById('mp-price');
    const down = document.getElementById('mp-down');
    const years = document.getElementById('mp-years');
    const monthEl = document.getElementById('mp-month');
    const loanEl = document.getElementById('mp-loan');
    const rateText = document.getElementById('mp-rate-text');
    const downPctView = document.getElementById('mp-down-pct-view');
    const priceInput = document.getElementById('mp-price-input');
    const downAmtInput = document.getElementById('mp-down-amt-input');
    const yearsInput = document.getElementById('mp-years-input');
    
    function fmt(n){ 
        return new Intl.NumberFormat('ru-RU').format(Math.round(n)); 
    }
    
    function parseNum(v){ 
        return Number(String(v||'').replace(/[^\d]/g,'')) || 0; 
    }
    
    function formatInputKeepCaret(inputEl){
        const start = inputEl.selectionStart || 0;
        const leftDigits = (inputEl.value.slice(0, start).match(/\d/g) || []).length;
        const digits = inputEl.value.replace(/[^\d]/g,'');
        const formatted = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        inputEl.value = formatted;
        let pos = 0, seen = 0;
        while (pos < formatted.length && seen < leftDigits){
            if (/\d/.test(formatted.charAt(pos))) seen++;
            pos++;
        }
        inputEl.setSelectionRange(pos, pos);
    }
    
    function calc(){
        const p = priceInput ? (parseNum(priceInput.value) || Number(price.value)) : Number(price.value);
        const downPct = Number(down.value)/100;
        const rateVal = program ? Number(program.value || baseRateEl?.value || 11.4) : Number(baseRateEl?.value || 11.4);
        const rate = rateVal/100; // годовая
        const n = Number(years.value) * 12;
        const monthlyRate = rate/12;
        const firstPay = p * downPct;
        const loan = Math.max(0, p - firstPay);
        const annuity = monthlyRate ? loan * (monthlyRate * Math.pow(1+monthlyRate, n)) / (Math.pow(1+monthlyRate, n) - 1) : (n ? loan/n : 0);
        
        monthEl.textContent = fmt(annuity) + ' ₽';
        loanEl.textContent = fmt(loan) + ' ₽';
        if (rateText) rateText.textContent = 'от ' + (rateVal.toFixed(1)) + ' %';
        if (downPctView) downPctView.textContent = Math.round(downPct*100) + '%';
        if (yearsInput) yearsInput.value = Number(years.value);
    }
    
    ['change','input'].forEach(ev=>{
        program && program.addEventListener(ev, calc);
        years.addEventListener(ev, calc);
    });
    
    // Sync from range: price -> text + amount
    price.addEventListener('input', function(){
        const val = Number(price.value);
        if (priceInput){ priceInput.value = fmt(val); }
        if (downAmtInput){ downAmtInput.value = fmt(val * (Number(down.value)/100)); downAmtInput.max = String(val); }
        calc();
    });
    
    // Sync from down slider -> amount
    down.addEventListener('input', function(){
        const p = priceInput ? (parseNum(priceInput.value) || Number(price.value)) : Number(price.value);
        if (downAmtInput){ downAmtInput.value = fmt(p * (Number(down.value)/100)); }
        calc();
    });
    
    // Ручной ввод цены с живым форматированием
    if (priceInput){
        priceInput.addEventListener('input', function(){
            formatInputKeepCaret(this);
            const raw = parseNum(this.value);
            if (downAmtInput){ downAmtInput.max = String(raw); }
            calc();
        });
        priceInput.addEventListener('blur', function(){
            const min = Number(price.min), max = Number(price.max);
            let val = parseNum(this.value);
            val = Math.max(min, Math.min(max, val));
            this.value = fmt(val);
            price.value = String(val);
            if (downAmtInput){ downAmtInput.max = String(val); downAmtInput.value = fmt(val * (Number(down.value)/100)); }
            calc();
        });
    }
    
    // Ручной ввод суммы первоначального взноса с живым форматированием
    if (downAmtInput){
        downAmtInput.addEventListener('input', function(){
            formatInputKeepCaret(this);
            const p = priceInput ? (parseNum(priceInput.value) || Number(price.value)) : Number(price.value);
            let amt = parseNum(this.value);
            amt = Math.max(0, Math.min(p, amt));
            const pctRaw = p ? (amt / p) * 100 : 0;
            const pct = Math.min(80, Math.max(10, Math.round(pctRaw)));
            down.value = String(pct);
            calc();
        });
        downAmtInput.addEventListener('blur', function(){
            const p = priceInput ? (parseNum(priceInput.value) || Number(price.value)) : Number(price.value);
            let amt = parseNum(this.value);
            amt = Math.max(0, Math.min(p, amt));
            this.value = fmt(amt);
        });
    }
    
    if (yearsInput){
        yearsInput.addEventListener('input', function(){
            const min = Number(years.min), max = Number(years.max);
            let val = Number(this.value||0);
            val = Math.max(min, Math.min(max, val));
            years.value = String(val);
            calc();
        });
    }
    
    // начальная отрисовка и форматирование
    if (priceInput){ priceInput.value = fmt(Number(price.value)); }
    if (downAmtInput){ const p0 = Number(price.value); downAmtInput.value = fmt(p0 * (Number(down.value)/100)); downAmtInput.max = String(p0); }
    calc();
    
    // Обработка выбора индивидуальной программы
    const programSelect = document.getElementById('mp-program');
    const complexesContainer = document.getElementById('complexes-container');
    
    if (programSelect && complexesContainer) {
        programSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const isIndividual = selectedOption.dataset.individual === 'True';
            const complexes = selectedOption.dataset.complexes;
            
            if (isIndividual && complexes) {
                // Показываем ЖК для индивидуальной программы
                showComplexesForProgram(complexes);
            } else {
                // Скрываем контейнер с ЖК
                complexesContainer.style.display = 'none';
            }
        });
    }
    
    function showComplexesForProgram(complexesString) {
        if (!complexesString) return;
        
        const complexIds = complexesString.split(',').filter(id => id.trim());
        if (complexIds.length === 0) return;
        
        // Загружаем данные ЖК через AJAX
        fetch('/api/mortgage-programs/complexes/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const selectedComplexes = data.complexes.filter(complex => 
                        complexIds.includes(complex._id) && 
                        complex.rating && 
                        complex.rating >= 4
                    );
                    
                    if (selectedComplexes.length > 0) {
                        let html = '<div class="complexes-section" style="margin-top:30px;">';
                        html += '<h3 style="margin-bottom:20px; color:#333; font-size:24px; font-weight:500;">Доступно в ЖК с рейтингом 4+ звезд:</h3>';
                        html += '<div class="catalog-grid" style="margin-top:20px;">';
                        
                        selectedComplexes.forEach(complex => {
                            // Получаем изображения из базы данных как в каталоге
                            let photos = [];
                            if (complex.photos && complex.photos.length > 0) {
                                photos = complex.photos.map(photo => {
                                    // Если фото уже содержит полный URL, используем как есть
                                    if (photo.startsWith('http')) {
                                        return photo;
                                    }
                                    // Иначе добавляем префикс /media/
                                    return `/media/${photo}`;
                                });
                            } else {
                                const img1 = complex.image_url || '/media/gallery/placeholders.png';
                                const img2 = complex.image_2_url;
                                const img3 = complex.image_3_url;
                                const img4 = complex.image_4_url;
                                photos = [img1, img2, img3, img4].filter(p => p);
                            }
                            
                            // Добавляем класс рейтинга для обводки (как в каталоге)
                            const rating = complex.rating || 0;
                            let ratingClass = '';
                            if (rating >= 5) {
                                ratingClass = 'rating-5';
                            } else if (rating >= 4) {
                                ratingClass = 'rating-4';
                            } else if (rating >= 1) {
                                ratingClass = 'rating-3';
                            }
                            
                            // Генерируем HTML для галереи как в каталоге
                            const galleryHtml = photos.map((photo, i) => 
                                `<img src="${photo}" alt="${complex.name}" class="gallery-image ${i === 0 ? 'active' : ''}" style="display: ${i === 0 ? 'block' : 'none'};">`
                            ).join('');
                            
                            const cardClasses = `property-card-compact ${ratingClass}`;
                            
                            html += `
                                <div class="${cardClasses}" data-complex-id="${complex._id}">
                                    <div class="compact-card-image-gallery" onclick="window.location.href='/complex/${complex._id}/'" style="cursor: pointer;">
                                        ${galleryHtml}
                                        ${photos.length > 1 ? `
                                            <button class="gallery-nav gallery-prev" onclick="event.stopPropagation(); changeImage(this, -1)">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <button class="gallery-nav gallery-next" onclick="event.stopPropagation(); changeImage(this, 1)">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                            <div class="gallery-dots">
                                                ${photos.map((_, i) => `<span class="dot ${i === 0 ? 'active' : ''}" onclick="event.stopPropagation(); setImage(this, ${i})"></span>`).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="compact-card-content" onclick="window.location.href='/complex/${complex._id}/'" style="cursor: pointer;">
                                        <div class="compact-card-header">
                                            <h3 class="compact-card-title">${complex.name}</h3>
                                            <div class="compact-card-location">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <span>${complex.address || complex.city || 'Уфа'}</span>
                                            </div>
                                            <div class="compact-card-details">
                                                ${complex.completion_date ? `
                                                <div class="compact-detail-item">
                                                    <i class="fas fa-calendar"></i>
                                                    <span>${complex.completion_date}</span>
                                                </div>
                                                ` : ''}
                                                ${complex.total_apartments ? `
                                                <div class="compact-detail-item apartments-item">
                                                    <i class="fas fa-home"></i>
                                                    <span>${complex.total_apartments} квартир</span>
                                                </div>
                                                ` : ''}
                                                ${complex.rating ? `
                                                <div class="compact-detail-item rating-item">
                                                    <i class="fas fa-star"></i>
                                                    <span class="rating-stars">
                                                        ${'★'.repeat(complex.rating)}${'☆'.repeat(5-complex.rating)}
                                                        <span class="rating-text">(${complex.rating}/5)</span>
                                                    </span>
                                                </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div class="compact-card-price">
                                            <div class="compact-price-text">${complex.price_range || complex.price_display || 'Цена по запросу'}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div></div>';
                        complexesContainer.innerHTML = html;
                        complexesContainer.style.display = 'block';
                    } else {
                        // Если нет ЖК с рейтингом 4+, показываем сообщение
                        complexesContainer.innerHTML = `
                            <div class="complexes-section" style="margin-top:30px; text-align:center; padding:40px 20px;">
                                <h3 style="margin-bottom:15px; color:#666; font-size:20px; font-weight:500;">Нет доступных ЖК с рейтингом 4+ звезд</h3>
                                <p style="color:#888; font-size:16px; margin:0;">Для данной индивидуальной программы нет жилых комплексов с высоким рейтингом.</p>
                            </div>
                        `;
                        complexesContainer.style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки ЖК:', error);
            });
    }
})();

// Функции для галереи изображений в карточках ипотеки
window.changeImage = function(button, direction) {
    const gallery = button.parentElement;
    const images = gallery.querySelectorAll('.gallery-image');
    const dots = gallery.querySelectorAll('.dot');
    let currentIndex = 0;
    
    // Находим текущий индекс
    images.forEach((img, i) => {
        if (img.style.display === 'block') {
            currentIndex = i;
        }
    });
    
    // Вычисляем новый индекс
    let newIndex = currentIndex + direction;
    if (newIndex < 0) newIndex = images.length - 1;
    if (newIndex >= images.length) newIndex = 0;
    
    // Переключаем изображения
    images[currentIndex].style.display = 'none';
    images[newIndex].style.display = 'block';
    
    // Переключаем точки
    dots[currentIndex].classList.remove('active');
    dots[newIndex].classList.add('active');
}

window.setImage = function(dot, index) {
    const gallery = dot.parentElement.parentElement;
    const images = gallery.querySelectorAll('.gallery-image');
    const dots = gallery.querySelectorAll('.dot');
    
    // Скрываем все изображения
    images.forEach(img => img.style.display = 'none');
    // Показываем выбранное
    images[index].style.display = 'block';
    
    // Обновляем точки
    dots.forEach(d => d.classList.remove('active'));
    dots[index].classList.add('active');
}

</script>
{% endblock %}


{% extends 'base.html' %}

{% block title %}{{ apartment.rooms }}-комнатная квартира в {{ complex.name }} — CENTURY 21{% endblock %}

{% block content %}
<div class="container">
    <section class="apartment-detail-section">
        <!-- Кнопка "Назад" -->
        <div style="margin-bottom: 16px;">
            <button id="back-button" onclick="returnToPrevious()" 
                style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 8px; color: #374151; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                onmouseover="this.style.background='#e5e7eb'; this.style.borderColor='#d1d5db';"
                onmouseout="this.style.background='#f3f4f6'; this.style.borderColor='#e5e7eb';">
                <i class="fas fa-arrow-left"></i>
                <span>Назад</span>
            </button>
        </div>

        <!-- Хлебные крошки -->
        <div class="breadcrumbs">
            <a href="{% url 'main:home' %}" class="breadcrumb-link">Главная</a>
            <span class="breadcrumb-separator">•</span>
            <a href="{% url 'main:catalog' %}" class="breadcrumb-link">Каталог</a>
            <span class="breadcrumb-separator">•</span>
            <a href="{% url 'main:detail' complex.id %}" class="breadcrumb-link">{{ complex.name }}</a>
            <span class="breadcrumb-separator">•</span>
            <span class="breadcrumb-current">{{ apartment.rooms }}-комнатная квартира</span>
        </div>

        <!-- Hero секция с галереей и агентом -->
        <div class="apartment-hero desktop-layout" style="display: grid; grid-template-columns: 1fr 380px; gap: 24px; margin: 24px 0;">
            <!-- Левая панель - Галерея изображений -->
            <div class="apartment-gallery-wrapper" style="position: relative;">
                <button class="favorite-btn-floating favorite-btn-detail" data-favorite-complex-id="{% if complex.id %}{{ complex.id }}{% else %}{% endif %}"
                    data-favorite-apartment-id="{% if apartment.id %}{{ apartment.id }}{% else %}{% endif %}"
                    onclick="if(typeof toggleApartmentFavoriteHandler === 'function') { toggleApartmentFavoriteHandler('{% if complex.id %}{{ complex.id }}{% else %}{% endif %}', '{% if apartment.id %}{{ apartment.id }}{% else %}{% endif %}', this); }"
                    title="Добавить в избранное">
                    <i class="far fa-heart"></i>
                </button>
                {% if apartment.photos %}
                <div class="apartment-gallery">
                    <div class="gallery-main" style="border-radius: 12px; overflow: hidden; background: #f5f5f5;">
                        <img src="{{ apartment.photos.0 }}" alt="{{ apartment.rooms }}-комнатная квартира" id="main-image"
                            loading="lazy" onclick="openImageFullSize(this.src)" style="cursor: pointer; width: 100%; height: auto; display: block;">
                    </div>
                    {% if apartment.photos|length > 1 %}
                    <div class="gallery-thumbnails" style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                        {% for photo in apartment.photos %}
                        <div class="thumbnail-item" onclick="changeMainImage('{{ photo }}')" style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: all 0.3s;">
                            <img src="{{ photo }}" alt="{{ apartment.rooms }}-комнатная квартира" loading="lazy" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="apartment-gallery">
                    <div class="gallery-main" style="border-radius: 12px; overflow: hidden; background: #f5f5f5;">
                        <img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ apartment.rooms }}-комнатная квартира" id="main-image"
                            loading="lazy" style="width: 100%; height: auto; display: block;">
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Правая панель - Информация об агенте -->
            <div class="agent-sidebar" style="display: flex; flex-direction: column;">
                <div class="agent-card"
                    style="background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%); border-radius: 12px; padding: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 20px; height: fit-content; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h2 class="agent-title" style="font-size: 18px; font-weight: 700; color: #ffffff; margin: 0; margin-bottom: 16px;">
                        Ответственный агент
                    </h2>
                    
                    <!-- Фото и информация об агенте -->
                    <div class="agent-profile" style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                        <div class="agent-photo-wrapper"
                            style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, #8b7355, #a0856b); display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 2px солид rgba(255, 255, 255, 0.2);">
                            {% if agent %}
                                {% if agent.images and agent.images.0 %}
                                    <img src="{{ agent.images.0 }}" alt="{% if agent.full_name %}{{ agent.full_name }}{% else %}Агент{% endif %}"
                                        style="width: 100%; height: 100%; object-fit: cover;">
                                {% elif agent.photo %}
                                    <img src="{{ agent.photo }}" alt="{% if agent.full_name %}{{ agent.full_name }}{% else %}Агент{% endif %}"
                                        style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                    <i class="fas fa-user" style="color: #ffffff; font-size: 32px;"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-user" style="color: #ffffff; font-size: 32px;"></i>
                            {% endif %}
                        </div>
                        <div class="agent-info" style="text-align: center;">
                            <div style="font-size: 18px; font-weight: 700; color: #ffffff; margin-bottom: 4px;">
                                {% if agent %}
                                {{ agent.full_name }}
                                {% else %}
                                Застройщик
                                {% endif %}
                            </div>
                            <div style="font-size: 13px; color: #e5e5e5; font-weight: 500;">
                                {% if agent %}
                                Риелтор
                                {% else %}
                                Застройщик
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="agent-actions" style="display: flex; flex-direction: column; gap: 12px; width: 100%;">
                        {% if agent and agent.id %}
                        <a href="{% url 'main:employee_detail' agent.id %}" class="agent-action-btn"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: linear-gradient(135deg, #8b7355, #a0856b); color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(139,115,85,0.3);">
                            <i class="fas fa-user-tie" style="font-size: 16px;"></i>
                            <span>Подробнее об агенте</span>
                        </a>
                        {% endif %}

                        <a href="#mortgage" class="agent-action-btn"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: linear-gradient(135deg, #8b7355, #a0856b); color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(139,115,85,0.3);">
                            <i class="fas fa-calculator" style="font-size: 16px;"></i>
                            <span>Рассчитать ипотеку</span>
                        </a>

                        <a href="tel:{% if agent and agent.phone %}{{ agent.phone }}{% else %}+78001234567{% endif %}" class="agent-action-btn agent-call-btn"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: #10b981; color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(16,185,129,0.3);">
                            <i class="fas fa-phone" style="font-size: 16px;"></i>
                            <span>Позвонить</span>
                        </a>

                        <a href="https://wa.me/{% if agent and agent.phone %}{% with phone=agent.phone|cut:' '|cut:'-'|cut:'('|cut:')'|cut:'+' %}{% if phone|slice:':1' == '8' %}7{{ phone|slice:'1:' }}{% elif phone|slice:':1' == '7' %}{{ phone }}{% else %}7{{ phone }}{% endif %}{% endwith %}{% else %}79001234567{% endif %}" target="_blank" rel="noopener noreferrer" class="agent-action-btn agent-whatsapp-btn"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: #25D366; color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(37,211,102,0.3);">
                            <i class="fab fa-whatsapp" style="font-size: 16px;"></i>
                            <span>Написать</span>
                        </a>

                        <button class="agent-action-btn agent-book-btn" onclick="openBookingModal()"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); color: var(--c21-dark); text-decoration: none; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(190,175,135,0.3); cursor: pointer;">
                            <i class="fas fa-calendar-check" style="font-size: 16px;"></i>
                            <span>Забронировать квартиру</span>
                        </button>
                    </div>
                </div>
            </div>
        </div> <!-- apartment-top -->

        <!-- Основная информация -->
        <div class="apartment-header">
            <div class="apartment-title-section">
                <h1 class="apartment-title">{{ apartment.rooms }}-комнатная квартира</h1>
                {% if complex.name %}
                <div class="apartment-complex-name">
                    {{ complex.name }}
                </div>
                {% endif %}
            </div>
            <div class="apartment-info-stack">
                <div class="info-row">
                    <span class="info-label">Стоимость</span>
                    <span class="info-value price">

            <!-- Правая панель - Информация об агенте -->
            <div class="agent-sidebar" style="display: flex; flex-direction: column;">
                <div class="agent-card"
                    style="background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%); border-radius: 12px; padding: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); display: flex; flex-direction: column; gap: 20px; height: fit-content; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h2 class="agent-title" style="font-size: 18px; font-weight: 700; color: #ffffff; margin: 0; margin-bottom: 16px;">
                        Ответственный агент
                    </h2>
                    
                    <!-- Фото и информация об агенте -->
                    <div class="agent-profile" style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                        <div class="agent-photo-wrapper"
                            style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; background: linear-gradient(135deg, #8b7355, #a0856b); display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 2px solid rgba(255, 255, 255, 0.2);">
                            {% if agent %}
                                {% if agent.images and agent.images.0 %}
                                    <img src="{{ agent.images.0 }}" alt="{% if agent.full_name %}{{ agent.full_name }}{% else %}Агент{% endif %}"
                                        style="width: 100%; height: 100%; object-fit: cover;">
                                {% elif agent.photo %}
                                    <img src="{{ agent.photo }}" alt="{% if agent.full_name %}{{ agent.full_name }}{% else %}Агент{% endif %}"
                                        style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                    <i class="fas fa-user" style="color: #ffffff; font-size: 32px;"></i>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-user" style="color: #ffffff; font-size: 32px;"></i>
                            {% endif %}
                        </div>
                        <div class="agent-info" style="text-align: center;">
                            <div style="font-size: 18px; font-weight: 700; color: #ffffff; margin-bottom: 4px;">
                                {% if agent %}
                                {{ agent.full_name }}
                                {% else %}
                                Застройщик
                                {% endif %}
                            </div>
                            <div style="font-size: 13px; color: #e5e5e5; font-weight: 500;">
                                {% if agent %}
                                Риелтор
                                {% else %}
                                Застройщик
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Кнопки действий -->
                    <div class="agent-actions" style="display: flex; flex-direction: column; gap: 12px; width: 100%;">
                        {% if agent and agent.id %}
                        <a href="{% url 'main:employee_detail' agent.id %}" class="agent-action-btn"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: linear-gradient(135deg, #8b7355, #a0856b); color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(139,115,85,0.3);">
                            <i class="fas fa-user-tie" style="font-size: 16px;"></i>
                            <span>Подробнее об агенте</span>
                        </a>
                        {% endif %}

                        <a href="#mortgage" class="agent-action-btn"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: linear-gradient(135deg, #8b7355, #a0856b); color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(139,115,85,0.3);">
                            <i class="fas fa-calculator" style="font-size: 16px;"></i>
                            <span>Рассчитать ипотеку</span>
                        </a>

                        <a href="tel:{% if agent and agent.phone %}{{ agent.phone }}{% else %}+78001234567{% endif %}" class="agent-action-btn agent-call-btn"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: #10b981; color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(16,185,129,0.3);">
                            <i class="fas fa-phone" style="font-size: 16px;"></i>
                            <span>Позвонить</span>
                        </a>

                        <a href="https://wa.me/{% if agent and agent.phone %}{% with phone=agent.phone|cut:' '|cut:'-'|cut:'('|cut:')'|cut:'+' %}{% if phone|slice:':1' == '8' %}7{{ phone|slice:'1:' }}{% elif phone|slice:':1' == '7' %}{{ phone }}{% else %}7{{ phone }}{% endif %}{% endwith %}{% else %}79001234567{% endif %}" target="_blank" rel="noopener noreferrer" class="agent-action-btn agent-whatsapp-btn"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: #25D366; color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(37,211,102,0.3);">
                            <i class="fab fa-whatsapp" style="font-size: 16px;"></i>
                            <span>Написать</span>
                        </a>

                        <button class="agent-action-btn agent-book-btn" onclick="openBookingModal()"
                            style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); color: var(--c21-dark); text-decoration: none; border: none; border-radius: 10px; font-weight: 600; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(190,175,135,0.3); cursor: pointer;">
                            <i class="fas fa-calendar-check" style="font-size: 16px;"></i>
                            <span>Забронировать квартиру</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="back-to-complex-link">
            <a href="{% url 'main:detail' complex.id %}" class="back-to-complex-btn">
                <i class="fas fa-building"></i>
                Перейти к ЖК
            </a>
        </div>

        <!-- Основная информация о квартире -->
        <div class="apartment-main-info" style="margin-top: 32px;">
            <h2 class="section-title">О квартире</h2>

            {% if apartment.description %}
            <div class="apartment-description">
                {{ apartment.description|linebreaks }}
            </div>
            {% endif %}

            <!-- Основные характеристики -->
            <div class="apartment-characteristics">
                <h3>Основные характеристики</h3>
                <div class="characteristics-grid">
                    {% if apartment.area %}
                    <div class="characteristic-item">
                        <i class="fas fa-ruler-combined"></i>
                        <div class="characteristic-content">
                            <span class="characteristic-label">Общая площадь</span>
                            <span class="characteristic-value">{{ apartment.area }} м²</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if apartment.rooms %}
                    <div class="characteristic-item">
                        <i class="fas fa-home"></i>
                        <div class="characteristic-content">
                            <span class="characteristic-label">Количество комнат</span>
                            <span class="characteristic-value">{{ apartment.rooms }}</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if apartment.floor %}
                    <div class="characteristic-item">
                        <i class="fas fa-layer-group"></i>
                        <div class="characteristic-content">
                            <span class="characteristic-label">Этаж</span>
                            <span class="characteristic-value">{{ apartment.floor }}</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if apartment.price_per_sqm or apartment.price_per_sqm_formatted %}
                    <div class="characteristic-item">
                        <i class="fas fa-ruble-sign"></i>
                        <div class="characteristic-content">
                            <span class="characteristic-label">Цена за м²</span>
                            <span class="characteristic-value">{% if apartment.price_per_sqm_formatted and apartment.price_per_sqm_formatted != '' %}{{ apartment.price_per_sqm_formatted }}{% elif apartment.price_per_sqm %}{{ apartment.price_per_sqm|floatformat:0 }}{% endif %} ₽</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if apartment.completion_date %}
                    <div class="characteristic-item">
                        <i class="fas fa-calendar-alt"></i>
                        <div class="characteristic-content">
                            <span class="characteristic-label">Срок сдачи</span>
                            <span class="characteristic-value">{{ apartment.completion_date }}</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if apartment.layout %}
                    <div class="characteristic-item">
                        <i class="fas fa-th-large"></i>
                        <div class="characteristic-content">
                            <span class="characteristic-label">Планировка</span>
                            <span class="characteristic-value">{{ apartment.layout }}</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if apartment.ceiling_height %}
                    <div class="characteristic-item">
                        <i class="fas fa-arrows-alt-v"></i>
                        <div class="characteristic-content">
                            <span class="characteristic-label">Высота потолков</span>
                            <span class="characteristic-value">{{ apartment.ceiling_height }} м</span>
                        </div>
                    </div>
                    {% endif %}

                    {% if apartment.condition %}
                    <div class="characteristic-item">
                        <i class="fas fa-tools"></i>
                        <div class="characteristic-content">
                            <span class="characteristic-label">Состояние</span>
                            <span class="characteristic-value">{{ apartment.condition }}</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Другие квартиры в ЖК -->
        {% if other_apartments %}
        <div class="other-apartments-section">
            <h2 class="section-title">Другие квартиры в {{ complex.name }}</h2>
            <div class="other-apartments-grid">
                {% for other_apt in other_apartments %}
                <div class="other-apartment-card">
                    <div class="other-apartment-media">
                        {% if other_apt.photos and other_apt.photos.0 %}
                        <img src="{{ other_apt.photos.0 }}"
                            alt="{% if other_apt.rooms %}{{ other_apt.rooms }}-комнатная квартира{% else %}Квартира{% endif %}"
                            loading="lazy">
                        {% else %}
                        <img src="{{ PLACEHOLDER_IMAGE_URL }}"
                            alt="{% if other_apt.rooms %}{{ other_apt.rooms }}-комнатная квартира{% else %}Квартира{% endif %}"
                            loading="lazy">
                        {% endif %}
                        {% if other_apt.rooms %}
                        <div class="other-apartment-badge">
                            <i class="fas fa-home"></i>
                            <span>{{ other_apt.rooms }}-комнатная</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="other-apartment-content">
                        <h3 class="other-apartment-title">{% if other_apt.rooms %}{{ other_apt.rooms }}-комнатная
                            квартира{% else %}Квартира{% endif %}</h3>
                        <div class="other-apartment-details">
                            {% if other_apt.area %}
                            <div class="other-apartment-area">
                                <i class="fas fa-ruler-combined"></i>
                                <span>{{ other_apt.area }} м²</span>
                            </div>
                            {% endif %}
                            {% if other_apt.floor %}
                            <div class="other-apartment-floor">
                                <i class="fas fa-layer-group"></i>
                                <span>{{ other_apt.floor }} этаж</span>
                            </div>
                            {% endif %}
                        </div>
                        {% if other_apt.price %}
                        <div class="other-apartment-price">
                            <span>{{ other_apt.price }}</span>
                        </div>
                        {% endif %}
                        <a href="{% url 'main:apartment_detail' complex.id other_apt.id %}?from=apartment&prev_apt={{ apartment.id }}"
                            class="other-apartment-link">
                            Подробнее
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </section>
</div>

<!-- Модальное окно бронирования -->
<div class="booking-modal" id="bookingModal">
    <div class="booking-modal-content">
        <div class="booking-modal-header">
            <h3 class="booking-modal-title">Забронировать квартиру</h3>
            <button class="booking-modal-close" onclick="closeBookingModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="booking-modal-body">
            <div class="booking-apartment-info">
                <h4>{{ apartment.rooms }}-комнатная квартира</h4>
                <p>{{ complex.name }}, {{ apartment.area }} м²</p>
                {% if apartment.price %}
                <div class="booking-price">{{ apartment.price }}</div>
                {% endif %}
            </div>

            <form class="booking-form" id="bookingForm">
                <div class="booking-form-group">
                    <label for="clientName">Ваше имя *</label>
                    <input type="text" id="clientName" name="client_name" placeholder="Иван Иванов" required>
                </div>

                <div class="booking-form-group">
                    <label for="clientPhone">Телефон *</label>
                    <input type="tel" id="clientPhone" name="client_phone" placeholder="+7 (999) 123-45-67" required>
                </div>

                <button type="submit" class="booking-submit-btn" id="bookingSubmitBtn">
                    <i class="fas fa-calendar-check"></i>
                    Забронировать
                </button>

                <div class="booking-message" id="bookingMessage"></div>
            </form>
        </div>
    </div>
</div>

<style>
    .apartment-detail-section {
        margin: 40px 0;
    }

    .breadcrumbs {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 24px;
        font-size: 14px;
        color: #666;
    }

    .breadcrumb-link {
        color: #666;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .breadcrumb-link:hover {
        color: var(--c21-gold);
    }

    .breadcrumb-separator {
        color: #999;
        font-size: 12px;
    }

    .breadcrumb-current {
        color: #999;
    }

    /* Заголовок квартиры */
    .apartment-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        gap: 20px;
    }

    .apartment-title-section {
        flex: 1;
    }

    .apartment-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--c21-dark);
        margin: 0 0 12px 0;
        line-height: 1.2;
    }

    .apartment-location {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #666;
        font-size: 16px;
    }

    .apartment-location i {
        color: var(--c21-gold);
    }

    .apartment-price-section {
        text-align: right;
    }

    .apartment-price {
        margin-bottom: 16px;
    }

    .price-main {
        display: block;
        font-size: 2rem;
        font-weight: 800;
        color: var(--c21-gold);
        margin-bottom: 4px;
    }

    .price-per-sqm {
        font-size: 14px;
        color: #666;
        font-weight: 600;
    }

    .book-apartment-btn {
        background: linear-gradient(135deg, var(--c21-gold) 0%, #d4af37 100%);
        color: var(--c21-dark);
        border: none;
        padding: 16px 24px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(190, 175, 135, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .book-apartment-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(190, 175, 135, 0.4);
    }

    /* Галерея */
    .apartment-gallery {
        margin-bottom: 40px;
    }

    .gallery-main {
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, .1);
    }

    .gallery-main img {
        width: 100%;
        height: auto;
        max-height: 600px;
        object-fit: contain;
        display: block;
    }

    .gallery-thumbnails {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding-bottom: 8px;
    }

    .thumbnail-item {
        flex-shrink: 0;
        width: 120px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease;
        border: 2px solid transparent;
    }

    .thumbnail-item:hover {
        transform: scale(1.05);
        border-color: var(--c21-gold);
    }

    .thumbnail-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .thumbnail-item img:hover {
        transform: scale(1.1);
    }

    /* Информация о квартире */
    .apartment-info-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 40px;
        margin-bottom: 60px;
    }

    .apartment-main-info {
        background: #fff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
    }

    .section-title {
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--c21-dark);
        margin: 0 0 24px 0;
    }

    .apartment-description {
        color: #444;
        line-height: 1.6;
        margin-bottom: 32px;
        font-size: 16px;
    }

    .apartment-characteristics h3,
    .detailed-characteristics h3 {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--c21-dark);
        margin: 0 0 20px 0;
    }

    .characteristics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }

    .characteristic-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        border: 1px solid #e9ecef;
    }

    .characteristic-item i {
        color: var(--c21-gold);
        font-size: 18px;
        width: 20px;
        text-align: center;
    }

    .characteristic-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .characteristic-label {
        font-size: 12px;
        color: #666;
        font-weight: 500;
    }

    .characteristic-value {
        font-size: 14px;
        color: var(--c21-dark);
        font-weight: 700;
    }

    .characteristics-grid-detailed {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .characteristic-detail-item {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .characteristic-detail-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, .1);
    }

    .characteristic-detail-label {
        font-size: 12px;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .characteristic-detail-value {
        font-size: 16px;
        color: var(--c21-dark);
        font-weight: 700;
        line-height: 1.4;
    }

    /* Контактная информация */
    .apartment-contact {
        position: sticky;
        top: 20px;
    }

    .contact-card {
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
        border: 1px solid #e9ecef;
    }

    .contact-card h3 {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--c21-dark);
        margin: 0 0 12px 0;
    }

    .contact-card p {
        color: #666;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    .contact-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 16px;
        background: var(--c21-gold);
        color: var(--c21-dark);
        text-decoration: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(190, 175, 135, .3);
        border: none;
        cursor: pointer;
    }

    .contact-btn:hover {
        background: var(--c21-gold-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(190, 175, 135, .4);
    }

    /* Другие квартиры */
    .other-apartments-section {
        margin-top: 60px;
    }

    .other-apartments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-top: 32px;
    }

    .other-apartment-card {
        background: #fff;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 24px rgba(0, 0, 0, .06);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        text-decoration: none;
        color: inherit;
    }

    .other-apartment-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, .12);
    }

    .other-apartment-media {
        position: relative;
        height: 200px;
        overflow: hidden;
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0;
    }

    .other-apartment-media img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        object-position: center;
        transition: transform 0.3s ease;
    }

    .other-apartment-card:hover .other-apartment-media img {
        transform: scale(1.05);
    }

    .other-apartment-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        background: var(--c21-gold);
        color: var(--c21-dark);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .other-apartment-content {
        padding: 20px;
    }

    .other-apartment-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--c21-dark);
        margin: 0 0 8px 0;
        line-height: 1.3;
    }

    .other-apartment-details {
        display: flex;
        gap: 16px;
        margin-bottom: 12px;
    }

    .other-apartment-area,
    .other-apartment-floor {
        display: flex;
        align-items: center;
        gap: 6px;
        color: #666;
        font-size: 14px;
    }

    .other-apartment-area i,
    .other-apartment-floor i {
        color: var(--c21-gold);
        font-size: 12px;
    }

    .other-apartment-price {
        font-size: 16px;
        font-weight: 700;
        color: var(--c21-gold);
        margin-bottom: 16px;
    }

    .other-apartment-link {
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--c21-dark);
        font-weight: 600;
        font-size: 14px;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .other-apartment-link:hover {
        color: var(--c21-gold);
    }

    .other-apartment-link i {
        transition: transform 0.3s ease;
    }

    .other-apartment-link:hover i {
        transform: translateX(4px);
    }

    /* Модальное окно бронирования */
    .booking-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .booking-modal.active {
        display: flex;
    }

    .booking-modal-content {
        background: #fff;
        border-radius: 20px;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .booking-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 24px 0 24px;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 24px;
    }

    .booking-modal-title {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--c21-dark);
        margin: 0;
    }

    .booking-modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .booking-modal-close:hover {
        background: #f8f9fa;
        color: var(--c21-dark);
    }

    .booking-modal-body {
        padding: 0 24px 24px 24px;
    }

    .booking-apartment-info {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border-left: 4px solid var(--c21-gold);
    }

    .booking-apartment-info h4 {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--c21-dark);
        margin: 0 0 8px 0;
    }

    .booking-apartment-info p {
        color: #666;
        margin: 0 0 8px 0;
        font-size: 14px;
    }

    .booking-price {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--c21-gold);
    }

    .booking-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .booking-form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .booking-form-group label {
        color: var(--c21-dark);
        font-weight: 600;
        font-size: 14px;
    }

    .booking-form-group input {
        padding: 14px 16px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        background: #fff;
        color: var(--c21-dark);
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .booking-form-group input::placeholder {
        color: #999;
    }

    .booking-form-group input:focus {
        outline: none;
        border-color: var(--c21-gold);
        box-shadow: 0 0 0 3px rgba(190, 175, 135, 0.2);
    }

    .booking-submit-btn {
        background: linear-gradient(135deg, var(--c21-gold) 0%, #d4af37 100%);
        color: var(--c21-dark);
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 15px rgba(190, 175, 135, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .booking-submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(190, 175, 135, 0.4);
    }

    .booking-submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .booking-message {
        margin-top: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 600;
        display: none;
        text-align: center;
    }

    .booking-message.success {
        background: rgba(34, 197, 94, 0.1);
        color: #22c55e;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .booking-message.error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    /* Адаптивность */
    @media (max-width: 1024px) {
        .apartment-info-grid {
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .apartment-contact {
            position: static;
        }
    }

    @media (max-width: 768px) {
        .apartment-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }

        .apartment-title {
            font-size: 2rem;
        }

        .apartment-price-section {
            text-align: left;
            width: 100%;
        }

        .gallery-main img {
            max-height: 400px;
        }

        .apartment-main-info {
            padding: 20px;
        }

        .characteristics-grid {
            grid-template-columns: 1fr;
        }

        .other-apartments-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .booking-modal-content {
            margin: 20px;
            max-width: none;
        }
    }

    @media (max-width: 480px) {
        .apartment-title {
            font-size: 1.8rem;
        }

        .gallery-main img {
            max-height: 300px;
        }

        .apartment-main-info {
            padding: 16px;
        }

        .contact-card {
            padding: 20px;
        }

        .thumbnail-item {
            width: 100px;
            height: 70px;
        }

        .booking-modal-header,
        .booking-modal-body {
            padding-left: 16px;
            padding-right: 16px;
        }
    }
</style>

<script>
    // Функции для галереи
    function changeMainImage(imageUrl) {
        const mainImage = document.getElementById('main-image');
        mainImage.src = imageUrl;
        mainImage.onclick = () => openImageFullSize(imageUrl);
    }

    function openImageFullSize(imageSrc) {
        const modal = document.createElement('div');
        modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    `;

        const img = document.createElement('img');
        img.src = imageSrc;
        img.style.cssText = `
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    `;

        modal.appendChild(img);
        document.body.appendChild(modal);

        modal.addEventListener('click', () => {
            document.body.removeChild(modal);
        });

        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                document.body.removeChild(modal);
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    }

    // Функции для модального окна бронирования (должны быть глобальными)
    function openBookingModal() {
        const modal = document.getElementById('bookingModal');
        if (modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeBookingModal() {
        const modal = document.getElementById('bookingModal');
        if (modal) {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
    }

    // Обработка формы бронирования
    document.addEventListener('DOMContentLoaded', function () {
        const bookingForm = document.getElementById('bookingForm');
        const bookingSubmitBtn = document.getElementById('bookingSubmitBtn');
        const bookingMessage = document.getElementById('bookingMessage');

        // Функция форматирования имени (только буквы и пробелы)
        function formatName(input) {
            let value = input.value;
            // Удаляем все символы кроме букв, пробелов и дефисов
            value = value.replace(/[^а-яёА-ЯЁa-zA-Z\s\-]/g, '');
            // Убираем множественные пробелы
            value = value.replace(/\s+/g, ' ');
            // Делаем первую букву каждого слова заглавной
            value = value.replace(/\b\w/g, function (char) {
                return char.toUpperCase();
            });
            input.value = value;
        }

        // Функция форматирования телефона
        function formatPhone(input) {
            let value = input.value.replace(/\D/g, ''); // Удаляем все нецифровые символы

            if (value.length === 0) {
                input.value = '';
                return;
            }

            if (value[0] === '8') {
                value = '7' + value.slice(1);
            }

            if (value[0] !== '7') {
                value = '7' + value;
            }

            if (value.length <= 1) {
                input.value = '+7';
            } else if (value.length <= 4) {
                input.value = '+7 (' + value.slice(1);
            } else if (value.length <= 7) {
                input.value = '+7 (' + value.slice(1, 4) + ') ' + value.slice(4);
            } else if (value.length <= 9) {
                input.value = '+7 (' + value.slice(1, 4) + ') ' + value.slice(4, 7) + '-' + value.slice(7);
            } else {
                input.value = '+7 (' + value.slice(1, 4) + ') ' + value.slice(4, 7) + '-' + value.slice(7, 9) + '-' + value.slice(9, 11);
            }
        }

        // Добавляем обработчики форматирования
        const nameInput = document.getElementById('clientName');
        const phoneInput = document.getElementById('clientPhone');

        if (nameInput) {
            nameInput.addEventListener('input', function () {
                formatName(this);
            });

            nameInput.addEventListener('paste', function (e) {
                setTimeout(() => formatName(this), 10);
            });
        }

        if (phoneInput) {
            phoneInput.addEventListener('input', function () {
                formatPhone(this);
            });

            phoneInput.addEventListener('paste', function (e) {
                setTimeout(() => formatPhone(this), 10);
            });

            // Обработка клавиш для телефона
            phoneInput.addEventListener('keydown', function (e) {
                // Разрешаем: backspace, delete, tab, escape, enter
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Разрешаем: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    // Разрешаем: home, end, left, right
                    (e.keyCode >= 35 && e.keyCode <= 40)) {
                    return;
                }
                // Убеждаемся, что это цифра
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
        }

        if (bookingForm) {
            bookingForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(bookingForm);
                const data = {
                    apartment_id: '{{ apartment.id }}',
                    complex_id: '{{ complex.id }}',
                    client_name: formData.get('client_name'),
                    client_phone: formData.get('client_phone')
                };

                // Проверяем, что apartment_id не None
                if (data.apartment_id === 'None' || !data.apartment_id) {
                    showBookingMessage('Ошибка: ID квартиры не найден', 'error');
                    return;
                }

                // Валидация
                if (!data.client_name || data.client_name.trim().length < 2) {
                    showBookingMessage('Пожалуйста, введите корректное имя', 'error');
                    return;
                }

                if (!data.client_phone || data.client_phone.replace(/\D/g, '').length < 11) {
                    showBookingMessage('Пожалуйста, введите корректный номер телефона', 'error');
                    return;
                }

                // Отправка данных
                bookingSubmitBtn.disabled = true;
                bookingSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправляем...';

                try {
                    const response = await fetch('/api/book-apartment/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(data)
                    });

                    // Проверяем статус ответа
                    if (!response.ok) {
                        // Если 404, значит маршрут не найден
                        if (response.status === 404) {
                            showBookingMessage('Ошибка: API endpoint не найден. Пожалуйста, перезапустите сервер или обратитесь к администратору.', 'error');
                            console.error('404 Not Found: /api/book-apartment/');
                            return;
                        }

                        // Для других ошибок пытаемся получить JSON
                        try {
                            const errorResult = await response.json();
                            showBookingMessage(errorResult.error || `Ошибка сервера (${response.status})`, 'error');
                        } catch (e) {
                            showBookingMessage(`Ошибка сервера (${response.status})`, 'error');
                        }
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showBookingMessage(result.message, 'success');
                        bookingForm.reset();

                        // Закрываем модальное окно через 2 секунды
                        setTimeout(() => {
                            closeBookingModal();
                        }, 2000);
                    } else {
                        showBookingMessage(result.error || 'Произошла ошибка при бронировании', 'error');
                    }
                } catch (error) {
                    console.error('Ошибка бронирования:', error);
                    showBookingMessage('Произошла ошибка при отправке запроса: ' + error.message, 'error');
                } finally {
                    bookingSubmitBtn.disabled = false;
                    bookingSubmitBtn.innerHTML = '<i class="fas fa-calendar-check"></i> Забронировать';
                }
            });
        }

        function showBookingMessage(text, type) {
            bookingMessage.textContent = text;
            bookingMessage.className = `booking-message ${type}`;
            bookingMessage.style.display = 'block';

            // Скрываем сообщение через 5 секунд
            setTimeout(() => {
                bookingMessage.style.display = 'none';
            }, 5000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Закрытие модального окна по клику вне его
        const modal = document.getElementById('bookingModal');
        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                closeBookingModal();
            }
        });

        // Закрытие модального окна по Escape
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && modal.classList.contains('active')) {
                closeBookingModal();
            }
        });

        // Инициализация кнопки избранного для квартиры
        const favoriteBtn = document.querySelector('.favorite-btn-detail[data-favorite-apartment-id]');
        if (favoriteBtn && typeof isApartmentInFavorites === 'function') {
            const complexId = favoriteBtn.getAttribute('data-favorite-complex-id');
            const apartmentId = favoriteBtn.getAttribute('data-favorite-apartment-id');
            if (complexId && apartmentId) {
                const isFavorite = isApartmentInFavorites(complexId, apartmentId);
                updateFavoriteIcon(favoriteBtn, isFavorite);
            }
        }

        // Отслеживание просмотра квартиры
        if (window.UserTracking && typeof window.UserTracking.trackApartmentView === 'function') {
            const apartmentId = '{{ apartment.id }}';
            // Безопасное преобразование значений в числа
            let rooms = 0;
            let area = 0;
            let price = 0;

            try {
                const roomsValue = '{{ apartment.rooms|default:0 }}';
                if (roomsValue && roomsValue !== 'None' && roomsValue !== '') {
                    // Извлекаем число из строки типа "3-комн" или просто число
                    const roomsMatch = roomsValue.toString().match(/^(\d+)/);
                    if (roomsMatch) {
                        rooms = parseInt(roomsMatch[1], 10) || 0;
                    }
                }
            } catch (e) {
                console.warn('Ошибка парсинга rooms:', e);
            }

            try {
                const areaValue = '{{ apartment.area|default:0 }}';
                if (areaValue && areaValue !== 'None' && areaValue !== '') {
                    // Извлекаем число из строки типа "58.9 м²" или "58,9"
                    const areaStr = areaValue.toString().replace(/[^\d.,]/g, '').replace(',', '.');
                    area = parseFloat(areaStr) || 0;
                }
            } catch (e) {
                console.warn('Ошибка парсинга area:', e);
            }

            try {
                const priceValue = '{{ apartment.price|default:0 }}';
                if (priceValue && priceValue !== 'None' && priceValue !== '') {
                    // Извлекаем число из строки типа "5 000 000 ₽"
                    const priceStr = priceValue.toString().replace(/[^\d]/g, '');
                    price = parseFloat(priceStr) || 0;
                }
            } catch (e) {
                console.warn('Ошибка парсинга price:', e);
            }

            const apartmentData = {
                rooms: rooms,
                area: area,
                price: price,
                complex_name: '{{ complex.name|escapejs }}'
            };

            if (apartmentId && apartmentId !== 'None') {
                window.UserTracking.trackApartmentView(apartmentId, apartmentData);
            }
        }

        // Функция возврата назад
        function returnToPrevious() {
            const urlParams = new URLSearchParams(window.location.search);
            const from = urlParams.get('from');
            const prevAptId = urlParams.get('prev_apt');
            const complexId = '{{ complex.id }}';
            
            if (from === 'favorites') {
                // Возврат в избранное
                window.location.href = '/favorites/';
            } else if (from === 'complex') {
                // Возврат на страницу ЖК
                window.location.href = '/complex/' + complexId + '/';
            } else if (from === 'apartment' && prevAptId) {
                // Возврат на предыдущую квартиру
                window.location.href = '/apartment/' + complexId + '/' + prevAptId + '/';
            } else {
                // По умолчанию - возврат на страницу ЖК
                window.location.href = '/complex/' + complexId + '/';
            }
        }
        
        // Делаем функцию глобальной
        window.returnToPrevious = returnToPrevious;

        // Обработка якоря для ипотечного калькулятора
        document.querySelectorAll('a[href="#mortgage"]').forEach(a => {
            a.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.getElementById('mortgage');
                if (target) {
                    // Если секция ипотеки есть на странице, прокручиваем к ней
                    const headerOffset = 100;
                    const elementPosition = target.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                } else {
                    // Если секции нет, переходим на страницу ЖК с якорем
                    const complexId = '{{ complex.id }}';
                    if (complexId) {
                        window.location.href = '/complex/' + complexId + '/#mortgage';
                    }
                }
            });
        });
    });
</script>

<style>
	/* Стили для секции агента на странице квартиры */
	.apartment-top {
		display: block;
	}

	.apartment-hero {
		display: grid;
		grid-template-columns: 1fr 380px;
		gap: 24px;
		margin: 24px 0;
		align-items: start;
	}

	.agent-sidebar {
		min-width: 0;
	}

	.agent-card {
		background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%) !important;
		border: 1px solid rgba(255, 255, 255, 0.1) !important;
	}

	.agent-action-btn {
		width: 100%;
		cursor: pointer;
	}

	.agent-action-btn:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
		opacity: 0.95;
	}

	.agent-action-btn.agent-call-btn:hover {
		background: #059669 !important;
		box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5) !important;
	}

	.agent-action-btn.agent-whatsapp-btn:hover {
		background: #128C7E !important;
		box-shadow: 0 4px 12px rgba(37, 211, 102, 0.5) !important;
	}

	.agent-action-btn.agent-book-btn:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(190, 175, 135, 0.5) !important;
	}

	.favorite-btn-floating {
		position: absolute;
		top: 16px;
		right: 16px;
		width: 44px;
		height: 44px;
		border-radius: 50%;
		border: none;
		background: rgba(255, 255, 255, 0.92);
		box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
		display: flex;
		align-items: center;
		justify-content: center;
		color: #b8b8b8;
		cursor: pointer;
		transition: all 0.2s ease;
		z-index: 5;
	}

	.favorite-btn-floating:hover {
		color: var(--c21-gold);
		background: #fff;
	}

	.apartment-info-stack {
		display: flex;
		flex-direction: column;
		gap: 12px;
		padding-top: 12px;
	}

	.info-row {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 12px;
		padding-bottom: 8px;
		border-bottom: 1px solid #f1f1f1;
	}

	.info-row:last-child {
		border-bottom: none;
	}

	.info-label {
		color: #6b7280;
		font-size: 14px;
	}

	.info-value {
		font-weight: 700;
		color: #1f2937;
		font-size: 16px;
	}

	.info-value.price {
		font-size: 22px;
		color: var(--c21-gold);
	}

	.back-to-complex-link {
		margin: 24px 0 12px;
	}

	.back-to-complex-btn {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		padding: 10px 18px;
		border-radius: 10px;
		border: 1px solid #e5e7eb;
		color: #374151;
		font-weight: 600;
		text-decoration: none;
		transition: all 0.2s ease;
	}

	.back-to-complex-btn:hover {
		border-color: #d1d5db;
		background: #f3f4f6;
	}

	.thumbnail-item:hover {
		border-color: var(--c21-gold) !important;
		transform: scale(1.05);
	}

	/* Мобильная версия */
	@media (max-width: 1024px) {
		.apartment-top {
			display: flex;
			flex-direction: column;
			gap: 24px;
		}

		.apartment-hero {
			grid-template-columns: 1fr !important;
			gap: 20px !important;
		}

		.agent-sidebar {
			order: 2;
		}

		.agent-card {
			max-width: 100%;
		}
	}

	@media (max-width: 768px) {
		.agent-actions {
			gap: 10px !important;
		}

		.agent-action-btn {
			padding: 10px 16px !important;
			font-size: 13px !important;
		}

		.gallery-thumbnails {
			gap: 6px !important;
		}

		.thumbnail-item {
			width: 60px !important;
			height: 60px !important;
		}
	}
</style>
{% endblock %}
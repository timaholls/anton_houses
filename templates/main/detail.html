{% extends 'base.html' %}

{% block title %}{{ complex.name }} - Антон Хаус{% endblock %}

{% block extra_css %}
<style>
/* Стили для галереи в карточках квартир */
.compact-card-image-gallery {
  position: relative;
  width: 100%;
  height: 280px;
  overflow: hidden;
  border-radius: 12px 12px 0 0;
  background: #f9fafb;
}

.compact-card-image-gallery .gallery-image {
  width: 100%;
  height: 100%;
  object-fit: contain;
  transition: opacity 0.3s ease;
}

.gallery-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0, 0, 0, 0.6);
  color: white;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  z-index: 10;
  opacity: 0;
}

.compact-card-image-gallery:hover .gallery-nav {
  opacity: 1;
}

.gallery-nav:hover {
  background: rgba(0, 0, 0, 0.8);
  transform: translateY(-50%) scale(1.1);
}

.gallery-prev {
  left: 10px;
}

.gallery-next {
  right: 10px;
}

.gallery-dots {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 6px;
  z-index: 10;
}

.gallery-dots .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  transition: all 0.3s ease;
}

.gallery-dots .dot.active {
  background: rgba(255, 255, 255, 1);
  width: 24px;
  border-radius: 4px;
}

.gallery-dots .dot:hover {
  background: rgba(255, 255, 255, 0.8);
}

/* Мобильная версия */
@media (max-width: 768px){
  .compact-card-image-gallery { height: 240px; }
  .gallery-nav { opacity: 1; width: 32px; height: 32px; }
}
</style>
{% endblock %}

{% block content %}
<div class="detail-container">
	<!-- Hero секция с главным изображением -->
	<div class="detail-hero">
		<div class="hero-image" id="heroGallery">
			{% if is_mongodb and complex.photos %}
				{% for photo in complex.photos %}
				<img src="{{ photo }}" alt="{{ complex.name }}" class="hero-main-image" style="{% if not forloop.first %}display:none;{% endif %}" data-photo-index="{{ forloop.counter0 }}">
				{% endfor %}
			{% elif complex.get_main_image and complex.get_main_image.image %}
				<img src="{{ complex.get_main_image.image.url }}" alt="{{ complex.name }}" class="hero-main-image">
			{% else %}
				<img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ complex.name }}" class="hero-main-image">
			{% endif %}
			
			<!-- Информационная панель поверх изображения -->
            <div class="hero-info-overlay">
                <h1 class="complex-name">{{ complex.name }}</h1>
				{% if is_mongodb and complex.photos %}
				<div class="photo-counter" style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); color:#fff; padding:8px 16px; border-radius:20px; font-size:14px;">
					<span id="currentPhotoIndex">1</span> / {{ complex.photos|length }}
				</div>
				{% endif %}
            </div>
		</div>
		<!-- Боковые стрелки навигации по фото -->
		{% if is_mongodb and complex.photos|length > 1 %}
		<div class="hero-photo-nav" style="position:absolute; top:50%; left:0; right:0; display:flex; justify-content:space-between; transform:translateY(-50%); pointer-events:none; padding:0 8px;">
			<button class="photo-nav-btn prev" onclick="changeHeroPhoto(-1)" style="pointer-events:auto; background:rgba(0,0,0,0.6); border:none; color:#fff; width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.3s;"><i class="fas fa-chevron-left"></i></button>
			<button class="photo-nav-btn next" onclick="changeHeroPhoto(1)" style="pointer-events:auto; background:rgba(0,0,0,0.6); border:none; color:#fff; width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.3s;"><i class="fas fa-chevron-right"></i></button>
		</div>
		{% endif %}
	</div>
	
	<!-- Основная информация -->
	<div class="detail-content">
		<!-- Блок с агентом и контактами в едином стиле -->
		<div class="agent-contact-block" style="margin: 24px 0; padding: 20px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
			<h2 class="section-title" style="font-size: 22px; font-weight: 700; color: var(--c21-dark); margin-bottom: 16px; border-bottom: 2px solid var(--c21-gold); padding-bottom: 8px; display: inline-block;">Контактная информация</h2>
			
			<div class="agent-info-grid" style="display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-top: 16px; align-items: center;">
				<!-- Информация об агенте -->
				<div class="agent-info-section" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 3px solid var(--c21-gold);">
					<div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
						{% if agent and agent.photo %}
							<img src="{{ agent.photo }}" alt="{{ agent.full_name }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
						{% else %}
							<i class="fas fa-user" style="color: var(--c21-dark); font-size: 20px;"></i>
						{% endif %}
					</div>
					<div style="flex: 1;">
						<div style="font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">
							{% if agent %}
								{{ agent.full_name }}
							{% else %}
								{{ complex.developer }}
							{% endif %}
						</div>
						<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
							{% if agent %}
								Ответственный агент
							{% else %}
								Застройщик
							{% endif %}
						</div>
					</div>
				</div>
				
				<!-- Кнопки действий -->
				<div class="action-buttons-section" style="display: flex; gap: 12px;">
					<a href="#mortgage" class="action-btn mortgage-btn" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); color: var(--c21-dark); text-decoration: none; border-radius: 10px; font-weight: 700; font-size: 14px; transition: all 0.3s; box-shadow: 0 2px 8px rgba(190,175,135,0.3);">
						<i class="fas fa-calculator" style="font-size: 16px;"></i>
						<span>Ипотека</span>
					</a>
					
					{% if agent %}
					<a href="{% url 'main:employee_detail' agent.id %}" class="action-btn agent-btn" style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: #ffffff; color: var(--c21-dark); text-decoration: none; border: 2px solid var(--c21-gold); border-radius: 10px; font-weight: 700; font-size: 14px; transition: all 0.3s;">
						<i class="fas fa-user-tie" style="font-size: 16px;"></i>
						<span>Агент</span>
					</a>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
	
	<!-- Описание объекта -->
	{% if is_secondary and complex.description %}
	<div class="detail-description" style="margin: 32px 0; padding: 24px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
		<h2 style="font-size: 24px; font-weight: 600; margin-bottom: 16px; color: #1e293b;">
			Описание объекта
		</h2>
		<div style="font-size: 16px; line-height: 1.6; color: #475569; white-space: pre-line;">
			{{ complex.description|safe }}
		</div>
	</div>
	{% endif %}
	
	{# Характеристики вторичной недвижимости #}
	{% if is_secondary %}
	<div class="secondary-characteristics-block" style="margin: 32px 0; padding: 28px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.06);">
		<h2 class="section-title" style="font-size: 28px; font-weight: 700; color: var(--c21-dark); margin-bottom: 20px; border-bottom: 3px solid var(--c21-gold); padding-bottom: 12px; display: inline-block;">Характеристики объекта</h2>
		
		<div class="secondary-chars-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 24px;">
			{# Адрес #}
			{% if complex.address or complex.street %}
			<div class="secondary-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-map-marker-alt" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Адрес</div>
					<div style="font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.4;">
						{% if complex.address %}{{ complex.address }}{% else %}{{ complex.street }}{% endif %}
					</div>
				</div>
			</div>
			{% endif %}
			
			{# Тип недвижимости #}
			{% if complex.house_type %}
			<div class="secondary-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-home" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Тип недвижимости</div>
					<div style="font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.4;">
						{% if complex.house_type == 'apartment' %}Квартира
						{% elif complex.house_type == 'house' %}Частный дом
						{% elif complex.house_type == 'cottage' %}Коттедж
						{% elif complex.house_type == 'townhouse' %}Таунхаус
						{% elif complex.house_type == 'commercial' %}Коммерческое помещение
						{% else %}{{ complex.house_type }}{% endif %}
					</div>
				</div>
			</div>
			{% endif %}
			
			{# Площадь #}
			{% if complex.area %}
			<div class="secondary-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-expand-arrows-alt" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Площадь</div>
					<div style="font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.4;">{{ complex.area }} м²</div>
				</div>
			</div>
			{% endif %}
			
			{# Количество комнат #}
			{% if complex.rooms %}
			<div class="secondary-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-bed" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Количество комнат</div>
					<div style="font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.4;">{{ complex.rooms }}-комнатная</div>
				</div>
			</div>
			{% endif %}
			
			{# Цена #}
			{% if complex.price %}
			<div class="secondary-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-ruble-sign" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Цена</div>
					<div style="font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.4;">{{ complex.price|floatformat:0 }} ₽</div>
				</div>
			</div>
			{% endif %}
			
			{# Время до центра #}
			{% if complex.commute_time %}
			<div class="secondary-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-clock" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Время до центра</div>
					<div style="font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.4;">{{ complex.commute_time }}</div>
				</div>
			</div>
			{% endif %}
			
			{# Количество этажей #}
			{% if complex.total_floors %}
			<div class="secondary-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-building" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Этажность</div>
					<div style="font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.4;">{{ complex.total_floors }} этаж{{ complex.total_floors|pluralize:"ей,а,ей" }}</div>
				</div>
			</div>
			{% endif %}
			
			{# Отделка #}
			{% if complex.finishing %}
			<div class="secondary-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-paint-brush" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 14px; color: #64748b; margin-bottom: 4px;">Отделка</div>
					<div style="font-size: 16px; font-weight: 600; color: #1e293b; line-height: 1.4;">
						{% if complex.finishing == 'without' %}Без отделки
						{% elif complex.finishing == 'rough' %}Черновая отделка
						{% elif complex.finishing == 'white_box' %}Белая коробка
						{% elif complex.finishing == 'full' %}Полная отделка
						{% elif complex.finishing == 'designer' %}Дизайнерская отделка
						{% else %}{{ complex.finishing }}{% endif %}
					</div>
				</div>
			</div>
			{% endif %}
		</div>
	</div>
	{% endif %}
	
	{# Основные характеристики новостройки #}
{% load main_extras %}
{% if is_mongodb and complex.parameters and not is_secondary %}
	<div class="main-characteristics-block" style="margin: 32px 0; padding: 28px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.06);">
		<h2 class="section-title" style="font-size: 28px; font-weight: 700; color: var(--c21-dark); margin-bottom: 20px; border-bottom: 3px solid var(--c21-gold); padding-bottom: 12px; display: inline-block;">О жилом комплексе</h2>
		
		<div class="main-chars-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 24px;">
			{# Адрес #}
			{% if complex.address %}
			<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-map-marker-alt" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Адрес</div>
					<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ complex.address }}</div>
				</div>
			</div>
			{% endif %}
			
			{# Проходим по всем параметрам и показываем нужные в красивом виде #}
			{% for key, value in complex.parameters.items %}
				{% if value and value != '' and value != 'None' %}
					{# Срок сдачи #}
					{% if 'Срок' in key and 'сдачи' in key %}
					<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
						<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
							<i class="fas fa-calendar" style="color: var(--c21-dark); font-size: 18px;"></i>
						</div>
						<div style="flex: 1;">
							<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Срок сдачи</div>
							<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ value }}</div>
						</div>
					</div>
					{% endif %}
					
					{# Класс жилья #}
					{% if 'Класс' in key %}
					<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
						<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
							<i class="fas fa-star" style="color: var(--c21-dark); font-size: 18px;"></i>
						</div>
						<div style="flex: 1;">
							<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Класс жилья</div>
							<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ value }}</div>
						</div>
					</div>
					{% endif %}
					
					{# Тип жилья #}
					{% if 'Тип' in key and 'жилья' in key %}
					<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
						<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
							<i class="fas fa-home" style="color: var(--c21-dark); font-size: 18px;"></i>
						</div>
						<div style="flex: 1;">
							<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Тип жилья</div>
							<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ value }}</div>
						</div>
					</div>
					{% endif %}
					
					{# Отделка #}
					{% if 'Отделка' in key %}
					<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
						<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
							<i class="fas fa-paint-roller" style="color: var(--c21-dark); font-size: 18px;"></i>
						</div>
						<div style="flex: 1;">
							<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Отделка</div>
							<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ value }}</div>
						</div>
					</div>
					{% endif %}
					
					{# Этажность #}
					{% if 'Этажность' in key or 'этаж' in key %}
					<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
						<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
							<i class="fas fa-building" style="color: var(--c21-dark); font-size: 18px;"></i>
						</div>
						<div style="flex: 1;">
							<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Этажность</div>
							<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ value }}</div>
						</div>
					</div>
					{% endif %}
					
					{# Тип дома #}
					{% if 'дома' in key and 'Тип' in key %}
					<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
						<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
							<i class="fas fa-warehouse" style="color: var(--c21-dark); font-size: 18px;"></i>
						</div>
						<div style="flex: 1;">
							<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Тип дома</div>
							<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ value }}</div>
						</div>
					</div>
					{% endif %}
					
					{# Количество корпусов #}
					{% if 'корпусов' in key or 'Количество' in key %}
					<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
						<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
							<i class="fas fa-city" style="color: var(--c21-dark); font-size: 18px;"></i>
						</div>
						<div style="flex: 1;">
							<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Количество корпусов</div>
							<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ value }}</div>
						</div>
					</div>
					{% endif %}
				{% endif %}
			{% endfor %}
			
			{# Если нет данных о корпусах в parameters, но есть в korpuses #}
			{% if complex.korpuses and not complex.parameters.items|length %}
			<div class="main-char-item" style="display: flex; align-items: flex-start; gap: 14px; padding: 16px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--c21-gold); transition: all 0.3s;">
				<div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
					<i class="fas fa-city" style="color: var(--c21-dark); font-size: 18px;"></i>
				</div>
				<div style="flex: 1;">
					<div style="font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Количество корпусов</div>
					<div style="font-size: 16px; color: #1e293b; font-weight: 700; line-height: 1.4;">{{ complex.korpuses|length }}</div>
				</div>
			</div>
			{% endif %}
		</div>
	</div>
	
	<style>
	.main-char-item:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0,0,0,0.08);
		background: #ffffff !important;
	}
	
	/* Стили для блока агента */
	.agent-info-section:hover {
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0,0,0,0.08);
		background: #ffffff !important;
	}
	
	.action-btn:hover {
		transform: translateY(-2px);
		box-shadow: 0 8px 20px rgba(0,0,0,0.15);
	}
	
	.mortgage-btn:hover {
		box-shadow: 0 8px 20px rgba(190,175,135,0.5);
	}
	
	.agent-btn:hover {
		background: var(--c21-gold) !important;
		color: var(--c21-dark) !important;
		border-color: var(--c21-gold-dark) !important;
	}
	
	.phone-btn:hover {
		border-color: #10b981 !important;
		background: #f0fdf4 !important;
	}
	
	/* Адаптивность */
	@media (max-width: 768px) {
		.agent-info-grid {
			grid-template-columns: 1fr !important;
			gap: 16px !important;
		}
		
		.agent-info-section {
			flex-direction: column !important;
			text-align: center !important;
			gap: 12px !important;
			padding: 12px !important;
		}
		
		.action-buttons-section {
			gap: 8px !important;
			justify-content: center !important;
		}
		
		.action-btn {
			padding: 10px 16px !important;
			font-size: 13px !important;
		}
	}
	</style>
{% endif %}
	
	{# Детальные характеристики в стиле будущих ЖК #}
{% if is_mongodb and complex.parameters %}
	<div class="detailed-characteristics-section" style="margin: 32px 0;">
		<h2 class="section-title" style="font-size: 28px; font-weight: 700; color: var(--c21-dark); margin-bottom: 16px;">Детальные характеристики</h2>

		{# Основные характеристики: показываем весь словарь параметров как аккуратную сетку #}
		<div class="characteristics-category" style="margin-bottom: 32px;">
			<h3 class="category-title" style="font-size: 20px; font-weight: 700; color: var(--c21-dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--c21-gold);">Основные характеристики</h3>
			<div class="characteristics-grid-detailed" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
				{% for key, value in complex.parameters.items %}
					{% if value and value != '' %}
					<div class="characteristic-detail-item" style="background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px 14px;">
						<div class="characteristic-detail-label" style="font-size:12px; color:#7f8c8d; text-transform:uppercase; letter-spacing:.02em;">{{ key }}</div>
						<div class="characteristic-detail-value" style="font-size:15px; font-weight:700; color:#2c3e50; margin-top:6px;">{{ value }}</div>
					</div>
					{% endif %}
				{% endfor %}
			</div>
		</div>

		{# Дополнительные блоки: сгруппированные, если ключи присутствуют #}
		{% with params=complex.parameters %}
		{% if params|has_key:'Велосипедные дорожки' or params|has_key:'Количество детских площадок' or params|has_key:'Количество спортивных площадок' %}
		<div class="characteristics-category" style="margin-bottom: 32px;">
			<h3 class="category-title" style="font-size: 20px; font-weight: 700; color: var(--c21-dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--c21-gold);">Благоустройство двора</h3>
			<div class="characteristics-grid-detailed" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
				{% if params|get_item:'Велосипедные дорожки' %}
				<div class="characteristic-detail-item" style="background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px 14px;">
					<div class="characteristic-detail-label" style="font-size:12px; color:#7f8c8d; text-transform:uppercase; letter-spacing:.02em;">Велосипедные дорожки</div>
					<div class="characteristic-detail-value" style="font-size:15px; font-weight:700; color:#2c3e50; margin-top:6px;">{{ params|get_item:'Велосипедные дорожки' }}</div>
				</div>
				{% endif %}
				{% if params|get_item:'Количество детских площадок' %}
				<div class="characteristic-detail-item" style="background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px 14px;">
					<div class="characteristic-detail-label" style="font-size:12px; color:#7f8c8d; text-transform:uppercase; letter-spacing:.02em;">Количество детских площадок</div>
					<div class="characteristic-detail-value" style="font-size:15px; font-weight:700; color:#2c3e50; margin-top:6px;">{{ params|get_item:'Количество детских площадок' }}</div>
				</div>
				{% endif %}
				{% if params|get_item:'Количество спортивных площадок' %}
				<div class="characteristic-detail-item" style="background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px 14px;">
					<div class="characteristic-detail-label" style="font-size:12px; color:#7f8c8d; text-transform:uppercase; letter-spacing:.02em;">Количество спортивных площадок</div>
					<div class="characteristic-detail-value" style="font-size:15px; font-weight:700; color:#2c3e50; margin-top:6px;">{{ params|get_item:'Количество спортивных площадок' }}</div>
				</div>
				{% endif %}
			</div>
		</div>
		{% endif %}

		{% if params|has_key:'Наличие пандуса' or params|has_key:'Наличие понижающих площадок' %}
		<div class="characteristics-category" style="margin-bottom: 32px;">
			<h3 class="category-title" style="font-size: 20px; font-weight: 700; color: var(--c21-dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--c21-gold);">Доступная среда</h3>
			<div class="characteristics-grid-detailed" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
				{% if params|get_item:'Наличие пандуса' %}
				<div class="characteristic-detail-item" style="background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px 14px;">
					<div class="characteristic-detail-label" style="font-size:12px; color:#7f8c8d; text-transform:uppercase; letter-spacing:.02em;">Наличие пандуса</div>
					<div class="characteristic-detail-value" style="font-size:15px; font-weight:700; color:#2c3e50; margin-top:6px;">{{ params|get_item:'Наличие пандуса' }}</div>
				</div>
				{% endif %}
				{% if params|get_item:'Наличие понижающих площадок' %}
				<div class="characteristic-detail-item" style="background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px 14px;">
					<div class="characteristic-detail-label" style="font-size:12px; color:#7f8c8d; text-transform:uppercase; letter-spacing:.02em;">Наличие понижающих площадок</div>
					<div class="characteristic-detail-value" style="font-size:15px; font-weight:700; color:#2c3e50; margin-top:6px;">{{ params|get_item:'Наличие понижающих площадок' }}</div>
				</div>
				{% endif %}
			</div>
		</div>
		{% endif %}

		{% if params|has_key:'Количество подъездов' or params|has_key:'Количество пассажирских лифтов' %}
		<div class="characteristics-category" style="margin-bottom: 0;">
			<h3 class="category-title" style="font-size: 20px; font-weight: 700; color: var(--c21-dark); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--c21-gold);">Лифты и подъезды</h3>
			<div class="characteristics-grid-detailed" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px;">
				{% if params|get_item:'Количество подъездов' %}
				<div class="characteristic-detail-item" style="background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px 14px;">
					<div class="characteristic-detail-label" style="font-size:12px; color:#7f8c8d; text-transform:uppercase; letter-spacing:.02em;">Количество подъездов</div>
					<div class="characteristic-detail-value" style="font-size:15px; font-weight:700; color:#2c3e50; margin-top:6px;">{{ params|get_item:'Количество подъездов' }}</div>
				</div>
				{% endif %}
				{% if params|get_item:'Количество пассажирских лифтов' %}
				<div class="characteristic-detail-item" style="background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px 14px;">
					<div class="characteristic-detail-label" style="font-size:12px; color:#7f8c8d; text-transform:uppercase; letter-spacing:.02em;">Количество пассажирских лифтов</div>
					<div class="characteristic-detail-value" style="font-size:15px; font-weight:700; color:#2c3e50; margin-top:6px;">{{ params|get_item:'Количество пассажирских лифтов' }}</div>
				</div>
				{% endif %}
			</div>
		</div>
		{% endif %}
		{% endwith %}
	</div>
	{% endif %}

    <!-- Варианты квартир из MongoDB -->
    {% if not is_secondary and is_mongodb and complex.apartment_variants %}
    <div class="detail-apartments" style="margin: 32px 0;">
        <h2 style="font-size: 28px; font-weight: 600; margin-bottom: 24px;">Варианты квартир</h2>
        
        <!-- Фильтр по типам (только существующие) -->
        <div class="apartment-types-filter" style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
            {% for type in complex.apartment_types %}
            <button class="apt-filter-btn {% if forloop.first %}active{% endif %}" data-type="{{ type }}" onclick="filterApartmentsByType('{{ type }}')" style="padding: 10px 20px; border: 2px solid {% if forloop.first %}#2563eb{% else %}#e5e7eb{% endif %}; background: {% if forloop.first %}#2563eb{% else %}white{% endif %}; color: {% if forloop.first %}white{% else %}#374151{% endif %}; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
                {% if type == 'Студия' %}Студия{% else %}{{type}}-комн{% endif %}
            </button>
            {% endfor %}
        </div>
        
        <!-- Список квартир по типам с пагинацией -->
        {% for apt_type in complex.apartment_types %}
        <div class="apartments-type-section" data-type-section="{{ apt_type }}" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
            <div class="apartments-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                {% for apt in complex.apartment_variants %}
                {% if apt.type == apt_type %}
                <div class="apartment-card" data-apt-type="{{ apt.type }}" data-apt-index="{{ forloop.counter0 }}" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: {% if forloop.counter0 < 6 %}block{% else %}none{% endif %};">
                    <!-- Галерея фото точно как в каталоге -->
                    <div class="compact-card-image-gallery" onclick="openAptGalleryFromCard(this)">
                        {% if apt.layout_photos %}
                            {% for photo in apt.layout_photos %}
                            <img src="{{ photo }}" alt="{{ apt.title }}" class="gallery-image" style="display: {% if forloop.first %}block{% else %}none{% endif %};">
                            {% endfor %}
                            
                            {% if apt.layout_photos|length > 1 %}
                            <button class="gallery-nav gallery-prev" onclick="event.stopPropagation(); changeImage(this, -1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="gallery-nav gallery-next" onclick="event.stopPropagation(); changeImage(this, 1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <div class="gallery-dots">
                                {% for photo in apt.layout_photos %}
                                <span class="dot {% if forloop.first %}active{% endif %}" onclick="event.stopPropagation(); setImage(this, {{ forloop.counter0 }})"></span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% else %}
                            <div style="width: 100%; height: 200px; display: flex; align-items: center; justify-content: center; color: #9ca3af; background: #f3f4f6; flex-direction: column;">
                                <i class="fas fa-image" style="font-size: 48px;"></i>
                                <div style="margin-top: 12px; font-size: 12px; text-align: center;">
                                    Нет фото<br>
                                    Debug: layout_photos = {{ apt.layout_photos|default:"None" }}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Информация о квартире -->
                    <div class="compact-card-content" style="padding: 16px;">
                        <div class="compact-card-header">
                            <h3 class="compact-card-title" style="font-size: 16px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">{{ apt.title }}</h3>
                        </div>
                        <div class="compact-card-price">
                            <div class="compact-price-text" style="font-size: 24px; font-weight: 700; color: #2563eb; margin-bottom: 4px;">{{ apt.price }}</div>
                        </div>
                        {% if apt.price_per_square %}
                        <div class="apt-price-per-m" style="font-size: 14px; color: #6b7280; margin-bottom: 8px;">{{ apt.price_per_square }}</div>
                        {% endif %}
                        <div class="compact-card-details" style="display: flex; flex-direction: column; gap: 4px;">
                            {% if apt.completion_date %}
                            <div class="compact-detail-item" style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #6b7280;">
                                <i class="fas fa-calendar"></i>
                                <span>{{ apt.completion_date }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            
            <!-- Пагинация для этого типа -->
            <div class="apt-pagination" data-type-pagination="{{ apt_type }}" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px;">
                <!-- Будет заполнено через JS -->
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if not is_secondary and not is_mongodb %}
    <!-- Старая версия для SQL -->
    <div class="detail-prices">
        <h2>Цены по типам квартир</h2>
        <div class="prices-grid">
            <div class="price-item">
                <span class="room-type">Студия</span>
                <span class="room-price">от {{ complex.studio_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
            </div>
            <div class="price-item">
                <span class="room-type">1-комн.</span>
                <span class="room-price">от {{ complex.one_room_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
            </div>
            <div class="price-item">
                <span class="room-type">2-комн.</span>
                <span class="room-price">от {{ complex.two_room_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
            </div>
            <div class="price-item">
                <span class="room-type">3-комн.</span>
                <span class="room-price">от {{ complex.three_room_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
            </div>
            <div class="price-item">
                <span class="room-type">4-комн.+</span>
                <span class="room-price">от {{ complex.four_room_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Галерея изображений -->
	<div class="detail-gallery" style="margin: 32px 0;">
		<h2 style="font-size: 28px; font-weight: 600; margin-bottom: 24px;">{% if is_secondary %}Фотографии{% else %}Фотографии ЖК{% endif %}</h2>
		<div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
			{% if is_secondary and complex.photos %}
				{% for photo in complex.photos %}
				<div class="gallery-item" data-image="{{ photo }}" onclick="openGalleryModal({{ forloop.counter0 }})" style="position: relative; border-radius: 12px; overflow: hidden; cursor: pointer; aspect-ratio: 4/3; transition: transform 0.3s;">
					<img src="{{ photo }}" alt="{{ complex.name }}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
					<div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); padding: 12px; color: white; font-size: 14px; opacity: 0; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">
						<i class="fas fa-search-plus"></i> Увеличить
					</div>
				</div>
				{% endfor %}
			{% elif is_mongodb and complex.photos %}
				{% for photo in complex.photos %}
				<div class="gallery-item" data-image="{{ photo }}" onclick="openGalleryModal({{ forloop.counter0 }})" style="position: relative; border-radius: 12px; overflow: hidden; cursor: pointer; aspect-ratio: 4/3; transition: transform 0.3s;">
					<img src="{{ photo }}" alt="{{ complex.name }}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
					<div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); padding: 12px; color: white; font-size: 14px; opacity: 0; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">
						<i class="fas fa-search-plus"></i> Увеличить
					</div>
				</div>
				{% empty %}
				<div class="gallery-item main" data-image="{{ PLACEHOLDER_IMAGE_URL }}" style="position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 4/3;">
					<img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ complex.name }}" style="width: 100%; height: 100%; object-fit: cover;">
				</div>
				{% endfor %}
			{% elif is_mongodb and complex.photos %}
				{% for photo in complex.photos %}
				<div class="gallery-item" data-image="{{ photo }}" onclick="openGalleryModal({{ forloop.counter0 }})" style="position: relative; border-radius: 12px; overflow: hidden; cursor: pointer; aspect-ratio: 4/3; transition: transform 0.3s;">
					<img src="{{ photo }}" alt="{{ complex.name }}" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
					<div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.6), transparent); padding: 12px; color: white; font-size: 14px; opacity: 0; transition: opacity 0.3s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0'">
						<i class="fas fa-search-plus"></i> Увеличить
					</div>
				</div>
				{% endfor %}
			{% else %}
				{% for image in complex.get_images %}
				{% if image.image %}
				<div class="gallery-item {% if image.is_main %}main{% endif %}" data-image="{{ image.image.url }}" onclick="openGalleryModal({{ forloop.counter0 }})" style="position: relative; border-radius: 12px; overflow: hidden; cursor: pointer; aspect-ratio: 4/3;">
					<img src="{{ image.image.url }}" alt="{{ image.title|default:complex.name }}" style="width: 100%; height: 100%; object-fit: cover;">
				</div>
				{% endif %}
				{% empty %}
				<div class="gallery-item main" data-image="{{ PLACEHOLDER_IMAGE_URL }}" style="position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 4/3;">
					<img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ complex.name }}" style="width: 100%; height: 100%; object-fit: cover;">
				</div>
				{% endfor %}
			{% endif %}
		</div>
	</div>
	
	<!-- Модальное окно для галереи -->
	<div id="galleryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; align-items:center; justify-content:center;" onclick="closeGalleryModal()">
		<button onclick="closeGalleryModal()" style="position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.2); border:none; width:50px; height:50px; border-radius:999px; cursor:pointer; color:white; font-size:24px; z-index:10001;">×</button>
		<button onclick="event.stopPropagation(); changeGalleryPhoto(-1)" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.2); border:none; width:50px; height:50px; border-radius:999px; cursor:pointer; color:white; font-size:24px; z-index:10001;">‹</button>
		<button onclick="event.stopPropagation(); changeGalleryPhoto(1)" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); background:rgba(255,255,255,0.2); border:none; width:50px; height:50px; border-radius:999px; cursor:pointer; color:white; font-size:24px; z-index:10001;">›</button>
		<div style="max-width: 90%; max-height: 90%; display: flex; align-items: center; justify-content: center;" onclick="event.stopPropagation()">
			<img id="galleryModalImage" src="" alt="" style="max-width: 100%; max-height: 90vh; object-fit: contain; border-radius: 8px;">
		</div>
		<div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); color:white; padding:10px 20px; border-radius:20px; font-size:16px; z-index:10001;">
			<span id="galleryModalCounter">1</span> / <span id="galleryModalTotal">1</span>
		</div>
	</div>
	
	<!-- Корпуса и сроки сдачи -->
	{% if is_mongodb and complex.korpuses %}
		{% comment %}Показываем секцию только если есть хотя бы один корпус с полными данными{% endcomment %}
		{% for korpus in complex.korpuses %}
			{% if korpus.name and korpus.quarter and korpus.year %}
				{% if forloop.first %}
				<div class="korpuses-section" style="margin: 32px 0;">
					<h2 style="font-size: 28px; font-weight: 600; margin-bottom: 24px;">Корпуса и сроки сдачи</h2>
					<div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
				{% endif %}
						<div style="display: flex; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid #e5e7eb; {% if forloop.counter0|divisibleby:2 %}border-left: 1px solid #e5e7eb;{% endif %}">
							<span style="font-size: 15px; color: #374151; font-weight: 500;">
								<i class="fas fa-building" style="color: #667eea; margin-right: 8px;"></i>{{ korpus.name }}
							</span>
							<span style="font-size: 15px; color: #6b7280; white-space: nowrap;">{{ korpus.quarter }} кв. {{ korpus.year }}</span>
						</div>
				{% if forloop.last %}
						</div>
					</div>
				</div>
				{% endif %}
			{% endif %}
		{% endfor %}
	{% endif %}
	
	<!-- Ход строительства -->
	{% if is_mongodb and complex.construction_progress and complex.construction_progress.construction_stages %}
	<div class="construction-progress-section" style="margin: 32px 0;">
		<h2 style="font-size: 28px; font-weight: 600; margin-bottom: 24px;">Ход строительства</h2>
		<div class="construction-stages-container">
			<!-- Пагинация для этапов строительства -->
			<div class="construction-pagination" style="display: flex; justify-content: center; align-items: center; gap: 16px; margin-bottom: 24px;">
				<button id="prevStagesBtn" class="pagination-btn" style="background: var(--c21-gold); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;" disabled>
					<i class="fas fa-chevron-left"></i> Предыдущие
				</button>
				<span id="stagesInfo" style="color: #666; font-weight: 600;">Этапы 1-3 из {{ complex.construction_progress.construction_stages|length }}</span>
				<button id="nextStagesBtn" class="pagination-btn" style="background: var(--c21-gold); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">
					Следующие <i class="fas fa-chevron-right"></i>
				</button>
			</div>
			
			<!-- Контейнер для карточек этапов -->
			<div id="constructionStagesGrid" class="construction-stages-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
				<!-- Карточки будут загружены через JavaScript -->
			</div>
			
			<!-- Нижняя пагинация -->
			<div class="construction-pagination-bottom" style="display: flex; justify-content: center; margin-top: 32px;">
				<div class="pagination-dots" id="paginationDots" style="display: flex; gap: 8px;">
					<!-- Точки пагинации будут добавлены через JavaScript -->
				</div>
			</div>
		</div>
	</div>
	{% endif %}

	<!-- Карта расположения ЖК -->
	{% if complex.latitude and complex.longitude %}
	<div class="detail-map-section" style="margin: 32px 0;">
		<h2 style="font-size: 28px; font-weight: 600; margin-bottom: 24px;">Расположение ЖК</h2>
		<div class="map-container">
			<div id="detail-map" style="width: 100%; height: 400px; border-radius: 12px; overflow: hidden;"></div>
		</div>
	</div>
	{% endif %}
	
{% if videos %}
<!-- Видеообзоры ЖК плиткой -->
<div class="detail-video" style="margin: 24px 0;">
    <h2>Видеообзоры ЖК</h2>
    <div class="videos-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
        {% for v in videos|slice:':3' %}
        <a href="{% url 'main:video_detail' v.id %}" class="video-card" style="background:#000; border-radius:12px; overflow:hidden; position:relative; aspect-ratio:16/9; text-decoration:none; display:block;">
            {% if v.thumbnail_url %}
                <img src="{{ v.thumbnail_url }}" alt="{{ v.title }}" style="width:100%; height:100%; object-fit:cover;">
                <div style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-play" style="font-size: 48px; color: white;"></i>
                </div>
            {% else %}
                <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; background: #f5f5f5; color: #666;">
                    <i class="fas fa-play" style="font-size: 48px;"></i>
                </div>
            {% endif %}
        </a>
        {% endfor %}
    </div>
    <div style="text-align:center;margin-top:24px;">
        <a class="btn btn-catalog" href="{% url 'main:video_detail' videos.0.id %}">
            <i class="fas fa-play-circle"></i>
            Перейти к видеообзорам ЖК
        </a>
    </div>
</div>
{% endif %}

	{% if complex_offers %}
	<!-- Акции ЖК -->
	<div class="complex-offers-section" style="margin: 32px 0;">
		<div class="offers-header" style="text-align:center;margin-bottom:24px;">
			                <h2 class="section-title" style="font-size:28px;font-weight:700;color:#222;margin:0;">Акции {{ complex.name }}</h2>
		</div>
		<div class="offers-grid" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(400px, 1fr));gap:20px;justify-items:center;">
			{% for offer in complex_offers %}
			<a href="{% url 'main:offer_detail' offer.id %}" class="offer-card" style="width:100%;max-width:600px;display:grid;grid-template-columns:200px 1fr;gap:16px;background:#fff;border:1px solid #efe7ce;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);transition:box-shadow .2s ease, transform .2s ease, border-color .2s ease;text-decoration:none;color:inherit;">
				<div class="offer-media" style="position:relative;border-radius:12px;overflow:hidden;aspect-ratio:16/10;min-height:120px;">
					{% if offer.get_main_image and offer.get_main_image.image %}
						<img src="{{ offer.get_main_image.image.url }}" alt="{{ offer.title }}" loading="lazy" decoding="async" style="width:100%;height:100%;object-fit:cover;display:block;">
					{% else %}
						<img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ offer.title }}" loading="lazy" decoding="async" style="width:100%;height:100%;object-fit:cover;display:block;">
					{% endif %}
					<div class="offer-media::after" style="content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,.00) 40%, rgba(0,0,0,.18) 100%);"></div>
				</div>
				<div class="offer-content" style="display:flex;flex-direction:column;justify-content:space-between;min-height:120px;">
					<div class="offer-head" style="display:flex;align-items:flex-start;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
						<span class="offer-chip" style="display:inline-block;background:var(--c21-dark);color:var(--c21-gold);padding:3px 8px;border-radius:999px;font-weight:700;font-size:11px;white-space:nowrap;">{{ offer.residential_complex.name }}</span>
						<h3 class="offer-title" style="margin:0;font-size:16px;font-weight:800;color:#222;line-height:1.3;word-wrap:break-word;hyphens:auto;">{{ offer.title }}</h3>
					</div>
					<div class="offer-limited" style="display:flex;align-items:center;gap:6px;color:#7b6a3e;background:#faf7ee;border:1px solid #efe7ce;border-radius:8px;padding:6px 8px;margin-top:8px;font-weight:600;font-size:12px;">
						<i class="far fa-clock" style="color:var(--c21-gold);font-size:12px;"></i>
						<span>
							{% if offer.expires_at %}
								До {{ offer.expires_at|date:"d.m.Y" }}
							{% else %}
								Временное предложение
							{% endif %}
						</span>
					</div>
					<div class="offer-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px;justify-content:flex-start;">
						<span class="btn btn-primary btn-small offer-cta" style="flex:none;text-align:center;padding:8px 16px !important;border-radius:8px;background:linear-gradient(180deg,var(--c21-gold), var(--c21-gold-dark)) !important;color:var(--c21-dark) !important;border:none !important;box-shadow:0 4px 12px rgba(190,175,135,.45);font-size:13px;font-weight:700;min-width:140px;">Подробнее об акции</span>
					</div>
				</div>
			</a>
			{% endfor %}
		</div>
        <style>
		.offer-card:hover{box-shadow:0 16px 36px rgba(0,0,0,.14);transform:translateY(-2px);border-color:var(--c21-gold)}
		.offer-cta:hover{filter:brightness(.98);transform:translateY(-1px)}
		</style>
	</div>
	{% endif %}
	
	<!-- Другие проекты агента -->
	{% if agent and agent_other_properties %}
	<div class="agent-properties-section">
		<h2>Другие проекты агента {{ agent.full_name }}</h2>
		<div class="similar-grid">
			{% for property in agent_other_properties %}
			<div class="similar-card">
				<div class="similar-image">
					{% if property.image and property.image.image %}
						<img src="{{ property.image.image.url }}" alt="{{ property.name }}">
					{% else %}
						<img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ property.name }}">
					{% endif %}
					<!-- Бейдж типа недвижимости -->
					<div class="property-type-badge">
						{% if property.type == 'residential' %}
							<span class="badge badge-primary">Новостройка</span>
						{% else %}
							<span class="badge badge-secondary">Вторичная</span>
						{% endif %}
					</div>
				</div>
				<div class="similar-content">
					<h3 class="similar-title">{{ property.name }}</h3>
					<div class="similar-location">{{ property.location }}</div>
					<div class="similar-price">
						{% if property.type == 'residential' %}
							от {{ property.price|floatformat:1 }} млн ₽
						{% else %}
							{{ property.price|floatformat:1 }} млн ₽
						{% endif %}
					</div>
					<a href="{{ property.url }}?agent_id={{ agent.id }}" class="btn btn-outline btn-small" style="margin-top: 8px; width: 100%; justify-content: center;">
						Подробнее
					</a>
				</div>
			</div>
			{% endfor %}
		</div>
		
		<!-- Кнопка "Все объекты агента" -->
		<div style="text-align: center; margin-top: 24px;">
			<a href="{% url 'main:agent_properties' agent.id %}" class="btn btn-secondary">
				<i class="fas fa-building"></i>
				Все объекты агента
			</a>
		</div>
	</div>
	{% endif %}
	
	<!-- Ипотечный калькулятор (новый дизайн) -->
	<div class="mortgage-calculator" id="mortgage">
		<div class="calculator-container">
			<!-- Левая панель - настройки -->
			<div class="calculator-settings">
				<div class="calculator-header">
					<h2 class="calculator-title">
						<i class="fas fa-calculator"></i>
						Ипотека онлайн
						<span class="calculator-note">*</span>
					</h2>
					<p class="calculator-subtitle">Одна заявка во все банки</p>
				</div>
				
				<!-- Скрытое поле с базовой ставкой -->
				<input id="mp-rate-fixed" type="hidden" value="{% if mortgage_programs %}{{ mortgage_programs.first.rate }}{% else %}11.4{% endif %}" />
				
				<div class="settings-form">
					<!-- Тип программы -->
					<div class="form-group">
						<label class="form-label">Тип программы</label>
						<div class="select-wrapper">
							<select id="mp-program" class="form-select">
								{% for p in mortgage_programs %}
								<option value="{{ p.rate }}">{{ p.name }}{% if p.is_individual %} (индивидуальная){% endif %}</option>
								{% endfor %}
							</select>
							<i class="fas fa-chevron-down select-icon"></i>
						</div>
					</div>
					
					<!-- Стоимость недвижимости -->
					<div class="form-group">
						<label class="form-label">Стоимость недвижимости</label>
						<div class="input-wrapper">
							<input id="mp-price-input" class="form-input" type="text" inputmode="numeric" value="5 000 000"/>
							<span class="input-currency">₽</span>
						</div>
						<input id="mp-price" class="form-range" type="range" min="800000" max="87500000" step="50000" value="5000000"/>
					</div>
					
					<!-- Первоначальный взнос -->
					<div class="form-group">
						<label class="form-label">Первоначальный взнос</label>
						<div class="input-wrapper">
							<input id="mp-down-amt-input" class="form-input" type="text" inputmode="numeric" value="1 000 000"/>
							<span class="input-currency">₽</span>
						</div>
						<div class="range-wrapper">
							<input id="mp-down" class="form-range" type="range" min="10" max="80" step="1" value="20"/>
							<span id="mp-down-pct-view" class="range-percentage">20%</span>
						</div>
					</div>
					
					<!-- Срок кредита -->
					<div class="form-group">
						<label class="form-label">Срок кредита</label>
						<div class="input-wrapper">
							<input id="mp-years-input" class="form-input form-input-small" type="number" min="3" max="30" step="1" value="30"/>
							<span class="input-unit">лет</span>
						</div>
						<input id="mp-years" class="form-range" type="range" min="3" max="30" step="1" value="30"/>
					</div>
				</div>
			</div>
			
			<!-- Правая панель - результаты -->
			<div class="calculator-results">
				<div class="results-header">
					<h3 class="results-title">Расчёт ипотеки</h3>
				</div>
				
				<div class="results-content">
					<div class="result-item main-result">
						<div class="result-label">Ежемесячный платёж</div>
						<div id="mp-month" class="result-value">60 283 ₽</div>
					</div>
					
					<div class="result-item">
						<div class="result-label">Процентная ставка</div>
						<div id="mp-rate-text" class="result-value">от 18.0 %</div>
					</div>
					
					<div class="result-item">
						<div class="result-label">Сумма кредита</div>
						<div id="mp-loan" class="result-value">4 000 000 ₽</div>
					</div>
				</div>
				
				<div class="bank-logos">
					<img src="/media/logo/banks.png" alt="Банки-партнёры" class="bank-logos-img"/>
				</div>
				
				<div class="results-actions">
                    <a href="#feedback-title" class="btn btn-catalog anchor-feedback-btn">
						<i class="fas fa-paper-plane"></i>
						Подать заявку
					</a>
				</div>
				
				<div class="calculator-disclaimer">
					* Расчёт примерный. Уточняйте актуальную информацию у нашего специалиста, оставив заявку
				</div>
			</div>
		</div>
	</div>
	
    <!-- Блок с ценами был перенесён выше фотографий и здесь удалён -->
	
    <!-- Кнопка перехода к каталогу перед похожими ЖК -->
    <div style="margin: 24px 0; text-align: center;">
        <a href="{% if is_secondary %}{% url 'main:secondary_index' %}{% else %}{% url 'main:catalog' %}{% endif %}" class="btn btn-catalog">
            <i class="fas fa-th-large"></i>
            Назад в каталог ЖК
        </a>
    </div>

    <!-- Похожие ЖК -->
	{% if similar_complexes %}
	<div class="similar-complexes">
		<h2>{% if agent %}Другие похожие ЖК{% else %}Похожие ЖК{% endif %}</h2>
		<div class="similar-grid">
			{% for similar in similar_complexes %}
			<div class="similar-card">
				<div class="similar-image">
					{% if similar.get_main_image and similar.get_main_image.image %}
						<img src="{{ similar.get_main_image.image.url }}" alt="{{ similar.name }}">
					{% else %}
						<img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ similar.name }}">
					{% endif %}
				</div>
				<div class="similar-content">
					<h3 class="similar-title">{{ similar.name }}</h3>
					<div class="similar-location">{{ similar.district|default:similar.city }}</div>
					<div class="similar-price">от {{ similar.price_from|floatformat:1 }} млн ₽</div>
				</div>
			</div>
			{% endfor %}
		</div>
	</div>
	{% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
	// Функциональность галереи изображений
	const galleryItems = document.querySelectorAll('.gallery-item');
	const heroImage = document.querySelector('.hero-main-image');
	const prevBtn = document.querySelector('.photo-nav-btn.prev');
	const nextBtn = document.querySelector('.photo-nav-btn.next');
	let currentIndex = 0;
	const allItems = Array.from(galleryItems);
	function setActiveByIndex(idx){
		if (!allItems.length) return;
		currentIndex = (idx + allItems.length) % allItems.length;
		const newActive = allItems[currentIndex];
		allItems.forEach(i => i.classList.remove('active'));
		newActive.classList.add('active');
		const imageUrl = newActive.getAttribute('data-image') || newActive.querySelector('img')?.src;
		if (imageUrl && heroImage) heroImage.src = imageUrl;
	}
	// Инициализация активного
	if (allItems.length){
		const initial = document.querySelector('.gallery-item.main') || allItems[0];
		currentIndex = allItems.indexOf(initial);
		setActiveByIndex(currentIndex);
	}

	galleryItems.forEach(item => {
		item.addEventListener('click', function() {
			const idx = allItems.indexOf(this);
			setActiveByIndex(idx);
		});
	});
	
	// Автопрокрутка каждые 5 секунд
	let slideshowTimer = null;
	function startSlideshow(){
		stopSlideshow();
		slideshowTimer = setInterval(()=> setActiveByIndex(currentIndex + 1), 5000);
	}
	function stopSlideshow(){ if (slideshowTimer) { clearInterval(slideshowTimer); slideshowTimer = null; } }
	startSlideshow();
	
	// Кнопки навигации
	prevBtn?.addEventListener('click', function(){ stopSlideshow(); setActiveByIndex(currentIndex - 1); startSlideshow(); });
	nextBtn?.addEventListener('click', function(){ stopSlideshow(); setActiveByIndex(currentIndex + 1); startSlideshow(); });

	// Функциональность кнопок действий
	const actionItems = document.querySelectorAll('.action-item');
	actionItems.forEach(item => {
		item.addEventListener('click', function() {
			const actionText = this.querySelector('span').textContent;});
	});
	
	// Функциональность избранного
	const favoriteBtn = document.querySelector('.favorite-btn');
	if (favoriteBtn) {
		favoriteBtn.addEventListener('click', function() {
			this.classList.toggle('active');
			const icon = this.querySelector('i');
			if (this.classList.contains('active')) {
				icon.className = 'fas fa-heart';
			} else {
				icon.className = 'far fa-heart';
			}
		});
	}
	
	const mortgageBtn = document.querySelector('.mortgage-btn');
	if (mortgageBtn) {
		mortgageBtn.addEventListener('click', function() {
			// smooth scroll handled via anchor; no alerts
		});
	}
	
	// Функциональность навигации по фото
	const photoNavBtns = document.querySelectorAll('.photo-nav-btn');
	photoNavBtns.forEach(btn => {
		btn.addEventListener('click', function() {
			const isNext = this.classList.contains('next');
			const currentActive = document.querySelector('.gallery-item.active') || document.querySelector('.gallery-item');
			const allItems = document.querySelectorAll('.gallery-item');
			const currentIndex = Array.from(allItems).indexOf(currentActive);
			
			let newIndex;
			if (isNext) {
				newIndex = (currentIndex + 1) % allItems.length;
			} else {
				newIndex = currentIndex === 0 ? allItems.length - 1 : currentIndex - 1;
			}
			
			const newActive = allItems[newIndex];
			if (newActive) {
				allItems.forEach(item => item.classList.remove('active'));
				newActive.classList.add('active');
				
				const imageUrl = newActive.getAttribute('data-image');
				if (imageUrl && heroImage) {
					heroImage.src = imageUrl;
				}
			}
		});
	});
	
	// Ипотечный калькулятор (обновлён под новый дизайн)
	(function(){
		const baseRateEl = document.getElementById('mp-rate-fixed');
		const program = document.getElementById('mp-program');
		const price = document.getElementById('mp-price');
		const down = document.getElementById('mp-down');
		const years = document.getElementById('mp-years');
		const monthEl = document.getElementById('mp-month');
		const loanEl = document.getElementById('mp-loan');
		const rateText = document.getElementById('mp-rate-text');
		const downPctView = document.getElementById('mp-down-pct-view');
		const priceInput = document.getElementById('mp-price-input');
		const downAmtInput = document.getElementById('mp-down-amt-input');
		const yearsInput = document.getElementById('mp-years-input');
		function fmt(n){ return new Intl.NumberFormat('ru-RU').format(Math.round(n)); }
		function parseNum(v){ return Number(String(v||'').replace(/[^\d]/g,'')) || 0; }
		function formatInputKeepCaret(inputEl){
			const start = inputEl.selectionStart || 0;
			const leftDigits = (inputEl.value.slice(0, start).match(/\d/g) || []).length;
			const digits = inputEl.value.replace(/[^\d]/g,'');
			const formatted = digits.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
			inputEl.value = formatted;
			let pos = 0, seen = 0;
			while (pos < formatted.length && seen < leftDigits){
				if (/\d/.test(formatted.charAt(pos))) seen++;
				pos++;
			}
			inputEl.setSelectionRange(pos, pos);
		}
		function calc(){
			const p = priceInput ? (parseNum(priceInput.value) || Number(price.value)) : Number(price.value);
			const downPct = Number(down.value)/100;
			const rateVal = program ? Number(program.value || baseRateEl?.value || 11.4) : Number(baseRateEl?.value || 11.4);
			const rate = rateVal/100; // годовая
			const n = Number(years.value) * 12;
			const monthlyRate = rate/12;
			const firstPay = p * downPct;
			const loan = Math.max(0, p - firstPay);
			const annuity = monthlyRate ? loan * (monthlyRate * Math.pow(1+monthlyRate, n)) / (Math.pow(1+monthlyRate, n) - 1) : (n ? loan/n : 0);
			monthEl.textContent = fmt(annuity) + ' ₽';
			loanEl.textContent = fmt(loan) + ' ₽';
			if (rateText) rateText.textContent = 'от ' + (rateVal.toFixed(1)) + ' %';
			if (downPctView) downPctView.textContent = Math.round(downPct*100) + '%';
			if (yearsInput) yearsInput.value = Number(years.value);
		}
		['change','input'].forEach(ev=>{
			program && program.addEventListener(ev, calc);
			years.addEventListener(ev, calc);
		});
		// Sync from range: price -> text + amount
		price.addEventListener('input', function(){
			const val = Number(price.value);
			if (priceInput){ priceInput.value = fmt(val); }
			if (downAmtInput){ downAmtInput.value = fmt(val * (Number(down.value)/100)); downAmtInput.max = String(val); }
			calc();
		});
		// Sync from down slider -> amount
		down.addEventListener('input', function(){
			const p = priceInput ? (parseNum(priceInput.value) || Number(price.value)) : Number(price.value);
			if (downAmtInput){ downAmtInput.value = fmt(p * (Number(down.value)/100)); }
			calc();
		});
		// Ручной ввод цены с живым форматированием
		if (priceInput){
			priceInput.addEventListener('input', function(){
				formatInputKeepCaret(this);
				const raw = parseNum(this.value);
				if (downAmtInput){ downAmtInput.max = String(raw); }
				calc();
			});
			priceInput.addEventListener('blur', function(){
				const min = Number(price.min), max = Number(price.max);
				let val = parseNum(this.value);
				val = Math.max(min, Math.min(max, val));
				this.value = fmt(val);
				price.value = String(val);
				if (downAmtInput){ downAmtInput.max = String(val); downAmtInput.value = fmt(val * (Number(down.value)/100)); }
				calc();
			});
		}
		// Ручной ввод суммы первоначального взноса с живым форматированием
		if (downAmtInput){
			downAmtInput.addEventListener('input', function(){
				formatInputKeepCaret(this);
				const p = priceInput ? (parseNum(priceInput.value) || Number(price.value)) : Number(price.value);
				let amt = parseNum(this.value);
				amt = Math.max(0, Math.min(p, amt));
				const pctRaw = p ? (amt / p) * 100 : 0;
				const pct = Math.min(80, Math.max(10, Math.round(pctRaw)));
				down.value = String(pct);
				calc();
			});
			downAmtInput.addEventListener('blur', function(){
				const p = priceInput ? (parseNum(priceInput.value) || Number(price.value)) : Number(price.value);
				let amt = parseNum(this.value);
				amt = Math.max(0, Math.min(p, amt));
				this.value = fmt(amt);
			});
		}
		if (yearsInput){
			yearsInput.addEventListener('input', function(){
				const min = Number(years.min), max = Number(years.max);
				let val = Number(this.value||0);
				val = Math.max(min, Math.min(max, val));
				years.value = String(val);
				calc();
			});
		}
		// начальная отрисовка и форматирование
		if (priceInput){ priceInput.value = fmt(Number(price.value)); }
		if (downAmtInput){ const p0 = Number(price.value); downAmtInput.value = fmt(p0 * (Number(down.value)/100)); downAmtInput.max = String(p0); }
		calc();
	})();

	// Функциональность похожих ЖК
	const similarCards = document.querySelectorAll('.similar-card');
	similarCards.forEach(card => {
		card.addEventListener('click', function() {});
	});


	// Плавный скролл к блоку ипотеки
	document.querySelectorAll('a[href="#mortgage"]').forEach(a=>{
		a.addEventListener('click', function(e){
			const target = document.getElementById('mortgage');
			if (target) {
				e.preventDefault();
				const top = target.getBoundingClientRect().top + window.pageYOffset - 30;
				window.scrollTo({ top, behavior: 'smooth' });
			}
		});
	});
});
</script>

<style>
/* Стили для секции "Другие проекты агента" */
.agent-properties-section {
	margin: 40px 0;
	padding: 32px;
	background: #f8f9fa;
	border-radius: 16px;
}

.agent-properties-section h2 {
	color: var(--c21-dark);
	margin-bottom: 24px;
	text-align: center;
}

.property-type-badge {
	position: absolute;
	top: 12px;
	right: 12px;
	z-index: 2;
}

.badge {
	padding: 4px 8px;
	border-radius: 999px;
	font-size: 11px;
	font-weight: 700;
	text-transform: uppercase;
	letter-spacing: 0.5px;
}

.badge-primary {
	background: var(--c21-gold);
	color: var(--c21-dark);
}

.badge-secondary {
	background: #6c757d;
	color: white;
}

@media (max-width: 768px) {
	.agent-properties-section {
		padding: 24px 16px;
	}
}

/* Стили для карты расположения */
.detail-map-section {
	margin: 32px 0;
}

.detail-map-section h2 {
	margin-bottom: 20px;
	color: var(--c21-dark);
}

.map-container {
	border-radius: 12px;
	overflow: hidden;
	box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}
</style>

<script>
// Инициализация карты расположения ЖК
document.addEventListener('DOMContentLoaded', function() {
	{% if complex.latitude and complex.longitude %}
	const mapElement = document.getElementById('detail-map');
	if (mapElement && typeof L !== 'undefined') {
		try {
			// Координаты ЖК из базы данных
			const complexCoords = [{{ complex.latitude }}, {{ complex.longitude }}];
			
			// Создаем карту
			const map = L.map('detail-map', { 
				attributionControl: false,
				zoomControl: true,
				scrollWheelZoom: true
			});
			
			// Добавляем слой карты
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; OpenStreetMap'
			}).addTo(map);
			
			// Устанавливаем центр и зум
			map.setView(complexCoords, 15);
			
			// Добавляем маркер ЖК
			const marker = L.marker(complexCoords).addTo(map);
			marker.bindPopup(`
				<div style="text-align: center; padding: 8px;">
					<h4 style="margin: 0; color: #333;">{{ complex.name }}</h4>
				</div>
			`);
			
			// Открываем попап сразу
			marker.openPopup();} catch (error) {
			console.error('Ошибка при инициализации карты ЖК:', error);
		}
	}
	{% endif %}
});
</script>

<script>
// JavaScript для MongoDB версии
{% if is_mongodb %}

// Навигация по фото в hero секции
let currentHeroPhotoIndex = 0;
const heroImages = document.querySelectorAll('#heroGallery .hero-main-image');

function changeHeroPhoto(direction) {
	if (heroImages.length <= 1) return;
	
	heroImages[currentHeroPhotoIndex].style.display = 'none';
	currentHeroPhotoIndex = (currentHeroPhotoIndex + direction + heroImages.length) % heroImages.length;
	heroImages[currentHeroPhotoIndex].style.display = 'block';
	
	const counter = document.getElementById('currentPhotoIndex');
	if (counter) counter.textContent = currentHeroPhotoIndex + 1;
}

// Модальное окно галереи (унифицированное)
let currentGalleryIndex = 0;
const galleryPhotos = {{ complex.photos_json|safe }} || [];
let galleryActivePhotos = galleryPhotos.slice();

function resolveImageUrl(pathOrUrl) {
    if (!pathOrUrl) return '';
    // Если это уже полный URL (S3 или любой другой), возвращаем как есть
    if (pathOrUrl.startsWith('http://') || pathOrUrl.startsWith('https://')) {
        return pathOrUrl;
    }
    // Для относительных путей (если остались) добавляем /media/
    try {
        const u = new URL(pathOrUrl, window.location.origin);
        const p = u.pathname;
        return p.startsWith('/media/') ? p : '/media/' + p.replace(/^\//, '');
    } catch (e) {
        return pathOrUrl.startsWith('/media/') ? pathOrUrl : '/media/' + pathOrUrl.replace(/^\//, '');
    }
}

function openGalleryWithPhotos(photos, startIndex) {
    galleryActivePhotos = (photos || []).map(resolveImageUrl);
    if (!Number.isFinite(startIndex) || startIndex < 0) startIndex = 0;
    currentGalleryIndex = Math.min(startIndex, Math.max(0, galleryActivePhotos.length - 1));
    const modal = document.getElementById('galleryModal');
    const img = document.getElementById('galleryModalImage');
    const counter = document.getElementById('galleryModalCounter');
    const total = document.getElementById('galleryModalTotal');
    if (modal && img && galleryActivePhotos.length) {
        img.src = galleryActivePhotos[currentGalleryIndex];
        if (counter) counter.textContent = currentGalleryIndex + 1;
        if (total) total.textContent = galleryActivePhotos.length;
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function openGalleryModal(index) {
    openGalleryWithPhotos(galleryPhotos, index);
}

function openAptGalleryFromCard(containerEl) {
    if (!containerEl) return;
    const imgs = containerEl.querySelectorAll('img.gallery-image');
    const photos = Array.from(imgs).map(img => img.getAttribute('src'));
    openGalleryWithPhotos(photos, 0);
}

function closeGalleryModal() {
	const modal = document.getElementById('galleryModal');
	if (modal) {
		modal.style.display = 'none';
		document.body.style.overflow = '';
	}
}

function changeGalleryPhoto(direction) {
    if (!galleryActivePhotos.length) return;
    currentGalleryIndex = (currentGalleryIndex + direction + galleryActivePhotos.length) % galleryActivePhotos.length;
    const img = document.getElementById('galleryModalImage');
    const counter = document.getElementById('galleryModalCounter');
    if (img && counter) {
        img.src = galleryActivePhotos[currentGalleryIndex];
        counter.textContent = currentGalleryIndex + 1;
    }
}

// Клавиши для навигации в галерее
document.addEventListener('keydown', function(e) {
	const modal = document.getElementById('galleryModal');
	if (modal && modal.style.display === 'flex') {
		if (e.key === 'ArrowLeft') changeGalleryPhoto(-1);
		if (e.key === 'ArrowRight') changeGalleryPhoto(1);
		if (e.key === 'Escape') closeGalleryModal();
	}
	
});

// Переключение типов квартир
function filterApartmentsByType(type) {
	// Скрываем все секции
	const sections = document.querySelectorAll('.apartments-type-section');
	sections.forEach(section => {
		section.style.display = 'none';
	});
	
	// Показываем выбранную секцию
	const activeSection = document.querySelector(`[data-type-section="${type}"]`);
	if (activeSection) {
		activeSection.style.display = 'block';
		initializePagination(type);
	}
	
	// Обновляем стили кнопок
	const buttons = document.querySelectorAll('.apt-filter-btn');
	buttons.forEach(btn => {
		if (btn.dataset.type === type) {
			btn.style.background = '#2563eb';
			btn.style.color = 'white';
			btn.style.borderColor = '#2563eb';
			btn.classList.add('active');
		} else {
			btn.style.background = 'white';
			btn.style.color = '#374151';
			btn.style.borderColor = '#e5e7eb';
			btn.classList.remove('active');
		}
	});
}

// Инициализация пагинации для типа квартир
function initializePagination(type) {
	const section = document.querySelector(`[data-type-section="${type}"]`);
	if (!section) return;
	
	const cards = section.querySelectorAll('.apartment-card');
	const totalCards = cards.length;
	const perPage = 6;
	const totalPages = Math.ceil(totalCards / perPage);
	
	if (totalPages <= 1) {
		// Если страница одна, скрываем пагинацию
		const pagination = section.querySelector('.apt-pagination');
		if (pagination) pagination.style.display = 'none';
		return;
	}
	
	// Показываем пагинацию
	const pagination = section.querySelector('.apt-pagination');
	if (pagination) {
		pagination.style.display = 'flex';
		renderPagination(type, 1, totalPages);
		showPage(type, 1, perPage);
	}
}

// Отображение страницы
function showPage(type, page, perPage) {
	const section = document.querySelector(`[data-type-section="${type}"]`);
	if (!section) return;
	
	const cards = section.querySelectorAll('.apartment-card');
	const start = (page - 1) * perPage;
	const end = start + perPage;
	
	cards.forEach((card, index) => {
		if (index >= start && index < end) {
			card.style.display = 'block';
		} else {
			card.style.display = 'none';
		}
	});
	
	// Прокрутка к началу секции
	section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Рендеринг кнопок пагинации
function renderPagination(type, currentPage, totalPages) {
	const pagination = document.querySelector(`[data-type-pagination="${type}"]`);
	if (!pagination) return;
	
	let html = '';
	
	// Кнопка "Назад"
	if (currentPage > 1) {
		html += `<button onclick="changePage('${type}', ${currentPage - 1})" style="padding: 8px 12px; border: 1px solid #e5e7eb; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s;"><i class="fas fa-chevron-left"></i></button>`;
	}
	
	// Кнопки страниц
	for (let i = 1; i <= totalPages; i++) {
		if (i === currentPage) {
			html += `<button style="padding: 8px 12px; border: 2px solid #2563eb; background: #2563eb; color: white; border-radius: 6px; font-weight: 600; font-size: 14px;">${i}</button>`;
		} else {
			html += `<button onclick="changePage('${type}', ${i})" style="padding: 8px 12px; border: 1px solid #e5e7eb; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s;">${i}</button>`;
		}
	}
	
	// Кнопка "Вперед"
	if (currentPage < totalPages) {
		html += `<button onclick="changePage('${type}', ${currentPage + 1})" style="padding: 8px 12px; border: 1px solid #e5e7eb; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s;"><i class="fas fa-chevron-right"></i></button>`;
	}
	
	pagination.innerHTML = html;
}

// Смена страницы
function changePage(type, page) {
	const section = document.querySelector(`[data-type-section="${type}"]`);
	if (!section) return;
	
	const cards = section.querySelectorAll('.apartment-card');
	const totalPages = Math.ceil(cards.length / 6);
	
	renderPagination(type, page, totalPages);
	showPage(type, page, 6);
}

// Функции для галереи фото (как в каталоге)
window.changeImage = function(button, direction) {
	const gallery = button.parentElement;
	const images = gallery.querySelectorAll('.gallery-image');
	const dots = gallery.querySelectorAll('.dot');
	let currentIndex = 0;
	
	// Находим текущий индекс
	images.forEach((img, i) => {
		if (img.style.display === 'block') {
			currentIndex = i;
		}
	});
	
	// Вычисляем новый индекс
	let newIndex = currentIndex + direction;
	if (newIndex < 0) newIndex = images.length - 1;
	if (newIndex >= images.length) newIndex = 0;
	
	// Переключаем изображения
	images[currentIndex].style.display = 'none';
	images[newIndex].style.display = 'block';
	
	// Переключаем точки
	if (dots.length > 0) {
		dots[currentIndex].classList.remove('active');
		dots[newIndex].classList.add('active');
	}
}

window.setImage = function(dot, index) {
	const gallery = dot.parentElement.parentElement;
	const images = gallery.querySelectorAll('.gallery-image');
	const dots = gallery.querySelectorAll('.dot');
	
	// Скрываем все изображения
	images.forEach(img => img.style.display = 'none');
	// Показываем выбранное
	if (images[index]) images[index].style.display = 'block';
	
	// Обновляем точки
	dots.forEach((d, i) => {
		if (i === index) {
			d.classList.add('active');
		} else {
			d.classList.remove('active');
		}
	});
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
	// Инициализируем пагинацию для первого типа
	const firstBtn = document.querySelector('.apt-filter-btn');
	if (firstBtn) {
		const firstType = firstBtn.dataset.type;
		initializePagination(firstType);
	}
});


// Hover эффекты для кнопок фильтра
document.addEventListener('DOMContentLoaded', function() {
	const filterBtns = document.querySelectorAll('.apt-filter-btn');
	filterBtns.forEach(btn => {
		btn.addEventListener('mouseenter', function() {
			if (!this.classList.contains('active')) {
				this.style.borderColor = '#2563eb';
				this.style.color = '#2563eb';
			}
		});
		btn.addEventListener('mouseleave', function() {
			if (!this.classList.contains('active')) {
				this.style.borderColor = '#e5e7eb';
				this.style.color = '#374151';
			}
		});
	});
	
	// Hover для карточек квартир
	const aptCards = document.querySelectorAll('.apartment-card');
	aptCards.forEach(card => {
		card.addEventListener('mouseenter', function() {
			this.style.transform = 'translateY(-4px)';
			this.style.boxShadow = '0 12px 24px rgba(0,0,0,0.15)';
		});
		card.addEventListener('mouseleave', function() {
			this.style.transform = 'translateY(0)';
			this.style.boxShadow = 'none';
		});
	});
});

{% endif %}
</script>

<style>
/* Стили для секции хода строительства */
.construction-stage-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.construction-stage-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
}

.stage-header {
    background: linear-gradient(135deg, var(--c21-gold), #d4af37);
    color: white;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 60px;
}

.stage-number {
    font-size: 16px;
    font-weight: 700;
    flex: 1;
    margin-right: 12px;
}

.stage-date {
    font-size: 12px;
    opacity: 0.9;
    text-align: right;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 180px;
}

.stage-photos-container {
    position: relative;
    min-height: 200px;
}

.stage-photos {
    position: relative;
    height: 200px;
    overflow: hidden;
}

.stage-photo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease;
}

.stage-photos-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    opacity: 0;
}

.stage-photos-container:hover .stage-photos-nav {
    opacity: 1;
}

.stage-photos-nav:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: translateY(-50%) scale(1.1);
}

.stage-photos-nav.prev {
    left: 10px;
}

.stage-photos-nav.next {
    right: 10px;
}

.stage-photos-dots {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
}

.stage-photos-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
}

.stage-photos-dot.active {
    background: white;
    transform: scale(1.2);
}

.stage-no-photos {
    height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #999;
    background: #f8f9fa;
}

.stage-no-photos i {
    font-size: 32px;
    margin-bottom: 8px;
    opacity: 0.5;
}

.pagination-btn:disabled {
    background: #ddd !important;
    color: #999 !important;
    cursor: not-allowed !important;
}

.pagination-btn:hover:not(:disabled) {
    background: var(--c21-gold-dark) !important;
    transform: translateY(-2px);
}

.pagination-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #ddd;
    cursor: pointer;
    transition: all 0.3s ease;
}

.pagination-dot.active {
    background: var(--c21-gold);
    transform: scale(1.2);
}

.pagination-dot:hover {
    background: var(--c21-gold);
    opacity: 0.7;
}

/* Мобильная адаптация */
@media (max-width: 768px) {
    .construction-stages-grid {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
    }
    
    .construction-pagination {
        flex-direction: column;
        gap: 12px !important;
    }
    
    .pagination-btn {
        width: 100%;
        max-width: 200px;
    }
    
    .stage-header {
        flex-direction: column;
        gap: 8px;
        text-align: center;
    }
}

/* Дополнительные стили для MongoDB версии */
{% if is_mongodb %}
.apartment-card {
	box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.apt-filter-btn:hover {
	transform: translateY(-2px);
}

.gallery-item:hover img {
	transform: scale(1.05);
}

@media (max-width: 768px) {
	.apartments-grid {
		grid-template-columns: 1fr !important;
	}
	
	.apartment-types-filter {
		overflow-x: auto;
		flex-wrap: nowrap !important;
	}
	
	.apt-filter-btn {
		white-space: nowrap;
	}
}
{% endif %}
</style>

<!-- JavaScript для секции хода строительства -->
{% if is_mongodb and complex.construction_progress and complex.construction_progress.construction_stages %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const stages = {{ complex.construction_progress.construction_stages|safe }};
    const stagesPerPage = 3;
    let currentPage = 0;
    const totalPages = Math.ceil(stages.length / stagesPerPage);
    
    const prevBtn = document.getElementById('prevStagesBtn');
    const nextBtn = document.getElementById('nextStagesBtn');
    const stagesInfo = document.getElementById('stagesInfo');
    const stagesGrid = document.getElementById('constructionStagesGrid');
    const paginationDots = document.getElementById('paginationDots');
    
    // Функция для создания карточки этапа
    function createStageCard(stage) {
        const photos = stage.photos || [];
        const photoHtml = photos.length > 0 ? photos.map((photo, index) => {
            const photoUrl = photo.startsWith('http') ? photo : `/media/${photo}`;
            return `<img src="${photoUrl}" alt="Этап ${stage.stage_number}" class="stage-photo" style="display: ${index === 0 ? 'block' : 'none'};">`;
        }).join('') : '';
        
        const navigationHtml = photos.length > 1 ? `
            <button class="stage-photos-nav prev" onclick="changeStagePhoto(this, -1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="stage-photos-nav next" onclick="changeStagePhoto(this, 1)">
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="stage-photos-dots">
                ${photos.map((_, index) => 
                    `<span class="stage-photos-dot ${index === 0 ? 'active' : ''}" onclick="setStagePhoto(this, ${index})"></span>`
                ).join('')}
            </div>
        ` : '';
        
        const noPhotosHtml = photos.length === 0 ? `
            <div class="stage-no-photos">
                <i class="fas fa-image"></i>
                <span>Фотографии отсутствуют</span>
            </div>
        ` : '';
        
        return `
            <div class="construction-stage-card">
                <div class="stage-header">
                    <div class="stage-number">Этап ${stage.stage_number}</div>
                    <div class="stage-date" title="${stage.date}">${stage.date}</div>
                </div>
                <div class="stage-photos-container">
                    ${photos.length > 0 ? `
                        <div class="stage-photos">
                            ${photoHtml}
                            ${navigationHtml}
                        </div>
                    ` : noPhotosHtml}
                </div>
            </div>
        `;
    }
    
    // Функция для обновления отображения этапов
    function updateStagesDisplay() {
        const startIndex = currentPage * stagesPerPage;
        const endIndex = Math.min(startIndex + stagesPerPage, stages.length);
        const currentStages = stages.slice(startIndex, endIndex);
        
        stagesGrid.innerHTML = currentStages.map(stage => createStageCard(stage)).join('');
        
        // Обновляем информацию о страницах
        stagesInfo.textContent = `Этапы ${startIndex + 1}-${endIndex} из ${stages.length}`;
        
        // Обновляем состояние кнопок
        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage === totalPages - 1;
        
        // Обновляем точки пагинации
        updatePaginationDots();
    }
    
    // Функция для обновления точек пагинации
    function updatePaginationDots() {
        paginationDots.innerHTML = '';
        for (let i = 0; i < totalPages; i++) {
            const dot = document.createElement('span');
            dot.className = `pagination-dot ${i === currentPage ? 'active' : ''}`;
            dot.onclick = () => goToPage(i);
            paginationDots.appendChild(dot);
        }
    }
    
    // Функция для перехода на страницу
    function goToPage(page) {
        if (page >= 0 && page < totalPages) {
            currentPage = page;
            updateStagesDisplay();
        }
    }
    
    // Обработчики кнопок
    prevBtn.addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            updateStagesDisplay();
        }
    });
    
    nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages - 1) {
            currentPage++;
            updateStagesDisplay();
        }
    });
    
    // Инициализация
    updateStagesDisplay();
    
    // Глобальные функции для навигации по фотографиям
    window.changeStagePhoto = function(button, direction) {
        const card = button.closest('.construction-stage-card');
        const photos = card.querySelectorAll('.stage-photo');
        const dots = card.querySelectorAll('.stage-photos-dot');
        
        let currentIndex = 0;
        photos.forEach((photo, index) => {
            if (photo.style.display === 'block') {
                currentIndex = index;
            }
        });
        
        const newIndex = (currentIndex + direction + photos.length) % photos.length;
        
        photos[currentIndex].style.display = 'none';
        photos[newIndex].style.display = 'block';
        
        dots[currentIndex].classList.remove('active');
        dots[newIndex].classList.add('active');
    };
    
    window.setStagePhoto = function(dot, index) {
        const card = dot.closest('.construction-stage-card');
        const photos = card.querySelectorAll('.stage-photo');
        const dots = card.querySelectorAll('.stage-photos-dot');
        
        photos.forEach(photo => photo.style.display = 'none');
        photos[index].style.display = 'block';
        
        dots.forEach(d => d.classList.remove('active'));
        dots[index].classList.add('active');
    };
});
</script>
{% endif %}

{% endblock %} 
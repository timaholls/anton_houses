{% extends 'base.html' %}
{% load static %}

{% block title %}{% if landing and landing.meta_title %}{{ landing.meta_title }}{% elif page_title %}{{ page_title }} —
CENTURY 21{% else %}CENTURY 21 - Каталог ЖК{% endif %}{% endblock %}

{% block extra_css %}
<style>
    /* Специальные правки страницы каталога ЖК (без адаптива) */
    .catalog-section~.feedback-wrapper {
        margin-top: 100px !important;
        padding: 120px 0 250px 0 !important;
    }

    .catalog-section~.feedback-wrapper .feedback-container {
        margin-bottom: 200px !important;
    }

    .catalog-section~.footer-transition {
        padding-top: 200px !important;
    }

    .catalog-section~.footer-transition .deco-logo.on-dark {
        top: 40px !important;
        z-index: 200 !important;
    }

    .catalog-section~.footer .footer-content {
        margin-top: 120px !important;
    }

    .catalog-section {
        margin-bottom: 30px !important;
    }

    .catalog-grid {
        margin-bottom: 30px !important;
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 24px !important;
    }

    .pagination-container {
        margin-top: 30px !important;
        margin-bottom: 50px !important;
    }

    /* Галерея фото в карточках */
    .compact-card-image-gallery {
        position: relative;
        width: 100%;
        height: 240px;
        overflow: hidden;
        border-radius: 12px 12px 0 0;
    }

    .compact-card-image-gallery .gallery-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 0.3s ease;
    }

    .gallery-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 10;
        opacity: 0;
    }

    .compact-card-image-gallery:hover .gallery-nav {
        opacity: 1;
    }

    .gallery-nav:hover {
        background: rgba(0, 0, 0, 0.8);
        transform: translateY(-50%) scale(1.1);
    }

    .gallery-prev {
        left: 10px;
    }

    .gallery-next {
        right: 10px;
    }

    .gallery-dots {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        z-index: 10;
    }

    .gallery-dots .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .gallery-dots .dot.active {
        background: rgba(255, 255, 255, 1);
        width: 24px;
        border-radius: 4px;
    }

    .gallery-dots .dot:hover {
        background: rgba(255, 255, 255, 0.8);
    }

    /* Исправление проблемы с длинными названиями улиц */
    .filter-select {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .filter-select option {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Стили для поля поиска ЖК */
    .complex-search-input {
        transition: all 0.3s ease;
    }

    .complex-search-input:focus {
        outline: none;
        border-color: #d4a574 !important;
        box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
    }

    .complex-search-input::placeholder {
        color: #9ca3af;
    }

    .complex-filter-item {
        transition: opacity 0.2s ease;
    }

    .complex-filter-item[style*="display: none"] {
        display: none !important;
    }

    /* Ограничиваем ширину полей фильтров */
    .filters-row-grid .filter-group {
        min-width: 0;
        /* Позволяет flex/grid элементам сжиматься */
        max-width: 100%;
    }

    /* Мобильная версия: одна карточка в ряд */
    @media (max-width: 768px) {
        .catalog-grid {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
        }

        .compact-card-image-gallery {
            height: 200px;
        }

        .gallery-nav {
            opacity: 1;
            width: 32px;
            height: 32px;
        }
    }

    /* Кнопка избранного на карточках */
    .favorite-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .favorite-btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .favorite-btn i {
        font-size: 18px;
        color: #666;
        transition: all 0.2s ease;
    }

    .favorite-btn.favorite-active i,
    .favorite-btn:hover i {
        color: #e74c3c;
    }

    .favorite-btn.favorite-active i {
        color: #e74c3c;
    }

    .favorite-btn.favorite-active {
        background: rgba(231, 76, 60, 0.1);
    }

    /* Стили для кастомных выпадающих списков с чекбоксами */
    .custom-dropdown {
        position: relative;
        width: 100%;
        z-index: 99999 !important;
    }

    .custom-dropdown-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d4a574;
        border-radius: 8px;
        background: #faf8f3;
        color: #1a1a1a;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        position: relative;
        z-index: 99999 !important;
    }

    .custom-dropdown-input:hover {
        border-color: #bcaf8a;
    }

    .custom-dropdown-input.active {
        border-color: #bcaf8a;
        box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
        z-index: 99999 !important;
    }

    .dropdown-text {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .dropdown-arrow {
        font-size: 12px;
        transition: transform 0.3s ease;
        color: #1a1a1a;
    }

    .custom-dropdown-input.active .dropdown-arrow {
        transform: rotate(180deg);
    }

    .custom-dropdown-list {
        position: fixed !important;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 999999 !important;
        display: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 200px;
    }

    .custom-dropdown-list.active {
        display: block;
    }

    .custom-dropdown-item {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid #f3f4f6;
    }

    .custom-dropdown-item:last-child {
        border-bottom: none;
    }

    .custom-dropdown-item:hover {
        background-color: #f9fafb;
    }

    .custom-dropdown-item input[type="checkbox"] {
        margin-right: 10px;
        width: 16px;
        height: 16px;
        cursor: pointer;
        accent-color: #d4a574;
    }

    .custom-dropdown-item span {
        flex: 1;
        font-size: 14px;
        color: #1a1a1a;
    }

    .custom-dropdown-item input[type="checkbox"]:checked + span {
        font-weight: 600;
    }

    /* Убеждаемся, что родительские контейнеры не обрезают выпадающие списки */
    .filter-group {
        overflow: visible !important;
        position: relative;
    }

    /* Убираем overflow: visible для мобильной версии - нужна прокрутка */
    @media (min-width: 769px) {
        .filters-section {
            overflow: visible !important;
        }
    }

    .filters-row {
        overflow: visible !important;
    }

    .filters-row-grid {
        overflow: visible !important;
    }

    /* Убеждаемся, что range-container не перекрывает выпадающие списки */
    .range-container {
        position: relative;
        z-index: 1 !important;
    }

    .range-slider {
        position: relative;
        z-index: 1 !important;
    }

    .range-slider-input {
        z-index: 2 !important;
    }
</style>
{% endblock %}

{% block meta %}
{% if landing and landing.meta_description %}
<meta name="description" content="{{ landing.meta_description }}">
{% elif page_description %}
<meta name="description" content="{{ page_description }}">
{% endif %}
{% if landing and landing.meta_keywords %}
<meta name="keywords" content="{{ landing.meta_keywords }}">
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <section class="catalog-section">
        <div class="catalog-header">
            <h1 class="section-title">{% if page_title %}{{ page_title }}{% else %}Каталог жилых комплексов{% endif %}
            </h1>
            <p class="section-subtitle">{% if page_description %}{{ page_description }}{% else %}Все доступные
                предложения{% endif %}</p>

            <div class="catalog-tabs">
                <a href="{% url 'main:newbuild_index' %}"
                    class="catalog-tab {% if dataset_type == 'newbuild' %}active{% endif %}">Новостройки</a>
                <a href="{% url 'main:secondary_index' %}"
                    class="catalog-tab alt {% if dataset_type == 'secondary' %}active{% endif %}">Вторичная
                    недвижимость</a>
            </div>
            {% if landing_categories %}
            <div class="catalog-categories">
                {% for lc in landing_categories %}
                <a href="{% url 'main:catalog_landing' lc.slug %}"
                    class="catalog-category{% if landing and landing.slug == lc.slug %} active{% endif %}">{{ lc.name
                    }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Хлебные крошки -->
        <div class="breadcrumbs">
            <a href="{% url 'main:home' %}" class="breadcrumb-link">Главная</a>
            <span class="breadcrumb-separator">•</span>
            <span class="breadcrumb-current">{% if dataset_type == 'secondary' %}Вторичная недвижимость{% else %}Каталог
                ЖК{% endif %}</span>
        </div>

        <!-- Мобильная кнопка открытия фильтра -->
        <button type="button" class="mobile-filter-toggle" id="mobile-filter-open">Фильтры</button>
        <div class="filters-backdrop" id="filters-backdrop" aria-hidden="true"></div>

        <!-- Фильтры -->
        <div class="filters-section" id="filters-sheet">
            <div class="filters-sheet-header">
                <span>Фильтры</span>
                <button type="button" class="sheet-close" id="mobile-filter-close" aria-label="Закрыть">×</button>
            </div>
            <form class="filters-form" id="filters-form">
                <div class="filters-row filters-row-grid fixed-grid">
                    <div class="filter-group" id="city-group">
                        <label>• Город</label>
                        <div class="custom-dropdown" id="city-dropdown">
                            <div class="custom-dropdown-input" id="city-input">
                                <span class="dropdown-text" id="city-text">Любой</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="custom-dropdown-list" id="city-list">
                                {% for city_name in cities %}
                                <label class="custom-dropdown-item">
                                    <input type="checkbox" name="city" value="{{ city_name }}" 
                                           class="city-checkbox" data-city="{{ city_name }}" 
                                           {% if filters.city == city_name %}checked{% endif %}>
                                    <span>{{ city_name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <input type="hidden" name="city" id="city-hidden" value="{{ filters.city|default:'' }}">
                    </div>

                    <div class="filter-group" id="district-group">
                        <label>• Район</label>
                        <div class="custom-dropdown" id="district-dropdown">
                            <div class="custom-dropdown-input" id="district-input">
                                <span class="dropdown-text" id="district-text">Любой</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="custom-dropdown-list" id="district-list">
                                {% for district_name in districts %}
                                <label class="custom-dropdown-item">
                                    <input type="checkbox" name="district" value="{{ district_name }}" 
                                           class="district-checkbox" data-district="{{ district_name }}">
                                    <span>{{ district_name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <input type="hidden" name="district" id="district-hidden" value="{{ filters.district|default:'' }}">
                    </div>

                    <div class="filter-group" id="street-group">
                        <label>• Улица</label>
                        <div class="custom-dropdown" id="street-dropdown">
                            <div class="custom-dropdown-input" id="street-input">
                                <span class="dropdown-text" id="street-text">Любая</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="custom-dropdown-list" id="street-list">
                                {% for street_name in streets %}
                                <label class="custom-dropdown-item">
                                    <input type="checkbox" name="street" value="{{ street_name }}" 
                                           class="street-checkbox" data-street="{{ street_name }}">
                                    <span>{{ street_name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <input type="hidden" name="street" id="street-hidden" value="{{ filters.street|default:'' }}">
                    </div>

                    <div class="filter-group">
                        <label>Укажите площадь дома, м²</label>
                        <div class="range-container">
                            <div class="range-display">
                                <span class="range-value">от <strong id="area-from-display">60</strong></span>
                                <span class="range-separator">—</span>
                                <span class="range-value">до <strong id="area-to-display">399</strong></span>
                            </div>
                            <div class="range-slider">
                                <input type="range" id="area-from-slider" class="range-slider-input" min="30" max="500"
                                    step="1" value="60">
                                <input type="range" id="area-to-slider" class="range-slider-input" min="30" max="500"
                                    step="1" value="399">
                                <div class="range-track">
                                    <div class="range-fill area-fill"></div>
                                </div>
                            </div>
                            <input type="hidden" name="area_from" id="area-from-hidden"
                                value="{{ filters.area_from|default:'' }}">
                            <input type="hidden" name="area_to" id="area-to-hidden"
                                value="{{ filters.area_to|default:'' }}">
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Цена, ₽</label>
                        <div class="range-container">
                            <div class="range-display">
                                <span class="range-value">от <strong id="price-from-display">1.0</strong> млн</span>
                                <span class="range-separator">—</span>
                                <span class="range-value">до <strong id="price-to-display">100.0</strong> млн</span>
                            </div>
                            <div class="range-slider">
                                <input type="range" id="price-from-slider" class="range-slider-input" min="1" max="100"
                                    step="0.1" value="1.0">
                                <input type="range" id="price-to-slider" class="range-slider-input" min="1" max="100"
                                    step="0.1" value="100.0">
                                <div class="range-track">
                                    <div class="range-fill price-fill"></div>
                                </div>
                            </div>
                            <input type="hidden" name="price_from" id="price-from-hidden"
                                value="{{ filters.price_from|default:'' }}">
                            <input type="hidden" name="price_to" id="price-to-hidden"
                                value="{{ filters.price_to|default:'' }}">
                        </div>
                    </div>

                    {% if dataset_type == 'secondary' %}
                    <div class="filter-group">
                        <label>Категория объекта</label>
                        <div class="button-filter chips">
                            <button type="button" class="filter-chip filter-chip-btn" data-value="" {% if not filters.stype %}data-active="true"{% endif %}>Все</button>
                            <button type="button" class="filter-chip filter-chip-btn" data-value="apartment" {% if filters.stype == 'apartment' %}data-active="true"{% endif %}>Квартиры</button>
                            <button type="button" class="filter-chip filter-chip-btn" data-value="cottage" {% if filters.stype == 'cottage' %}data-active="true"{% endif %}>Коттеджи</button>
                            <button type="button" class="filter-chip filter-chip-btn" data-value="townhouse" {% if filters.stype == 'townhouse' %}data-active="true"{% endif %}>Таунхаусы</button>
                            <button type="button" class="filter-chip filter-chip-btn" data-value="commercial" {% if filters.stype == 'commercial' %}data-active="true"{% endif %}>Коммерческие</button>
                        </div>
                        <input type="hidden" name="stype" id="stype-hidden" value="{{ filters.stype|default:'' }}">
                    </div>
                    {% else %}
                    <div class="filter-group">
                        <label>Укажите количество комнат</label>
                        <div class="button-filter">
                            <button type="button" class="filter-btn" data-value=""
                                data-active="{% if not filters.rooms %}true{% else %}false{% endif %}">
                                Любое
                            </button>
                            {% for value, label in rooms_choices %}
                            <button type="button" class="filter-btn" data-value="{{ value }}" data-active="false">
                                {{ label }}
                            </button>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="rooms" id="rooms-hidden" value="{{ filters.rooms|default:'' }}">
                    </div>

                    <div class="filter-group">
                        <label>Специальные предложения</label>
                        <div class="button-filter">
                            <button type="button" class="filter-btn" data-value=""
                                data-active="{% if not filters.has_offers %}true{% else %}false{% endif %}">
                                Любое
                            </button>
                            <button type="button" class="filter-btn" data-value="true"
                                data-active="{% if filters.has_offers %}true{% else %}false{% endif %}">
                                Скидки
                            </button>
                        </div>
                        <input type="hidden" name="has_offers" id="has_offers-hidden"
                            value="{{ filters.has_offers|default:'' }}">
                    </div>
                    {% endif %}

                    <!-- Фильтр по названиям ЖК (только для новостроек, не для вторички) -->
                    {% if dataset_type != 'secondary' %}
                    <div class="filter-group" style="grid-column: 1 / -1;">
                        <label>Жилые комплексы</label>
                        <input type="text" id="complex-search-input" class="complex-search-input"
                            placeholder="Поиск ЖК по названию..."
                            style="width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; background: #fff; color: #374151; box-sizing: border-box;">
                        <div class="complexes-filter-container"
                            style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #fff;">
                            {% for complex in complexes_list %}
                            <label class="complex-filter-item"
                                style="display: flex; align-items: center; padding: 6px 0; cursor: pointer;"
                                data-complex-name="{{ complex.name|lower }}">
                                <input type="checkbox" name="complexes" value="{{ complex.id }}"
                                    class="complex-checkbox" data-complex-id="{{ complex.id }}"
                                    style="margin-right: 8px; width: 16px; height: 16px; cursor: pointer;">
                                <span class="complex-name" style="font-size: 14px; color: #374151;">{{ complex.name }}</span>
                            </label>
                            {% empty %}
                            <div style="padding: 12px; text-align: center; color: #9ca3af;">ЖК не найдены</div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="complexes" id="complexes-hidden"
                            value="{{ filters.complexes|default:'' }}">
                    </div>
                    {% endif %}

                    <!-- Фильтр по сроку сдачи -->
                    <div class="filter-group" id="delivery-quarter-group">
                        <label>• Срок сдачи</label>
                        <div class="custom-dropdown" id="delivery-quarter-dropdown">
                            <div class="custom-dropdown-input" id="delivery-quarter-input">
                                <span class="dropdown-text" id="delivery-quarter-text">Любой срок</span>
                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                            </div>
                            <div class="custom-dropdown-list" id="delivery-quarter-list">
                                {% for quarter in delivery_quarters %}
                                <label class="custom-dropdown-item">
                                    <input type="checkbox" name="delivery_quarter" value="{{ quarter.value }}" 
                                           class="delivery-quarter-checkbox" data-quarter="{{ quarter.value }}" 
                                           {% if filters.delivery_quarter == quarter.value %}checked{% endif %}>
                                    <span>{{ quarter.label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        <input type="hidden" name="delivery_quarter" id="delivery-quarter-hidden" value="{{ filters.delivery_quarter|default:'' }}">
                    </div>
                </div>

                <div class="filters-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Поиск
                    </button>

                    <div class="results-count">
                        Найдено 0 домов
                    </div>

                    <a href="{% if dataset_type == 'secondary' %}{% url 'main:secondary_index' %}{% else %}{% url 'main:catalog' %}{% endif %}"
                        class="clear-filters" id="clear-filters">
                        <i class="fas fa-times"></i>
                        Очистить фильтр
                    </a>
                </div>
            </form>
        </div>

        <!-- Сортировка отдельно слева -->
        <div class="controls-section">
            <div class="sorting-left">
                <div class="sorting-dropdown">
                    <div class="sorting-options" id="sorting-options">
                        <div class="sorting-option" data-sort="price_asc">
                            <span>Дешевле</span>
                        </div>
                        <div class="sorting-option" data-sort="price_desc">
                            <span>Дороже</span>
                        </div>
                        <div class="sorting-option" data-sort="area_desc">
                            <span>С большей площадью</span>
                        </div>
                        <div class="sorting-option" data-sort="area_asc">
                            <span>С меньшей площадью</span>
                        </div>
                    </div>
                    <div class="sorting-active" id="sorting-active">
                        <i class="fas fa-sort"></i>
                        <span id="sorting-text">Дешевле</span>
                        <i class="fas fa-chevron-up"></i>
                    </div>
                </div>
                <input type="hidden" name="sort" id="sort-hidden" value="{{ filters.sort|default:'price_asc' }}">
            </div>

            <div class="view-toggle-right">
                <button type="button" class="view-btn active" data-view="map">Картой</button>
                <button type="button" class="view-btn" data-view="list">Списком</button>
            </div>
            
            {% if dataset_type == 'newbuild' %}
            <div class="content-toggle-right" style="margin-left: 12px;">
                <button type="button" class="content-btn active" data-content="complexes">ЖК</button>
                <button type="button" class="content-btn" data-content="apartments">Квартиры</button>
            </div>
            {% endif %}
        </div>

        <!-- Результаты поиска -->
        {% if filters_applied %}
        <div class="search-results">
            <h3 class="search-title">Результаты поиска</h3>
        </div>
        {% endif %}

        <div class="catalog-content">
            <div id="map"
                style="width: 100%; height: 520px; display:block; border-radius:12px; overflow:hidden; margin-bottom:24px;">
            </div>
            <div class="catalog-grid" id="catalog-grid">
                <!-- Карточки загружаются через API -->
            </div>
        </div>

        <!-- Пагинация загружается через API -->
        <div class="pagination-container" style="display:none;">
            <div class="pagination-info"></div>
            <div class="pagination-controls"></div>
        </div>


    </section>

</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
    .catalog-tabs {
        margin-top: 12px;
        display: flex;
        gap: 16px;
        justify-content: center;
    }

    .catalog-tab {
        padding: 8px 16px;
        border-radius: 999px;
        background: var(--c21-light);
        color: var(--c21-dark);
        text-decoration: none;
        font-weight: 600;
    }

    .catalog-tab.active {
        background: var(--c21-dark);
        color: var(--c21-gold);
    }

    .catalog-tab.alt {
        background: var(--c21-light);
        color: var(--c21-dark);
    }

    .catalog-tab.alt.active {
        background: var(--c21-dark);
        color: var(--c21-gold);
    }

    .catalog-categories {
        margin-top: 16px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .catalog-category {
        padding: 6px 12px;
        border: 1px solid var(--c21-mid);
        border-radius: 999px;
        text-decoration: none;
        color: var(--c21-dark);
        font-weight: 600;
    }

    .catalog-category.active,
    .catalog-category:hover {
        border-color: var(--c21-gold);
        color: var(--c21-gold);
    }

    .filter-chip {
        display: inline-block;
        padding: 8px 14px;
        background: var(--c21-light);
        color: var(--c21-dark);
        border-radius: 999px;
        text-decoration: none;
        font-weight: 600;
    }

    .filter-chip.active,
    .filter-chip:hover {
        background: var(--c21-dark);
        color: var(--c21-gold);
    }

    /* Стили для звездочек рейтинга */
    .rating-stars {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .rating-stars .star {
        font-size: 14px;
        line-height: 1;
    }

    .rating-stars .star.filled {
        color: #fbbf24;
    }

    .rating-stars .star.empty {
        color: #d1d5db;
    }

    .rating-stars .rating-text {
        margin-left: 4px;
        font-size: 12px;
        color: #6b7280;
    }
    
    /* Стили для тумблера ЖК/Квартиры */
    .content-toggle-right {
        display: flex;
        gap: 8px;
    }
    
    .content-toggle-right .content-btn {
        padding: 10px 16px;
        border: 2px solid rgba(190, 175, 135, 0.3);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        color: var(--c21-dark);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .content-toggle-right .content-btn:hover {
        border-color: rgba(190, 175, 135, 0.6);
        background: rgba(255, 255, 255, 0.9);
        transform: translateY(-1px);
    }
    
    .content-toggle-right .content-btn.active {
        background: linear-gradient(135deg, var(--c21-gold) 0%, var(--c21-gold-dark) 100%);
        border-color: var(--c21-gold);
        color: white;
        box-shadow: 0 4px 12px rgba(190, 175, 135, 0.3);
    }
    
    @media (max-width: 768px) {
        .controls-section {
            flex-wrap: wrap;
        }
        
        .content-toggle-right {
            width: 100%;
            justify-content: center;
            margin-top: 8px;
        }
        
        .content-toggle-right .content-btn {
            flex: 1;
            text-align: center;
        }
    }
</style>

<script>
    // Глобальные функции - должны быть определены первой
    window.renderItems = function (data) {
        const grid = document.getElementById('catalog-grid');
        const resultsCount = document.querySelector('.results-count');
        const isSecondary = '{{ dataset_type }}' === 'secondary';

        // Для вторичной недвижимости всегда показываем списком, для новостроек - карту + список
        const currentView = isSecondary ? 'list' : 'map';

        // Всегда рендерим и карту и список для новостроек
        if (!isSecondary) {
            // Новостройки: рендерим и карту и список
            if (typeof renderMapPoints === 'function') {
                const mapPoints = data.map_points || data.complexes || [];
                renderMapPoints(mapPoints, false, false); // false = не квартиры
            }

            const list = data.complexes || [];
            if (!list.length) {
                grid.innerHTML = '<div class="no-complexes"><p>По вашему запросу ничего не найдено</p></div>';
            } else {
                // Используем полноценный рендер с компактными карточками
                if (typeof updateCatalog === 'function') {
                    updateCatalog(data);
                }
            }
        } else {
            // Вторичка: только список
            if (currentView === 'map') {
                if (typeof renderMapPoints === 'function') {
                    renderMapPoints(data.items || [], true);
                }
            }

            if (!data.items || !data.items.length) {
                grid.innerHTML = '<div class="no-complexes"><p>По вашему запросу ничего не найдено</p></div>';
            } else {
                grid.innerHTML = data.items.map(item => {
                    // Отладочная информация (можно убрать в продакшене)// Формируем массив фото
                    let photos = [];
                    if (item.photos && item.photos.length > 0) {
                        photos = item.photos.map(photo => {
                            // Если фото уже содержит полный путь, используем как есть
                            if (photo.startsWith('/media/') || photo.startsWith('http')) {
                                return photo;
                            }
                            // Иначе добавляем префикс /media/
                            return `/media/${photo}`;
                        });
                    } else {
                        // Проверяем image_url и формируем правильный путь
                        let fallbackImage = '/media/gallery/placeholders.png';
                        if (item.image_url) {
                            if (item.image_url.startsWith('/media/') || item.image_url.startsWith('http')) {
                                fallbackImage = item.image_url;
                            } else {
                                fallbackImage = `/media/${item.image_url}`;
                            }
                        }
                        photos = [fallbackImage];
                    }

                    // Генерируем HTML для галереи
                    const galleryHtml = photos.map((photo, i) =>
                        `<img src="${photo}" alt="${item.name}" class="gallery-image ${i === 0 ? 'active' : ''}" style="display: ${i === 0 ? 'block' : 'none'};">`
                    ).join('');

                    // Для вторички не добавляем класс рейтинга (у вторички нет рейтинга)
                    const cardClasses = 'property-card-compact';
                    return `
        <div class="${cardClasses}" data-complex-id="${item.id}">
          <div class="compact-card-image-gallery" onclick="window.location.href='/secondary/${item.id}/'" style="cursor: pointer;">
            ${galleryHtml}
            ${photos.length > 1 ? `
              <button class="gallery-nav gallery-prev" onclick="event.stopPropagation(); changeImage(this, -1)">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="gallery-nav gallery-next" onclick="event.stopPropagation(); changeImage(this, 1)">
                <i class="fas fa-chevron-right"></i>
              </button>
              <div class="gallery-dots">
                ${photos.map((_, i) => `<span class="dot ${i === 0 ? 'active' : ''}" onclick="event.stopPropagation(); setImage(this, ${i})"></span>`).join('')}
              </div>
            ` : ''}
          </div>
          
          <div class="compact-card-content" onclick="window.location.href='/secondary/${item.id}/'" style="cursor: pointer;">
            <div class="compact-card-header">
              <h3 class="compact-card-title">${item.name}</h3>
              <div class="compact-card-location">
                <i class="fas fa-map-marker-alt"></i>
                <span>${item.city}${item.district ? ', ' + item.district : ''}</span>
              </div>
              <div class="compact-card-details">
                <div class="compact-detail-item">
                  <i class="fas fa-expand-arrows-alt"></i>
                  <span>${item.area_from || '—'} м²</span>
                </div>
                ${item.rooms ? `<div class="compact-detail-item"><i class="fas fa-bed"></i><span>${item.rooms}-комн.</span></div>` : ''}
              </div>
            </div>
            <div class="compact-card-price">
              <div class="compact-price-text">${item.price_range || item.price_display || 'Цена по запросу'}</div>
            </div>
          </div>
        </div>`;
                }).join('');
            }
        }
        // Обновляем пагинацию под список
        if (typeof updatePagination === 'function') {
            updatePagination(data);
        }
        if (resultsCount) {
            const total = (typeof data.total_count !== 'undefined') ? data.total_count : (data.total_count ?? data.total ?? 0);
            if (total) resultsCount.textContent = `Найдено ${total} домов`;
        }
    }

    // Глобальная функция applyFilters
    window.applyFilters = function () {
        // Используем вспомогательную функцию для сброса страницы и загрузки данных
        window.resetPageAndFetch();
    }

    // Глобальная функция loadPage
    window.loadPage = function (page) {
        if (page === window.currentPage) return;
        
        // Устанавливаем страницу в скрытое поле формы
        const pageInput = document.getElementById('page-hidden');
        if (pageInput) {
            pageInput.value = page;
        } else {
            // Создаем скрытое поле если его нет
            const form = document.getElementById('filters-form');
            if (form) {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = 'page-hidden';
                hiddenInput.name = 'page';
                hiddenInput.value = page;
                form.appendChild(hiddenInput);
            }
        }
        
        window.currentPage = page;
        // Используем единую функцию fetchData, которая учитывает режим ЖК/Квартиры
        window.fetchData();
    }

    // Глобальная функция updateCatalog
    window.updateCatalog = function (data) {
        const grid = document.getElementById('catalog-grid');

        if (data.complexes.length === 0) {
            grid.innerHTML = '<div class="no-complexes"><p>По вашему запросу ничего не найдено</p><p>Попробуйте изменить параметры поиска</p></div>';
            return;
        }

        let html = '';
        data.complexes.forEach((complex, index) => {
            // Создаем массив фото из photos или используем старые поля
            let photos = [];
            if (complex.photos && complex.photos.length > 0) {
                photos = complex.photos.map(photo => {
                    // Если фото уже содержит полный URL, используем как есть
                    if (photo.startsWith('http')) {
                        return photo;
                    }
                    // Иначе добавляем префикс /media/
                    return `/media/${photo}`;
                });
            } else {
                const img1 = complex.image_url || '/media/gallery/placeholders.png';
                const img2 = complex.image_2_url;
                const img3 = complex.image_3_url;
                const img4 = complex.image_4_url;
                photos = [img1, img2, img3, img4].filter(p => p);
            }

            // Генерируем HTML для галереи
            const galleryHtml = photos.map((photo, i) =>
                `<img src="${photo}" alt="${complex.name}" class="gallery-image ${i === 0 ? 'active' : ''}" style="display: ${i === 0 ? 'block' : 'none'};">`
            ).join('');

            // Добавляем класс рейтинга для обводки
            const rating = complex.rating || 0;
            let ratingClass = '';
            if (rating >= 5) {
                ratingClass = 'rating-5';
            } else if (rating >= 4) {
                ratingClass = 'rating-4';
            } else if (rating >= 1) {
                ratingClass = 'rating-3';
            }

            const cardClasses = `property-card-compact ${ratingClass}`;

            html += `
            <div class="${cardClasses}" data-complex-id="${complex.id}">
                <div class="compact-card-image-gallery" onclick="window.location.href='/complex/${complex.id}/'" style="cursor: pointer; position: relative;">
                    ${galleryHtml}
                    ${complex.completion_date ? `
                        <div class="future-complex-badge">
                            <i class="fas fa-calendar-alt"></i>
                            <span>Сдача: ${complex.completion_date}</span>
                        </div>
                    ` : ''}
                    ${photos.length > 1 ? `
                        <button class="gallery-nav gallery-prev" onclick="event.stopPropagation(); changeImage(this, -1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="gallery-nav gallery-next" onclick="event.stopPropagation(); changeImage(this, 1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div class="gallery-dots">
                            ${photos.map((_, i) => `<span class="dot ${i === 0 ? 'active' : ''}" onclick="event.stopPropagation(); setImage(this, ${i})"></span>`).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="compact-card-content" onclick="window.location.href='/complex/${complex.id}/'" style="cursor: pointer;">
                    <div class="compact-card-header">
                        <h3 class="compact-card-title">${complex.name}</h3>
                        <div class="compact-card-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${complex.address || complex.city || 'Уфа'}</span>
                        </div>
                        <div class="compact-card-details">
                            ${complex.total_apartments ? `
                            <div class="compact-detail-item apartments-item">
                                <i class="fas fa-home"></i>
                                <span>${complex.total_apartments} квартир</span>
                            </div>
                            ` : ''}
                            ${complex.rating ? `
                            <div class="compact-detail-item rating-item">
                                <i class="fas fa-star"></i>
                                <span class="rating-stars">
                                    ${'★'.repeat(complex.rating)}${'☆'.repeat(5 - complex.rating)}
                                    <span class="rating-text">(${complex.rating}/5)</span>
                                </span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="compact-card-price">
                        <div class="compact-price-text">${complex.price_range || complex.price_display || 'Цена по запросу'}</div>
                    </div>
                </div>
            </div>
        `;
        });

        grid.innerHTML = html;
    }

    // Глобальная функция updateResultsCount
    window.updateResultsCount = function (count) {
        const resultsCount = document.querySelector('.results-count');
        if (resultsCount) {
            resultsCount.textContent = `Найдено ${count} домов`;
        }
    }

    // Функции для галереи фото
    window.changeImage = function (button, direction) {
        const gallery = button.parentElement;
        const images = gallery.querySelectorAll('.gallery-image');
        const dots = gallery.querySelectorAll('.dot');
        let currentIndex = 0;

        // Находим текущий индекс
        images.forEach((img, i) => {
            if (img.style.display === 'block') {
                currentIndex = i;
            }
        });

        // Вычисляем новый индекс
        let newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = images.length - 1;
        if (newIndex >= images.length) newIndex = 0;

        // Переключаем изображения
        images[currentIndex].style.display = 'none';
        images[newIndex].style.display = 'block';

        // Переключаем точки
        dots[currentIndex].classList.remove('active');
        dots[newIndex].classList.add('active');
    }

    window.setImage = function (dot, index) {
        const gallery = dot.parentElement.parentElement;
        const images = gallery.querySelectorAll('.gallery-image');
        const dots = gallery.querySelectorAll('.dot');

        // Скрываем все изображения
        images.forEach(img => img.style.display = 'none');
        // Показываем выбранное
        images[index].style.display = 'block';

        // Обновляем точки
        dots.forEach(d => d.classList.remove('active'));
        dots[index].classList.add('active');
    }

    // Глобальная функция updatePagination
    window.updatePagination = function (data) {
        const container = document.querySelector('.pagination-container');
        if (!container) return;

        // Показываем контейнер пагинации
        container.style.display = 'block';

        const info = container.querySelector('.pagination-info');
        const controls = container.querySelector('.pagination-controls');

        info.textContent = `Страница ${data.current_page} из ${data.total_pages}`;

        let controlsHtml = '';

        if (data.has_previous) {
            controlsHtml += `
            <button class="pagination-btn" onclick="loadPage(${data.current_page - 1})">
                <i class="fas fa-chevron-left"></i> Назад
            </button>
        `;
        }

        controlsHtml += '<div class="pagination-numbers">';
        for (let i = 1; i <= data.total_pages; i++) {
            if (i === data.current_page) {
                controlsHtml += `<span class="pagination-number active">${i}</span>`;
            } else if (i > data.current_page - 3 && i < data.current_page + 3) {
                controlsHtml += `<button class="pagination-number" onclick="loadPage(${i})">${i}</button>`;
            }
        }
        controlsHtml += '</div>';

        if (data.has_next) {
            controlsHtml += `
            <button class="pagination-btn" onclick="loadPage(${data.current_page + 1})">
                Вперед <i class="fas fa-chevron-right"></i>
            </button>
        `;
        }

        controls.innerHTML = controlsHtml;
    }

    // Глобальная функция initImageCarousel
    window.initImageCarousel = function () {
        const propertyCards = document.querySelectorAll('.property-card-large');

        propertyCards.forEach(card => {
            const mainImage = card.querySelector('.main-image img');
            const thumbnails = card.querySelectorAll('.thumbnail');
            const imageCounter = card.querySelector('.image-counter');
            const prevBtn = card.querySelector('.nav-btn.prev');
            const nextBtn = card.querySelector('.nav-btn.next');

            let currentImageIndex = 0;
            const totalImages = thumbnails.length;

            // Функция для обновления главного изображения
            function updateMainImage(index) {
                const thumbnail = thumbnails[index];
                const thumbnailImg = thumbnail.querySelector('img');

                if (thumbnailImg) {
                    mainImage.src = thumbnailImg.src;
                    mainImage.alt = thumbnailImg.alt;

                    // Обновляем счетчик
                    imageCounter.textContent = `${index + 1} из ${totalImages}`;

                    // Обновляем активную миниатюру
                    thumbnails.forEach((thumb, i) => {
                        thumb.classList.toggle('active', i === index);
                    });

                    currentImageIndex = index;
                }
            }

            // Обработчики кликов по миниатюрам
            thumbnails.forEach((thumbnail, index) => {
                thumbnail.addEventListener('click', function (e) {
                    e.stopPropagation(); // Предотвращаем всплытие события
                    updateMainImage(index);
                });
            });

            // Обработчики для кнопок навигации
            if (prevBtn) {
                prevBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const newIndex = currentImageIndex > 0 ? currentImageIndex - 1 : totalImages - 1;
                    updateMainImage(newIndex);
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const newIndex = currentImageIndex < totalImages - 1 ? currentImageIndex + 1 : 0;
                    updateMainImage(newIndex);
                });
            }

            // Обработчик клика по главному изображению для перехода к следующему
            mainImage.addEventListener('click', function (e) {
                e.stopPropagation();
                const newIndex = currentImageIndex < totalImages - 1 ? currentImageIndex + 1 : 0;
                updateMainImage(newIndex);
            });
        });
    }

    // Инициализация глобальных переменных
    window.currentPage = 1;

    // Вспомогательная функция для сброса страницы и загрузки данных
    window.resetPageAndFetch = function () {
        window.currentPage = 1;
        const form = document.getElementById('filters-form');
        if (form) {
            const pageInput = form.querySelector('input[name="page"]');
            if (pageInput) {
                pageInput.value = 1;
            } else {
                // Создаем скрытое поле для страницы если его нет
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'page';
                hiddenInput.value = 1;
                form.appendChild(hiddenInput);
            }
        }
        window.fetchData();
    }

    // Глобальная функция fetchData
    window.fetchData = async function () {
        const form = document.getElementById('filters-form');
        const grid = document.getElementById('catalog-grid');
        const isSecondary = '{{ dataset_type }}' === 'secondary';
        
        // Определяем режим: ЖК или Квартиры
        const contentMode = localStorage.getItem('catalog_content_mode') || 'complexes';
        const isApartmentsMode = contentMode === 'apartments' && !isSecondary;
        
        const apiUrl = isSecondary ? '/api/secondary/' : (isApartmentsMode ? '/api/apartments/' : '/api/catalog/');

        if (!form || !grid) return;
        
        // Устанавливаем страницу в форму, если она не установлена
        const pageInput = form.querySelector('input[name="page"]');
        if (pageInput) {
            // Если page не был установлен через loadPage, используем текущую страницу или 1
            if (!pageInput.value || pageInput.value === '') {
                pageInput.value = window.currentPage || 1;
            }
        } else {
            // Создаем скрытое поле для страницы если его нет
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'page';
            hiddenInput.value = window.currentPage || 1;
            form.appendChild(hiddenInput);
        }
        
        if ((localStorage.getItem('catalog_view') || 'list') !== 'map') {
            grid.innerHTML = '<div class="loading">Поиск...</div>';
        }
        const qs = window.serialize();
        // Отменяем предыдущий запрос и помечаем текущий как последний
        try {
            if (window.activeController) { window.activeController.abort(); }
            const controller = new AbortController();
            window.activeController = controller;
            const requestId = ++window.latestRequestId;
            const res = await fetch(apiUrl + (qs ? ('?' + qs) : ''), { signal: controller.signal });
            const data = await res.json();
            // Если это не самый свежий ответ — игнорируем
            if (requestId !== window.latestRequestId) return;
            
            // Обновляем текущую страницу из ответа
            if (data.current_page) {
                window.currentPage = data.current_page;
            }
            
            if (isApartmentsMode) {
                renderApartments(data);
            } else {
                renderItems(data);
            }
        } catch (e) {
            // Игнорируем AbortError - это нормальная отмена запроса
            if (e.name === 'AbortError') {
                return;
            }
            if (grid) grid.innerHTML = '<div class="error">Ошибка загрузки</div>';
            console.error(e);
        }
    }
    
    // Глобальная функция renderApartments для рендеринга карточек квартир
    window.renderApartments = function (data) {
        const grid = document.getElementById('catalog-grid');
        const resultsCount = document.querySelector('.results-count');
        const isSecondary = '{{ dataset_type }}' === 'secondary';
        
        if (!grid) return;
        
        const apartments = data.apartments || [];
        const currentView = isSecondary ? 'list' : 'map';
        
        // Рендерим карту для новостроек - показываем точки ЖК (как в режиме ЖК)
        if (!isSecondary) {
            if (typeof renderMapPoints === 'function') {
                const mapPoints = data.map_points || [];
                // Важно: передаем false в третьем параметре чтобы показывались ЖК, а не квартиры
                renderMapPoints(mapPoints, false, false); // false = показываем точки ЖК
            }
        }
        
        if (!apartments.length) {
            grid.innerHTML = '<div class="no-complexes"><p>По вашему запросу ничего не найдено</p><p>Попробуйте изменить параметры поиска</p></div>';
        } else {
            let html = '';
            apartments.forEach((apt, index) => {
                // Формируем фото планировки квартиры
                let photo = apt.photo || (Array.isArray(apt.complex_photos) && apt.complex_photos.length > 0 ? apt.complex_photos[0] : null) || '/media/gallery/placeholders.png';
                
                // Преобразуем в строку и проверяем
                if (photo) {
                    photo = String(photo);
                    if (photo && photo !== '/media/gallery/placeholders.png' && !photo.startsWith('/media/') && !photo.startsWith('http')) {
                        photo = `/media/${photo}`;
                    }
                } else {
                    photo = '/media/gallery/placeholders.png';
                }
                
                // Формируем название квартиры (крупно)
                const apartmentTitle = apt.apartment_title || (apt.rooms === 'Студия' ? 'Студия' : apt.rooms === '1' ? '1-комнатная квартира' : apt.rooms === '2' ? '2-комнатная квартира' : apt.rooms === '3' ? '3-комнатная квартира' : apt.rooms === '4' ? '4-комнатная квартира' : apt.rooms === '5+' ? '5+ комнат' : `${apt.rooms}-комнатная квартира`);
                
                // Формируем цену
                const priceDisplay = apt.price || 'Цена по запросу';
                
                // Формируем площадь
                const areaDisplay = apt.area ? `${apt.area} м²` : '—';
                
                // Формируем этаж
                const floorDisplay = apt.floor ? `${apt.floor} этаж` : '';
                
                html += `
        <div class="compact-card">
          <div class="compact-card-image-gallery">
            <img src="${photo}" alt="${apartmentTitle}" class="gallery-image active" style="display: block;">
            <div class="favorite-btn" data-id="${apt.id}" data-type="apartment" onclick="event.stopPropagation(); toggleFavorite('${apt.id}', 'apartment', this)">
              <i class="far fa-heart"></i>
            </div>
          </div>
          
          <div class="compact-card-content" onclick="window.location.href='/apartment/${apt.complex_id}/${apt.apartment_id || (apt.id ? apt.id.split('_').slice(-2).join('_') : '0_0')}/'" style="cursor: pointer;">
            <div class="compact-card-header">
              <h3 class="compact-card-title">${apartmentTitle}</h3>
              <div class="compact-card-location" style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                <i class="fas fa-building" style="font-size: 11px;"></i>
                <span>${apt.complex_name || ''}</span>
              </div>
              <div class="compact-card-details">
                <div class="compact-detail-item">
                  <i class="fas fa-expand-arrows-alt"></i>
                  <span>${areaDisplay}</span>
                </div>
                ${floorDisplay ? `<div class="compact-detail-item"><i class="fas fa-layer-group"></i><span>${floorDisplay}</span></div>` : ''}
              </div>
            </div>
            <div class="compact-card-price">
              <div class="compact-price-text">${priceDisplay}</div>
            </div>
          </div>
        </div>`;
            });
            grid.innerHTML = html;
        }
        
        // Обновляем пагинацию
        if (typeof updatePagination === 'function') {
            updatePagination(data);
        }
        if (resultsCount) {
            const total = data.total_count || 0;
            if (total) resultsCount.textContent = `Найдено ${total} квартир`;
        }
        
        // Инициализируем состояние кнопок избранного для квартир
        setTimeout(() => {
            const favoriteBtns = grid.querySelectorAll('.favorite-btn[data-type="apartment"]');
            favoriteBtns.forEach(btn => {
                const id = btn.getAttribute('data-id');
                if (id) {
                    const parts = id.split('_apt_');
                    if (parts.length === 2) {
                        const complexId = parts[0];
                        const apartmentId = parts[1];
                        // Проверяем, есть ли квартира в избранном через localStorage
                        try {
                            const favorites = JSON.parse(localStorage.getItem('century21_favorites') || '{"apartments":[]}');
                            const idStr = `${complexId}_${apartmentId}`;
                            const isFavorite = favorites.apartments && favorites.apartments.includes(idStr);
                            
                            // Обновляем иконку
                            const icon = btn.querySelector('i');
                            if (icon) {
                                if (isFavorite) {
                                    icon.classList.remove('far');
                                    icon.classList.add('fas');
                                    btn.classList.add('favorite-active');
                                } else {
                                    icon.classList.remove('fas');
                                    icon.classList.add('far');
                                    btn.classList.remove('favorite-active');
                                }
                            }
                        } catch (e) {
                            console.error('Ошибка проверки избранного:', e);
                        }
                    }
                }
            });
        }, 100);
    }

    // Глобальная функция initMap
    window.initMap = function () {
        const mapEl = document.getElementById('map');
        if (!mapEl) return;

        window.map = L.map('map', { attributionControl: false });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(window.map);
        window.markersLayer = L.layerGroup().addTo(window.map);
        window.map.setView([54.7388, 55.9721], 11); // Уфа по умолчанию
    }

    // Глобальная функция serialize
    window.serialize = function () {
        const form = document.getElementById('filters-form');
        if (!form) return '';

        const fd = new FormData(form);
        const params = new URLSearchParams();

        // Собираем все параметры, исключая чекбоксы city, complexes, district, street, delivery_quarter (они обрабатываются через скрытые поля)
        for (const [k, v] of fd.entries()) {
            if (k !== 'city' && k !== 'complexes' && k !== 'district' && k !== 'street' && k !== 'delivery_quarter' && v !== '') {
                params.append(k, v);
            }
        }

        // Добавляем city из скрытого поля
        const cityHidden = document.getElementById('city-hidden');
        if (cityHidden && cityHidden.value) {
            params.set('city', cityHidden.value);
        }

        // Добавляем complexes из скрытого поля
        const complexesHidden = document.getElementById('complexes-hidden');
        if (complexesHidden && complexesHidden.value) {
            params.set('complexes', complexesHidden.value);
        }

        // Добавляем district из скрытого поля
        const districtHidden = document.getElementById('district-hidden');
        if (districtHidden && districtHidden.value) {
            params.set('district', districtHidden.value);
        }

        // Добавляем street из скрытого поля
        const streetHidden = document.getElementById('street-hidden');
        if (streetHidden && streetHidden.value) {
            params.set('street', streetHidden.value);
        }

        // Добавляем delivery_quarter из скрытого поля
        const deliveryQuarterHidden = document.getElementById('delivery-quarter-hidden');
        if (deliveryQuarterHidden && deliveryQuarterHidden.value) {
            params.set('delivery_quarter', deliveryQuarterHidden.value);
        }

        const sort = document.getElementById('sort-hidden');
        if (sort && sort.value) params.set('sort', sort.value);
        return params.toString();
    }

    // Глобальная функция renderMapPoints
    window.renderMapPoints = function (list, isSec, isApartments) {
        // Убеждаемся, что карта видна для новостроек
        const mapEl = document.getElementById('map');
        if (mapEl && !isSec) {
            mapEl.style.display = 'block';
        }
        
        if (!window.map) {
            // Если карта не инициализирована, инициализируем её
            if (typeof window.initMap === 'function') {
                window.initMap();
            } else {
                console.warn('initMap function not found');
                return;
            }
        }
        if (!window.map) {
            console.warn('Map not initialized');
            return;
        }
        
        // Очищаем существующие маркеры
        if (window.markersLayer) {
            window.markersLayer.clearLayers();
        } else {
            window.markersLayer = L.layerGroup().addTo(window.map);
        }
        
        const bounds = [];
        list.forEach(item => {
            const lat = item.lat || item.latitude;
            const lng = item.lng || item.longitude;
            if (lat && lng) {
                const marker = L.marker([lat, lng]).addTo(window.markersLayer);
                const price = item.price_range || item.price_display || 'Цена по запросу';
                
                // Формируем ссылку в зависимости от типа
                let link;
                if (isSec) {
                    link = `/secondary/${item.id}/`;
                } else if (isApartments) {
                    // В режиме квартир используем точки ЖК (как в режиме ЖК)
                    // Проверяем, содержит ли ID формат квартиры (complex_id_apt_apartment_id)
                    if (item.id.includes('_apt_')) {
                        // Если это ID квартиры, извлекаем complex_id и apartment_id
                        const parts = item.id.split('_apt_');
                        if (parts.length === 2) {
                            const complexId = parts[0];
                            const apartmentId = parts[1];
                            link = `/apartment/${complexId}/${apartmentId}/`;
                        } else {
                            link = `/complex/${parts[0]}/`;
                        }
                    } else {
                        // Если это просто ID ЖК (что и должно быть после исправления)
                        link = `/complex/${item.id}/`;
                    }
                } else {
                    link = `/complex/${item.id}/`;
                }
                
                marker.bindPopup(`<b>${item.name}</b><br/>${price}<br/><a href="${link}">Подробнее</a>`);
                bounds.push([lat, lng]);
            }
        });
        
        // Обновляем границы карты, если есть маркеры
        if (bounds.length) {
            window.map.fitBounds(bounds, { padding: [20, 20] });
        } else {
            // Если нет маркеров, устанавливаем вид по умолчанию (Уфа)
            window.map.setView([54.7388, 55.9721], 11);
        }
    }

    // Глобальная функция setView
    window.setView = function (view) {
        const grid = document.getElementById('catalog-grid');
        const mapEl = document.getElementById('map');
        const toggleBtns = document.querySelectorAll('.view-btn');
        const isSecondary = '{{ dataset_type }}' === 'secondary';

        // Не позволяем переключиться на карту для вторичной недвижимости
        if (isSecondary && view === 'map') {
            return;
        }

        toggleBtns.forEach(b => b.classList.toggle('active', b.getAttribute('data-view') === view));

        // Всегда показываем оба элемента, но меняем порядок
        if (view === 'map') {
            // Карта сверху, список снизу
            mapEl.style.display = 'block';
            mapEl.style.order = '1';
            grid.style.display = 'block';
            grid.style.order = '2';
            if (!window.map) initMap();
            fetchData();
        } else {
            // Список сверху, карта снизу (или скрыта для вторички)
            if (isSecondary) {
                mapEl.style.display = 'none';
                grid.style.display = 'block';
            } else {
                mapEl.style.display = 'block';
                mapEl.style.order = '2';
                grid.style.display = 'block';
                grid.style.order = '1';
            }
            fetchData();
        }

        // Сохраняем в localStorage только для новостроек
        if (!isSecondary) {
            localStorage.setItem('catalog_view', view);
        }
    }

    // Инициализация глобальных переменных для AJAX
    window.activeController = null;
    window.latestRequestId = 0;
    window.map = null;
    window.markersLayer = null;

    // Range Slider функциональность
    document.addEventListener('DOMContentLoaded', function () {
        // Инициализация range sliders
        initRangeSlider('area-from-slider', 'area-to-slider', 'area-from-display', 'area-to-display', 'area-from-hidden', 'area-to-hidden', 'area-fill');
        initRangeSlider('price-from-slider', 'price-to-slider', 'price-from-display', 'price-to-display', 'price-from-hidden', 'price-to-hidden', 'price-fill');

        // Обработка отправки формы фильтров (для всех типов недвижимости)
        const filtersForm = document.getElementById('filters-form');
        if (filtersForm) {
            filtersForm.addEventListener('submit', function (e) {
                e.preventDefault();
                applyFilters();
            });
        }

        // Обработка нажатия на кнопку "Поиск" - закрытие фильтра теперь в обработчике submit формы

        // Обработка выбора города
        const cityGroup = document.getElementById('city-group');
        const cityDropdown = document.getElementById('city-dropdown');
        const cityList = document.getElementById('city-list');
        const cityInput = document.getElementById('city-input');
        const cityText = document.getElementById('city-text');
        const cityHidden = document.getElementById('city-hidden');
        const districtGroup = document.getElementById('district-group');
        const streetGroup = document.getElementById('street-group');
        const districtDropdown = document.getElementById('district-dropdown');
        const streetDropdown = document.getElementById('street-dropdown');
        const districtList = document.getElementById('district-list');
        const streetList = document.getElementById('street-list');
        const districtInput = document.getElementById('district-input');
        const streetInput = document.getElementById('street-input');
        const districtText = document.getElementById('district-text');
        const streetText = document.getElementById('street-text');
        const districtHidden = document.getElementById('district-hidden');
        const streetHidden = document.getElementById('street-hidden');
        const deliveryQuarterGroup = document.getElementById('delivery-quarter-group');
        const deliveryQuarterDropdown = document.getElementById('delivery-quarter-dropdown');
        const deliveryQuarterList = document.getElementById('delivery-quarter-list');
        const deliveryQuarterInput = document.getElementById('delivery-quarter-input');
        const deliveryQuarterText = document.getElementById('delivery-quarter-text');
        const deliveryQuarterHidden = document.getElementById('delivery-quarter-hidden');
        
        // Функция обновления текста в выпадающем списке города
        window.updateCityText = function() {
            if (!cityText) return;
            const checkedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);
            if (checkedCities.length === 0) {
                cityText.textContent = 'Любой';
            } else if (checkedCities.length === 1) {
                cityText.textContent = checkedCities[0];
            } else {
                cityText.textContent = `Выбрано: ${checkedCities.length}`;
            }
        };
        
        // Функция обновления скрытого поля города
        function updateCityHidden() {
            if (!cityHidden) return;
            const checkedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);
            cityHidden.value = checkedCities.join(',');
            window.updateCityText();
        }
        
        // Функция обновления текста в выпадающем списке срока сдачи
        window.updateDeliveryQuarterText = function() {
            if (!deliveryQuarterText) return;
            const checked = document.querySelectorAll('.delivery-quarter-checkbox:checked');
            if (checked.length === 0) {
                deliveryQuarterText.textContent = 'Любой срок';
            } else if (checked.length === 1) {
                deliveryQuarterText.textContent = checked[0].nextElementSibling.textContent;
            } else {
                deliveryQuarterText.textContent = `Выбрано: ${checked.length}`;
            }
        };
        
        // Функция обновления скрытого поля срока сдачи
        function updateDeliveryQuarterHidden() {
            if (!deliveryQuarterHidden) return;
            const checked = Array.from(document.querySelectorAll('.delivery-quarter-checkbox:checked')).map(cb => cb.value);
            deliveryQuarterHidden.value = checked.join(',');
            window.updateDeliveryQuarterText();
        }

        // Функция обновления текста в выпадающем списке районов
        window.updateDistrictText = function() {
            const districtText = document.getElementById('district-text');
            if (!districtText) return;
            const checked = document.querySelectorAll('.district-checkbox:checked');
            if (checked.length === 0) {
                districtText.textContent = 'Любой';
            } else if (checked.length === 1) {
                districtText.textContent = checked[0].value;
            } else {
                districtText.textContent = `Выбрано: ${checked.length}`;
            }
        }

        // Функция обновления текста в выпадающем списке улиц
        window.updateStreetText = function() {
            const streetText = document.getElementById('street-text');
            if (!streetText) return;
            const checked = document.querySelectorAll('.street-checkbox:checked');
            if (checked.length === 0) {
                streetText.textContent = 'Любая';
            } else if (checked.length === 1) {
                streetText.textContent = checked[0].value;
            } else {
                streetText.textContent = `Выбрано: ${checked.length}`;
            }
        }

        // Функция загрузки улиц по выбранным районам
        function loadStreetsForDistricts(selectedDistricts) {
            const checkedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);
            const city = checkedCities.length > 0 ? checkedCities[0] : '';
            const streetList = document.getElementById('street-list');
            const streetHidden = document.getElementById('street-hidden');
            
            if (!city || !streetList) return;
            
            // Сохраняем текущие выбранные улицы
            const currentSelectedStreets = streetHidden ? streetHidden.value.split(',').filter(s => s.trim()) : [];
            
            // Формируем URL для запроса улиц
            let url = `/api/streets/?city=${encodeURIComponent(city)}`;
            if (selectedDistricts.length > 0) {
                url += `&district=${selectedDistricts.map(d => encodeURIComponent(d)).join(',')}`;
            }
            
            // Показываем индикатор загрузки только если список открыт или виден
            const streetInput = document.getElementById('street-input');
            if (streetInput && streetInput.classList.contains('active')) {
                streetList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Загрузка...</div>';
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    streetList.innerHTML = '';
                    
                    if (data.streets && data.streets.length > 0) {
                        data.streets.forEach(street => {
                            // Проверяем, была ли эта улица выбрана ранее
                            const wasSelected = currentSelectedStreets.includes(street);
                            const item = document.createElement('label');
                            item.className = 'custom-dropdown-item';
                            item.innerHTML = `
                                <input type="checkbox" name="street" value="${street}" 
                                       class="street-checkbox" data-street="${street}" ${wasSelected ? 'checked' : ''}>
                                <span>${street}</span>
                            `;
                            streetList.appendChild(item);
                        });
                        
                        // Перепривязываем обработчики для новых чекбоксов
                        document.querySelectorAll('.street-checkbox').forEach(checkbox => {
                            // Удаляем старые обработчики
                            const newCheckbox = checkbox.cloneNode(true);
                            checkbox.parentNode.replaceChild(newCheckbox, checkbox);
                            newCheckbox.addEventListener('change', function() {
                                updateStreetHidden();
                                window.resetPageAndFetch();
                            });
                        });
                        
                        // Обновляем скрытое поле, оставляя только те улицы, которые есть в новом списке
                        const validSelectedStreets = currentSelectedStreets.filter(s => 
                            data.streets.includes(s)
                        );
                        if (streetHidden) {
                            streetHidden.value = validSelectedStreets.join(',');
                        }
                        window.updateStreetText();
                        
                        // Запускаем поиск после обновления списка улиц
                        window.fetchData();
                    } else {
                        streetList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Улицы не найдены</div>';
                        if (streetHidden) {
                            streetHidden.value = '';
                        }
                        window.updateStreetText();
                        // Запускаем поиск даже если улиц нет
                        window.fetchData();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки улиц:', error);
                    streetList.innerHTML = '<div style="padding: 20px; text-align: center; color: #e74c3c;">Ошибка загрузки</div>';
                });
        }

        // Функция обновления скрытого поля районов
        function updateDistrictHidden() {
            const districtHidden = document.getElementById('district-hidden');
            const checked = Array.from(document.querySelectorAll('.district-checkbox:checked'))
                .map(cb => cb.value);
            if (districtHidden) {
                districtHidden.value = checked.join(',');
            }
            window.updateDistrictText();
            
            // Загружаем улицы для выбранных районов
            const checkedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);
            if (checkedCities.length > 0) {
                loadStreetsForDistricts(checked);
            }
        }

        // Функция обновления скрытого поля улиц
        function updateStreetHidden() {
            const streetHidden = document.getElementById('street-hidden');
            const checked = Array.from(document.querySelectorAll('.street-checkbox:checked'))
                .map(cb => cb.value);
            if (streetHidden) {
                streetHidden.value = checked.join(',');
            }
            window.updateStreetText();
        }

        // Инициализация текста при загрузке
        // Сначала инициализируем город из скрытого поля, если он есть
        if (cityHidden && cityHidden.value) {
            const selectedCity = cityHidden.value.split(',')[0].trim(); // Берем первый город, если несколько
            if (selectedCity) {
                const cityCheckbox = document.querySelector(`.city-checkbox[value="${selectedCity}"]`);
                if (cityCheckbox) {
                    cityCheckbox.checked = true;
                }
            }
        }
        // Обновляем текст после инициализации
        window.updateCityText();
        window.updateDistrictText();
        window.updateStreetText();
        window.updateDeliveryQuarterText();

        // Функция для вычисления позиции выпадающего списка
        function updateDropdownPosition(input, list) {
            if (!input || !list) return;
            const rect = input.getBoundingClientRect();
            list.style.top = (rect.bottom + 4) + 'px';
            list.style.left = rect.left + 'px';
            list.style.width = rect.width + 'px';
        }

        // Функция для перемещения списка в body при открытии
        function moveDropdownToBody(list, input) {
            if (!list || !input) return;
            // Если список уже в body, не перемещаем
            if (list.parentElement === document.body) return;
            
            // Сохраняем оригинального родителя
            if (!list.dataset.originalParent) {
                // Определяем правильный родитель по ID списка
                let defaultParent = 'district-group';
                if (list.id === 'city-list') {
                    defaultParent = 'city-group';
                } else if (list.id === 'street-list') {
                    defaultParent = 'street-group';
                }
                list.dataset.originalParent = list.parentElement.id || defaultParent;
            }
            
            // Перемещаем в body
            document.body.appendChild(list);
            updateDropdownPosition(input, list);
        }

        // Функция для возврата списка на место при закрытии
        function returnDropdownToOriginal(list) {
            if (!list || !list.dataset.originalParent) return;
            const originalParent = document.getElementById(list.dataset.originalParent) || 
                                   document.querySelector('.filter-group');
            if (originalParent && list.parentElement === document.body) {
                originalParent.appendChild(list);
            }
        }

        // Обработка открытия/закрытия выпадающего списка города
        if (cityInput && cityList) {
            cityInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const isActive = cityInput.classList.contains('active');
                
                // Закрываем все выпадающие списки
                if (districtInput) districtInput.classList.remove('active');
                if (districtList) {
                    districtList.classList.remove('active');
                    returnDropdownToOriginal(districtList);
                }
                if (streetInput) streetInput.classList.remove('active');
                if (streetList) {
                    streetList.classList.remove('active');
                    returnDropdownToOriginal(streetList);
                }
                if (deliveryQuarterInput) deliveryQuarterInput.classList.remove('active');
                if (deliveryQuarterList) {
                    deliveryQuarterList.classList.remove('active');
                    returnDropdownToOriginal(deliveryQuarterList);
                }
                
                if (isActive) {
                    cityInput.classList.remove('active');
                    cityList.classList.remove('active');
                    returnDropdownToOriginal(cityList);
                } else {
                    cityInput.classList.add('active');
                    cityList.classList.add('active');
                    // Перемещаем в body и вычисляем позицию
                    moveDropdownToBody(cityList, cityInput);
                }
            });
        }
        
        // Обработка выбора города через чекбоксы
        document.querySelectorAll('.city-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Для города можно выбрать только один - снимаем выбор с других
                if (this.checked) {
                    document.querySelectorAll('.city-checkbox').forEach(cb => {
                        if (cb !== this) cb.checked = false;
                    });
                }
                updateCityHidden();
                
                // Загружаем районы и улицы для выбранного города
                const selectedCity = this.checked ? this.value : '';
                if (selectedCity) {
                    // Загружаем районы для выбранного города
                    fetch(`/api/districts/?city=${encodeURIComponent(selectedCity)}`)
                        .then(response => response.json())
                        .then(data => {
                            districtList.innerHTML = '';
                            data.districts.forEach(district => {
                                const item = document.createElement('label');
                                item.className = 'custom-dropdown-item';
                                item.innerHTML = `
                                    <input type="checkbox" name="district" value="${district}" 
                                           class="district-checkbox" data-district="${district}">
                                    <span>${district}</span>
                                `;
                                districtList.appendChild(item);
                            });
                            // Перепривязываем обработчики
                            document.querySelectorAll('.district-checkbox').forEach(checkbox => {
                                checkbox.addEventListener('change', function() {
                                    updateDistrictHidden();
                                });
                            });
                            districtGroup.classList.remove('hidden');
                            updateDistrictHidden();
                        });
                    
                    // Загружаем все улицы для выбранного города
                    loadStreetsForDistricts([]);
                    streetGroup.classList.remove('hidden');
                } else {
                    // Если город не выбран, скрываем районы и улицы
                    districtGroup.classList.add('hidden');
                    streetGroup.classList.add('hidden');
                    if (districtHidden) districtHidden.value = '';
                    if (streetHidden) streetHidden.value = '';
                    window.updateDistrictText();
                    window.updateStreetText();
                }
                
                // Запускаем поиск
                window.fetchData();
            });
        });
        
        // Обработка открытия/закрытия выпадающего списка районов
        if (districtInput && districtList) {
            districtInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const isActive = districtInput.classList.contains('active');
                
                // Закрываем все выпадающие списки
                if (cityInput) cityInput.classList.remove('active');
                if (cityList) {
                    cityList.classList.remove('active');
                    returnDropdownToOriginal(cityList);
                }
                if (streetInput) streetInput.classList.remove('active');
                if (streetList) {
                    streetList.classList.remove('active');
                    returnDropdownToOriginal(streetList);
                }
                
                if (isActive) {
                    districtInput.classList.remove('active');
                    districtList.classList.remove('active');
                    returnDropdownToOriginal(districtList);
                } else {
                    districtInput.classList.add('active');
                    districtList.classList.add('active');
                    // Перемещаем в body и вычисляем позицию
                    moveDropdownToBody(districtList, districtInput);
                }
            });
        }

        // Обработка открытия/закрытия выпадающего списка улиц
        if (streetInput && streetList) {
            streetInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const isActive = streetInput.classList.contains('active');
                
                // Закрываем все выпадающие списки
                if (cityInput) cityInput.classList.remove('active');
                if (cityList) {
                    cityList.classList.remove('active');
                    returnDropdownToOriginal(cityList);
                }
                if (districtInput) districtInput.classList.remove('active');
                if (districtList) {
                    districtList.classList.remove('active');
                    returnDropdownToOriginal(districtList);
                }
                if (deliveryQuarterInput) deliveryQuarterInput.classList.remove('active');
                if (deliveryQuarterList) {
                    deliveryQuarterList.classList.remove('active');
                    returnDropdownToOriginal(deliveryQuarterList);
                }
                
                if (isActive) {
                    streetInput.classList.remove('active');
                    streetList.classList.remove('active');
                    returnDropdownToOriginal(streetList);
                } else {
                    streetInput.classList.add('active');
                    streetList.classList.add('active');
                    // Перемещаем в body и вычисляем позицию
                    moveDropdownToBody(streetList, streetInput);
                }
            });
        }

        // Обновляем позицию при скролле и изменении размера окна
        window.addEventListener('scroll', function() {
            if (cityList && cityList.classList.contains('active') && cityInput) {
                updateDropdownPosition(cityInput, cityList);
            }
            if (districtList && districtList.classList.contains('active') && districtInput) {
                updateDropdownPosition(districtInput, districtList);
            }
            if (streetList && streetList.classList.contains('active') && streetInput) {
                updateDropdownPosition(streetInput, streetList);
            }
        }, true);

        window.addEventListener('resize', function() {
            if (cityList && cityList.classList.contains('active') && cityInput) {
                updateDropdownPosition(cityInput, cityList);
            }
            if (districtList && districtList.classList.contains('active') && districtInput) {
                updateDropdownPosition(districtInput, districtList);
            }
            if (streetList && streetList.classList.contains('active') && streetInput) {
                updateDropdownPosition(streetInput, streetList);
            }
        });

        // Обработка открытия/закрытия выпадающего списка срока сдачи
        if (deliveryQuarterInput && deliveryQuarterList) {
            deliveryQuarterInput.addEventListener('click', function(e) {
                e.stopPropagation();
                const isActive = deliveryQuarterInput.classList.contains('active');
                
                // Закрываем все выпадающие списки
                if (cityInput) cityInput.classList.remove('active');
                if (cityList) {
                    cityList.classList.remove('active');
                    returnDropdownToOriginal(cityList);
                }
                if (districtInput) districtInput.classList.remove('active');
                if (districtList) {
                    districtList.classList.remove('active');
                    returnDropdownToOriginal(districtList);
                }
                if (streetInput) streetInput.classList.remove('active');
                if (streetList) {
                    streetList.classList.remove('active');
                    returnDropdownToOriginal(streetList);
                }
                
                if (isActive) {
                    deliveryQuarterInput.classList.remove('active');
                    deliveryQuarterList.classList.remove('active');
                    returnDropdownToOriginal(deliveryQuarterList);
                } else {
                    deliveryQuarterInput.classList.add('active');
                    deliveryQuarterList.classList.add('active');
                    // Перемещаем в body и вычисляем позицию
                    moveDropdownToBody(deliveryQuarterList, deliveryQuarterInput);
                }
            });
        }
        
        // Обработка выбора срока сдачи через чекбоксы
        document.querySelectorAll('.delivery-quarter-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Для срока сдачи можно выбрать только один - снимаем выбор с других
                if (this.checked) {
                    document.querySelectorAll('.delivery-quarter-checkbox').forEach(cb => {
                        if (cb !== this) cb.checked = false;
                    });
                }
                updateDeliveryQuarterHidden();
                
                // Запускаем поиск
                window.fetchData();
            });
        });
        
        // Закрытие выпадающих списков при клике вне их
        document.addEventListener('click', function(e) {
            if (cityDropdown && !cityDropdown.contains(e.target) && 
                cityList && !cityList.contains(e.target)) {
                if (cityInput) cityInput.classList.remove('active');
                if (cityList) {
                    cityList.classList.remove('active');
                    returnDropdownToOriginal(cityList);
                }
            }
            if (districtDropdown && !districtDropdown.contains(e.target) && 
                districtList && !districtList.contains(e.target)) {
                if (districtInput) districtInput.classList.remove('active');
                if (districtList) {
                    districtList.classList.remove('active');
                    returnDropdownToOriginal(districtList);
                }
            }
            if (streetDropdown && !streetDropdown.contains(e.target) && 
                streetList && !streetList.contains(e.target)) {
                if (streetInput) streetInput.classList.remove('active');
                if (streetList) {
                    streetList.classList.remove('active');
                    returnDropdownToOriginal(streetList);
                }
            }
            if (deliveryQuarterDropdown && !deliveryQuarterDropdown.contains(e.target) && 
                deliveryQuarterList && !deliveryQuarterList.contains(e.target)) {
                if (deliveryQuarterInput) deliveryQuarterInput.classList.remove('active');
                if (deliveryQuarterList) {
                    deliveryQuarterList.classList.remove('active');
                    returnDropdownToOriginal(deliveryQuarterList);
                }
            }
        });

        // Также закрываем при скролле страницы (опционально, можно убрать если нужно)
        // window.addEventListener('scroll', function() {
        //     districtInput.classList.remove('active');
        //     districtList.classList.remove('active');
        //     streetInput.classList.remove('active');
        //     streetList.classList.remove('active');
        // }, true);

        // Обработка изменения чекбоксов районов
        document.querySelectorAll('.district-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateDistrictHidden();
                // Не запускаем fetchData сразу, так как загрузка улиц может занять время
                // Запустим после обновления списка улиц
            });
        });

        // Обработка изменения чекбоксов улиц
        document.querySelectorAll('.street-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateStreetHidden();
                window.resetPageAndFetch();
            });
        });

        // Инициализация выбранных значений из скрытых полей
        const urlParams = new URLSearchParams(window.location.search);
        const urlCity = urlParams.get('city') || (cityHidden ? cityHidden.value : '');
        const urlDistricts = urlParams.get('district') || (districtHidden ? districtHidden.value : '');
        const urlStreets = urlParams.get('street') || (streetHidden ? streetHidden.value : '');
        const urlDeliveryQuarter = urlParams.get('delivery_quarter') || (deliveryQuarterHidden ? deliveryQuarterHidden.value : '');
        const selectedDistrictsFromUrl = urlDistricts ? urlDistricts.split(',').map(d => d.trim()).filter(d => d) : [];
        const selectedStreetsFromUrl = urlStreets ? urlStreets.split(',').map(s => s.trim()).filter(s => s) : [];
        
        // Инициализация города из URL или скрытого поля
        if (urlCity) {
            const cityValue = urlCity.split(',')[0].trim();
            const cityCheckbox = document.querySelector(`.city-checkbox[value="${cityValue}"]`);
            if (cityCheckbox) {
                cityCheckbox.checked = true;
                if (cityHidden) {
                    cityHidden.value = cityValue;
                }
            }
        }
        
        // Инициализация срока сдачи из URL или скрытого поля
        if (urlDeliveryQuarter) {
            const quarterValue = urlDeliveryQuarter.split(',')[0].trim();
            const quarterCheckbox = document.querySelector(`.delivery-quarter-checkbox[value="${quarterValue}"]`);
            if (quarterCheckbox) {
                quarterCheckbox.checked = true;
                if (deliveryQuarterHidden) {
                    deliveryQuarterHidden.value = quarterValue;
                }
            }
        }

        // Инициализация: загружаем районы и улицы, если город уже выбран
        const checkedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);
        if (checkedCities.length > 0) {
            const selectedCity = checkedCities[0];
            const selectedDistricts = selectedDistrictsFromUrl.length > 0 ? selectedDistrictsFromUrl : (districtHidden ? districtHidden.value.split(',').filter(d => d) : []);

            // Загружаем районы
            fetch(`/api/districts/?city=${selectedCity}`)
                .then(response => response.json())
                .then(data => {
                    districtList.innerHTML = '';
                    data.districts.forEach(district => {
                        const isChecked = selectedDistricts.includes(district);
                        const item = document.createElement('label');
                        item.className = 'custom-dropdown-item';
                        item.innerHTML = `
                            <input type="checkbox" name="district" value="${district}" 
                                   class="district-checkbox" data-district="${district}" ${isChecked ? 'checked' : ''}>
                            <span>${district}</span>
                        `;
                        districtList.appendChild(item);
                    });
                    // Обновляем скрытое поле и текст
                    if (selectedDistricts.length > 0 && districtHidden) {
                        districtHidden.value = selectedDistricts.join(',');
                    }
                    window.updateDistrictText();
                    // Перепривязываем обработчики
                    document.querySelectorAll('.district-checkbox').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            updateDistrictHidden();
                        });
                    });
                    districtGroup.classList.remove('hidden');
                });

            // Загружаем улицы для выбранных районов (или все, если районы не выбраны)
            loadStreetsForDistricts(selectedDistricts);
            streetGroup.classList.remove('hidden');
        }

        // Обработка изменения города уже добавлена выше в обработчике чекбоксов
        // Удаляем старый обработчик для select, так как теперь используем кастомный выпадающий список



        // Обработка кнопок фильтра количества комнат и скидок
        const filterBtns = document.querySelectorAll('.filter-btn');
        const roomsHidden = document.getElementById('rooms-hidden');
        const hasOffersHidden = document.getElementById('has_offers-hidden');

        // Инициализация состояния кнопок комнат при загрузке страницы
        if (roomsHidden && roomsHidden.value) {
            const selectedRooms = roomsHidden.value.split(',').filter(v => v.trim() !== '');
            const roomsGroup = roomsHidden.closest('.filter-group');
            if (roomsGroup && selectedRooms.length > 0) {
                const roomsBtns = roomsGroup.querySelectorAll('.filter-btn');
                roomsBtns.forEach(btn => {
                    const btnValue = btn.getAttribute('data-value');
                    if (btnValue === '') {
                        // Кнопка "Любое" - неактивна, если выбраны конкретные комнаты
                        btn.setAttribute('data-active', 'false');
                        btn.classList.remove('active');
                    } else if (selectedRooms.includes(btnValue)) {
                        // Кнопка выбрана
                        btn.setAttribute('data-active', 'true');
                        btn.classList.add('active');
                    } else {
                        // Кнопка не выбрана
                        btn.setAttribute('data-active', 'false');
                        btn.classList.remove('active');
                    }
                });
            }
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const parentGroup = this.closest('.filter-group');
                const groupBtns = parentGroup.querySelectorAll('.filter-btn');
                const hiddenField = parentGroup.querySelector('input[type="hidden"]');
                const isRoomsFilter = hiddenField && hiddenField.id === 'rooms-hidden';

                const clickedValue = this.getAttribute('data-value');
                const isCurrentlyActive = this.getAttribute('data-active') === 'true';

                if (isRoomsFilter) {
                    // Множественный выбор для фильтра комнат
                    if (clickedValue === '') {
                        // Кнопка "Любое" - сбрасываем все выборы
                        groupBtns.forEach(b => {
                            b.setAttribute('data-active', 'false');
                            b.classList.remove('active');
                        });
                        this.setAttribute('data-active', 'true');
                        this.classList.add('active');
                        hiddenField.value = '';
                    } else {
                        // Обычная кнопка комнат - toggle
                        if (isCurrentlyActive) {
                            // Убираем из выбора
                            this.setAttribute('data-active', 'false');
                            this.classList.remove('active');
                        } else {
                            // Добавляем в выбор
                            this.setAttribute('data-active', 'true');
                            this.classList.add('active');
                            // Убираем активность с кнопки "Любое"
                            groupBtns.forEach(b => {
                                if (b.getAttribute('data-value') === '') {
                                    b.setAttribute('data-active', 'false');
                                    b.classList.remove('active');
                                }
                            });
                        }

                        // Собираем все выбранные значения
                        const selectedValues = [];
                        groupBtns.forEach(b => {
                            if (b.getAttribute('data-value') !== '' && b.getAttribute('data-active') === 'true') {
                                selectedValues.push(b.getAttribute('data-value'));
                            }
                        });

                        // Если ничего не выбрано, активируем кнопку "Любое"
                        if (selectedValues.length === 0) {
                            groupBtns.forEach(b => {
                                if (b.getAttribute('data-value') === '') {
                                    b.setAttribute('data-active', 'true');
                                    b.classList.add('active');
                                }
                            });
                            hiddenField.value = '';
                        } else {
                            // Обновляем скрытое поле
                            hiddenField.value = selectedValues.join(',');
                        }
                    }
                } else {
                    // Одиночный выбор для других фильтров (скидки и т.д.)
                    groupBtns.forEach(b => {
                        b.setAttribute('data-active', 'false');
                        b.classList.remove('active');
                    });

                    this.setAttribute('data-active', 'true');
                    this.classList.add('active');

                    if (hiddenField) {
                        hiddenField.value = clickedValue;
                    }
                }

                // Мгновенный запуск поиска без перезагрузки страницы
                const form = document.getElementById('filters-form');
                if (form) {
                    form.dispatchEvent(new Event('submit', { cancelable: true }));
                }
            });
        });

        // Обработка сортировки
        const sortingActive = document.getElementById('sorting-active');
        const sortingOptions = document.getElementById('sorting-options');
        const sortingDropdown = document.querySelector('.sorting-dropdown');
        const sortHidden = document.getElementById('sort-hidden');
        const sortingText = document.getElementById('sorting-text');

        sortingActive.addEventListener('click', function () {
            sortingDropdown.classList.toggle('active');
            sortingOptions.classList.toggle('active');
        });

        // Закрытие сортировки при клике вне её
        document.addEventListener('click', function (e) {
            if (!sortingDropdown.contains(e.target)) {
                sortingDropdown.classList.remove('active');
                sortingOptions.classList.remove('active');
            }
        });

        // Обработка выбора сортировки
        const sortingOptionBtns = document.querySelectorAll('.sorting-option');
        sortingOptionBtns.forEach(option => {
            option.addEventListener('click', function () {
                const sortValue = this.getAttribute('data-sort');
                const sortText = this.querySelector('span').textContent;

                // Обновляем скрытое поле
                sortHidden.value = sortValue;

                // Обновляем текст в активной кнопке
                sortingText.textContent = sortText;

                // Убираем активное состояние у всех опций
                sortingOptionBtns.forEach(o => o.classList.remove('active'));

                // Устанавливаем активное состояние для выбранной опции
                this.classList.add('active');

                // Закрываем dropdown
                sortingDropdown.classList.remove('active');
                sortingOptions.classList.remove('active');

                // Автоматически выполняем поиск с новой сортировкой
                window.fetchData();
            });
        });

        // Обработка кликов по display полям для ручного ввода
        document.querySelectorAll('.range-display').forEach(display => {
            display.addEventListener('click', function () {
                const container = this.closest('.range-container');
                const fromDisplay = container.querySelector('.range-value strong:first-of-type');
                const toDisplay = container.querySelector('.range-value strong:last-of-type');

                // Создаем временные input поля для ручного ввода
                const fromInput = document.createElement('input');
                fromInput.type = 'number';
                fromInput.className = 'temp-input';
                fromInput.value = fromDisplay.textContent;
                fromInput.style.cssText = 'width: 50px; padding: 3px; border: 1px solid #0066cc; border-radius: 3px; margin-right: 6px; font-size: 12px;';

                const toInput = document.createElement('input');
                toInput.type = 'number';
                toInput.className = 'temp-input';
                toInput.value = toDisplay.textContent;
                toInput.style.cssText = 'width: 50px; padding: 3px; border: 1px solid #0066cc; border-radius: 3px; margin-left: 6px; font-size: 12px;';

                // Заменяем display на input поля
                fromDisplay.parentNode.replaceChild(fromInput, fromDisplay);
                toDisplay.parentNode.replaceChild(toInput, toDisplay);

                // Фокус на первое поле
                fromInput.focus();

                // Обработка завершения ввода
                function finishInput() {
                    const fromValue = parseFloat(fromInput.value) || 0;
                    const toValue = parseFloat(toInput.value) || 0;

                    // Восстанавливаем display
                    fromDisplay.textContent = fromValue;
                    toDisplay.textContent = toValue;

                    fromInput.parentNode.replaceChild(fromDisplay, fromInput);
                    toInput.parentNode.replaceChild(toDisplay, toInput);

                    // Обновляем slider значения
                    const fromSlider = container.querySelector('input[type="range"]:first-of-type');
                    const toSlider = container.querySelector('input[type="range"]:last-of-type');
                    const fromHidden = container.querySelector('input[type="hidden"]:first-of-type');
                    const toHidden = container.querySelector('input[type="hidden"]:last-of-type');

                    fromSlider.value = fromValue;
                    toSlider.value = toValue;
                    fromHidden.value = fromValue;
                    toHidden.value = toValue;

                    // Обновляем fill
                    updateRangeFill(fromSlider, toSlider, container.querySelector('.range-fill'));
                }

                // Обработчики событий
                fromInput.addEventListener('blur', finishInput);
                toInput.addEventListener('blur', finishInput);
                fromInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') finishInput();
                });
                toInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') finishInput();
                });
            });
        });
    });

    function initRangeSlider(fromSliderId, toSliderId, fromDisplayId, toDisplayId, fromHiddenId, toHiddenId, fillId) {
        const fromSlider = document.getElementById(fromSliderId);
        const toSlider = document.getElementById(toSliderId);
        const fromDisplay = document.getElementById(fromDisplayId);
        const toDisplay = document.getElementById(toDisplayId);
        const fromHidden = document.getElementById(fromHiddenId);
        const toHidden = document.getElementById(toHiddenId);
        const fill = document.querySelector('.' + fillId);

        if (!fromSlider || !toSlider) return;

        // Устанавливаем начальные значения (пустые значения не применяем как фильтр)
        if (fromHidden.value !== '' && toHidden.value !== '') {
            fromSlider.value = fromHidden.value;
            toSlider.value = toHidden.value;
        } else {
            fromSlider.value = fromSlider.min;
            toSlider.value = toSlider.max;
        }
        fromDisplay.textContent = fromSlider.value;
        toDisplay.textContent = toSlider.value;

        // Обновляем fill при загрузке
        updateRangeFill(fromSlider, toSlider, fill);

        // Обработчики событий
        fromSlider.addEventListener('input', function () {
            const fromValue = parseInt(this.value);
            const toValue = parseInt(toSlider.value);

            if (fromValue > toValue) {
                this.value = toValue;
                fromValue = toValue;
            }

            fromDisplay.textContent = fromValue;
            fromHidden.value = fromValue;
            updateRangeFill(fromSlider, toSlider, fill);

            // Автоматически выполняем поиск при изменении слайдера
            window.fetchData();
        });

        toSlider.addEventListener('input', function () {
            const fromValue = parseInt(fromSlider.value);
            const toValue = parseInt(this.value);

            if (toValue < fromValue) {
                this.value = fromValue;
                toValue = fromValue;
            }

            toDisplay.textContent = toValue;
            toHidden.value = toValue;
            updateRangeFill(fromSlider, toSlider, fill);

            // Автоматически выполняем поиск при изменении слайдера
            window.fetchData();
        });
    }

    function updateRangeFill(fromSlider, toSlider, fill) {
        if (!fill) return;

        const fromValue = parseInt(fromSlider.value);
        const toValue = parseInt(toSlider.value);
        const min = parseInt(fromSlider.min);
        const max = parseInt(fromSlider.max);

        const fromPercent = ((fromValue - min) / (max - min)) * 100;
        const toPercent = ((toValue - min) / (max - min)) * 100;

        // Учитываем отступы в 10px с каждой стороны
        const adjustedFromPercent = fromPercent * 0.8 + 10; // 80% от ширины + 10px отступ
        const adjustedToPercent = toPercent * 0.8 + 10;

        fill.style.left = adjustedFromPercent + '%';
        fill.style.width = (adjustedToPercent - adjustedFromPercent) + '%';
    }



    // Обработка чипов категорий вторички (выбор без авто-перехода)
    (function () {
        const chipBtns = document.querySelectorAll('.filter-chip-btn');
        const stypeHidden = document.getElementById('stype-hidden');
        if (!chipBtns.length || !stypeHidden) return;
        chipBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                chipBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                stypeHidden.value = this.getAttribute('data-value');
                // Мгновенный запуск поиска
                const form = document.getElementById('filters-form');
                if (form) form.dispatchEvent(new Event('submit', { cancelable: true }));
            });
            // Инициализация активного состояния из скрытого поля
            if (btn.getAttribute('data-value') === (stypeHidden.value || '')) {
                btn.classList.add('active');
            }
        });
    })();

    // Эффект тени для sticky шапки при прокрутке
    window.addEventListener('scroll', function () {
        const header = document.querySelector('.main-header');
        if (window.scrollY > 10) {
            header.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
        } else {
            header.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.05)';
        }
    });



    // Обработчики для избранного
    function toggleComplexFavoriteHandler(complexId, button) {
        if (typeof toggleComplexFavorite === 'function') {
            const isFavorite = toggleComplexFavorite(complexId);
            if (typeof updateFavoriteIcon === 'function') {
                updateFavoriteIcon(button, isFavorite);
            }

            // Показываем уведомление
            if (isFavorite) {
                showFavoriteNotification('Добавлено в избранное');
            } else {
                showFavoriteNotification('Удалено из избранного');
            }
        }
    }

    // Глобальная функция для обработки избранного (ЖК и Квартиры)
    window.toggleFavorite = function(id, type, button) {
        if (!id || !type || !button) return;
        
        if (type === 'apartment') {
            // ID квартиры в формате: complex_id_apt_apartment_id
            // Нужно извлечь complex_id и apartment_id
            const parts = id.split('_apt_');
            if (parts.length === 2) {
                const complexId = parts[0];
                const apartmentId = parts[1];
                // Используем глобальную функцию из favorites.js
                if (typeof window.toggleApartmentFavoriteHandler === 'function') {
                    window.toggleApartmentFavoriteHandler(complexId, apartmentId, button);
                } else if (typeof toggleApartmentFavorite === 'function') {
                    // Fallback: используем напрямую функции из favorites.js
                    const isFavorite = toggleApartmentFavorite(complexId, apartmentId);
                    if (typeof updateFavoriteIcon === 'function') {
                        updateFavoriteIcon(button, isFavorite);
                    }
                    if (isFavorite) {
                        showFavoriteNotification('Квартира добавлена в избранное');
                    } else {
                        showFavoriteNotification('Квартира удалена из избранного');
                    }
                }
            }
        } else if (type === 'complex') {
            // Для ЖК просто передаем ID
            if (typeof window.toggleComplexFavoriteHandler === 'function') {
                window.toggleComplexFavoriteHandler(id, button);
            } else if (typeof toggleComplexFavorite === 'function') {
                // Fallback: используем напрямую функции из favorites.js
                const isFavorite = toggleComplexFavorite(id);
                if (typeof updateFavoriteIcon === 'function') {
                    updateFavoriteIcon(button, isFavorite);
                }
                if (isFavorite) {
                    showFavoriteNotification('Добавлено в избранное');
                } else {
                    showFavoriteNotification('Удалено из избранного');
                }
            }
        }
    }

    // Функция показа уведомления об избранном (глобальная)
    window.showFavoriteNotification = function (message) {
        // Создаем временное уведомление
        const notification = document.createElement('div');
        notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--c21-gold);
    color: var(--c21-dark);
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10000;
    font-weight: 600;
    animation: slideInRight 0.3s ease;
  `;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 2000);
    };

    // Добавляем анимации для уведомлений
    if (!document.getElementById('favorite-notification-styles')) {
        const style = document.createElement('style');
        style.id = 'favorite-notification-styles';
        style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
        document.head.appendChild(style);
    }

    // Инициализация карусели изображений при загрузке страницы
    document.addEventListener('DOMContentLoaded', function () {
        initImageCarousel();
    });

    // AJAX-загрузка без изменения URL
    (function () {
        const form = document.getElementById('filters-form');
        const grid = document.getElementById('catalog-grid');
        const resultsCount = document.querySelector('.results-count');
        const isSecondary = '{{ dataset_type }}' === 'secondary';
        const apiUrl = isSecondary ? '/api/secondary/' : '/api/catalog/';
        const mapEl = document.getElementById('map');
        let map, markersLayer;
        let activeController = null;
        let latestRequestId = 0;

        // View toggle
        const toggleBtns = document.querySelectorAll('.view-btn');
        const savedView = localStorage.getItem('catalog_view') || 'list';

        // Отключаем кнопку карты для вторичной недвижимости
        if (isSecondary) {
            const mapBtn = document.querySelector('.view-btn[data-view="map"]');
            if (mapBtn) {
                mapBtn.disabled = true;
                mapBtn.style.opacity = '0.5';
                mapBtn.style.cursor = 'not-allowed';
                mapBtn.title = 'Карта недоступна для вторичной недвижимости';
            }
        }


        toggleBtns.forEach(b => b.addEventListener('click', () => {
            // Не обрабатываем клик по кнопке карты для вторичной недвижимости
            if (isSecondary && b.getAttribute('data-view') === 'map') {
                return;
            }
            setView(b.getAttribute('data-view'));
        }));

        // Content toggle (ЖК / Квартиры) - только для новостроек
        if (!isSecondary) {
            const contentBtns = document.querySelectorAll('.content-btn');
            const savedContentMode = localStorage.getItem('catalog_content_mode') || 'complexes';
            
            // Устанавливаем активную кнопку
            contentBtns.forEach(btn => {
                const mode = btn.getAttribute('data-content');
                if (mode === savedContentMode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Обработчик клика на тумблер ЖК/Квартиры
            contentBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.getAttribute('data-content');
                    localStorage.setItem('catalog_content_mode', mode);
                    
                    // Обновляем активные кнопки
                    contentBtns.forEach(b => {
                        b.classList.toggle('active', b.getAttribute('data-content') === mode);
                    });
                    
                    // Перезагружаем данные
                    window.fetchData();
                });
            });
        }

        // Инициализация вида по умолчанию
        // Принудительно устанавливаем вид "списком" для вторичной недвижимости
        if (isSecondary) {
            setView('list');
        } else {
            // По умолчанию показываем карту для новостроек
            setView('map');
            localStorage.setItem('catalog_view', 'map');
        }



        if (form && !form.dataset.ajaxBound) {
            form.addEventListener('submit', function (e) { 
                e.preventDefault(); 
                window.fetchData(); 
            });
            form.dataset.ajaxBound = '1';
        }
        
        // Обработка нажатия на кнопку "Поиск" - закрываем фильтр только при явном клике
        const searchButton = form ? form.querySelector('button[type="submit"]') : null;
        if (searchButton) {
            searchButton.addEventListener('click', function (e) {
                // Закрываем фильтр только при явном нажатии на кнопку "Поиск" (мобильная версия)
                if (window.innerWidth <= 768) {
                    setTimeout(function () {
                        const sheet = document.getElementById('filters-sheet');
                        const backdrop = document.getElementById('filters-backdrop');
                        if (sheet) sheet.classList.remove('open');
                        if (backdrop) backdrop.classList.remove('open');
                        document.body.classList.remove('filter-open');
                    }, 100);
                }
            });
        }

        document.getElementById('clear-filters')?.addEventListener('click', function (e) {
            e.preventDefault();
            // reset native form controls
            form.reset();

            // reset area range
            const afs = document.getElementById('area-from-slider');
            const ats = document.getElementById('area-to-slider');
            const afd = document.getElementById('area-from-display');
            const atd = document.getElementById('area-to-display');
            const afh = document.getElementById('area-from-hidden');
            const ath = document.getElementById('area-to-hidden');
            if (afs && ats && afd && atd && afh && ath) {
                afs.value = afs.min;
                ats.value = ats.max;
                afd.textContent = afs.min;
                atd.textContent = ats.max;
                afh.value = '';
                ath.value = '';
                updateRangeFill(afs, ats, document.querySelector('.area-fill'));
            }

            // reset price range
            const pfs = document.getElementById('price-from-slider');
            const pts = document.getElementById('price-to-slider');
            const pfd = document.getElementById('price-from-display');
            const ptd = document.getElementById('price-to-display');
            const pfh = document.getElementById('price-from-hidden');
            const pth = document.getElementById('price-to-hidden');
            if (pfs && pts && pfd && ptd && pfh && pth) {
                pfs.value = pfs.min;
                pts.value = pts.max;
                pfd.textContent = pfs.min;
                ptd.textContent = pts.max;
                pfh.value = '';
                pth.value = '';
                updateRangeFill(pfs, pts, document.querySelector('.price-fill'));
            }

            // reset rooms filter (newbuild)
            const roomsHidden = document.getElementById('rooms-hidden');
            if (roomsHidden) roomsHidden.value = '';
            const hasOffersHidden = document.getElementById('has_offers-hidden');
            if (hasOffersHidden) hasOffersHidden.value = '';

            // reset all filter buttons
            const allFilterBtns = document.querySelectorAll('.filter-btn');
            if (allFilterBtns && allFilterBtns.length) {
                allFilterBtns.forEach(b => {
                    b.setAttribute('data-active', 'false');
                    b.classList.remove('active');
                });

                // activate "Any" buttons
                const anyBtns = Array.from(allFilterBtns).filter(b => (b.getAttribute('data-value') || '') === '');
                anyBtns.forEach(btn => {
                    btn.setAttribute('data-active', 'true');
                    btn.classList.add('active');
                });
            }

            // reset secondary type chips
            const stypeHidden = document.getElementById('stype-hidden');
            if (stypeHidden) stypeHidden.value = '';
            const chipBtns = document.querySelectorAll('.filter-chip-btn');
            if (chipBtns && chipBtns.length) {
                chipBtns.forEach(b => b.classList.remove('active'));
                const allChip = Array.from(chipBtns).find(b => (b.getAttribute('data-value') || '') === '');
                if (allChip) allChip.classList.add('active');
            }

            // reset sorting
            const sortHidden = document.getElementById('sort-hidden');
            const sortingText = document.getElementById('sorting-text');
            if (sortHidden) sortHidden.value = 'price_asc';
            if (sortingText) sortingText.textContent = 'Дешевле';
            document.querySelectorAll('.sorting-option').forEach(o => o.classList.toggle('active', o.getAttribute('data-sort') === 'price_asc'));

            // reset complexes checkboxes
            const complexesCheckboxes = document.querySelectorAll('.complex-checkbox');
            const complexesHidden = document.getElementById('complexes-hidden');
            const complexSearchInput = document.getElementById('complex-search-input');
            if (complexesCheckboxes) {
                complexesCheckboxes.forEach(cb => cb.checked = false);
            }
            if (complexesHidden) complexesHidden.value = '';

            // reset district checkboxes
            const districtCheckboxes = document.querySelectorAll('.district-checkbox');
            const districtHidden = document.getElementById('district-hidden');
            if (districtCheckboxes) {
                districtCheckboxes.forEach(cb => cb.checked = false);
            }
            if (districtHidden) districtHidden.value = '';
            if (typeof updateDistrictText === 'function') updateDistrictText();

            // reset street checkboxes
            const streetCheckboxes = document.querySelectorAll('.street-checkbox');
            const streetHidden = document.getElementById('street-hidden');
            if (streetCheckboxes) {
                streetCheckboxes.forEach(cb => cb.checked = false);
            }
            if (streetHidden) streetHidden.value = '';
            if (typeof updateStreetText === 'function') updateStreetText();
            // Очистка поля поиска ЖК и показ всех элементов
            if (complexSearchInput) {
                complexSearchInput.value = '';
                // Показываем все элементы списка
                const complexFilterItems = document.querySelectorAll('.complex-filter-item');
                complexFilterItems.forEach(item => {
                    item.style.display = 'flex';
                });
                // Скрываем сообщение "не найдено"
                const container = document.querySelector('.complexes-filter-container');
                const noResultsMsg = container ? container.querySelector('.no-results-message') : null;
                if (noResultsMsg) {
                    noResultsMsg.style.display = 'none';
                }
            }

            // fetch with cleared filters
            window.fetchData();
        });

        // Обработка чекбоксов ЖК будет инициализирована в DOMContentLoaded
    })();

    // Мгновенный сабмит при выборe фильтров — обрабатывается AJAX-слоем

    // Современные анимации для фильтров
    document.addEventListener('DOMContentLoaded', function () {
        // Инициализация чекбоксов ЖК
        const complexesCheckboxes = document.querySelectorAll('.complex-checkbox');
        const complexesHidden = document.getElementById('complexes-hidden');
        const complexSearchInput = document.getElementById('complex-search-input');
        const complexFilterItems = document.querySelectorAll('.complex-filter-item');

        function updateComplexesHidden() {
            const selected = Array.from(complexesCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            if (complexesHidden) {
                complexesHidden.value = selected.join(',');
            }
        }

        // Функция фильтрации списка ЖК по поисковому запросу
        function filterComplexes(searchText) {
            const searchLower = searchText.toLowerCase().trim();
            let visibleCount = 0;

            complexFilterItems.forEach(item => {
                const complexName = item.getAttribute('data-complex-name') || '';
                const shouldShow = !searchLower || complexName.includes(searchLower);

                if (shouldShow) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // Показываем сообщение, если ничего не найдено
            const container = document.querySelector('.complexes-filter-container');
            let noResultsMsg = container.querySelector('.no-results-message');

            if (searchLower && visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-results-message';
                    noResultsMsg.style.cssText = 'padding: 12px; text-align: center; color: #9ca3af; font-size: 14px;';
                    noResultsMsg.textContent = 'ЖК не найдены';
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        // Обработчик поиска ЖК
        if (complexSearchInput) {
            complexSearchInput.addEventListener('input', function (e) {
                filterComplexes(e.target.value);
            });

            // Очистка поиска при нажатии Escape
            complexSearchInput.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    e.target.value = '';
                    filterComplexes('');
                    e.target.blur();
                }
            });
        }

        complexesCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                updateComplexesHidden();
                window.resetPageAndFetch();
            });
        });

        // Инициализация выбранных ЖК из URL параметров или фильтров
        const urlParams = new URLSearchParams(window.location.search);
        const selectedComplexes = urlParams.get('complexes') || (complexesHidden ? complexesHidden.value : '');
        if (selectedComplexes && complexesCheckboxes.length) {
            const selectedIds = selectedComplexes.split(',').map(id => id.trim()).filter(id => id);
            complexesCheckboxes.forEach(cb => {
                if (selectedIds.includes(cb.value)) {
                    cb.checked = true;
                }
            });
            updateComplexesHidden();
        }

        // Инициализация выбранных районов и улиц из URL параметров или скрытых полей
        const districtHidden = document.getElementById('district-hidden');
        const streetHidden = document.getElementById('street-hidden');
        const urlDistricts = urlParams.get('district') || (districtHidden ? districtHidden.value : '');
        const urlStreets = urlParams.get('street') || (streetHidden ? streetHidden.value : '');
        
        if (urlDistricts) {
            const selectedDistricts = urlDistricts.split(',').map(d => d.trim()).filter(d => d);
            document.querySelectorAll('.district-checkbox').forEach(cb => {
                if (selectedDistricts.includes(cb.value)) {
                    cb.checked = true;
                }
            });
            if (districtHidden) districtHidden.value = urlDistricts;
            window.updateDistrictText();
        }
        
        if (urlStreets) {
            const selectedStreets = urlStreets.split(',').map(s => s.trim()).filter(s => s);
            document.querySelectorAll('.street-checkbox').forEach(cb => {
                if (selectedStreets.includes(cb.value)) {
                    cb.checked = true;
                }
            });
            if (streetHidden) streetHidden.value = urlStreets;
            window.updateStreetText();
        }

        // Анимация появления фильтров
        const filterGroups = document.querySelectorAll('.filter-group');
        filterGroups.forEach((group, index) => {
            group.style.opacity = '0';
            group.style.transform = 'translateY(20px)';

            setTimeout(() => {
                group.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                group.style.opacity = '1';
                group.style.transform = 'translateY(0)';
            }, index * 100);
        });

        // Анимация для кнопок фильтра
        const filterBtns = document.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
            btn.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-3px) scale(1.02)';
            });

            btn.addEventListener('mouseleave', function () {
                if (!this.getAttribute('data-active') === 'true') {
                    this.style.transform = 'translateY(0) scale(1)';
                }
            });
        });

        // Анимация для select элементов
        const filterSelects = document.querySelectorAll('.filter-select');
        filterSelects.forEach(select => {
            select.addEventListener('focus', function () {
                this.parentElement.style.transform = 'translateY(-2px)';
            });

            select.addEventListener('blur', function () {
                this.parentElement.style.transform = 'translateY(0)';
            });

            // Автоматически выполняем поиск при изменении select
            select.addEventListener('change', function () {
                // Сбрасываем страницу на 1 при изменении фильтров
                window.resetPageAndFetch();
            });
        });

        // Анимация для range sliders
        const rangeSliders = document.querySelectorAll('.range-slider-input');
        rangeSliders.forEach(slider => {
            slider.addEventListener('input', function () {
                const container = this.closest('.range-container');
                container.style.transform = 'translateY(-1px) scale(1.01)';

                setTimeout(() => {
                    container.style.transform = 'translateY(0) scale(1)';
                }, 150);
            });
        });

        // Анимация для кнопки очистки фильтров
        const clearFiltersBtn = document.querySelector('.clear-filters');
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-3px) scale(1.02)';
            });

            clearFiltersBtn.addEventListener('mouseleave', function () {
                this.style.transform = 'translateY(0) scale(1)';
            });
        }

        // Анимация для сортировки
        const sortingActive = document.querySelector('.sorting-active');
        if (sortingActive) {
            sortingActive.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-2px) scale(1.01)';
            });

            sortingActive.addEventListener('mouseleave', function () {
                this.style.transform = 'translateY(0) scale(1)';
            });
        }

        // Плавная анимация для результатов поиска
        const resultsCount = document.querySelector('.results-count');
        if (resultsCount) {
            resultsCount.style.opacity = '0';
            resultsCount.style.transform = 'translateY(10px)';

            setTimeout(() => {
                resultsCount.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
                resultsCount.style.opacity = '1';
                resultsCount.style.transform = 'translateY(0)';
            }, 500);
        }

        // Анимация для секции фильтров при скролле
        const filtersSection = document.querySelector('.filters-section');
        if (filtersSection) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, { threshold: 0.1 });

            filtersSection.style.opacity = '0';
            filtersSection.style.transform = 'translateY(30px)';
            filtersSection.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';

            observer.observe(filtersSection);
        }

        // Управление мобильным bottom-sheet фильтром
        const openBtn = document.getElementById('mobile-filter-open');
        const closeBtn = document.getElementById('mobile-filter-close');
        const sheet = document.getElementById('filters-sheet');
        const backdrop = document.getElementById('filters-backdrop');
        
        let isSheetOpen = false;
        
        function openSheet() { 
            if (sheet) { 
                sheet.classList.add('open');
                
                // Принудительно применяем стили для прокрутки через JavaScript
                sheet.style.setProperty('overflow-y', 'auto', 'important');
                sheet.style.setProperty('overflow-x', 'hidden', 'important');
                sheet.style.setProperty('-webkit-overflow-scrolling', 'touch', 'important');
                sheet.style.setProperty('touch-action', 'pan-y', 'important');
                sheet.style.setProperty('max-height', '80vh', 'important');
                sheet.style.setProperty('height', 'auto', 'important');
                
                // Убеждаемся, что форма не блокирует прокрутку
                const form = sheet.querySelector('.filters-form');
                if (form) {
                    form.style.setProperty('height', 'auto', 'important');
                    form.style.setProperty('overflow', 'visible', 'important');
                }
            } 
            if (backdrop) { 
                backdrop.classList.add('open'); 
            } 
            
            // Блокируем прокрутку основной страницы
            document.body.classList.add('filter-open');
            
            isSheetOpen = true;
        }
        
        function closeSheet() { 
            if (sheet) { 
                sheet.classList.remove('open');
            } 
            if (backdrop) { 
                backdrop.classList.remove('open'); 
            } 
            
            // Разблокируем прокрутку основной страницы
            document.body.classList.remove('filter-open');
            
            isSheetOpen = false;
        }
        
        if (openBtn) openBtn.addEventListener('click', openSheet);
        if (closeBtn) closeBtn.addEventListener('click', closeSheet);
        if (backdrop) backdrop.addEventListener('click', closeSheet);

        // Принудительная инициализация для всех типов
        const isSecondary = '{{ dataset_type }}' === 'secondary';
        const mapEl = document.getElementById('map');
        const grid = document.getElementById('catalog-grid');

        if (mapEl && grid) {
            if (!isSecondary) {
                // Новостройки: карта сверху, список снизу
                mapEl.style.display = 'block';
                mapEl.style.order = '1';
                grid.style.display = 'block';
                grid.style.order = '2';

                // Инициализируем карту если еще не инициализирована
                if (!window.map && typeof initMap === 'function') {
                    initMap();
                }

                // Загружаем данные для карты и списка
                if (typeof fetchData === 'function') {
                    fetchData();
                }

                // Устанавливаем активную кнопку "Картой"
                const mapBtn = document.querySelector('.view-btn[data-view="map"]');
                const listBtn = document.querySelector('.view-btn[data-view="list"]');
                if (mapBtn && listBtn) {
                    mapBtn.classList.add('active');
                    listBtn.classList.remove('active');
                }
            } else {
                // Вторичка: только список, карта скрыта
                mapEl.style.display = 'none';
                grid.style.display = 'block';

                // Загружаем данные для вторичной недвижимости
                if (typeof fetchData === 'function') {
                    fetchData();
                }

                // Устанавливаем активную кнопку "Списком"
                const mapBtn = document.querySelector('.view-btn[data-view="map"]');
                const listBtn = document.querySelector('.view-btn[data-view="list"]');
                if (mapBtn && listBtn) {
                    listBtn.classList.add('active');
                    mapBtn.classList.remove('active');
                }
            }
        }
    });

    // Функции для галереи изображений
    window.changeImage = function (button, direction) {
        const gallery = button.parentElement;
        const images = gallery.querySelectorAll('.gallery-image');
        const dots = gallery.querySelectorAll('.dot');
        let currentIndex = 0;

        // Находим текущий индекс
        images.forEach((img, i) => {
            if (img.style.display === 'block') {
                currentIndex = i;
            }
        });

        // Вычисляем новый индекс
        let newIndex = currentIndex + direction;
        if (newIndex < 0) newIndex = images.length - 1;
        if (newIndex >= images.length) newIndex = 0;

        // Переключаем изображения
        images[currentIndex].style.display = 'none';
        images[newIndex].style.display = 'block';

        // Переключаем точки
        dots[currentIndex].classList.remove('active');
        dots[newIndex].classList.add('active');
    }

    window.setImage = function (dot, index) {
        const gallery = dot.parentElement.parentElement;
        const images = gallery.querySelectorAll('.gallery-image');
        const dots = gallery.querySelectorAll('.dot');

        // Скрываем все изображения
        images.forEach(img => img.style.display = 'none');
        // Показываем выбранное
        images[index].style.display = 'block';

        // Обновляем точки
        dots.forEach(d => d.classList.remove('active'));
        dots[index].classList.add('active');
    }
</script>
{% endblock %}
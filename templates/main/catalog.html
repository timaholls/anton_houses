{% extends 'base.html' %}
{% load static %}

{% block title %}{% if landing and landing.meta_title %}{{ landing.meta_title }}{% elif page_title %}{{ page_title }} —
    CENTURY 21{% else %}CENTURY 21 - Каталог ЖК{% endif %}{% endblock %}

{% block extra_css %}
    <style>
        /* Специальные правки страницы каталога ЖК (без адаптива) */
        .catalog-section ~ .feedback-wrapper {
            margin-top: 100px !important;
            padding: 120px 0 250px 0 !important;
        }

        .catalog-section ~ .feedback-wrapper .feedback-container {
            margin-bottom: 200px !important;
        }

        .catalog-section ~ .footer-transition {
            padding-top: 200px !important;
        }

        .catalog-section ~ .footer-transition .deco-logo.on-dark {
            top: 40px !important;
            z-index: 200 !important;
        }

        .catalog-section ~ .footer .footer-content {
            margin-top: 120px !important;
        }

        .catalog-section {
            margin-bottom: 30px !important;
        }

        .catalog-grid {
            margin-bottom: 30px !important;
            display: flex !important;
            flex-direction: column;
            gap: 24px !important;
        }

        .pagination-container {
            margin-top: 30px !important;
            margin-bottom: 50px !important;
        }

        .catalog-card-horizontal {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 28px;
            padding: 22px;
            border-radius: 24px;
            border: 1px solid rgba(188, 175, 135, 0.4);
            background: #fff;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
        }

        .catalog-card-media {
            width: 360px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .catalog-card-main-image {
            width: 100%;
            aspect-ratio: 4 / 3;
            border-radius: 16px;
            overflow: hidden;
            background: #f5f5f7;
        }

        .catalog-card-main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .catalog-card-thumbs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .catalog-thumb {
            width: 68px;
            height: 68px;
            border-radius: 12px;
            border: 2px solid transparent;
            overflow: hidden;
            padding: 0;
            background: none;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .catalog-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .catalog-thumb.active {
            border-color: #bcaf87;
        }

        .catalog-card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 14px;
            min-width: 0;
        }

        .catalog-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .catalog-card-badge {
            background: #22c55e1a;
            color: #15803d;
            font-size: 13px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 999px;
        }

        .catalog-card-subtitle {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .catalog-card-address {
            margin: 0;
            font-size: 14px;
            color: #6b7280;
        }

        .catalog-card-price-line {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            gap: 6px;
            align-items: baseline;
        }

        .catalog-card-detail-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 20px;
        }

        .catalog-card-detail-list .catalog-detail-item {
            display: flex;
            flex-direction: column;
            font-size: 13px;
            color: #6b7280;
        }

        .catalog-card-detail-list .catalog-detail-item strong {
            font-size: 15px;
            color: #111827;
        }

        .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
        }

        .compact-card-image-gallery:hover .gallery-nav {
            opacity: 1;
        }

        .gallery-nav:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .gallery-prev {
            left: 10px;
        }

        .gallery-next {
            right: 10px;
        }

        .gallery-dots {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            z-index: 10;
        }

        .gallery-dots .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gallery-dots .dot.active {
            background: rgba(255, 255, 255, 1);
            width: 24px;
            border-radius: 4px;
        }

        .gallery-dots .dot:hover {
            background: rgba(255, 255, 255, 0.8);
        }

        /* Исправление проблемы с длинными названиями улиц */
        .filter-select {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .filter-select option {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Стили для поля поиска ЖК */
        .complex-search-input {
            transition: all 0.3s ease;
        }

        .complex-search-input:focus {
            outline: none;
            border-color: #d4a574 !important;
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
        }

        .complex-search-input::placeholder {
            color: #9ca3af;
        }

        .complex-filter-item {
            transition: opacity 0.2s ease;
        }

        .complex-filter-item[style*="display: none"] {
            display: none !important;
        }

        /* Ограничиваем ширину полей фильтров */
        .filters-row-grid .filter-group {
            min-width: 0;
            /* Позволяет flex/grid элементам сжиматься */
            max-width: 100%;
        }

        .catalog-sidebar .filters-row {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .catalog-sidebar .filters-row.fixed-grid {
            grid-template-columns: none;
        }

        .catalog-sidebar .filter-group {
            width: 100%;
        }

        /* Мобильная версия: одна карточка в ряд */
        @media (max-width: 768px) {
            .catalog-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            .compact-card-image-gallery {
                height: 200px;
            }

            .gallery-nav {
                opacity: 1;
                width: 32px;
                height: 32px;
            }

            .catalog-card-horizontal {
                flex-direction: column;
            }

            .catalog-card-media {
                width: 100%;
            }

            .catalog-card-thumbs {
                justify-content: flex-start;
            }

            /* Отступы для модального окна фильтра на мобильной версии */
            #filters-sheet.filters-section .filters-sheet-header {
                padding: 20px 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                flex-direction: row !important;
                position: relative !important;
            }

            #filters-sheet.filters-section .filters-form {
                padding: 24px !important;
            }

            #filters-sheet.filters-section .filters-actions {
                padding: 0 24px 24px 24px !important;
                margin-top: 12px !important;
            }

            /* Заголовок слева */
            #filters-sheet.filters-section .filters-modal-title {
                margin: 0 !important;
                font-size: 1.25rem !important;
                font-weight: 700 !important;
                color: #1f2937 !important;
                flex: 1 !important;
            }

            /* Кнопка закрытия справа вверху */
            #filters-sheet.filters-section .filter-modal-close,
            #filters-sheet.filters-section #mobile-filter-close {
                border: none !important;
                background: transparent !important;
                border-radius: 50% !important;
                width: 32px !important;
                height: 32px !important;
                font-size: 18px !important;
                color: #666 !important;
                cursor: pointer !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                transition: all 0.2s ease !important;
                flex-shrink: 0 !important;
                margin-left: auto !important;
                padding: 0 !important;
                position: relative !important;
                z-index: 10 !important;
            }

            #filters-sheet.filters-section .filter-modal-close:hover,
            #filters-sheet.filters-section #mobile-filter-close:hover {
                background: #f8f9fa !important;
                color: #1f2937 !important;
            }

            /* Показываем кнопку закрытия на мобильной версии */
            #mobile-filter-close {
                display: flex !important;
            }
        }

        /* Планшетная версия: фильтр как на мобильном, карточки как на ПК */
        @media (min-width: 769px) and (max-width: 991px) {
            /* Показываем кнопку открытия фильтра (используем мобильные стили) */
            .mobile-filter-toggle {
                display: inline-flex !important;
            }

            /* Скрываем фильтр по умолчанию */
            .filters-section {
                opacity: 0 !important;
                transform: translate(-50%, -50%) scale(0.95) !important;
                pointer-events: none !important;
                visibility: hidden !important;
            }

            /* Показываем фильтр при открытии */
            .filters-section.open {
                opacity: 1 !important;
                transform: translate(-50%, -50%) scale(1) !important;
                pointer-events: auto !important;
                visibility: visible !important;
            }

            /* Показываем кнопку закрытия */
            #mobile-filter-close {
                display: flex !important;
            }

            /* Карточки остаются горизонтальными (как на ПК) */
            .catalog-card-horizontal {
                flex-direction: row !important;
            }

            .catalog-card-media {
                width: 360px !important;
            }

            /* Фильтр в модальном окне */
            #filters-sheet.filters-section {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) scale(0.95) !important;
                width: 90% !important;
                max-width: 600px !important;
                max-height: 85vh !important;
                z-index: 10000 !important;
                background: #fff !important;
                border-radius: 16px !important;
                padding: 0 !important;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
                margin: 0 !important;
                transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s ease !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }

            /* Показываем фильтр при открытии (более специфичный селектор) */
            #filters-sheet.filters-section.open {
                opacity: 1 !important;
                transform: translate(-50%, -50%) scale(1) !important;
                pointer-events: auto !important;
                visibility: visible !important;
            }

            /* Скрываем sidebar на планшетах, но позволяем модальному окну внутри отображаться */
            .catalog-sidebar {
                display: block !important;
                visibility: hidden !important;
                position: absolute !important;
                width: 0 !important;
                height: 0 !important;
                overflow: visible !important;
                pointer-events: none !important;
            }
            
            /* Когда фильтр открыт, разрешаем взаимодействие */
            body.filter-open .catalog-sidebar {
                pointer-events: auto !important;
            }

            /* Layout без sidebar */
            .catalog-layout {
                display: flex !important;
                flex-direction: column !important;
            }

            /* Отступы для модального окна фильтра на планшетной версии */
            #filters-sheet.filters-section .filters-sheet-header {
                padding: 20px 24px !important;
            }

            #filters-sheet.filters-section .filters-form {
                padding: 24px !important;
            }

            #filters-sheet.filters-section .filters-actions {
                padding: 0 24px 24px 24px !important;
                margin-top: 12px !important;
            }

            /* Настройка header для правильного позиционирования */
            #filters-sheet.filters-section .filters-sheet-header {
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                flex-direction: row !important;
                position: relative !important;
            }

            /* Заголовок слева */
            #filters-sheet.filters-section .filters-modal-title {
                margin: 0 !important;
                font-size: 1.25rem !important;
                font-weight: 700 !important;
                color: #1f2937 !important;
                flex: 1 !important;
            }

            /* Кнопка закрытия справа вверху */
            #filters-sheet.filters-section .filter-modal-close,
            #filters-sheet.filters-section #mobile-filter-close {
                border: none !important;
                background: transparent !important;
                border-radius: 50% !important;
                width: 32px !important;
                height: 32px !important;
                font-size: 18px !important;
                color: #666 !important;
                cursor: pointer !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                transition: all 0.2s ease !important;
                flex-shrink: 0 !important;
                margin-left: auto !important;
                padding: 0 !important;
                position: relative !important;
                z-index: 10 !important;
            }

            #filters-sheet.filters-section .filter-modal-close:hover,
            #filters-sheet.filters-section #mobile-filter-close:hover {
                background: #f8f9fa !important;
                color: #1f2937 !important;
            }

            /* Показываем кнопку закрытия на планшетной версии */
            #mobile-filter-close {
                display: flex !important;
            }

        }

        @media (min-width: 992px) {
            #mobile-filter-close {
                display: none;
            }

            .mobile-filter-toggle {
                display: none !important;
            }

            .filters-section {
                opacity: 1 !important;
                transform: none !important;
            }

            .catalog-sidebar {
                display: block !important;
            }

            .catalog-sidebar .filters-section {
                max-height: none;
                overflow: visible;
            }
        }

        /* Кнопка избранного на карточках */
        .favorite-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .favorite-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .favorite-btn i {
            font-size: 18px;
            color: #666;
            transition: all 0.2s ease;
        }

        .favorite-btn.favorite-active i,
        .favorite-btn:hover i {
            color: #e74c3c;
        }

        .favorite-btn.favorite-active i {
            color: #e74c3c;
        }

        .favorite-btn.favorite-active {
            background: rgba(231, 76, 60, 0.1);
        }

        /* Стили для кастомных выпадающих списков с чекбоксами */
        .custom-dropdown {
            position: relative;
            width: 100%;
            z-index: 99999 !important;
        }

        .custom-dropdown-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d4a574;
            border-radius: 8px;
            background: #faf8f3;
            color: #1a1a1a;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 99999 !important;
        }

        .custom-dropdown-input:hover {
            border-color: #bcaf8a;
        }

        .custom-dropdown-input.active {
            border-color: #bcaf8a;
            box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.1);
            z-index: 99999 !important;
        }

        .dropdown-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
            color: #1a1a1a;
        }

        .custom-dropdown-input.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .custom-dropdown-list {
            position: fixed !important;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 999999 !important;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
        }

        .custom-dropdown-list.active {
            display: block;
        }

        .custom-dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .custom-dropdown-item:last-child {
            border-bottom: none;
        }

        .custom-dropdown-item:hover {
            background-color: #f9fafb;
        }

        .custom-dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #d4a574;
        }

        .custom-dropdown-item span {
            flex: 1;
            font-size: 14px;
            color: #1a1a1a;
        }

        .custom-dropdown-item input[type="checkbox"]:checked + span {
            font-weight: 600;
        }

        /* Убеждаемся, что родительские контейнеры не обрезают выпадающие списки */
        .filter-group {
            overflow: visible !important;
            position: relative;
        }

        /* Убираем overflow: visible для мобильной версии - нужна прокрутка */
        @media (min-width: 769px) {
            .filters-section {
                overflow: visible !important;
            }
        }

        .filters-row {
            overflow: visible !important;
        }

        .filters-row-grid {
            overflow: visible !important;
        }

        /* Убеждаемся, что range-container не перекрывает выпадающие списки */
        .range-container {
            position: relative;
            z-index: 1 !important;
        }

        .range-slider {
            position: relative;
            z-index: 1 !important;
        }

        .range-slider-input {
            z-index: 2 !important;
        }
    </style>
{% endblock %}

{% block meta %}
    {% if landing and landing.meta_description %}
        <meta name="description" content="{{ landing.meta_description }}">
    {% elif page_description %}
        <meta name="description" content="{{ page_description }}">
    {% endif %}
    {% if landing and landing.meta_keywords %}
        <meta name="keywords" content="{{ landing.meta_keywords }}">
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container">
        <section class="catalog-section">
            <div class="catalog-header">
                <div class="catalog-tabs">
                    <a href="{% url 'main:newbuild_index' %}"
                       class="catalog-tab {% if dataset_type == 'newbuild' %}active{% endif %}">Новостройки</a>
                    <a href="{% url 'main:secondary_index' %}"
                       class="catalog-tab alt {% if dataset_type == 'secondary' %}active{% endif %}">Вторичная
                        недвижимость</a>
                </div>
                {% if landing_categories %}
                    <div class="catalog-categories">
                        {% for lc in landing_categories %}
                            <a href="{% url 'main:catalog_landing' lc.slug %}"
                               class="catalog-category{% if landing and landing.slug == lc.slug %} active{% endif %}">
                                {{ lc.name
                                        }}</a>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="filters-backdrop" id="filters-backdrop" aria-hidden="true"></div>

            <div class="catalog-layout">
                <aside class="catalog-sidebar" aria-label="Фильтры каталога">
                    <div class="filters-section" id="filters-sheet">
                        <div class="filters-sheet-header">
                            <h2 class="filters-modal-title">Фильтры</h2>
                            <button type="button" class="filter-modal-close" id="mobile-filter-close" aria-label="Закрыть">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form class="filters-form" id="filters-form">
                            <input type="hidden" name="per_page" id="per_page-hidden" value="{{ request.GET.per_page|default:'15' }}">
                            <div class="filters-row filters-row-grid fixed-grid">
                                {% if dataset_type != 'secondary' %}
                                    <div class="filter-group" style="grid-column: 1 / -1;" id="complex-group">
                                        <label>Жилые комплексы</label>
                                        <button type="button" class="filter-select-input" id="complexes-input">
                                    <span id="complexes-text">
                                        {% if filters.complexes_list %}
                                            {% if filters.complexes_list|length == 1 %}
                                                1 выбран
                                            {% else %}
                                                Выбрано: {{ filters.complexes_list|length }}
                                            {% endif %}
                                        {% else %}
                                            Любые
                                        {% endif %}
                                    </span>
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <input type="hidden" name="complexes" id="complexes-hidden"
                                               value="{{ filters.complexes|default:'' }}">
                                    </div>
                                {% endif %}
                            {% if dataset_type != 'secondary' %}
                            <div class="filter-group content-toggle-wrapper">
                                <div class="content-toggle-segmented">
                                    <button type="button" class="content-toggle-btn-segmented" data-value="complexes"
                                        data-active="{% if not filters.content_mode or filters.content_mode == 'complexes' %}true{% else %}false{% endif %}"
                                        data-content="complexes">
                                        ЖК
                                    </button>
                                    <button type="button" class="content-toggle-btn-segmented" data-value="apartments"
                                        data-active="{% if filters.content_mode == 'apartments' %}true{% else %}false{% endif %}"
                                        data-content="apartments">
                                        Квартиры
                                    </button>
                                </div>
                                <input type="hidden" name="content_mode" id="content-mode-hidden" value="{{ filters.content_mode|default:'complexes' }}">
                            </div>
                            {% endif %}

                            <div class="filter-group" id="city-group">
                                    <label>• Город</label>
                                    <button type="button" class="filter-select-input" id="city-input">
                                        <span id="city-text">Любой</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <input type="hidden" name="city" id="city-hidden"
                                           value="{{ filters.city|default:'' }}">
                                </div>

                                <div class="filter-group" id="district-group">
                                    <label>• Район</label>
                                    <button type="button" class="filter-select-input" id="district-input">
                                        <span id="district-text">Любой</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <input type="hidden" name="district" id="district-hidden"
                                           value="{{ filters.district|default:'' }}">
                                </div>

                                <div class="filter-group" id="street-group">
                                    <label>• Улица</label>
                                    <button type="button" class="filter-select-input" id="street-input">
                                        <span id="street-text">Любая</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <input type="hidden" name="street" id="street-hidden"
                                           value="{{ filters.street|default:'' }}">
                                </div>


                                {% if dataset_type == 'secondary' %}
                                    <div class="filter-group">
                                        <label>Категория объекта</label>
                                        <div class="button-filter chips">
                                            <button type="button" class="filter-chip filter-chip-btn" data-value=""
                                                    {% if not filters.stype %}data-active="true"{% endif %}>Все
                                            </button>
                                            <button type="button" class="filter-chip filter-chip-btn"
                                                    data-value="apartment"
                                                    {% if filters.stype == 'apartment' %}data-active="true"{% endif %}>
                                                Квартиры
                                            </button>
                                            <button type="button" class="filter-chip filter-chip-btn"
                                                    data-value="cottage"
                                                    {% if filters.stype == 'cottage' %}data-active="true"{% endif %}>
                                                Коттеджи
                                            </button>
                                            <button type="button" class="filter-chip filter-chip-btn"
                                                    data-value="townhouse"
                                                    {% if filters.stype == 'townhouse' %}data-active="true"{% endif %}>
                                                Таунхаусы
                                            </button>
                                            <button type="button" class="filter-chip filter-chip-btn"
                                                    data-value="commercial"
                                                    {% if filters.stype == 'commercial' %}data-active="true"{% endif %}>
                                                Коммерческие
                                            </button>
                                        </div>
                                        <input type="hidden" name="stype" id="stype-hidden"
                                               value="{{ filters.stype|default:'' }}">
                                    </div>
                                {% else %}
                                    <div class="filter-group" id="rooms-filter-group" style="display: none;">
                                        <label>Количество комнат</label>
                                        <div class="rooms-checkboxes">
                                            {% for value, label in rooms_choices %}
                                                <label class="room-checkbox-item">
                                                    <input type="checkbox"
                                                           name="rooms"
                                                           value="{{ value }}"
                                                           class="room-checkbox"
                                                           data-room-value="{{ value }}"
                                                           {% if filters.rooms == value %}checked{% endif %}>
                                                    <span>{{ label }}</span>
                                                </label>
                                            {% endfor %}
                                        </div>
                                        <input type="hidden" name="rooms" id="rooms-hidden"
                                               value="{{ filters.rooms|default:'' }}">
                                    </div>

                                {% endif %}

                                {% if dataset_type != 'secondary' %}
                                <div class="filter-group" id="floor-filter-group" style="display: none;">
                                    <label>Этаж</label>
                                    <div class="range-container">
                                        <div class="range-input-group">
                                            <div class="range-input-wrapper">
                                                <input type="number"
                                                       id="floor-from-input"
                                                       name="floor_from"
                                                       class="range-input"
                                                       placeholder="От"
                                                       min="1"
                                                       step="1"
                                                       value="{{ filters.floor_from|default:'' }}"
                                                       inputmode="numeric"
                                                       pattern="[0-9]*">
                                            </div>
                                            <div class="range-input-wrapper">
                                                <input type="number"
                                                       id="floor-to-input"
                                                       name="floor_to"
                                                       class="range-input"
                                                       placeholder="До"
                                                       min="1"
                                                       step="1"
                                                       value="{{ filters.floor_to|default:'' }}"
                                                       inputmode="numeric"
                                                       pattern="[0-9]*">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <div class="filter-group">
                                    <label>Цена, ₽</label>
                                    <div class="range-container">
                                        <div class="range-input-group">
                                            <div class="range-input-wrapper">
                                                <input type="text"
                                                       id="price-from-input"
                                                       name="price_from"
                                                       class="range-input"
                                                       placeholder="От"
                                                       value="{{ filters.price_from|default:'' }}"
                                                       inputmode="numeric"
                                                       pattern="[0-9\s]*">
                                            </div>
                                            <div class="range-input-wrapper">
                                                <input type="text"
                                                       id="price-to-input"
                                                       name="price_to"
                                                       class="range-input"
                                                       placeholder="До"
                                                       value="{{ filters.price_to|default:'' }}"
                                                       inputmode="numeric"
                                                       pattern="[0-9\s]*">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="filter-group" id="area-filter-group" style="display: none;">
                                    <label>Укажите площадь, м²</label>
                                    <div class="range-container">
                                        <div class="range-input-group">
                                            <div class="range-input-wrapper">
                                                <input type="number"
                                                       id="area-from-input"
                                                       name="area_from"
                                                       class="range-input"
                                                       placeholder="От"
                                                       min="30"
                                                       max="500"
                                                       step="1"
                                                       value="{{ filters.area_from|default:'' }}"
                                                       inputmode="numeric"
                                                       pattern="[0-9]*">
                                            </div>
                                            <div class="range-input-wrapper">
                                                <input type="number"
                                                       id="area-to-input"
                                                       name="area_to"
                                                       class="range-input"
                                                       placeholder="До"
                                                       min="30"
                                                       max="500"
                                                       step="1"
                                                       value="{{ filters.area_to|default:'' }}"
                                                       inputmode="numeric"
                                                       pattern="[0-9]*">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            {% if dataset_type != 'secondary' %}
                            <div class="filter-group">
                                <div class="content-toggle-segmented">
                                    <button type="button" class="offers-toggle-btn" data-value=""
                                        data-active="{% if not filters.has_offers %}true{% else %}false{% endif %}">
                                        Любое
                                    </button>
                                    <button type="button" class="offers-toggle-btn" data-value="true"
                                        data-active="{% if filters.has_offers %}true{% else %}false{% endif %}">
                                        Скидки
                                    </button>
                                </div>
                                <input type="hidden" name="has_offers" id="has_offers-hidden"
                                    value="{{ filters.has_offers|default:'' }}">
                            </div>
                            {% endif %}

                                <!-- Фильтр по названиям ЖК (только для новостроек, не для вторички) -->
                                {% if dataset_type != 'secondary' %}
                                    <!-- Фильтр по сроку сдачи -->
                                    <div class="filter-group" id="delivery-quarter-group">
                                        <label>• Срок сдачи</label>
                                        <div class="custom-dropdown-input" id="delivery-quarter-input"
                                             style="cursor: pointer;">
                                            <span class="dropdown-text" id="delivery-quarter-text">Любой срок</span>
                                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                                        </div>
                                        <input type="hidden" name="delivery_quarter" id="delivery-quarter-hidden"
                                               value="{{ filters.delivery_quarter|default:'' }}">
                                    </div>
                                {% endif %}

                                <div class="filter-group">
                                    <label>Сортировка</label>
                                    <div class="sorting-radio-group">
                                        <label class="sorting-radio-item">
                                            <input type="radio"
                                                   name="sort"
                                                   value="price_asc"
                                                   class="sorting-radio"
                                                   {% if filters.sort == 'price_asc' or not filters.sort %}checked{% endif %}>
                                            <span>Дешевле</span>
                                        </label>
                                        <label class="sorting-radio-item">
                                            <input type="radio"
                                                   name="sort"
                                                   value="price_desc"
                                                   class="sorting-radio"
                                                   {% if filters.sort == 'price_desc' %}checked{% endif %}>
                                            <span>Дороже</span>
                                        </label>
                                    </div>
                                    <input type="hidden" name="sort" id="sort-hidden"
                                           value="{{ filters.sort|default:'price_asc' }}">
                                </div>
                            </div>

                            <div class="filters-actions">
                                <button type="button" class="filters-reset-btn" id="filters-reset-btn">
                                    Сбросить
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check"></i>
                                    Применить
                                </button>
                            </div>
                        </form>
                    </div>
                </aside>

                <div class="catalog-main-column">
                    <div class="search-results">
                        <h2 class="search-title" id="results-summary">
                            Найдено
                            <span id="results-count-number">—</span>
                            <span id="results-count-label">
                            {% if dataset_type == 'secondary' %}
                                объектов вторичного рынка
                            {% else %}
                                {% if filters.content_mode == 'apartments' %}квартир{% else %}новостроек{% endif %}
                            {% endif %}
                        </span>
                            в городе Уфа
                        </h2>
                    </div>

                <div class="view-toggle-right">
                    <!-- Кнопка фильтров в мобильной версии -->
                    <button type="button" class="mobile-filter-toggle" id="mobile-filter-open">Фильтры</button>
                    
                    {% if dataset_type != 'secondary' %}
                    <div class="view-toggle-buttons">
                        <button type="button" class="view-btn active" data-view="map">Картой</button>
                        <button type="button" class="view-btn" data-view="list">Списком</button>
                    </div>
                    {% endif %}
                    <div class="page-size-toggle">
                        <span>Элементов:</span>
                        <button type="button" class="page-size-btn" data-size="15" data-active="true">15</button>
                        <button type="button" class="page-size-btn" data-size="20">20</button>
                        <button type="button" class="page-size-btn" data-size="30">30</button>
                    </div>
                </div>

                    <div class="catalog-content">
                    <div id="map"
                        style="width: 100%; height: 260px; display:block; border-radius:12px; overflow:hidden; margin-bottom:24px;">
                        </div>
                        <div class="catalog-grid" id="catalog-grid">
                            <!-- Карточки загружаются через API -->
                        </div>
                    </div>

                    <div class="pagination-container" style="display:none;">
                        <div class="pagination-info"></div>
                        <div class="pagination-controls"></div>
                    </div>
                </div>
            </div>

            <!-- Модальные окна фильтров -->
            <div class="filter-modal" id="city-modal">
                <div class="filter-modal-backdrop"></div>
                <div class="filter-modal-content">
                    <div class="filter-modal-header">
                        <h3>Город</h3>
                        <button type="button" class="filter-modal-close" id="city-modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="filter-modal-body">
                        <div class="filter-modal-list" id="city-modal-list">
                            {% for city_name in cities %}
                                <label class="filter-modal-item">
                                    <input type="checkbox" class="city-modal-checkbox" value="{{ city_name }}"
                                           data-city="{{ city_name }}"
                                           {% if city_name in filters.city_list %}checked{% endif %}>
                                    <span>{{ city_name }}</span>
                                </label>
                            {% empty %}
                                <div class="filter-modal-empty">Города не найдены</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="filter-modal-footer">
                        <button type="button" class="filter-modal-reset" id="city-modal-reset">Сбросить</button>
                        <div class="filter-modal-actions">
                            <button type="button" class="filter-modal-cancel" id="city-modal-cancel">Закрыть</button>
                            <button type="button" class="filter-modal-apply" id="city-modal-apply">Применить</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-modal" id="district-modal">
                <div class="filter-modal-backdrop"></div>
                <div class="filter-modal-content">
                    <div class="filter-modal-header">
                        <h3>Район</h3>
                        <button type="button" class="filter-modal-close" id="district-modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="filter-modal-body">
                        <div class="filter-modal-list" id="district-modal-list">
                            {% for district_name in districts %}
                                <label class="filter-modal-item">
                                    <input type="checkbox" class="district-modal-checkbox" value="{{ district_name }}"
                                           data-district="{{ district_name }}"
                                           {% if district_name in filters.district_list %}checked{% endif %}>
                                    <span>{{ district_name }}</span>
                                </label>
                            {% empty %}
                                <div class="filter-modal-empty">Районы не найдены</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="filter-modal-footer">
                        <button type="button" class="filter-modal-reset" id="district-modal-reset">Сбросить</button>
                        <div class="filter-modal-actions">
                            <button type="button" class="filter-modal-cancel" id="district-modal-cancel">Закрыть
                            </button>
                            <button type="button" class="filter-modal-apply" id="district-modal-apply">Применить
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-modal" id="street-modal">
                <div class="filter-modal-backdrop"></div>
                <div class="filter-modal-content">
                    <div class="filter-modal-header">
                        <h3>Улица</h3>
                        <button type="button" class="filter-modal-close" id="street-modal-close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="filter-modal-body">
                        <div class="filter-modal-list" id="street-modal-list">
                            {% for street_name in streets %}
                                <label class="filter-modal-item">
                                    <input type="checkbox" class="street-modal-checkbox" value="{{ street_name }}"
                                           data-street="{{ street_name }}"
                                           {% if street_name in filters.street_list %}checked{% endif %}>
                                    <span>{{ street_name }}</span>
                                </label>
                            {% empty %}
                                <div class="filter-modal-empty">Улицы не найдены</div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="filter-modal-footer">
                        <button type="button" class="filter-modal-reset" id="street-modal-reset">Сбросить</button>
                        <div class="filter-modal-actions">
                            <button type="button" class="filter-modal-cancel" id="street-modal-cancel">Закрыть</button>
                            <button type="button" class="filter-modal-apply" id="street-modal-apply">Применить</button>
                        </div>
                    </div>
                </div>
            </div>

            {% if dataset_type != 'secondary' %}
                <div class="filter-modal" id="complexes-modal">
                    <div class="filter-modal-backdrop"></div>
                    <div class="filter-modal-content">
                        <div class="filter-modal-header">
                            <h3>Жилые комплексы</h3>
                            <button type="button" class="filter-modal-close" id="complexes-modal-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="filter-modal-body">
                            <div class="filter-modal-search">
                                <input type="text" id="complexes-modal-search" class="complex-search-input"
                                       placeholder="Поиск ЖК по названию...">
                            </div>
                            <div class="filter-modal-list" id="complexes-list">
                                {% for complex in complexes_list %}
                                    <label class="filter-modal-item" data-name="{{ complex.name|lower }}">
                                        <input type="checkbox" class="complex-modal-checkbox" value="{{ complex.id }}"
                                               data-complex-id="{{ complex.id }}"
                                               {% if complex.id in filters.complexes_list %}checked{% endif %}>
                                        <span>{{ complex.name }}</span>
                                    </label>
                                {% empty %}
                                    <div class="filter-modal-empty">ЖК не найдены</div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="filter-modal-footer">
                            <button type="button" class="filter-modal-reset" id="complexes-modal-reset">Сбросить
                            </button>
                            <div class="filter-modal-actions">
                                <button type="button" class="filter-modal-cancel" id="complexes-modal-cancel">Закрыть
                                </button>
                                <button type="button" class="filter-modal-apply" id="complexes-modal-apply">Применить
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Модальное окно для выбора срока сдачи -->
            {% if dataset_type != 'secondary' %}
                <div class="filter-modal" id="delivery-quarter-modal">
                    <div class="filter-modal-backdrop"></div>
                    <div class="filter-modal-content">
                        <div class="filter-modal-header">
                            <h3>Срок сдачи</h3>
                            <button type="button" class="filter-modal-close" id="delivery-quarter-modal-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="filter-modal-body">
                            <div class="filter-modal-list">
                                {% for quarter in delivery_quarters %}
                                    <label class="filter-modal-item delivery-quarter-modal-item">
                                        <input type="checkbox"
                                               value="{{ quarter.value }}"
                                               class="delivery-quarter-modal-checkbox"
                                               data-quarter="{{ quarter.value }}"
                                               {% if quarter.value in filters.delivery_quarter_list %}checked{% endif %}>
                                        <span>{{ quarter.label }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="filter-modal-footer">
                            <button type="button" class="filter-modal-reset" id="delivery-quarter-modal-reset">
                                Сбросить
                            </button>
                            <div class="filter-modal-actions">
                                <button type="button" class="filter-modal-cancel" id="delivery-quarter-modal-cancel">
                                    Закрыть
                                </button>
                                <button type="button" class="filter-modal-apply" id="delivery-quarter-modal-apply">
                                    Применить
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

        </section>

    </div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .catalog-tabs {
            margin-top: 12px;
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .catalog-tab {
            padding: 8px 16px;
            border-radius: 999px;
            background: var(--c21-light);
            color: var(--c21-dark);
            text-decoration: none;
            font-weight: 600;
        }

        .catalog-tab.active {
            background: var(--c21-dark);
            color: var(--c21-gold);
        }

        .catalog-tab.alt {
            background: var(--c21-light);
            color: var(--c21-dark);
        }

        .catalog-tab.alt.active {
            background: var(--c21-dark);
            color: var(--c21-gold);
        }

        .catalog-categories {
            margin-top: 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .catalog-category {
            padding: 6px 12px;
            border: 1px solid var(--c21-mid);
            border-radius: 999px;
            text-decoration: none;
            color: var(--c21-dark);
            font-weight: 600;
        }

        .catalog-category.active,
        .catalog-category:hover {
            border-color: var(--c21-gold);
            color: var(--c21-gold);
        }

        .filter-chip {
            display: inline-block;
            padding: 8px 14px;
            background: var(--c21-light);
            color: var(--c21-dark);
            border-radius: 999px;
            text-decoration: none;
            font-weight: 600;
        }

        .filter-chip.active,
        .filter-chip:hover {
            background: var(--c21-dark);
            color: var(--c21-gold);
        }

        /* Стили для звездочек рейтинга */
        .rating-stars {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .rating-stars .star {
            font-size: 14px;
            line-height: 1;
        }

        .rating-stars .star.filled {
            color: #fbbf24;
        }

        .rating-stars .star.empty {
            color: #d1d5db;
        }

        .rating-stars .rating-text {
            margin-left: 4px;
            font-size: 12px;
            color: #6b7280;
        }

        /* Стили для тумблера ЖК/Квартиры */
        .content-toggle-right {
            display: flex;
            gap: 8px;
        }

        .content-toggle-right .content-btn {
            padding: 10px 16px;
            border: 2px solid rgba(190, 175, 135, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            color: var(--c21-dark);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .content-toggle-right .content-btn:hover {
            border-color: rgba(190, 175, 135, 0.6);
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
        }

        .content-toggle-right .content-btn.active {
            background: linear-gradient(135deg, var(--c21-gold) 0%, var(--c21-gold-dark) 100%);
            border-color: var(--c21-gold);
            color: white;
            box-shadow: 0 4px 12px rgba(190, 175, 135, 0.3);
        }

        @media (max-width: 768px) {
            .controls-section {
                flex-wrap: wrap;
            }

            .content-toggle-right {
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }

            .content-toggle-right .content-btn {
                flex: 1;
                text-align: center;
            }
        }

        /* Стили для блока "Подберём квартиру" когда ничего не найдено */
        .no-complexes-cta {
            grid-column: 1 / -1;
            padding: 32px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: #1f2937;
            margin: 24px 0;
        }

        .no-complexes-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #e0f2fe;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
        }

        .no-complexes-cta h3 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .no-complexes-cta p {
            margin: 0;
            font-size: 15px;
            color: #4b5563;
            max-width: 420px;
        }

        .no-complexes-btn {
            margin-top: 8px;
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--c21-gold), var(--c21-gold-dark));
            color: var(--c21-dark);
            border: none;
            border-radius: 999px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(190, 175, 135, 0.4);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .no-complexes-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(190, 175, 135, 0.5);
        }
    </style>

    <script>
        // Вспомогательные функции
        function formatPriceText(value) {
            if (value === null || value === undefined) {
                return 'Цена по запросу';
            }
            let text = String(value).trim();
            if (!text) {
                return 'Цена по запросу';
            }
            const digitsOnly = text.replace(/\s/g, '');
            if (/^\d+$/.test(digitsOnly)) {
                const num = parseInt(digitsOnly, 10);
                if (!isNaN(num) && num > 0) {
                    return `${num.toLocaleString('ru-RU')} ₽`;
                }
            }
            if (!/руб|₽/i.test(text)) {
                text = `${text} ₽`;
            }
            return text.replace(/\s{2,}/g, ' ').trim();
        }

        // Глобальные функции - должны быть определены первой
        window.renderItems = function (data) {
            const grid = document.getElementById('catalog-grid');
            const isSecondary = '{{ dataset_type }}' === 'secondary';

            // Для вторичной недвижимости всегда показываем списком, для новостроек - карту + список
            const currentView = isSecondary ? 'list' : 'map';

            // Всегда рендерим и карту и список для новостроек
            if (!isSecondary) {
                // Новостройки: рендерим и карту и список
                if (typeof renderMapPoints === 'function') {
                    const mapPoints = data.map_points || data.complexes || [];
                    renderMapPoints(mapPoints, false, false); // false = не квартиры
                }

                const list = data.complexes || [];
                if (!list.length) {
                    grid.innerHTML = `
                    <div class="no-complexes-cta">
                        <div class="no-complexes-icon">
                            <span>🎧</span>
                        </div>
                        <h3>Подберём квартиру от застройщика</h3>
                        <p>По вашему запросу ничего не найдено — оставьте заявку, менеджер предложит подходящие квартиры в других проектах.</p>
                        <button type="button" class="no-complexes-btn anchor-feedback-btn">
                            Подобрать квартиру
                        </button>
                    </div>
                `;
                } else {
                    // Используем полноценный рендер с компактными карточками
                    if (typeof updateCatalog === 'function') {
                        updateCatalog(data);
                    }
                }
            } else {
                // Вторичка: только список
                if (currentView === 'map') {
                    if (typeof renderMapPoints === 'function') {
                        renderMapPoints(data.items || [], true);
                    }
                }

                if (!data.items || !data.items.length) {
                    grid.innerHTML = `
                    <div class="no-complexes-cta">
                        <h3>Подберём варианты в других проектах</h3>
                        <p>По вашему запросу ничего не найдено — оставьте заявку, менеджер предложит подходящие варианты в других проектах.</p>
                        <button type="button" class="no-complexes-btn anchor-feedback-btn">
                            Оставить заявку
                        </button>
                    </div>
                `;
                } else {
                    grid.innerHTML = data.items.map(item => {
                        // Отладочная информация (можно убрать в продакшене)// Формируем массив фото
                        let photos = [];
                        if (item.photos && item.photos.length > 0) {
                            photos = item.photos.map(photo => {
                                // Если фото уже содержит полный путь, используем как есть
                                if (photo.startsWith('/media/') || photo.startsWith('http')) {
                                    return photo;
                                }
                                // Иначе добавляем префикс /media/
                                return `/media/${photo}`;
                            });
                        } else {
                            // Проверяем image_url и формируем правильный путь
                            let fallbackImage = '/media/gallery/placeholders.png';
                            if (item.image_url) {
                                if (item.image_url.startsWith('/media/') || item.image_url.startsWith('http')) {
                                    fallbackImage = item.image_url;
                                } else {
                                    fallbackImage = `/media/${item.image_url}`;
                                }
                            }
                            photos = [fallbackImage];
                        }

                        // Формируем главное фото и миниатюры (как у новостроек)
                        const mainPhoto = photos[0] || '/media/gallery/placeholders.png';
                        const thumbnailsHtml = photos.length > 1 ? `
                <div class="catalog-card-thumbs">
                    ${photos.map((photo, i) => `
                        <button type="button" class="catalog-thumb ${i === 0 ? 'active' : ''}" data-photo="${photo}"
                            onclick="event.stopPropagation(); window.switchCatalogCardPhoto(this);">
                            <img src="${photo}" alt="${item.name} превью ${i + 1}">
                        </button>
                    `).join('')}
                </div>
            ` : '';

                        // Для вторички не добавляем класс рейтинга (у вторички нет рейтинга)
                        const cardClasses = 'property-card-compact catalog-card-horizontal';
                        const priceText = formatPriceText(item.price_range || item.price_display || item.price || '');
                        const addressText = item.address || (item.city ? (item.district ? `${item.city}, ${item.district}` : item.city) : 'Уфа');
                        
                        // Формируем детали для вторички
                        let detailsHtml = '';
                        if (item.area_from || item.rooms || item.floor) {
                            detailsHtml = '<div class="catalog-card-detail-list">';
                            if (item.area_from) {
                                detailsHtml += `
                                    <div class="catalog-detail-item">
                                        <span>Площадь</span>
                                        <strong>${item.area_from} м²</strong>
                                    </div>
                                `;
                            }
                            if (item.rooms) {
                                detailsHtml += `
                                    <div class="catalog-detail-item">
                                        <span>Комнат</span>
                                        <strong>${item.rooms}</strong>
                                    </div>
                                `;
                            }
                            if (item.floor) {
                                detailsHtml += `
                                    <div class="catalog-detail-item">
                                        <span>Этаж</span>
                                        <strong>${item.floor}</strong>
                                    </div>
                                `;
                            }
                            detailsHtml += '</div>';
                        }
                        
                        return `
            <div class="${cardClasses}" data-complex-id="${item.id}">
                <div class="catalog-card-media">
                    <div class="catalog-card-main-image" onclick="window.open('/secondary/${item.id}/', '_blank');">
                        <img src="${mainPhoto}" alt="${item.name}">
                    </div>
                    ${thumbnailsHtml}
                </div>
                
                <div class="catalog-card-body" onclick="window.open('/secondary/${item.id}/', '_blank');">
                    <div class="catalog-card-header">
                        <h3 class="compact-card-title">${item.name}</h3>
                    </div>
                    <p class="catalog-card-address">${addressText}</p>
                    ${priceText ? `<div class="catalog-card-price-line"><span>Стоимость:</span><strong>${priceText}</strong></div>` : ''}
                    ${detailsHtml}
                </div>
            </div>`;
                    }).join('');
                }
            }
            // Обновляем пагинацию под список
            if (typeof updatePagination === 'function') {
                updatePagination(data);
            }
        }

        // Глобальная функция applyFilters
        window.applyFilters = function () {
            // Используем вспомогательную функцию для сброса страницы и загрузки данных
            window.resetPageAndFetch();
        }

        // Глобальная функция loadPage
        window.loadPage = function (page) {
            if (page === window.currentPage) return;

            // Устанавливаем страницу в скрытое поле формы
            const form = document.getElementById('filters-form');
            const pageInputs = form ? form.querySelectorAll('input[name="page"]') : [];
            if (pageInputs.length > 0) {
                pageInputs[0].value = page;
                pageInputs.forEach((input, index) => {
                    if (index > 0) input.remove();
                });
            } else {
                // Создаем скрытое поле если его нет
                if (form) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = 'page-hidden';
                    hiddenInput.name = 'page';
                    hiddenInput.value = page;
                    form.appendChild(hiddenInput);
                }
            }

            window.currentPage = page;
            // Используем единую функцию fetchData, которая учитывает режим ЖК/Квартиры
            window.fetchData();
        }

        // Глобальная функция updateCatalog
        window.updateCatalog = function (data) {
            const grid = document.getElementById('catalog-grid');

            if (data.complexes.length === 0) {
                grid.innerHTML = `
                <div class="no-complexes-cta">
                    <div class="no-complexes-icon">
                        <span>🎧</span>
                    </div>
                    <h3>Подберём квартиру от застройщика</h3>
                    <p>По вашему запросу ничего не найдено — оставьте заявку, менеджер предложит подходящие квартиры в других проектах.</p>
                    <button type="button" class="no-complexes-btn anchor-feedback-btn">
                        Подобрать квартиру
                    </button>
                </div>
            `;
                return;
            }

            let html = '';
            data.complexes.forEach((complex, index) => {
                // Создаем массив фото из photos или используем старые поля
                let photos = [];
                if (complex.photos && complex.photos.length > 0) {
                    photos = complex.photos.map(photo => {
                        // Если фото уже содержит полный URL, используем как есть
                        if (photo.startsWith('http')) {
                            return photo;
                        }
                        // Иначе добавляем префикс /media/
                        return `/media/${photo}`;
                    });
                } else {
                    const img1 = complex.image_url || '/media/gallery/placeholders.png';
                    const img2 = complex.image_2_url;
                    const img3 = complex.image_3_url;
                    const img4 = complex.image_4_url;
                    photos = [img1, img2, img3, img4].filter(p => p);
                }

                if (!photos.length) {
                    photos = ['/media/gallery/placeholders.png'];
                }

                const mainPhoto = photos[0] || '/media/gallery/placeholders.png';
                const thumbnailsHtml = photos.length > 1 ? `
                <div class="catalog-card-thumbs">
                    ${photos.map((photo, i) => `
                        <button type="button" class="catalog-thumb ${i === 0 ? 'active' : ''}" data-photo="${photo}"
                            onclick="event.stopPropagation(); window.switchCatalogCardPhoto(this);">
                            <img src="${photo}" alt="${complex.name} превью ${i + 1}">
                        </button>
                    `).join('')}
                </div>
            ` : '';

                // Добавляем класс рейтинга для обводки
                const rating = complex.rating || 0;
                let ratingClass = '';
                if (rating >= 5) {
                    ratingClass = 'rating-5';
                } else if (rating >= 4) {
                    ratingClass = 'rating-4';
                } else if (rating >= 1) {
                    ratingClass = 'rating-3';
                }

                const cardClasses = `property-card-compact ${ratingClass}`;
                const priceRaw = complex.price_range || complex.price_display || '';
                const priceText = formatPriceText(priceRaw || '');

                const badgeHtml = complex.has_offers ? `<span class="catalog-card-badge">Есть акции</span>` : '';
                const addressText = complex.address || complex.city || 'Уфа';

                html += `
            <div class="${cardClasses} catalog-card-horizontal" data-complex-id="${complex.id}">
                <div class="catalog-card-media">
                    <div class="catalog-card-main-image" onclick="window.open('/complex/${complex.id}/', '_blank');">
                        <img src="${mainPhoto}" alt="${complex.name}">
                    </div>
                    ${thumbnailsHtml}
                </div>
                
                <div class="catalog-card-body" onclick="window.open('/complex/${complex.id}/', '_blank');">
                    <div class="catalog-card-header">
                        <h3 class="compact-card-title">${complex.name}</h3>
                        ${badgeHtml}
                    </div>
                    ${complex.completion_date ? `<p class="catalog-card-subtitle">Сдача: ${complex.completion_date}</p>` : ''}
                    <p class="catalog-card-address">${addressText}</p>
                    ${priceText ? `<div class="catalog-card-price-line"><span>Стоимость:</span><strong>${priceText}</strong></div>` : ''}
                    <div class="catalog-card-detail-list">
                        ${complex.total_apartments ? `
                            <div class="catalog-detail-item">
                                <span>Квартир</span>
                                <strong>${complex.total_apartments}</strong>
                            </div>
                        ` : ''}
                        ${complex.housing_class ? `
                            <div class="catalog-detail-item">
                                <span>Класс</span>
                                <strong>${complex.housing_class}</strong>
                            </div>
                        ` : ''}
                        ${complex.housing_type ? `
                            <div class="catalog-detail-item">
                                <span>Тип</span>
                                <strong>${complex.housing_type}</strong>
                            </div>
                        ` : ''}
                        ${complex.rating ? `
                            <div class="catalog-detail-item">
                                <span>Рейтинг</span>
                                <strong>${complex.rating}/5</strong>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
            });

            grid.innerHTML = html;
        }

        // Глобальная функция updateResultsCount
        window.updateResultsCount = function (count, options = {}) {
            const numberEl = document.getElementById('results-count-number');
            const labelEl = document.getElementById('results-count-label');
            if (!numberEl || !labelEl) {
                return;
            }

            const normalizedCount = Number.isFinite(Number(count)) ? Number(count) : 0;
            numberEl.textContent = normalizedCount.toLocaleString('ru-RU');

            const datasetType = '{{ dataset_type }}';
            let labelText;

            if (datasetType === 'secondary') {
                labelText = 'объектов вторичного рынка';
            } else {
                const contentModeHidden = document.getElementById('content-mode-hidden');
                const storedMode = localStorage.getItem('catalog_content_mode') || 'complexes';
                const currentMode = options.mode || (contentModeHidden ? contentModeHidden.value : storedMode) || 'complexes';
                labelText = currentMode === 'apartments' ? 'квартир' : 'новостроек';
            }

            labelEl.textContent = labelText;
        }

        // Функции для галереи фото
        window.changeImage = function (button, direction) {
            const gallery = button.parentElement;
            const images = gallery.querySelectorAll('.gallery-image');
            const dots = gallery.querySelectorAll('.dot');
            let currentIndex = 0;

            // Находим текущий индекс
            images.forEach((img, i) => {
                if (img.style.display === 'block') {
                    currentIndex = i;
                }
            });

            // Вычисляем новый индекс
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = images.length - 1;
            if (newIndex >= images.length) newIndex = 0;

            // Переключаем изображения
            images[currentIndex].style.display = 'none';
            images[newIndex].style.display = 'block';

            // Переключаем точки
            dots[currentIndex].classList.remove('active');
            dots[newIndex].classList.add('active');
        }

        window.setImage = function (dot, index) {
            const gallery = dot.parentElement.parentElement;
            const images = gallery.querySelectorAll('.gallery-image');
            const dots = gallery.querySelectorAll('.dot');

            // Скрываем все изображения
            images.forEach(img => img.style.display = 'none');
            // Показываем выбранное
            images[index].style.display = 'block';

            // Обновляем точки
            dots.forEach(d => d.classList.remove('active'));
            dots[index].classList.add('active');
        }

        window.switchCatalogCardPhoto = function (thumbButton) {
            if (!thumbButton) return;
            const mediaWrapper = thumbButton.closest('.catalog-card-media');
            const mainImage = mediaWrapper ? mediaWrapper.querySelector('.catalog-card-main-image img') : null;
            if (!mediaWrapper || !mainImage) return;
            const targetPhoto = thumbButton.getAttribute('data-photo');
            if (targetPhoto) {
                mainImage.src = targetPhoto;
            }
            mediaWrapper.querySelectorAll('.catalog-thumb').forEach(btn => {
                btn.classList.toggle('active', btn === thumbButton);
            });
        }

        // Глобальная функция updatePagination
        window.updatePagination = function (data) {
            const container = document.querySelector('.pagination-container');
            if (!container) return;

            // Показываем контейнер пагинации
            container.style.display = 'block';

            const info = container.querySelector('.pagination-info');
            const controls = container.querySelector('.pagination-controls');

            info.textContent = `Страница ${data.current_page} из ${data.total_pages}`;

            let controlsHtml = '';

            if (data.has_previous) {
                controlsHtml += `
            <button class="pagination-btn" onclick="loadPage(${data.current_page - 1})">
                <i class="fas fa-chevron-left"></i> Назад
            </button>
        `;
            }

            controlsHtml += '<div class="pagination-numbers">';
            for (let i = 1; i <= data.total_pages; i++) {
                if (i === data.current_page) {
                    controlsHtml += `<span class="pagination-number active">${i}</span>`;
                } else if (i > data.current_page - 3 && i < data.current_page + 3) {
                    controlsHtml += `<button class="pagination-number" onclick="loadPage(${i})">${i}</button>`;
                }
            }
            controlsHtml += '</div>';

            if (data.has_next) {
                controlsHtml += `
            <button class="pagination-btn" onclick="loadPage(${data.current_page + 1})">
                Вперед <i class="fas fa-chevron-right"></i>
            </button>
        `;
            }

            controls.innerHTML = controlsHtml;
        }

        // Глобальная функция initImageCarousel
        window.initImageCarousel = function () {
            const propertyCards = document.querySelectorAll('.property-card-large');

            propertyCards.forEach(card => {
                const mainImage = card.querySelector('.main-image img');
                const thumbnails = card.querySelectorAll('.thumbnail');
                const imageCounter = card.querySelector('.image-counter');
                const prevBtn = card.querySelector('.nav-btn.prev');
                const nextBtn = card.querySelector('.nav-btn.next');

                let currentImageIndex = 0;
                const totalImages = thumbnails.length;

                // Функция для обновления главного изображения
                function updateMainImage(index) {
                    const thumbnail = thumbnails[index];
                    const thumbnailImg = thumbnail.querySelector('img');

                    if (thumbnailImg) {
                        mainImage.src = thumbnailImg.src;
                        mainImage.alt = thumbnailImg.alt;

                        // Обновляем счетчик
                        imageCounter.textContent = `${index + 1} из ${totalImages}`;

                        // Обновляем активную миниатюру
                        thumbnails.forEach((thumb, i) => {
                            thumb.classList.toggle('active', i === index);
                        });

                        currentImageIndex = index;
                    }
                }

                // Обработчики кликов по миниатюрам
                thumbnails.forEach((thumbnail, index) => {
                    thumbnail.addEventListener('click', function (e) {
                        e.stopPropagation(); // Предотвращаем всплытие события
                        updateMainImage(index);
                    });
                });

                // Обработчики для кнопок навигации
                if (prevBtn) {
                    prevBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const newIndex = currentImageIndex > 0 ? currentImageIndex - 1 : totalImages - 1;
                        updateMainImage(newIndex);
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        const newIndex = currentImageIndex < totalImages - 1 ? currentImageIndex + 1 : 0;
                        updateMainImage(newIndex);
                    });
                }

                // Обработчик клика по главному изображению для перехода к следующему
                mainImage.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const newIndex = currentImageIndex < totalImages - 1 ? currentImageIndex + 1 : 0;
                    updateMainImage(newIndex);
                });
            });
        }

        // Инициализация глобальных переменных
        window.currentPage = 1;

        // Вспомогательная функция для сброса страницы и загрузки данных
        window.resetPageAndFetch = function () {
            window.currentPage = 1;
            const form = document.getElementById('filters-form');
            if (form) {
                const pageInputs = form.querySelectorAll('input[name="page"]');
                if (pageInputs.length > 0) {
                    pageInputs[0].value = 1;
                    // Удаляем все дублирующие поля страницы
                    pageInputs.forEach((input, index) => {
                        if (index > 0) {
                            input.remove();
                        }
                    });
                } else {
                    // Создаем скрытое поле для страницы если его нет
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.id = 'page-hidden';
                    hiddenInput.name = 'page';
                    hiddenInput.value = 1;
                    form.appendChild(hiddenInput);
                }
            }
            window.fetchData();
        }

        // Глобальная функция fetchData
        window.fetchData = async function () {
            const form = document.getElementById('filters-form');
            const grid = document.getElementById('catalog-grid');
            const isSecondary = '{{ dataset_type }}' === 'secondary';

            // Определяем режим: ЖК или Квартиры
            const contentModeField = document.getElementById('content-mode-hidden');
            let contentMode = contentModeField && contentModeField.value ? contentModeField.value : null;
            if (!contentMode) {
                contentMode = localStorage.getItem('catalog_content_mode') || 'complexes';
                if (contentModeField) {
                    contentModeField.value = contentMode;
                }
            } else {
                localStorage.setItem('catalog_content_mode', contentMode);
            }
            const isApartmentsMode = contentMode === 'apartments' && !isSecondary;

            const apiUrl = isSecondary ? '/api/secondary/' : (isApartmentsMode ? '/api/apartments/' : '/api/catalog/');

            if (!form || !grid) return;

            window.initialCatalogFetchDone = true;

            // Устанавливаем страницу в форму, если она не установлена
            const pageInputs = form.querySelectorAll('input[name="page"]');
            if (pageInputs.length > 0) {
                if (!pageInputs[0].value || pageInputs[0].value === '') {
                    pageInputs[0].value = window.currentPage || 1;
                }
                // Удаляем дублирующиеся поля
                pageInputs.forEach((input, index) => {
                    if (index > 0) {
                        input.remove();
                    }
                });
            } else {
                // Создаем скрытое поле для страницы если его нет
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.id = 'page-hidden';
                hiddenInput.name = 'page';
                hiddenInput.value = window.currentPage || 1;
                form.appendChild(hiddenInput);
            }

            if ((localStorage.getItem('catalog_view') || 'list') !== 'map') {
                grid.innerHTML = '<div class="loading">Поиск...</div>';
            }
            const qs = window.serialize();
            // Отменяем предыдущий запрос и помечаем текущий как последний
            try {
                if (window.activeController) {
                    window.activeController.abort();
                }
                const controller = new AbortController();
                window.activeController = controller;
                const requestId = ++window.latestRequestId;
                const res = await fetch(apiUrl + (qs ? ('?' + qs) : ''), {signal: controller.signal});
                const data = await res.json();
                // Если это не самый свежий ответ — игнорируем
                if (requestId !== window.latestRequestId) return;

                if (typeof window.updateResultsCount === 'function') {
                    const totalCount = Number.isFinite(Number(data.total_count)) ? Number(data.total_count) : 0;
                    const modeForCount = isSecondary ? 'secondary' : (isApartmentsMode ? 'apartments' : 'complexes');
                    window.updateResultsCount(totalCount, {mode: modeForCount});
                }

                // Обновляем текущую страницу из ответа
                if (data.current_page) {
                    window.currentPage = data.current_page;
                }

                if (isApartmentsMode) {
                    renderApartments(data);
                } else {
                    renderItems(data);
                }
            } catch (e) {
                // Игнорируем AbortError - это нормальная отмена запроса
                if (e.name === 'AbortError') {
                    return;
                }
                if (typeof window.updateResultsCount === 'function') {
                    const fallbackMode = isSecondary ? 'secondary' : (isApartmentsMode ? 'apartments' : 'complexes');
                    window.updateResultsCount(0, {mode: fallbackMode});
                }
                if (grid) grid.innerHTML = '<div class="error">Ошибка загрузки</div>';
                console.error(e);
            }
        }

        // Глобальная функция renderApartments для рендеринга карточек квартир
        window.renderApartments = function (data) {
            const grid = document.getElementById('catalog-grid');
            const isSecondary = '{{ dataset_type }}' === 'secondary';

            if (!grid) return;

            const apartments = data.apartments || [];
            const currentView = isSecondary ? 'list' : 'map';

            // Рендерим карту для новостроек - показываем точки ЖК (как в режиме ЖК)
            if (!isSecondary) {
                if (typeof renderMapPoints === 'function') {
                    const mapPoints = data.map_points || [];
                    // Важно: передаем false в третьем параметре чтобы показывались ЖК, а не квартиры
                    renderMapPoints(mapPoints, false, false); // false = показываем точки ЖК
                }
            }

            if (!apartments.length) {
                // Для вторичной недвижимости убираем иконку
                const noResultsHtml = isSecondary ? `
                <div class="no-complexes-cta">
                    <h3>Подберём варианты в других проектах</h3>
                    <p>По вашему запросу ничего не найдено — оставьте заявку, менеджер предложит подходящие варианты в других проектах.</p>
                    <button type="button" class="no-complexes-btn anchor-feedback-btn">
                        Оставить заявку
                    </button>
                </div>
                ` : `
                <div class="no-complexes-cta">
                    <div class="no-complexes-icon">
                        <span>🎧</span>
                    </div>
                    <h3>Подберём квартиру от застройщика</h3>
                    <p>По вашему запросу ничего не найдено — оставьте заявку, менеджер предложит подходящие квартиры в других проектах.</p>
                    <button type="button" class="no-complexes-btn anchor-feedback-btn">
                        Подобрать квартиру
                    </button>
                </div>
                `;
                grid.innerHTML = noResultsHtml;
            } else {
                // Используем тот же горизонтальный стиль, что и для ЖК
                let html = '';
                apartments.forEach((apt) => {
                    let photo = apt.photo || (Array.isArray(apt.complex_photos) && apt.complex_photos.length > 0 ? apt.complex_photos[0] : null) || '/media/gallery/placeholders.png';
                    if (photo) {
                        photo = String(photo);
                        if (photo && photo !== '/media/gallery/placeholders.png' && !photo.startsWith('/media/') && !photo.startsWith('http')) {
                            photo = `/media/${photo}`;
                        }
                    } else {
                        photo = '/media/gallery/placeholders.png';
                    }

                    const additionalPhotos = Array.isArray(apt.complex_photos) ? apt.complex_photos.slice(1, 5) : [];
                    const thumbnailsHtml = additionalPhotos.length ? `
                        <div class="catalog-card-thumbs">
                            ${additionalPhotos.map((extra, index) => {
                                let thumbSrc = extra || '';
                                if (thumbSrc && !thumbSrc.startsWith('/media/') && !thumbSrc.startsWith('http')) {
                                    thumbSrc = `/media/${thumbSrc}`;
                                }
                                if (!thumbSrc) thumbSrc = '/media/gallery/placeholders.png';
                                return `
                                    <button type="button" class="catalog-thumb ${index === 0 ? 'active' : ''}" data-photo="${thumbSrc}"
                                        onclick="event.stopPropagation(); window.switchCatalogCardPhoto(this);">
                                        <img src="${thumbSrc}" alt="${apt.apartment_title || ''} превью ${index + 1}">
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    ` : '';

                    const apartmentTitle = apt.apartment_title || (apt.rooms === 'Студия' ? 'Студия' : apt.rooms === '1' ? '1-комнатная квартира' : apt.rooms === '2' ? '2-комнатная квартира' : apt.rooms === '3' ? '3-комнатная квартира' : apt.rooms === '4' ? '4-комнатная квартира' : apt.rooms === '5+' ? '5+ комнат' : `${apt.rooms}-комнатная квартира`);
                    const priceDisplay = formatPriceText(apt.price || apt.price_display || apt.price_range || '');
                    const areaDisplay = apt.area ? `${apt.area} м²` : '—';
                    const floorDisplay = apt.floor ? `${apt.floor} этаж` : '';
                    const apartmentUrl = `/apartment/${apt.complex_id}/${apt.apartment_id ? String(apt.apartment_id) : (apt.id ? (String(apt.id).includes('_apt_') ? String(apt.id).split('_apt_')[1] : String(apt.id).split('_').slice(-2).join('_')) : '0_0')}/`;
                    
                    // Определяем complexId и apartmentId для избранного
                    const complexId = apt.complex_id || '';
                    const apartmentId = apt.apartment_id ? String(apt.apartment_id) : (apt.id ? (String(apt.id).includes('_apt_') ? String(apt.id).split('_apt_')[1] : String(apt.id).split('_').slice(-2).join('_')) : '0_0');

                    html += `
                        <div class="property-card-compact catalog-card-horizontal" data-complex-id="${apt.id}">
                            <div class="catalog-card-media">
                                <div class="catalog-card-main-image" onclick="window.open('${apartmentUrl}', '_blank');" style="position: relative;">
                                    <button class="favorite-btn" data-favorite-complex-id="${complexId}"
                                        data-favorite-apartment-id="${apartmentId}"
                                        onclick="event.stopPropagation(); if(typeof toggleApartmentFavoriteHandler === 'function') { toggleApartmentFavoriteHandler('${complexId}', '${apartmentId}', this); }"
                                        title="Добавить в избранное">
                                        <i class="far fa-heart"></i>
                                    </button>
                                    <img src="${photo}" alt="${apartmentTitle}">
                                </div>
                                ${thumbnailsHtml}
                            </div>
                            <div class="catalog-card-body" onclick="window.open('${apartmentUrl}', '_blank');">
                                <div class="catalog-card-header">
                                    <h3 class="compact-card-title">${apartmentTitle}</h3>
                                    ${apt.special_offer ? `<span class="catalog-card-badge">Есть акция</span>` : ''}
                                </div>
                                <p class="catalog-card-subtitle">
                                    ${apt.complex_name || ''}${apt.completion_date ? ` • Сдача: ${apt.completion_date}` : ''}
                                </p>
                                <p class="catalog-card-address">
                                    ${apt.address || apt.complex_address || apt.city || 'Уфа'}
                                </p>
                                ${priceDisplay ? `<div class="catalog-card-price-line"><span>Стоимость:</span><strong>${priceDisplay}</strong></div>` : ''}
                                <div class="catalog-card-detail-list">
                                    ${areaDisplay ? `
                                        <div class="catalog-detail-item">
                                            <span>Площадь</span>
                                            <strong>${areaDisplay}</strong>
                                        </div>
                                    ` : ''}
                                    ${floorDisplay ? `
                                        <div class="catalog-detail-item">
                                            <span>Этаж</span>
                                            <strong>${floorDisplay}</strong>
                                        </div>
                                    ` : ''}
                                    ${apt.rooms ? `
                                        <div class="catalog-detail-item">
                                            <span>Комнат</span>
                                            <strong>${apt.rooms}</strong>
                                        </div>
                                    ` : ''}
                                    ${apt.completion_date ? `
                                        <div class="catalog-detail-item">
                                            <span>Сдача</span>
                                            <strong>${apt.completion_date}</strong>
                                        </div>
                                    ` : ''}
                                    ${apt.complex_name ? `
                                        <div class="catalog-detail-item">
                                            <span>ЖК</span>
                                            <strong>${apt.complex_name}</strong>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>`;
                });
                grid.innerHTML = html;
            }

            // Обновляем пагинацию
            if (typeof updatePagination === 'function') {
                updatePagination(data);
            }

            // Инициализируем состояние кнопок избранного для квартир
            setTimeout(() => {
                // Старый формат (для совместимости)
                const favoriteBtns = grid.querySelectorAll('.favorite-btn[data-type="apartment"]');
                favoriteBtns.forEach(btn => {
                    const id = btn.getAttribute('data-id');
                    if (id) {
                        const parts = id.split('_apt_');
                        if (parts.length === 2) {
                            const complexId = parts[0];
                            const apartmentId = parts[1];
                            // Проверяем, есть ли квартира в избранном через localStorage
                            try {
                                const favorites = JSON.parse(localStorage.getItem('century21_favorites') || '{"apartments":[]}');
                                const idStr = `${complexId}_${apartmentId}`;
                                const isFavorite = favorites.apartments && favorites.apartments.includes(idStr);

                                // Обновляем иконку
                                const icon = btn.querySelector('i');
                                if (icon) {
                                    if (isFavorite) {
                                        icon.classList.remove('far');
                                        icon.classList.add('fas');
                                        btn.classList.add('favorite-active');
                                    } else {
                                        icon.classList.remove('fas');
                                        icon.classList.add('far');
                                        btn.classList.remove('favorite-active');
                                    }
                                }
                            } catch (e) {
                                console.error('Ошибка проверки избранного:', e);
                            }
                        }
                    }
                });
                
                // Новый формат с data-favorite-complex-id и data-favorite-apartment-id
                const newFavoriteBtns = grid.querySelectorAll('.favorite-btn[data-favorite-apartment-id]');
                newFavoriteBtns.forEach(btn => {
                    const complexId = btn.getAttribute('data-favorite-complex-id');
                    const apartmentId = btn.getAttribute('data-favorite-apartment-id');
                    if (complexId && apartmentId) {
                        // Проверяем, есть ли квартира в избранном через localStorage
                        try {
                            const favorites = JSON.parse(localStorage.getItem('century21_favorites') || '{"apartments":[]}');
                            const idStr = `${complexId}_${apartmentId}`;
                            const isFavorite = favorites.apartments && favorites.apartments.includes(idStr);

                            // Обновляем иконку
                            const icon = btn.querySelector('i');
                            if (icon) {
                                if (isFavorite) {
                                    icon.classList.remove('far');
                                    icon.classList.add('fas');
                                    btn.classList.add('favorite-active');
                                } else {
                                    icon.classList.remove('fas');
                                    icon.classList.add('far');
                                    btn.classList.remove('favorite-active');
                                }
                            }
                        } catch (e) {
                            console.error('Ошибка проверки избранного:', e);
                        }
                    }
                });
            }, 100);
        }

        // Глобальная функция initMap
        window.initMap = function () {
            const mapEl = document.getElementById('map');
            if (!mapEl) return;

            window.map = L.map('map', {attributionControl: false});
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; OpenStreetMap'}).addTo(window.map);
            window.markersLayer = L.layerGroup().addTo(window.map);
            window.map.setView([54.7388, 55.9721], 11); // Уфа по умолчанию
        }

        // Глобальная функция serialize
        window.serialize = function () {
            const form = document.getElementById('filters-form');
            if (!form) return '';

            const fd = new FormData(form);
            const params = new URLSearchParams();

            // Собираем все параметры, исключая чекбоксы city, complexes, district, street, delivery_quarter (они обрабатываются через скрытые поля)
            for (const [k, v] of fd.entries()) {
                if (k !== 'city' && k !== 'complexes' && k !== 'district' && k !== 'street' && k !== 'delivery_quarter' && v !== '') {
                    // Удаляем пробелы из значений цены перед отправкой
                    if (k === 'price_from' || k === 'price_to') {
                        const cleanValue = String(v).replace(/\s/g, '');
                        if (cleanValue) {
                            params.append(k, cleanValue);
                        }
                    } else {
                        params.append(k, v);
                    }
                }
            }

            // Добавляем city из скрытого поля
            const cityHidden = document.getElementById('city-hidden');
            if (cityHidden && cityHidden.value) {
                params.set('city', cityHidden.value);
            }

            // Добавляем complexes из скрытого поля
            const complexesHidden = document.getElementById('complexes-hidden');
            if (complexesHidden && complexesHidden.value) {
                params.set('complexes', complexesHidden.value);
            }

            // Добавляем district из скрытого поля
            const districtHidden = document.getElementById('district-hidden');
            if (districtHidden && districtHidden.value) {
                params.set('district', districtHidden.value);
            }

            // Добавляем street из скрытого поля
            const streetHidden = document.getElementById('street-hidden');
            if (streetHidden && streetHidden.value) {
                params.set('street', streetHidden.value);
            }

            // Добавляем delivery_quarter из скрытого поля
            const deliveryQuarterHidden = document.getElementById('delivery-quarter-hidden');
            if (deliveryQuarterHidden && deliveryQuarterHidden.value) {
                params.set('delivery_quarter', deliveryQuarterHidden.value);
            }

            const sort = document.getElementById('sort-hidden');
            if (sort && sort.value) params.set('sort', sort.value);
            return params.toString();
        }

        // Глобальная функция renderMapPoints
        window.renderMapPoints = function (list, isSec, isApartments) {
            // Убеждаемся, что карта видна для новостроек
            const mapEl = document.getElementById('map');
            if (mapEl && !isSec) {
                mapEl.style.display = 'block';
            }

            if (!window.map) {
                // Если карта не инициализирована, инициализируем её
                if (typeof window.initMap === 'function') {
                    window.initMap();
                } else {
                    console.warn('initMap function not found');
                    return;
                }
            }
            if (!window.map) {
                console.warn('Map not initialized');
                return;
            }

            // Очищаем существующие маркеры
            if (window.markersLayer) {
                window.markersLayer.clearLayers();
            } else {
                window.markersLayer = L.layerGroup().addTo(window.map);
            }

            const bounds = [];
            list.forEach(item => {
                const lat = item.lat || item.latitude;
                const lng = item.lng || item.longitude;
                if (lat && lng) {
                    const marker = L.marker([lat, lng]).addTo(window.markersLayer);
                    const price = item.price_range || item.price_display || 'Цена по запросу';

                    // Формируем ссылку в зависимости от типа
                    let link;
                    if (isSec) {
                        link = `/secondary/${item.id}/`;
                    } else if (isApartments) {
                        // В режиме квартир используем точки ЖК (как в режиме ЖК)
                        // Проверяем, содержит ли ID формат квартиры (complex_id_apt_apartment_id)
                        if (item.id.includes('_apt_')) {
                            // Если это ID квартиры, извлекаем complex_id и apartment_id
                            const parts = item.id.split('_apt_');
                            if (parts.length === 2) {
                                const complexId = parts[0];
                                const apartmentId = parts[1];
                                link = `/apartment/${complexId}/${apartmentId}/`;
                            } else {
                                link = `/complex/${parts[0]}/`;
                            }
                        } else {
                            // Если это просто ID ЖК (что и должно быть после исправления)
                            link = `/complex/${item.id}/`;
                        }
                    } else {
                        link = `/complex/${item.id}/`;
                    }

                    marker.bindPopup(`<b>${item.name}</b><br/>${price}<br/><a href="${link}">Подробнее</a>`);
                    bounds.push([lat, lng]);
                }
            });

            // Обновляем границы карты, если есть маркеры
            if (bounds.length) {
                window.map.fitBounds(bounds, {padding: [20, 20]});
            } else {
                // Если нет маркеров, устанавливаем вид по умолчанию (Уфа)
                window.map.setView([54.7388, 55.9721], 11);
            }
        }

        function setupFiltersModal() {
            const openBtn = document.getElementById('mobile-filter-open');
            const closeBtn = document.getElementById('mobile-filter-close');
            const sheet = document.getElementById('filters-sheet');
            let backdrop = document.getElementById('filters-backdrop');

            if (!openBtn || !sheet) {
                return;
            }

            if (!backdrop) {
                backdrop = document.createElement('div');
                backdrop.id = 'filters-backdrop';
                backdrop.className = 'filters-backdrop';
                backdrop.setAttribute('aria-hidden', 'true');
                document.body.appendChild(backdrop);
            }

            let isSheetOpen = false;

            const applyScrollFixes = () => {
                sheet.style.setProperty('overflow-y', 'auto', 'important');
                sheet.style.setProperty('overflow-x', 'hidden', 'important');
                sheet.style.setProperty('-webkit-overflow-scrolling', 'touch', 'important');
                sheet.style.setProperty('touch-action', 'pan-y', 'important');
                sheet.style.setProperty('max-height', '85vh', 'important');
                sheet.style.setProperty('height', 'auto', 'important');

                const form = sheet.querySelector('.filters-form');
                if (form) {
                    form.style.setProperty('height', 'auto', 'important');
                    form.style.setProperty('overflow-y', 'auto', 'important');
                }
            };

            const openSheet = () => {
                applyScrollFixes();
                
                // Для планшетов (769-991px): принудительно показываем модальное окно
                if (window.innerWidth >= 769 && window.innerWidth <= 991) {
                    sheet.style.cssText = `
                        position: fixed !important;
                        top: 50% !important;
                        left: 50% !important;
                        transform: translate(-50%, -50%) scale(1) !important;
                        opacity: 1 !important;
                        visibility: visible !important;
                        pointer-events: auto !important;
                        z-index: 10000 !important;
                        width: 90% !important;
                        max-width: 600px !important;
                        max-height: 85vh !important;
                        background: #fff !important;
                        border-radius: 16px !important;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3) !important;
                        overflow: hidden !important;
                        display: flex !important;
                        flex-direction: column !important;
                    `;
                }
                
                sheet.classList.add('open');
                sheet.setAttribute('aria-hidden', 'false');
                document.body.classList.add('filter-open');
                if (backdrop) {
                    backdrop.classList.add('open');
                    backdrop.setAttribute('aria-hidden', 'false');
                }
                isSheetOpen = true;
            };

            const closeSheet = () => {
                sheet.classList.remove('open');
                sheet.setAttribute('aria-hidden', 'true');
                document.body.classList.remove('filter-open');
                
                // Сбрасываем inline стили для планшетов
                if (window.innerWidth >= 769 && window.innerWidth <= 991) {
                    sheet.style.cssText = '';
                }
                
                if (backdrop) {
                    backdrop.classList.remove('open');
                    backdrop.setAttribute('aria-hidden', 'true');
                }
                isSheetOpen = false;
            };

            openBtn.addEventListener('click', function (e) {
                if (window.innerWidth > 991) return;
                e.preventDefault();
                e.stopPropagation();
                openSheet();
            });

            if (closeBtn) {
                closeBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeSheet();
                });
            }

            if (backdrop) {
                backdrop.addEventListener('click', function (e) {
                    if (e.target === backdrop) {
                        closeSheet();
                    }
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && isSheetOpen) {
                    closeSheet();
                }
            });

            // Закрываем модальное окно при нажатии "Применить" на мобильных/планшетах
            const applyBtn = sheet.querySelector('button[type="submit"].btn-primary');
            if (applyBtn) {
                applyBtn.addEventListener('click', function() {
                    setTimeout(function() {
                        if (window.innerWidth <= 991) {
                            closeSheet();
                        }
                    }, 100);
                });
            }

            window.showFiltersSheet = openSheet;
            window.hideFiltersSheet = closeSheet;
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupFiltersModal);
        } else {
            setupFiltersModal();
        }

        // Глобальная функция setView
        window.setView = function (view) {
            const grid = document.getElementById('catalog-grid');
            const mapEl = document.getElementById('map');
            const toggleBtns = document.querySelectorAll('.view-btn');
            const isSecondary = '{{ dataset_type }}' === 'secondary';

            // Не позволяем переключиться на карту для вторичной недвижимости
            if (isSecondary && view === 'map') {
                return;
            }

            toggleBtns.forEach(b => b.classList.toggle('active', b.getAttribute('data-view') === view));

            // Всегда показываем оба элемента, но меняем порядок
            if (view === 'map') {
                // Карта сверху, список снизу
                mapEl.style.display = 'block';
                mapEl.style.order = '1';
                grid.style.display = 'block';
                grid.style.order = '2';
                if (!window.map) initMap();
                fetchData();
            } else {
                // Список сверху, карта снизу (или скрыта для вторички)
                if (isSecondary) {
                    mapEl.style.display = 'none';
                    grid.style.display = 'block';
                } else {
                    mapEl.style.display = 'block';
                    mapEl.style.order = '2';
                    grid.style.display = 'block';
                    grid.style.order = '1';
                }
                fetchData();
            }

            // Сохраняем в localStorage только для новостроек
            if (!isSecondary) {
                localStorage.setItem('catalog_view', view);
            }
        }

        // Инициализация глобальных переменных для AJAX
        window.activeController = null;
        window.latestRequestId = 0;
        window.map = null;
        window.markersLayer = null;
        window.initialCatalogFetchDone = false;

        // Обработка полей ввода "От" и "До" для площади и цены
        document.addEventListener('DOMContentLoaded', function () {
            // Инициализация видимости фильтра площади для вторички (этаж убран)
            const isSecondaryPage = '{{ dataset_type }}' === 'secondary';
            const areaFilterGroupInit = document.getElementById('area-filter-group');
            if (isSecondaryPage) {
                if (areaFilterGroupInit) {
                    areaFilterGroupInit.style.display = 'block';
                }
            }

            // Обработка полей ввода площади
            const areaFromInput = document.getElementById('area-from-input');
            const areaToInput = document.getElementById('area-to-input');
            if (areaFromInput && areaToInput) {
                [areaFromInput, areaToInput].forEach(input => {
                    input.addEventListener('change', function () {
                        // Валидация: проверяем, что "от" не больше "до" (только если оба поля заполнены)
                        const fromValue = parseFloat(areaFromInput.value);
                        const toValue = parseFloat(areaToInput.value);
                        if (fromValue && toValue && fromValue > toValue) {
                            // Если "от" больше "до", меняем местами только если оба заполнены
                            areaFromInput.value = toValue;
                            areaToInput.value = fromValue;
                        }
                        window.resetPageAndFetch();
                    });
                    input.addEventListener('blur', function () {
                        window.resetPageAndFetch();
                    });
                });
            }

            // Функция форматирования цены с пробелами
            function formatPriceInput(value) {
                // Убираем все нецифровые символы (кроме пробелов, которые мы добавим)
                const numbers = String(value).replace(/\D/g, '');
                if (!numbers) return '';
                // Форматируем с пробелами для разделения тысяч
                return numbers.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
            }

            // Функция получения числового значения из отформатированной строки
            function getPriceNumber(value) {
                return String(value).replace(/\s/g, '').trim();
            }

            // Обработка полей ввода цены
            const priceFromInput = document.getElementById('price-from-input');
            const priceToInput = document.getElementById('price-to-input');
            if (priceFromInput && priceToInput) {
                // Форматируем начальные значения при загрузке страницы
                if (priceFromInput.value) {
                    priceFromInput.value = formatPriceInput(priceFromInput.value);
                }
                if (priceToInput.value) {
                    priceToInput.value = formatPriceInput(priceToInput.value);
                }

                [priceFromInput, priceToInput].forEach(input => {
                    input.addEventListener('input', function (e) {
                        const cursorPosition = this.selectionStart;
                        const oldValue = this.value;
                        const oldLength = oldValue.length;
                        
                        // Форматируем значение
                        const formatted = formatPriceInput(this.value);
                        this.value = formatted;
                        
                        // Восстанавливаем позицию курсора
                        const newLength = formatted.length;
                        const lengthDiff = newLength - oldLength;
                        const newPosition = Math.max(0, Math.min(cursorPosition + lengthDiff, formatted.length));
                        this.setSelectionRange(newPosition, newPosition);
                    });

                    input.addEventListener('change', function () {
                        // Валидация: проверяем, что "от" не больше "до" (только если оба поля заполнены)
                        const fromValueNum = parseFloat(getPriceNumber(priceFromInput.value));
                        const toValueNum = parseFloat(getPriceNumber(priceToInput.value));
                        if (fromValueNum && toValueNum && fromValueNum > toValueNum) {
                            // Если "от" больше "до", меняем местами только если оба заполнены
                            const temp = priceFromInput.value;
                            priceFromInput.value = priceToInput.value;
                            priceToInput.value = temp;
                        }
                        window.resetPageAndFetch();
                    });
                    input.addEventListener('blur', function () {
                        // Убеждаемся, что значение отформатировано при потере фокуса
                        if (this.value) {
                            this.value = formatPriceInput(this.value);
                        }
                        window.resetPageAndFetch();
                    });
                });
            }

            // Обработка полей ввода этажа
            const floorFromInput = document.getElementById('floor-from-input');
            const floorToInput = document.getElementById('floor-to-input');
            if (floorFromInput && floorToInput) {
                [floorFromInput, floorToInput].forEach(input => {
                    input.addEventListener('change', function () {
                        // Валидация: проверяем, что "от" не больше "до" (только если оба поля заполнены)
                        const fromValue = parseInt(floorFromInput.value);
                        const toValue = parseInt(floorToInput.value);
                        if (fromValue && toValue && fromValue > toValue) {
                            // Если "от" больше "до", меняем местами только если оба заполнены
                            floorFromInput.value = toValue;
                            floorToInput.value = fromValue;
                        }
                        window.resetPageAndFetch();
                    });
                    input.addEventListener('blur', function () {
                        window.resetPageAndFetch();
                    });
                });
            }

            // Обработка отправки формы фильтров (для всех типов недвижимости)
            const filtersForm = document.getElementById('filters-form');
            if (filtersForm) {
                filtersForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    applyFilters();
                });
            }

            // Обработка нажатия на кнопку "Поиск" - закрытие фильтра теперь в обработчике submit формы

            // Обработка выбора города
            const cityGroup = document.getElementById('city-group');
            const cityInput = document.getElementById('city-input');
            const cityText = document.getElementById('city-text');
            const cityHidden = document.getElementById('city-hidden');
            const districtGroup = document.getElementById('district-group');
            const streetGroup = document.getElementById('street-group');
            const districtInput = document.getElementById('district-input');
            const streetInput = document.getElementById('street-input');
            const districtText = document.getElementById('district-text');
            const streetText = document.getElementById('street-text');
            const districtHidden = document.getElementById('district-hidden');
            const streetHidden = document.getElementById('street-hidden');
            const deliveryQuarterGroup = document.getElementById('delivery-quarter-group');
            const deliveryQuarterInput = document.getElementById('delivery-quarter-input');
            const deliveryQuarterText = document.getElementById('delivery-quarter-text');
            const deliveryQuarterHidden = document.getElementById('delivery-quarter-hidden');
            const cityDropdown = document.getElementById('city-dropdown');
            const cityList = document.getElementById('city-list');
            const districtDropdown = document.getElementById('district-dropdown');
            const districtList = document.getElementById('district-list');
            const streetDropdown = document.getElementById('street-dropdown');
            const streetList = document.getElementById('street-list');
            const deliveryQuarterDropdown = document.getElementById('delivery-quarter-dropdown');
            const deliveryQuarterList = document.getElementById('delivery-quarter-list');
            const deliveryQuarterModal = document.getElementById('delivery-quarter-modal');
            const deliveryQuarterModalClose = document.getElementById('delivery-quarter-modal-close');
            const deliveryQuarterModalCancel = document.getElementById('delivery-quarter-modal-cancel');
            const deliveryQuarterModalApply = document.getElementById('delivery-quarter-modal-apply');
            const deliveryQuarterModalReset = document.getElementById('delivery-quarter-modal-reset');
            const deliveryQuarterModalCheckboxes = document.querySelectorAll('.delivery-quarter-modal-checkbox');
            const datasetType = '{{ dataset_type|default:"newbuild" }}';


            function getSelectedValues(input) {
                if (!input || !input.value) return [];
                return input.value.split(',').map(v => v.trim()).filter(Boolean);
            }

            function setSelectedValues(input, values) {
                if (!input) return;
                input.value = values.join(',');
            }

            function formatSelectionText(values, defaultLabel) {
                if (!values || values.length === 0) return defaultLabel;
                if (values.length === 1) return values[0];
                return `Выбрано: ${values.length}`;
            }

            function setupCheckboxModal({
                                            input,
                                            modal,
                                            hiddenInput,
                                            updateText,
                                            onApply,
                                            checkboxSelector,
                                            resetButton,
                                            applyButton,
                                            cancelButton,
                                            closeButton,
                                            searchInputId
                                        }) {
                if (!input || !modal || !hiddenInput) return;
                const backdrop = modal.querySelector('.filter-modal-backdrop');
                const closeBtn = closeButton || modal.querySelector('.filter-modal-close');
                const cancelBtn = cancelButton || modal.querySelector('.filter-modal-cancel');
                const resetBtn = resetButton || modal.querySelector('.filter-modal-reset');
                const applyBtn = applyButton || modal.querySelector('.filter-modal-apply');

                const getCheckboxes = () => modal.querySelectorAll(checkboxSelector);

                function syncFromHidden() {
                    const selected = getSelectedValues(hiddenInput);
                    getCheckboxes().forEach(cb => {
                        cb.checked = selected.includes(cb.value);
                    });
                }

                function closeModal() {
                    modal.classList.remove('active');
                }

                input.addEventListener('click', function (e) {
                    e.stopPropagation();
                    syncFromHidden();
                    modal.classList.add('active');
                });

                closeBtn?.addEventListener('click', closeModal);
                cancelBtn?.addEventListener('click', closeModal);
                backdrop?.addEventListener('click', closeModal);

                resetBtn?.addEventListener('click', function () {
                    getCheckboxes().forEach(cb => cb.checked = false);
                });

                if (searchInputId) {
                    const searchInput = document.getElementById(searchInputId);
                    if (searchInput) {
                        searchInput.addEventListener('input', function () {
                            const term = this.value.trim().toLowerCase();
                            modal.querySelectorAll('.filter-modal-item').forEach(item => {
                                const text = item.textContent.toLowerCase();
                                item.style.display = text.includes(term) ? '' : 'none';
                            });
                        });
                    }
                }

                applyBtn?.addEventListener('click', function () {
                    const selected = Array.from(getCheckboxes()).filter(cb => cb.checked).map(cb => cb.value);
                    setSelectedValues(hiddenInput, selected);
                    if (typeof updateText === 'function') {
                        updateText(selected);
                    }
                    let shouldAutoApply = true;
                    if (typeof onApply === 'function') {
                        const result = onApply(selected);
                        if (result === false) {
                            shouldAutoApply = false;
                        }
                    }
                    if (shouldAutoApply) {
                        window.resetPageAndFetch();
                    }
                    closeModal();
                });
            }

            // Функция обновления текста в поле города
            window.updateCityText = function (values) {
                if (!cityText) return;
                const selected = Array.isArray(values) ? values : getSelectedValues(cityHidden);
                cityText.textContent = formatSelectionText(selected, 'Любой');
            };

            // Функция обновления текста в поле срока сдачи
            window.updateDeliveryQuarterText = function () {
                if (!deliveryQuarterText) return;
                const value = deliveryQuarterHidden ? deliveryQuarterHidden.value : '';
                if (!value) {
                    deliveryQuarterText.textContent = 'Любой срок';
                    return;
                }
                const values = value.split(',').map(v => v.trim()).filter(Boolean);
                if (values.length === 0) {
                    deliveryQuarterText.textContent = 'Любой срок';
                } else if (values.length === 1) {
                    const checkbox = document.querySelector(`.delivery-quarter-modal-checkbox[value="${CSS && CSS.escape ? CSS.escape(values[0]) : values[0]}"]`);
                    if (checkbox && checkbox.nextElementSibling) {
                        deliveryQuarterText.textContent = checkbox.nextElementSibling.textContent;
                    } else {
                        deliveryQuarterText.textContent = values[0];
                    }
                } else {
                    deliveryQuarterText.textContent = `Выбрано: ${values.length}`;
                }
            };

            // Функция обновления текста в поле районов
            window.updateDistrictText = function (values) {
                const districtTextEl = document.getElementById('district-text');
                if (!districtTextEl) return;
                const selected = Array.isArray(values) ? values : getSelectedValues(districtHidden);
                districtTextEl.textContent = formatSelectionText(selected, 'Любой');
            };

            // Функция обновления текста в поле улиц
            window.updateStreetText = function (values) {
                const streetTextEl = document.getElementById('street-text');
                if (!streetTextEl) return;
                const selected = Array.isArray(values) ? values : getSelectedValues(streetHidden);
                streetTextEl.textContent = formatSelectionText(selected, 'Любая');
            };

            window.updateComplexesText = function (values) {
                const complexesTextEl = document.getElementById('complexes-text');
                const complexesHidden = document.getElementById('complexes-hidden');
                if (!complexesTextEl) return;
                const selected = Array.isArray(values) ? values : getSelectedValues(complexesHidden);
                if (selected.length === 0) {
                    complexesTextEl.textContent = 'Любые';
                } else if (selected.length === 1) {
                    complexesTextEl.textContent = '1 выбран';
                } else {
                    complexesTextEl.textContent = `Выбрано: ${selected.length}`;
                }
            };

            const cityModal = document.getElementById('city-modal');
            const districtModal = document.getElementById('district-modal');
            const streetModal = document.getElementById('street-modal');
            const complexesModal = document.getElementById('complexes-modal');

            setupCheckboxModal({
                input: cityInput,
                modal: cityModal,
                hiddenInput: cityHidden,
                updateText: window.updateCityText,
                onApply: function (selected) {
                    handleCitySelection(selected);
                    return false;
                },
                checkboxSelector: '.city-modal-checkbox'
            });

            setupCheckboxModal({
                input: districtInput,
                modal: districtModal,
                hiddenInput: districtHidden,
                updateText: window.updateDistrictText,
                onApply: function (selected) {
                    handleDistrictSelection(selected);
                    return false;
                },
                checkboxSelector: '.district-modal-checkbox'
            });

            setupCheckboxModal({
                input: streetInput,
                modal: streetModal,
                hiddenInput: streetHidden,
                updateText: window.updateStreetText,
                checkboxSelector: '.street-modal-checkbox'
            });

            setupCheckboxModal({
                input: document.getElementById('complexes-input'),
                modal: complexesModal,
                hiddenInput: document.getElementById('complexes-hidden'),
                updateText: window.updateComplexesText,
                checkboxSelector: '.complex-modal-checkbox',
                searchInputId: 'complexes-modal-search'
            });

            function handleCitySelection(selectedCities) {
                const selectedCity = selectedCities[0] || '';
                const districtListEl = document.getElementById('district-modal-list');
                const streetListEl = document.getElementById('street-modal-list');

                if (!districtListEl || !streetListEl) {
                    window.resetPageAndFetch();
                    return false;
                }

                if (!selectedCity) {
                    setSelectedValues(districtHidden, []);
                    setSelectedValues(streetHidden, []);
                    districtListEl.innerHTML = '<div class="filter-modal-empty">Выберите город</div>';
                    streetListEl.innerHTML = '<div class="filter-modal-empty">Выберите район</div>';
                    window.updateDistrictText([]);
                    window.updateStreetText([]);
                    window.resetPageAndFetch();
                    return false;
                }

                fetch(`/api/districts/?city=${encodeURIComponent(selectedCity)}&dataset=${encodeURIComponent(datasetType)}`)
                    .then(response => response.json())
                    .then(data => {
                        districtListEl.innerHTML = '';
                        if (data.districts && data.districts.length > 0) {
                            data.districts.forEach(district => {
                                const item = document.createElement('label');
                                item.className = 'filter-modal-item';
                                item.innerHTML = `
                                <input type="checkbox" class="district-modal-checkbox" value="${district}" data-district="${district}">
                                <span>${district}</span>
                            `;
                                districtListEl.appendChild(item);
                            });
                        } else {
                            const empty = document.createElement('div');
                            empty.className = 'filter-modal-empty';
                            empty.textContent = 'Районы не найдены';
                            districtListEl.appendChild(empty);
                        }

                        setSelectedValues(districtHidden, []);
                        setSelectedValues(streetHidden, []);
                        window.updateDistrictText([]);
                        window.updateStreetText([]);

                        loadStreetsForDistricts([]).finally(() => {
                            window.resetPageAndFetch();
                        });
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки районов:', error);
                        districtListEl.innerHTML = '<div class="filter-modal-empty">Ошибка загрузки</div>';
                        setSelectedValues(districtHidden, []);
                        setSelectedValues(streetHidden, []);
                        window.updateDistrictText([]);
                        window.updateStreetText([]);
                        window.resetPageAndFetch();
                    });

                return false;
            }

            function handleDistrictSelection(selectedDistricts) {
                loadStreetsForDistricts(selectedDistricts).finally(() => {
                    window.updateStreetText();
                    window.resetPageAndFetch();
                });
                return false;
            }

            function loadStreetsForDistricts(selectedDistricts) {
                const streetListEl = document.getElementById('street-modal-list');
                if (!streetListEl) return Promise.resolve();
                const selectedCities = getSelectedValues(cityHidden);
                const cityValue = selectedCities.length > 0 ? selectedCities[0] : '';

                if (!cityValue) {
                    streetListEl.innerHTML = '<div class="filter-modal-empty">Сначала выберите город</div>';
                    setSelectedValues(streetHidden, []);
                    window.updateStreetText([]);
                    return Promise.resolve();
                }

                const currentSelected = getSelectedValues(streetHidden);
                let url = `/api/streets/?city=${encodeURIComponent(cityValue)}&dataset=${encodeURIComponent(datasetType)}`;
                const districts = selectedDistricts && selectedDistricts.length ? selectedDistricts : getSelectedValues(districtHidden);
                if (districts.length > 0) {
                    url += `&district=${districts.map(d => encodeURIComponent(d)).join(',')}`;
                }

                streetListEl.innerHTML = '<div class="filter-modal-empty">Загрузка...</div>';

                return fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        streetListEl.innerHTML = '';
                        if (data.streets && data.streets.length > 0) {
                            data.streets.forEach(street => {
                                const item = document.createElement('label');
                                item.className = 'filter-modal-item';
                                item.innerHTML = `
                                <input type="checkbox" class="street-modal-checkbox" value="${street}" data-street="${street}" ${currentSelected.includes(street) ? 'checked' : ''}>
                                <span>${street}</span>
                            `;
                                streetListEl.appendChild(item);
                            });

                            const validSelected = currentSelected.filter(s => data.streets.includes(s));
                            setSelectedValues(streetHidden, validSelected);
                            window.updateStreetText(validSelected);
                        } else {
                            const empty = document.createElement('div');
                            empty.className = 'filter-modal-empty';
                            empty.textContent = 'Улицы не найдены';
                            streetListEl.appendChild(empty);
                            setSelectedValues(streetHidden, []);
                            window.updateStreetText([]);
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки улиц:', error);
                        streetListEl.innerHTML = '<div class="filter-modal-empty">Ошибка загрузки</div>';
                        setSelectedValues(streetHidden, []);
                        window.updateStreetText([]);
                    });
            }

            window.updateCityText();
            window.updateDistrictText();
            window.updateStreetText();
            window.updateComplexesText();
            window.updateDeliveryQuarterText();

            // Функция загрузки улиц по выбранным районам
            function loadStreetsForDistricts(selectedDistricts) {
                const checkedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);
                const city = checkedCities.length > 0 ? checkedCities[0] : '';
                const streetList = document.getElementById('street-list');
                const streetHidden = document.getElementById('street-hidden');

                if (!city || !streetList) return Promise.resolve();

                // Сохраняем текущие выбранные улицы
                const currentSelectedStreets = streetHidden ? streetHidden.value.split(',').filter(s => s.trim()) : [];

                // Формируем URL для запроса улиц
                let url = `/api/streets/?city=${encodeURIComponent(city)}&dataset=${encodeURIComponent(datasetType)}`;
                if (selectedDistricts.length > 0) {
                    url += `&district=${selectedDistricts.map(d => encodeURIComponent(d)).join(',')}`;
                }

                // Показываем индикатор загрузки только если список открыт или виден
                const streetInput = document.getElementById('street-input');
                if (streetInput && streetInput.classList.contains('active')) {
                    streetList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Загрузка...</div>';
                }

                return fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        streetList.innerHTML = '';

                        if (data.streets && data.streets.length > 0) {
                            data.streets.forEach(street => {
                                // Проверяем, была ли эта улица выбрана ранее
                                const wasSelected = currentSelectedStreets.includes(street);
                                const item = document.createElement('label');
                                item.className = 'custom-dropdown-item';
                                item.innerHTML = `
                                <input type="checkbox" name="street" value="${street}" 
                                       class="street-checkbox" data-street="${street}" ${wasSelected ? 'checked' : ''}>
                                <span>${street}</span>
                            `;
                                streetList.appendChild(item);
                            });

                            // Перепривязываем обработчики для новых чекбоксов
                            document.querySelectorAll('.street-checkbox').forEach(checkbox => {
                                // Удаляем старые обработчики
                                const newCheckbox = checkbox.cloneNode(true);
                                if (checkbox.parentNode) {
                                    checkbox.parentNode.replaceChild(newCheckbox, checkbox);
                                    newCheckbox.addEventListener('change', function () {
                                        updateStreetHidden();
                                        window.resetPageAndFetch();
                                    });
                                }
                            });

                            // Обновляем скрытое поле, оставляя только те улицы, которые есть в новом списке
                            const validSelectedStreets = currentSelectedStreets.filter(s =>
                                data.streets.includes(s)
                            );
                            if (streetHidden) {
                                streetHidden.value = validSelectedStreets.join(',');
                            }
                            window.updateStreetText();

                            // Запускаем поиск после обновления списка улиц
                            window.resetPageAndFetch();
                        } else {
                            streetList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Улицы не найдены</div>';
                            if (streetHidden) {
                                streetHidden.value = '';
                            }
                            window.updateStreetText();
                            // Запускаем поиск даже если улиц нет
                            window.resetPageAndFetch();
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки улиц:', error);
                        streetList.innerHTML = '<div style="padding: 20px; text-align: center; color: #e74c3c;">Ошибка загрузки</div>';
                    });
            }

            // Функция обновления скрытого поля районов
            function updateDistrictHidden() {
                const districtHidden = document.getElementById('district-hidden');
                const checked = Array.from(document.querySelectorAll('.district-checkbox:checked'))
                    .map(cb => cb.value);
                if (districtHidden) {
                    districtHidden.value = checked.join(',');
                }
                window.updateDistrictText();

                // Загружаем улицы для выбранных районов
                const checkedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);
                if (checkedCities.length > 0) {
                    loadStreetsForDistricts(checked);
                }
            }

            // Функция обновления скрытого поля улиц
            function updateStreetHidden() {
                const streetHidden = document.getElementById('street-hidden');
                const checked = Array.from(document.querySelectorAll('.street-checkbox:checked'))
                    .map(cb => cb.value);
                if (streetHidden) {
                    streetHidden.value = checked.join(',');
                }
                window.updateStreetText();
            }

            // Инициализация текста при загрузке
            // Сначала инициализируем город из скрытого поля, если он есть
            if (cityHidden && cityHidden.value) {
                const selectedCity = cityHidden.value.split(',')[0].trim(); // Берем первый город, если несколько
                if (selectedCity) {
                    const cityCheckbox = document.querySelector(`.city-checkbox[value="${selectedCity}"]`);
                    if (cityCheckbox) {
                        cityCheckbox.checked = true;
                    }
                }
            }
            // Обновляем текст после инициализации
            window.updateCityText();
            window.updateDistrictText();
            window.updateStreetText();
            window.updateDeliveryQuarterText();

            // Функция для вычисления позиции выпадающего списка
            function updateDropdownPosition(input, list) {
                if (!input || !list) return;
                const rect = input.getBoundingClientRect();
                list.style.top = (rect.bottom + 4) + 'px';
                list.style.left = rect.left + 'px';
                list.style.width = rect.width + 'px';
            }

            // Функция для перемещения списка в body при открытии
            function moveDropdownToBody(list, input) {
                if (!list || !input) return;
                // Если список уже в body, не перемещаем
                if (list.parentElement === document.body) return;

                // Сохраняем оригинального родителя
                if (!list.dataset.originalParent) {
                    // Определяем правильный родитель по ID списка
                    let defaultParent = 'district-group';
                    if (list.id === 'city-list') {
                        defaultParent = 'city-group';
                    } else if (list.id === 'street-list') {
                        defaultParent = 'street-group';
                    }
                    list.dataset.originalParent = list.parentElement.id || defaultParent;
                }

                // Перемещаем в body
                document.body.appendChild(list);
                updateDropdownPosition(input, list);
            }

            // Функция для возврата списка на место при закрытии
            function returnDropdownToOriginal(list) {
                if (!list || !list.dataset.originalParent) return;
                const originalParent = document.getElementById(list.dataset.originalParent) ||
                    document.querySelector('.filter-group');
                if (originalParent && list.parentElement === document.body) {
                    originalParent.appendChild(list);
                }
            }

            // Обработка открытия/закрытия выпадающего списка города
            if (cityInput && cityList) {
                cityInput.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isActive = cityInput.classList.contains('active');

                    // Закрываем все выпадающие списки
                    if (districtInput) districtInput.classList.remove('active');
                    if (districtList) {
                        districtList.classList.remove('active');
                        returnDropdownToOriginal(districtList);
                    }
                    if (streetInput) streetInput.classList.remove('active');
                    if (streetList) {
                        streetList.classList.remove('active');
                        returnDropdownToOriginal(streetList);
                    }
                    if (deliveryQuarterModal) {
                        deliveryQuarterModal.classList.remove('active');
                    }

                    if (isActive) {
                        cityInput.classList.remove('active');
                        cityList.classList.remove('active');
                        returnDropdownToOriginal(cityList);
                    } else {
                        cityInput.classList.add('active');
                        cityList.classList.add('active');
                        // Перемещаем в body и вычисляем позицию
                        moveDropdownToBody(cityList, cityInput);
                    }
                });
            }

            // Новые модальные окна реализованы ниже

            // Обработка открытия/закрытия выпадающего списка районов
            if (districtInput && districtList) {
                districtInput.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isActive = districtInput.classList.contains('active');

                    // Закрываем все выпадающие списки
                    if (cityInput) cityInput.classList.remove('active');
                    if (cityList) {
                        cityList.classList.remove('active');
                        returnDropdownToOriginal(cityList);
                    }
                    if (streetInput) streetInput.classList.remove('active');
                    if (streetList) {
                        streetList.classList.remove('active');
                        returnDropdownToOriginal(streetList);
                    }

                    if (isActive) {
                        districtInput.classList.remove('active');
                        districtList.classList.remove('active');
                        returnDropdownToOriginal(districtList);
                    } else {
                        districtInput.classList.add('active');
                        districtList.classList.add('active');
                        // Перемещаем в body и вычисляем позицию
                        moveDropdownToBody(districtList, districtInput);
                    }
                });
            }

            // Обработка открытия/закрытия выпадающего списка улиц
            if (streetInput && streetList) {
                streetInput.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isActive = streetInput.classList.contains('active');

                    // Закрываем все выпадающие списки
                    if (cityInput) cityInput.classList.remove('active');
                    if (cityList) {
                        cityList.classList.remove('active');
                        returnDropdownToOriginal(cityList);
                    }
                    if (districtInput) districtInput.classList.remove('active');
                    if (districtList) {
                        districtList.classList.remove('active');
                        returnDropdownToOriginal(districtList);
                    }
                    if (deliveryQuarterModal) {
                        deliveryQuarterModal.classList.remove('active');
                    }

                    if (isActive) {
                        streetInput.classList.remove('active');
                        streetList.classList.remove('active');
                        returnDropdownToOriginal(streetList);
                    } else {
                        streetInput.classList.add('active');
                        streetList.classList.add('active');
                        // Перемещаем в body и вычисляем позицию
                        moveDropdownToBody(streetList, streetInput);
                    }
                });
            }

            // Обновляем позицию при скролле и изменении размера окна
            window.addEventListener('scroll', function () {
                if (cityList && cityList.classList.contains('active') && cityInput) {
                    updateDropdownPosition(cityInput, cityList);
                }
                if (districtList && districtList.classList.contains('active') && districtInput) {
                    updateDropdownPosition(districtInput, districtList);
                }
                if (streetList && streetList.classList.contains('active') && streetInput) {
                    updateDropdownPosition(streetInput, streetList);
                }
            }, true);

            window.addEventListener('resize', function () {
                if (cityList && cityList.classList.contains('active') && cityInput) {
                    updateDropdownPosition(cityInput, cityList);
                }
                if (districtList && districtList.classList.contains('active') && districtInput) {
                    updateDropdownPosition(districtInput, districtList);
                }
                if (streetList && streetList.classList.contains('active') && streetInput) {
                    updateDropdownPosition(streetInput, streetList);
                }
            });

            // Обработка открытия модального окна срока сдачи
            if (deliveryQuarterInput && deliveryQuarterModal) {
                deliveryQuarterInput.addEventListener('click', function (e) {
                    e.stopPropagation();
                    deliveryQuarterModal.classList.add('active');
                });
            }

            // Закрытие модального окна
            function closeDeliveryQuarterModal() {
                if (deliveryQuarterModal) {
                    deliveryQuarterModal.classList.remove('active');
                }
            }

            if (deliveryQuarterModalClose) {
                deliveryQuarterModalClose.addEventListener('click', closeDeliveryQuarterModal);
            }

            if (deliveryQuarterModalCancel) {
                deliveryQuarterModalCancel.addEventListener('click', closeDeliveryQuarterModal);
            }

            // Закрытие при клике на backdrop
            const deliveryQuarterModalBackdrop = deliveryQuarterModal ? deliveryQuarterModal.querySelector('.delivery-quarter-modal-backdrop') : null;
            if (deliveryQuarterModalBackdrop) {
                deliveryQuarterModalBackdrop.addEventListener('click', closeDeliveryQuarterModal);
            }

            if (deliveryQuarterModal) {
                const deliveryQuarterBackdrop = deliveryQuarterModal.querySelector('.filter-modal-backdrop');

                function syncDeliveryQuarterModal() {
                    const selectedValues = deliveryQuarterHidden && deliveryQuarterHidden.value
                        ? deliveryQuarterHidden.value.split(',').map(v => v.trim()).filter(Boolean)
                        : [];
                    deliveryQuarterModalCheckboxes.forEach(cb => {
                        cb.checked = selectedValues.includes(cb.value);
                    });
                }

                function closeDeliveryQuarterModal() {
                    deliveryQuarterModal.classList.remove('active');
                }

                deliveryQuarterInput?.addEventListener('click', function (e) {
                    e.stopPropagation();
                    syncDeliveryQuarterModal();
                    deliveryQuarterModal.classList.add('active');
                });

                deliveryQuarterModalClose?.addEventListener('click', closeDeliveryQuarterModal);
                deliveryQuarterModalCancel?.addEventListener('click', closeDeliveryQuarterModal);
                deliveryQuarterBackdrop?.addEventListener('click', closeDeliveryQuarterModal);

                deliveryQuarterModalReset?.addEventListener('click', function () {
                    deliveryQuarterModalCheckboxes.forEach(cb => cb.checked = false);
                });

                deliveryQuarterModalApply?.addEventListener('click', function () {
                    const selected = Array.from(deliveryQuarterModalCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);
                    deliveryQuarterHidden.value = selected.join(',');
                    window.updateDeliveryQuarterText();
                    closeDeliveryQuarterModal();
                    window.resetPageAndFetch();
                });
            }

            // Закрытие выпадающих списков при клике вне их
            // Старые выпадающие списки заменены модальными окнами; глобальный обработчик кликов больше не требуется.

            // Также закрываем при скролле страницы (опционально, можно убрать если нужно)
            // window.addEventListener('scroll', function() {
            //     districtInput.classList.remove('active');
            //     districtList.classList.remove('active');
            //     streetInput.classList.remove('active');
            //     streetList.classList.remove('active');
            // }, true);

            // Обработка изменения чекбоксов районов
            document.querySelectorAll('.district-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateDistrictHidden();
                    // Не запускаем fetchData сразу, так как загрузка улиц может занять время
                    // Запустим после обновления списка улиц
                });
            });

            // Обработка изменения чекбоксов улиц
            document.querySelectorAll('.street-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    updateStreetHidden();
                    window.resetPageAndFetch();
                });
            });

            // Инициализация выбранных значений из скрытых полей
            const urlParams = new URLSearchParams(window.location.search);
            const urlCity = urlParams.get('city') || (cityHidden ? cityHidden.value : '');
            const urlDistricts = urlParams.get('district') || (districtHidden ? districtHidden.value : '');
            const urlStreets = urlParams.get('street') || (streetHidden ? streetHidden.value : '');
            const urlDeliveryQuarter = urlParams.get('delivery_quarter') || (deliveryQuarterHidden ? deliveryQuarterHidden.value : '');
            const selectedDistrictsFromUrl = urlDistricts ? urlDistricts.split(',').map(d => d.trim()).filter(d => d) : [];
            const selectedStreetsFromUrl = urlStreets ? urlStreets.split(',').map(s => s.trim()).filter(s => s) : [];

            // Инициализация города из URL или скрытого поля
            if (urlCity) {
                const cityValue = urlCity.split(',')[0].trim();
                const cityCheckbox = document.querySelector(`.city-checkbox[value="${cityValue}"]`);
                if (cityCheckbox) {
                    cityCheckbox.checked = true;
                    if (cityHidden) {
                        cityHidden.value = cityValue;
                    }
                }
            }

            // Инициализация срока сдачи из URL или скрытого поля
            if (urlDeliveryQuarter) {
                const quarterValue = urlDeliveryQuarter.split(',')[0].trim();
                const quarterCheckbox = document.querySelector(`.delivery-quarter-modal-checkbox[value="${quarterValue}"]`);
                if (quarterCheckbox) {
                    quarterCheckbox.checked = true;
                    if (deliveryQuarterHidden) {
                        deliveryQuarterHidden.value = quarterValue;
                    }
                }
            }

            // Инициализация: загружаем районы и улицы, если город уже выбран
            const checkedCities = Array.from(document.querySelectorAll('.city-checkbox:checked')).map(cb => cb.value);
            if (checkedCities.length > 0) {
                const selectedCity = checkedCities[0];
                const selectedDistricts = selectedDistrictsFromUrl.length > 0 ? selectedDistrictsFromUrl : (districtHidden ? districtHidden.value.split(',').filter(d => d) : []);

                // Загружаем районы
                fetch(`/api/districts/?city=${encodeURIComponent(selectedCity)}&dataset=${encodeURIComponent(datasetType)}`)
                    .then(response => response.json())
                    .then(data => {
                        districtList.innerHTML = '';
                        data.districts.forEach(district => {
                            const isChecked = selectedDistricts.includes(district);
                            const item = document.createElement('label');
                            item.className = 'custom-dropdown-item';
                            item.innerHTML = `
                            <input type="checkbox" name="district" value="${district}" 
                                   class="district-checkbox" data-district="${district}" ${isChecked ? 'checked' : ''}>
                            <span>${district}</span>
                        `;
                            districtList.appendChild(item);
                        });
                        // Обновляем скрытое поле и текст
                        if (selectedDistricts.length > 0 && districtHidden) {
                            districtHidden.value = selectedDistricts.join(',');
                        }
                        window.updateDistrictText();
                        // Перепривязываем обработчики
                        document.querySelectorAll('.district-checkbox').forEach(checkbox => {
                            checkbox.addEventListener('change', function () {
                                updateDistrictHidden();
                            });
                        });
                        districtGroup.classList.remove('hidden');
                    });

                // Загружаем улицы для выбранных районов (или все, если районы не выбраны)
                loadStreetsForDistricts(selectedDistricts);
                streetGroup.classList.remove('hidden');
            }

            // Обработка изменения города уже добавлена выше в обработчике чекбоксов
            // Удаляем старый обработчик для select, так как теперь используем кастомный выпадающий список


            const isSecondary = '{{ dataset_type }}' === 'secondary';

            // Обработка кнопок фильтра количества комнат и скидок
            const filterBtns = document.querySelectorAll('.filter-btn');
            const roomsHidden = document.getElementById('rooms-hidden');

            // Обработка чекбоксов комнат
            const roomCheckboxes = document.querySelectorAll('.room-checkbox');
            if (roomCheckboxes.length > 0) {
                function updateRoomsHidden() {
                    const checked = Array.from(roomCheckboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);
                    if (roomsHidden) {
                        roomsHidden.value = checked.join(',');
                    }
                }

                roomCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function () {
                        updateRoomsHidden();
                        window.resetPageAndFetch();
                    });
                });

                // Инициализация состояния чекбоксов комнат при загрузке страницы
                if (roomsHidden && roomsHidden.value) {
                    const selectedRooms = roomsHidden.value.split(',').filter(v => v.trim() !== '');
                    roomCheckboxes.forEach(checkbox => {
                        if (selectedRooms.includes(checkbox.value)) {
                            checkbox.checked = true;
                        }
                    });
                }
            }

            filterBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    // Обработка переключателя новостройки/вторичка
                    const url = this.getAttribute('data-url');
                    if (url) {
                        window.location.href = url;
                        return;
                    }

                    // Пропускаем обработку для переключателя ЖК/Квартиры, так как у него свой обработчик
                    if (this.classList.contains('content-toggle-btn-segmented')) {
                        return;
                    }

                    // Пропускаем обработку для переключателя "Специальные предложения", так как у него свой обработчик
                    if (this.classList.contains('offers-toggle-btn')) {
                        return;
                    }

                    const parentGroup = this.closest('.filter-group');
                    const groupBtns = parentGroup.querySelectorAll('.filter-btn');
                    const hiddenField = parentGroup.querySelector('input[type="hidden"]');
                    const isRoomsFilter = hiddenField && hiddenField.id === 'rooms-hidden';

                    // Пропускаем обработку для фильтра комнат, так как теперь используются чекбоксы
                    if (isRoomsFilter) {
                        return;
                    }

                    const clickedValue = this.getAttribute('data-value');
                    const isCurrentlyActive = this.getAttribute('data-active') === 'true';

                    if (clickedValue === '') {
                        // Кнопка "Любое" - сбрасываем все выборы
                        groupBtns.forEach(b => {
                            b.setAttribute('data-active', 'false');
                            b.classList.remove('active');
                        });
                        this.setAttribute('data-active', 'true');
                        this.classList.add('active');
                        if (hiddenField) {
                            hiddenField.value = '';
                        }
                    } else {
                        // Обычная кнопка - toggle
                        if (isCurrentlyActive) {
                            // Убираем из выбора
                            this.setAttribute('data-active', 'false');
                            this.classList.remove('active');
                            if (hiddenField) {
                                hiddenField.value = '';
                            }
                        } else {
                            // Добавляем в выбор
                            this.setAttribute('data-active', 'true');
                            this.classList.add('active');
                            // Убираем активность с кнопки "Любое"
                            groupBtns.forEach(b => {
                                if (b.getAttribute('data-value') === '') {
                                    b.setAttribute('data-active', 'false');
                                    b.classList.remove('active');
                                }
                            });
                            if (hiddenField) {
                                hiddenField.value = clickedValue;
                            }
                        }
                    }

                    // Мгновенный запуск поиска без перезагрузки страницы
                    const form = document.getElementById('filters-form');
                    if (form) {
                        form.dispatchEvent(new Event('submit', {cancelable: true}));
                    }
                });
            });

            // Обработка сортировки через radio buttons
            const sortingRadios = document.querySelectorAll('.sorting-radio');
            const sortHidden = document.getElementById('sort-hidden');

            if (sortingRadios.length > 0 && sortHidden) {
                sortingRadios.forEach(radio => {
                    radio.addEventListener('change', function () {
                        if (this.checked) {
                            sortHidden.value = this.value;
                            window.resetPageAndFetch();
                        }
                    });
                });
            }

            // Обработка переключателя "Специальные предложения"
            const offersToggleBtns = document.querySelectorAll('.offers-toggle-btn');
            const hasOffersHidden = document.getElementById('has_offers-hidden');

            if (offersToggleBtns.length > 0 && hasOffersHidden) {
                offersToggleBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        const value = this.getAttribute('data-value');

                        // Обновляем скрытое поле
                        hasOffersHidden.value = value;

                        // Обновляем активные кнопки
                        offersToggleBtns.forEach(b => {
                            const bValue = b.getAttribute('data-value');
                            if (bValue === value) {
                                b.setAttribute('data-active', 'true');
                            } else {
                                b.setAttribute('data-active', 'false');
                            }
                        });

                        // Перезагружаем данные
                        window.resetPageAndFetch();
                    });
                });
            }

            // Обработка переключателя "ЖК / Квартиры"
            if (!isSecondary) {
                const contentToggleBtns = document.querySelectorAll('.content-toggle-btn-segmented[data-content]');
                const contentModeHidden = document.getElementById('content-mode-hidden');
                const floorFilterGroup = document.getElementById('floor-filter-group');
                const areaFilterGroup = document.getElementById('area-filter-group');
                const roomsFilterGroup = document.getElementById('rooms-filter-group');
                if (contentToggleBtns.length > 0 && contentModeHidden) {
                    const applyContentMode = (mode) => {
                        contentModeHidden.value = mode;
                        localStorage.setItem('catalog_content_mode', mode);
                        contentToggleBtns.forEach(b => {
                            const bMode = b.getAttribute('data-content');
                            b.setAttribute('data-active', bMode === mode ? 'true' : 'false');
                        });
                        // Показываем фильтры этажей, площади и комнат только в режиме квартир
                        if (floorFilterGroup) {
                            floorFilterGroup.style.display = (mode === 'apartments') ? 'block' : 'none';
                        }
                        if (areaFilterGroup) {
                            areaFilterGroup.style.display = (mode === 'apartments') ? 'block' : 'none';
                        }
                        if (roomsFilterGroup) {
                            roomsFilterGroup.style.display = (mode === 'apartments') ? 'block' : 'none';
                        }
                    };

                    const initialMode = contentModeHidden.value || localStorage.getItem('catalog_content_mode') || 'complexes';
                    applyContentMode(initialMode);

                    contentToggleBtns.forEach(btn => {
                        btn.addEventListener('click', function () {
                            const mode = this.getAttribute('data-content');
                            if (!mode) return;
                            applyContentMode(mode);
                            if (typeof window.resetPageAndFetch === 'function') {
                                window.resetPageAndFetch();
                            }
                        });
                    });
                }
            }

            // Обработка кликов по display полям для ручного ввода
            document.querySelectorAll('.range-display').forEach(display => {
                display.addEventListener('click', function () {
                    const container = this.closest('.range-container');
                    const fromDisplay = container.querySelector('.range-value strong:first-of-type');
                    const toDisplay = container.querySelector('.range-value strong:last-of-type');

                    // Создаем временные input поля для ручного ввода
                    const fromInput = document.createElement('input');
                    fromInput.type = 'number';
                    fromInput.className = 'temp-input';
                    fromInput.value = fromDisplay ? fromDisplay.textContent : '';
                    fromInput.style.cssText = 'width: 50px; padding: 3px; border: 1px solid #0066cc; border-radius: 3px; margin-right: 6px; font-size: 12px;';

                    const toInput = document.createElement('input');
                    toInput.type = 'number';
                    toInput.className = 'temp-input';
                    toInput.value = toDisplay ? toDisplay.textContent : '';
                    toInput.style.cssText = 'width: 50px; padding: 3px; border: 1px solid #0066cc; border-radius: 3px; margin-left: 6px; font-size: 12px;';

                    // Заменяем display на input поля
                    if (fromDisplay && fromDisplay.parentNode) {
                        fromDisplay.parentNode.replaceChild(fromInput, fromDisplay);
                    }
                    if (toDisplay && toDisplay.parentNode) {
                        toDisplay.parentNode.replaceChild(toInput, toDisplay);
                    }

                    // Фокус на первое поле
                    fromInput.focus();

                    // Обработка завершения ввода
                    function finishInput() {
                        const fromValue = parseFloat(fromInput.value) || 0;
                        const toValue = parseFloat(toInput.value) || 0;

                        // Восстанавливаем display
                        if (fromDisplay) {
                            fromDisplay.textContent = fromValue;
                        }
                        if (toDisplay) {
                            toDisplay.textContent = toValue;
                        }

                        if (fromInput && fromInput.parentNode && fromDisplay) {
                            fromInput.parentNode.replaceChild(fromDisplay, fromInput);
                        }
                        if (toInput && toInput.parentNode && toDisplay) {
                            toInput.parentNode.replaceChild(toDisplay, toInput);
                        }

                        // Обновляем slider значения
                        const fromSlider = container.querySelector('input[type="range"]:first-of-type');
                        const toSlider = container.querySelector('input[type="range"]:last-of-type');
                        const fromHidden = container.querySelector('input[type="hidden"]:first-of-type');
                        const toHidden = container.querySelector('input[type="hidden"]:last-of-type');

                        fromSlider.value = fromValue;
                        toSlider.value = toValue;
                        fromHidden.value = fromValue;
                        toHidden.value = toValue;

                        // Обновляем fill
                        updateRangeFill(fromSlider, toSlider, container.querySelector('.range-fill'));
                    }

                    // Обработчики событий
                    fromInput.addEventListener('blur', finishInput);
                    toInput.addEventListener('blur', finishInput);
                    fromInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') finishInput();
                    });
                    toInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') finishInput();
                    });
                });
            });
        });

        function initRangeSlider(fromSliderId, toSliderId, fromDisplayId, toDisplayId, fromHiddenId, toHiddenId, fillId) {
            const fromSlider = document.getElementById(fromSliderId);
            const toSlider = document.getElementById(toSliderId);
            const fromDisplay = document.getElementById(fromDisplayId);
            const toDisplay = document.getElementById(toDisplayId);
            const fromHidden = document.getElementById(fromHiddenId);
            const toHidden = document.getElementById(toHiddenId);
            const fill = document.querySelector('.' + fillId);

            if (!fromSlider || !toSlider) return;

            // Устанавливаем начальные значения (пустые значения не применяем как фильтр)
            if (fromHidden.value !== '' && toHidden.value !== '') {
                fromSlider.value = fromHidden.value;
                toSlider.value = toHidden.value;
            } else {
                fromSlider.value = fromSlider.min;
                toSlider.value = toSlider.max;
            }
            fromDisplay.textContent = fromSlider.value;
            toDisplay.textContent = toSlider.value;

            // Обновляем fill при загрузке
            updateRangeFill(fromSlider, toSlider, fill);

            // Обработчики событий
            fromSlider.addEventListener('input', function () {
                const fromValue = parseInt(this.value);
                const toValue = parseInt(toSlider.value);

                if (fromValue > toValue) {
                    this.value = toValue;
                    fromValue = toValue;
                }

                fromDisplay.textContent = fromValue;
                fromHidden.value = fromValue;
                updateRangeFill(fromSlider, toSlider, fill);

                // Автоматически выполняем поиск при изменении слайдера
                window.resetPageAndFetch();
            });

            toSlider.addEventListener('input', function () {
                const fromValue = parseInt(fromSlider.value);
                const toValue = parseInt(this.value);

                if (toValue < fromValue) {
                    this.value = fromValue;
                    toValue = fromValue;
                }

                toDisplay.textContent = toValue;
                toHidden.value = toValue;
                updateRangeFill(fromSlider, toSlider, fill);

                // Автоматически выполняем поиск при изменении слайдера
                window.resetPageAndFetch();
            });
        }

        function updateRangeFill(fromSlider, toSlider, fill) {
            if (!fill) return;

            const fromValue = parseInt(fromSlider.value);
            const toValue = parseInt(toSlider.value);
            const min = parseInt(fromSlider.min);
            const max = parseInt(fromSlider.max);

            const fromPercent = ((fromValue - min) / (max - min)) * 100;
            const toPercent = ((toValue - min) / (max - min)) * 100;

            // Учитываем отступы в 10px с каждой стороны
            const adjustedFromPercent = fromPercent * 0.8 + 10; // 80% от ширины + 10px отступ
            const adjustedToPercent = toPercent * 0.8 + 10;

            fill.style.left = adjustedFromPercent + '%';
            fill.style.width = (adjustedToPercent - adjustedFromPercent) + '%';
        }


        // Обработка чипов категорий вторички (выбор без авто-перехода)
        (function () {
            const chipBtns = document.querySelectorAll('.filter-chip-btn');
            const stypeHidden = document.getElementById('stype-hidden');
            if (!chipBtns.length || !stypeHidden) return;
            chipBtns.forEach(btn => {
                btn.addEventListener('click', function () {
                    chipBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    stypeHidden.value = this.getAttribute('data-value');
                    // Мгновенный запуск поиска
                    const form = document.getElementById('filters-form');
                    if (form) form.dispatchEvent(new Event('submit', {cancelable: true}));
                });
                // Инициализация активного состояния из скрытого поля
                if (btn.getAttribute('data-value') === (stypeHidden.value || '')) {
                    btn.classList.add('active');
                }
            });
        })();

        // Эффект тени для sticky шапки при прокрутке
        window.addEventListener('scroll', function () {
            const header = document.querySelector('.main-header');
            if (window.scrollY > 10) {
                header.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            } else {
                header.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.05)';
            }
        });


        // Обработчики для избранного
        function toggleComplexFavoriteHandler(complexId, button) {
            if (typeof toggleComplexFavorite === 'function') {
                const isFavorite = toggleComplexFavorite(complexId);
                if (typeof updateFavoriteIcon === 'function') {
                    updateFavoriteIcon(button, isFavorite);
                }

                // Показываем уведомление
                if (isFavorite) {
                    showFavoriteNotification('Добавлено в избранное');
                } else {
                    showFavoriteNotification('Удалено из избранного');
                }
            }
        }

        // Глобальная функция для обработки избранного (ЖК и Квартиры)
        window.toggleFavorite = function (id, type, button) {
            if (!id || !type || !button) return;

            if (type === 'apartment') {
                // ID квартиры в формате: complex_id_apt_apartment_id
                // Нужно извлечь complex_id и apartment_id
                const parts = id.split('_apt_');
                if (parts.length === 2) {
                    const complexId = parts[0];
                    const apartmentId = parts[1];
                    // Используем глобальную функцию из favorites.js
                    if (typeof window.toggleApartmentFavoriteHandler === 'function') {
                        window.toggleApartmentFavoriteHandler(complexId, apartmentId, button);
                    } else if (typeof toggleApartmentFavorite === 'function') {
                        // Fallback: используем напрямую функции из favorites.js
                        const isFavorite = toggleApartmentFavorite(complexId, apartmentId);
                        if (typeof updateFavoriteIcon === 'function') {
                            updateFavoriteIcon(button, isFavorite);
                        }
                        if (isFavorite) {
                            showFavoriteNotification('Квартира добавлена в избранное');
                        } else {
                            showFavoriteNotification('Квартира удалена из избранного');
                        }
                    }
                }
            } else if (type === 'complex') {
                // Для ЖК просто передаем ID
                if (typeof window.toggleComplexFavoriteHandler === 'function') {
                    window.toggleComplexFavoriteHandler(id, button);
                } else if (typeof toggleComplexFavorite === 'function') {
                    // Fallback: используем напрямую функции из favorites.js
                    const isFavorite = toggleComplexFavorite(id);
                    if (typeof updateFavoriteIcon === 'function') {
                        updateFavoriteIcon(button, isFavorite);
                    }
                    if (isFavorite) {
                        showFavoriteNotification('Добавлено в избранное');
                    } else {
                        showFavoriteNotification('Удалено из избранного');
                    }
                }
            }
        }

        // Функция показа уведомления об избранном (глобальная)
        window.showFavoriteNotification = function (message) {
            // Создаем временное уведомление
            const notification = document.createElement('div');
            notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--c21-gold);
    color: var(--c21-dark);
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 10000;
    font-weight: 600;
    animation: slideInRight 0.3s ease;
  `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        };

        // Добавляем анимации для уведомлений
        if (!document.getElementById('favorite-notification-styles')) {
            const style = document.createElement('style');
            style.id = 'favorite-notification-styles';
            style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
  `;
            document.head.appendChild(style);
        }

        // Инициализация карусели изображений при загрузке страницы
        document.addEventListener('DOMContentLoaded', function () {
            initImageCarousel();
        });

        // AJAX-загрузка без изменения URL
        (function () {
            console.log('🔴🔴🔴 ВХОД В IIFE - AJAX блок');
            console.log('🔴 Текущая строка после входа в IIFE');
            const form = document.getElementById('filters-form');
            const ajaxGrid = document.getElementById('catalog-grid');
            const isSecondaryAjax = '{{ dataset_type }}' === 'secondary';
            const isSecondary = isSecondaryAjax; // ← ДОБАВИТЬ СЮДА
            const apiUrl = isSecondaryAjax ? '/api/secondary/' : '/api/catalog/';
            const mapElAjax = document.getElementById('map');
            let map, markersLayer;
            let activeController = null;
            let latestRequestId = 0;

            // View toggle - инициализация перенесена в отдельную функцию
            const savedView = localStorage.getItem('catalog_view') || 'list';

            // Отключаем кнопку карты для вторичной недвижимости
            if (isSecondary) {
                const mapBtn = document.querySelector('.view-btn[data-view="map"]');
                if (mapBtn) {
                    mapBtn.disabled = true;
                    mapBtn.style.opacity = '0.5';
                    mapBtn.style.cursor = 'not-allowed';
                    mapBtn.title = 'Карта недоступна для вторичной недвижимости';
                }
            }

            // Функция инициализации кнопок view toggle
            function initViewToggleButtons() {
                const mapBtn = document.querySelector('.view-btn[data-view="map"]');
                const listBtn = document.querySelector('.view-btn[data-view="list"]');
                
                if (!mapBtn || !listBtn) {
                    console.log('View buttons not found');
                    return;
                }
                
                // Клонируем кнопки чтобы удалить все старые обработчики
                const newMapBtn = mapBtn.cloneNode(true);
                const newListBtn = listBtn.cloneNode(true);
                mapBtn.parentNode.replaceChild(newMapBtn, mapBtn);
                listBtn.parentNode.replaceChild(newListBtn, listBtn);
                
                // Добавляем обработчик на кнопку "Картой"
                newMapBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (isSecondary) return;
                    
                    if (typeof window.setView === 'function') {
                        window.setView('map');
                    }
                });
                
                // Добавляем обработчик на кнопку "Списком"
                newListBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (typeof window.setView === 'function') {
                        window.setView('list');
                    }
                });
                
                console.log('View toggle buttons initialized');
            }
            
            // Инициализируем кнопки после полной загрузки DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initViewToggleButtons);
            } else {
                // DOM уже загружен, используем небольшую задержку чтобы быть последними
                setTimeout(initViewToggleButtons, 100);
            }
            // Инициализация вида по умолчанию
            // Принудительно устанавливаем вид "списком" для вторичной недвижимости
            if (isSecondary) {
                setView('list');
            } else {
                // По умолчанию показываем карту для новостроек
                setView('map');
                localStorage.setItem('catalog_view', 'map');
            }


            // Инициализация кнопок количества элементов - пустая заглушка
            // Реальная инициализация происходит ниже через делегирование событий

            if (form && !form.dataset.ajaxBound) {
                form.addEventListener('submit', function (e) {
                    e.preventDefault();
                    window.resetPageAndFetch();
                });
                form.dataset.ajaxBound = '1';
            }

            // Обработка нажатия на кнопку "Поиск" - закрываем фильтр только при явном клике
            const searchButton = form ? form.querySelector('button[type="submit"]') : null;
            if (searchButton) {
                searchButton.addEventListener('click', function (e) {
                    // Закрываем фильтр только при явном нажатии на кнопку "Поиск" (мобильная и планшетная версия)
                    if (window.innerWidth <= 991) {
                        setTimeout(function () {
                            const sheet = document.getElementById('filters-sheet');
                            const backdrop = document.getElementById('filters-backdrop');
                            if (sheet) sheet.classList.remove('open');
                            if (backdrop) backdrop.classList.remove('open');
                            document.body.classList.remove('filter-open');
                        }, 100);
                    }
                });
            }
            const urlParams = new URLSearchParams(window.location.search);

            // Анимация появления фильтров
            const filterGroups = document.querySelectorAll('.filter-group');
            filterGroups.forEach((group, index) => {
                group.style.opacity = '0';
                group.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    group.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                    group.style.opacity = '1';
                    group.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Анимация для кнопок фильтра
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('mouseenter', function () {
                    this.style.transform = 'translateY(-3px) scale(1.02)';
                });

                btn.addEventListener('mouseleave', function () {
                    if (!this.getAttribute('data-active') === 'true') {
                        this.style.transform = 'translateY(0) scale(1)';
                    }
                });
            });

            // Анимация для select элементов
            const filterSelects = document.querySelectorAll('.filter-select');
            filterSelects.forEach(select => {
                select.addEventListener('focus', function () {
                    this.parentElement.style.transform = 'translateY(-2px)';
                });

                select.addEventListener('blur', function () {
                    this.parentElement.style.transform = 'translateY(0)';
                });

                // Автоматически выполняем поиск при изменении select
                select.addEventListener('change', function () {
                    // Сбрасываем страницу на 1 при изменении фильтров
                    window.resetPageAndFetch();
                });
            });

            // Анимация для range sliders
            const rangeSliders = document.querySelectorAll('.range-slider-input');
            rangeSliders.forEach(slider => {
                slider.addEventListener('input', function () {
                    const container = this.closest('.range-container');
                    container.style.transform = 'translateY(-1px) scale(1.01)';

                    setTimeout(() => {
                        container.style.transform = 'translateY(0) scale(1)';
                    }, 150);
                });
            });


            // Анимация для секции фильтров при скролле
            const filtersSection = document.querySelector('.filters-section');
            if (filtersSection) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.opacity = '1';
                            entry.target.style.transform = 'translateY(0)';
                        }
                    });
                }, {threshold: 0.1});

                filtersSection.style.opacity = '0';
                filtersSection.style.transform = 'translateY(30px)';
                filtersSection.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';

                observer.observe(filtersSection);
            }
            // Кнопка "Сбросить" - инициализация вынесена в конец файла

            // Инициализация города Уфа по умолчанию
            (function initDefaultCity() {
                const cityHidden = document.getElementById('city-hidden');
                const cityText = document.getElementById('city-text');
                // Если город не выбран (пустое значение), устанавливаем Уфу по умолчанию
                if (cityHidden && !cityHidden.value) {
                    cityHidden.value = 'Уфа';
                    if (cityText) cityText.textContent = 'Уфа';
                    // Также отмечаем чекбокс в модальном окне города
                    const cityCheckbox = document.querySelector('.city-modal-checkbox[value="Уфа"]');
                    if (cityCheckbox) cityCheckbox.checked = true;
                }
            })();

            // Принудительная инициализация для всех типов
            const isSecondaryInit = '{{ dataset_type }}' === 'secondary';
            const mapElInit = document.getElementById('map');
            const gridInit = document.getElementById('catalog-grid');

            if (mapElInit && gridInit) {
                if (!isSecondaryInit) {
                    // Новостройки: карта сверху, список снизу
                    mapElInit.style.display = 'block';
                    mapElInit.style.order = '1';
                    gridInit.style.display = 'block';
                    gridInit.style.order = '2';

                    // Инициализируем карту если еще не инициализирована
                    if (!window.map && typeof initMap === 'function') {
                        initMap();
                    }

                    // Загружаем данные для карты и списка
                    if (typeof fetchData === 'function') {
                        fetchData();
                    }

                    // Устанавливаем активную кнопку "Картой"
                    const mapBtn = document.querySelector('.view-btn[data-view="map"]');
                    const listBtn = document.querySelector('.view-btn[data-view="list"]');
                    if (mapBtn && listBtn) {
                        mapBtn.classList.add('active');
                        listBtn.classList.remove('active');
                    }
                } else {
                    // Вторичка: только список, карта скрыта
                    mapElInit.style.display = 'none';
                    gridInit.style.display = 'block';

                    // Загружаем данные для вторичной недвижимости
                    if (typeof fetchData === 'function') {
                        fetchData();
                    }

                    // Устанавливаем активную кнопку "Списком"
                    const mapBtn = document.querySelector('.view-btn[data-view="map"]');
                    const listBtn = document.querySelector('.view-btn[data-view="list"]');
                    if (mapBtn && listBtn) {
                        listBtn.classList.add('active');
                        mapBtn.classList.remove('active');
                    }
                }
            }
        });

        // Функции для галереи изображений
        window.changeImage = function (button, direction) {
            const gallery = button.parentElement;
            const images = gallery.querySelectorAll('.gallery-image');
            const dots = gallery.querySelectorAll('.dot');
            let currentIndex = 0;

            // Находим текущий индекс
            images.forEach((img, i) => {
                if (img.style.display === 'block') {
                    currentIndex = i;
                }
            });

            // Вычисляем новый индекс
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = images.length - 1;
            if (newIndex >= images.length) newIndex = 0;

            // Переключаем изображения
            images[currentIndex].style.display = 'none';
            images[newIndex].style.display = 'block';

            // Переключаем точки
            dots[currentIndex].classList.remove('active');
            dots[newIndex].classList.add('active');
        }

        window.setImage = function (dot, index) {
            const gallery = dot.parentElement.parentElement;
            const images = gallery.querySelectorAll('.gallery-image');
            const dots = gallery.querySelectorAll('.dot');

            // Скрываем все изображения
            images.forEach(img => img.style.display = 'none');
            // Показываем выбранное
            images[index].style.display = 'block';

            // Обновляем точки
            dots.forEach(d => d.classList.remove('active'));
            dots[index].classList.add('active');
        }

        // Обработчик для кнопки "Подобрать квартиру" - прокрутка к форме обратной связи
        // Используем делегирование событий, так как кнопки создаются динамически
        document.addEventListener('DOMContentLoaded', function () {
            console.log('🔍 Инициализация обработчика кнопки "Подобрать квартиру"');

            // Используем делегирование событий на родительском элементе
            const catalogGrid = document.getElementById('catalog-grid');

            if (!catalogGrid) {
                console.warn('⚠️ Элемент #catalog-grid не найден!');
                return;
            }

            console.log('✅ Элемент #catalog-grid найден, используем делегирование событий');

            // Обработчик на родительском элементе для всех кнопок (включая динамически созданные)
            catalogGrid.addEventListener('click', function (e) {
                // Проверяем, что клик был по кнопке с нужным классом
                const clickedButton = e.target.closest('.anchor-feedback-btn');

                if (!clickedButton) {
                    return; // Клик был не по нашей кнопке
                }

                console.log('🖱️ Клик по кнопке "Подобрать квартиру"');
                console.log('📍 Кнопка:', clickedButton);
                console.log('📍 Текст кнопки:', clickedButton.textContent.trim());

                e.preventDefault();
                e.stopPropagation();
                console.log('✅ preventDefault() и stopPropagation() выполнены');

                // Ищем форму обратной связи по ID
                const feedbackTarget = document.getElementById('feedback-title');
                console.log('🎯 Поиск элемента с id="feedback-title":', feedbackTarget);

                if (feedbackTarget) {
                    console.log('✅ Элемент feedback-title найден!');
                    console.log('📍 Позиция элемента:', {
                        top: feedbackTarget.getBoundingClientRect().top,
                        left: feedbackTarget.getBoundingClientRect().left,
                        height: feedbackTarget.offsetHeight
                    });

                    const headerOffset = 120;
                    const elementPosition = feedbackTarget.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                    console.log('📐 Расчеты:', {
                        elementPosition: elementPosition,
                        pageYOffset: window.pageYOffset,
                        headerOffset: headerOffset,
                        offsetPosition: offsetPosition
                    });

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });

                    console.log('✅ Прокрутка запущена к позиции:', offsetPosition);
                } else {
                    console.warn('⚠️ Элемент feedback-title не найден!');
                    console.log('🔍 Ищем альтернативные элементы...');

                    const alternatives = {
                        'feedback-form': document.getElementById('feedback-form'),
                        '.feedback-title': document.querySelector('.feedback-title'),
                        '.feedback-section': document.querySelector('.feedback-section'),
                        '.feedback-container': document.querySelector('.feedback-container')
                    };

                    console.log('🔍 Альтернативные элементы:', alternatives);

                    // Пробуем найти любой элемент с feedback
                    let found = null;
                    for (const [key, element] of Object.entries(alternatives)) {
                        if (element) {
                            console.log(`✅ Найден альтернативный элемент: ${key}`, element);
                            found = element;
                            break;
                        }
                    }

                    if (found) {
                        const headerOffset = 120;
                        const elementPosition = found.getBoundingClientRect().top;
                        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

                        console.log('📐 Расчеты для альтернативного элемента:', {
                            elementPosition: elementPosition,
                            offsetPosition: offsetPosition
                        });

                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });

                        console.log('✅ Прокрутка к альтернативному элементу запущена');
                    } else {
                        console.warn('⚠️ Никакие элементы формы обратной связи не найдены!');
                        console.log('📏 Прокручиваем вниз страницы...');

                        // Если формы нет на странице, прокручиваем вниз страницы
                        window.scrollTo({
                            top: document.body.scrollHeight,
                            behavior: 'smooth'
                        });

                        console.log('✅ Прокрутка вниз страницы запущена');
                    }
                }
            });

            console.log('✅ Инициализация завершена, делегирование событий настроено');
        });

        // Гарантируем первичную загрузку каталога после инициализации страницы
        (function ensureInitialCatalogFetch() {
            const trigger = () => {
                if (window.initialCatalogFetchDone) return;
                const isSecondaryInit = '{{ dataset_type }}' === 'secondary';
                const storedView = localStorage.getItem('catalog_view');
                const defaultView = isSecondaryInit ? 'list' : (storedView || 'map');
                if (!storedView && !isSecondaryInit) {
                    localStorage.setItem('catalog_view', defaultView);
                }

                if (!localStorage.getItem('catalog_content_mode')) {
                    localStorage.setItem('catalog_content_mode', 'complexes');
                }

                if (typeof window.setView === 'function') {
                    window.setView(defaultView);
                } else if (typeof window.fetchData === 'function') {
                    window.fetchData();
                }
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', trigger);
            } else {
                trigger();
            }
        })();

        // ========== ИНИЦИАЛИЗАЦИЯ КНОПОК КОЛИЧЕСТВА ЭЛЕМЕНТОВ ==========
        // Используем делегирование событий на родительском элементе
        (function() {
            function initPageSizeButtons() {
                const container = document.querySelector('.page-size-toggle');
                if (!container) {
                    console.warn('page-size-toggle container not found');
                    return;
                }
                
                // Устанавливаем начальное состояние
                const perPageField = document.getElementById('per_page-hidden');
                if (perPageField) {
                    const savedSize = localStorage.getItem('catalog_per_page') || perPageField.value || '15';
                    perPageField.value = savedSize;
                    
                    // Обновляем активную кнопку
                    container.querySelectorAll('.page-size-btn').forEach(btn => {
                        btn.setAttribute('data-active', btn.getAttribute('data-size') === savedSize ? 'true' : 'false');
                    });
                }
                
                // Используем делегирование событий
                container.addEventListener('click', function(e) {
                    const btn = e.target.closest('.page-size-btn');
                    if (!btn) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const size = btn.getAttribute('data-size');
                    const perPageField = document.getElementById('per_page-hidden');
                    
                    if (!size || !perPageField) {
                        console.error('Page size button click: missing size or field');
                        return;
                    }
                    
                    // Обновляем значение
                    perPageField.value = size;
                    localStorage.setItem('catalog_per_page', size);
                    
                    // Обновляем состояние всех кнопок
                    container.querySelectorAll('.page-size-btn').forEach(b => {
                        b.setAttribute('data-active', b.getAttribute('data-size') === size ? 'true' : 'false');
                    });
                    
                    // Запускаем поиск
                    if (typeof window.resetPageAndFetch === 'function') {
                        window.resetPageAndFetch();
                    } else if (typeof window.fetchData === 'function') {
                        window.currentPage = 1;
                        window.fetchData();
                    }
                });
            }
            
            // Запускаем при готовности DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPageSizeButtons);
            } else {
                initPageSizeButtons();
            }
        })();

        // ========== КНОПКА "СБРОСИТЬ" ФИЛЬТРЫ ==========
        (function() {
            function initResetButton() {
                const resetBtn = document.getElementById('filters-reset-btn');
                if (!resetBtn) {
                    console.warn('Reset button not found');
                    return;
                }
                
                resetBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Reset button clicked');
                    
                    const form = document.getElementById('filters-form');
                    if (!form) {
                        console.error('Form not found');
                        return;
                    }
                    
                    // Сбрасываем форму
                    form.reset();
                    
                    // Сбрасываем все скрытые поля (кроме per_page)
                    form.querySelectorAll('input[type="hidden"]').forEach(input => {
                        if (input.id !== 'per_page-hidden') {
                            input.value = '';
                        }
                    });
                    
                    // Сбрасываем активные кнопки комнат
                    form.querySelectorAll('[data-active="true"]').forEach(btn => {
                        if (!btn.classList.contains('page-size-btn')) {
                            btn.setAttribute('data-active', 'false');
                            btn.classList.remove('active');
                        }
                    });
                    
                    // Сбрасываем категорию объекта (для вторичной недвижимости)
                    const stypeHidden = document.getElementById('stype-hidden');
                    if (stypeHidden) {
                        stypeHidden.value = '';
                    }
                    // Сбрасываем кнопки категории объекта
                    document.querySelectorAll('.filter-chip-btn').forEach(btn => {
                        btn.setAttribute('data-active', 'false');
                        btn.classList.remove('active');
                        // Активируем кнопку "Все"
                        if (btn.getAttribute('data-value') === '') {
                            btn.setAttribute('data-active', 'true');
                            btn.classList.add('active');
                        }
                    });
                    
                    // Сбрасываем чекбоксы
                    form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                    
                    // Сбрасываем текстовые поля
                    const fieldsToReset = [
                        'floor-from-input', 'floor-to-input',
                        'area-from-input', 'area-to-input',
                        'price-from-input', 'price-to-input'
                    ];
                    fieldsToReset.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = '';
                    });
                    
                    // Устанавливаем город Уфа по умолчанию
                    const cityHidden = document.getElementById('city-hidden');
                    const cityText = document.getElementById('city-text');
                    if (cityHidden) {
                        cityHidden.value = 'Уфа';
                    }
                    if (cityText) {
                        cityText.textContent = 'Уфа';
                    }
                    // Отмечаем чекбокс города Уфа
                    const cityCheckbox = document.querySelector('.city-modal-checkbox[value="Уфа"]');
                    if (cityCheckbox) cityCheckbox.checked = true;
                    
                    // Сбрасываем районы
                    const districtHidden = document.getElementById('district-hidden');
                    const districtText = document.getElementById('district-text');
                    if (districtHidden) districtHidden.value = '';
                    if (districtText) districtText.textContent = 'Любой';
                    document.querySelectorAll('.district-modal-checkbox').forEach(cb => cb.checked = false);
                    
                    // Сбрасываем улицы
                    const streetHidden = document.getElementById('street-hidden');
                    const streetText = document.getElementById('street-text');
                    if (streetHidden) streetHidden.value = '';
                    if (streetText) streetText.textContent = 'Любая';
                    document.querySelectorAll('.street-modal-checkbox').forEach(cb => cb.checked = false);
                    
                    // Сбрасываем ЖК
                    const complexesHidden = document.getElementById('complexes-hidden');
                    const complexesText = document.getElementById('complexes-text');
                    if (complexesHidden) complexesHidden.value = '';
                    if (complexesText) complexesText.textContent = 'Любые';
                    document.querySelectorAll('.complex-modal-checkbox').forEach(cb => cb.checked = false);
                    
                    // Сбрасываем срок сдачи
                    const deliveryHidden = document.getElementById('delivery-quarter-hidden');
                    const deliveryText = document.getElementById('delivery-quarter-text');
                    if (deliveryHidden) deliveryHidden.value = '';
                    if (deliveryText) deliveryText.textContent = 'Любой срок';
                    document.querySelectorAll('.delivery-quarter-modal-checkbox').forEach(cb => cb.checked = false);
                    
                    // Закрываем модальное окно фильтров (для мобильной версии)
                    if (window.innerWidth <= 991) {
                        const sheet = document.getElementById('filters-sheet');
                        const backdrop = document.getElementById('filters-backdrop');
                        if (sheet) sheet.classList.remove('open');
                        if (backdrop) backdrop.classList.remove('open');
                        document.body.classList.remove('filter-open');
                    }
                    
                    console.log('Filters reset, calling API...');
                    
                    // Выполняем AJAX поиск
                    if (typeof window.resetPageAndFetch === 'function') {
                        window.resetPageAndFetch();
                    } else if (typeof window.fetchData === 'function') {
                        window.currentPage = 1;
                        window.fetchData();
                    } else {
                        console.error('No fetch function available');
                    }
                });
                
                console.log('Reset button handler attached');
            }
            
            // Запускаем при готовности DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initResetButton);
            } else {
                initResetButton();
            }
        })();
    </script>
    
    <!-- ФИНАЛЬНЫЙ ФИКС: Кнопки Карта/Список - выполняется последним -->
    <script>
        (function() {
            function fixViewToggleButtons() {
                const mapBtn = document.querySelector('.view-btn[data-view="map"]');
                const listBtn = document.querySelector('.view-btn[data-view="list"]');
                
                if (!mapBtn || !listBtn) {
                    console.log('View buttons not found, retrying...');
                    setTimeout(fixViewToggleButtons, 100);
                    return;
                }
                
                // Клонируем чтобы удалить ВСЕ старые обработчики
                const newMapBtn = mapBtn.cloneNode(true);
                const newListBtn = listBtn.cloneNode(true);
                mapBtn.parentNode.replaceChild(newMapBtn, mapBtn);
                listBtn.parentNode.replaceChild(newListBtn, listBtn);
                
                // Добавляем обработчики
                newMapBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof window.setView === 'function') {
                        window.setView('map');
                    }
                });
                
                newListBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof window.setView === 'function') {
                        window.setView('list');
                    }
                });
                
                console.log('✅ View toggle buttons fixed');
            }
            
            // Запускаем с задержкой чтобы гарантировано быть последними
            if (document.readyState === 'complete') {
                setTimeout(fixViewToggleButtons, 200);
            } else {
                window.addEventListener('load', function() {
                    setTimeout(fixViewToggleButtons, 200);
                });
            }
        })();
    </script>
{% endblock %}
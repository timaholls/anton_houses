{% extends 'base.html' %}
{% load static %}

{% block title %}{% if landing and landing.meta_title %}{{ landing.meta_title }}{% elif page_title %}{{ page_title }} — CENTURY 21{% else %}CENTURY 21 - Каталог ЖК{% endif %}{% endblock %}

{% block extra_css %}
<style>
/* Специальные исправления для страницы каталога ЖК */
.catalog-section ~ .feedback-wrapper {
    margin-top: 100px !important;
    padding: 120px 0 250px 0 !important;
}

.catalog-section ~ .feedback-wrapper .feedback-container {
    margin-bottom: 200px !important;
}

.catalog-section ~ .footer-transition {
    padding-top: 200px !important;
}

.catalog-section ~ .footer-transition .deco-logo.on-dark {
    top: 40px !important;
    z-index: 200 !important;
}

.catalog-section ~ .footer .footer-content {
    margin-top: 120px !important;
}

.catalog-section {
    margin-bottom: 30px !important;
}

.catalog-grid {
    margin-bottom: 30px !important;
}

.pagination-container {
    margin-top: 30px !important;
    margin-bottom: 50px !important;
}

@media (max-width: 768px) {
    .catalog-section ~ .feedback-wrapper {
        margin-top: 80px !important;
        padding: 80px 0 180px 0 !important;
    }
    
    .catalog-section ~ .footer-transition {
        padding-top: 150px !important;
    }
    
    .catalog-section ~ .footer-transition .deco-logo.on-dark {
        top: 30px !important;
        z-index: 200 !important;
    }
    
    .catalog-section ~ .footer .footer-content {
        margin-top: 100px !important;
    }
}

@media (max-width: 600px) {
    .catalog-section ~ .feedback-wrapper {
        margin-top: 60px !important;
        padding: 60px 0 150px 0 !important;
    }
    
    .catalog-section ~ .footer-transition {
        padding-top: 120px !important;
    }
    
    .catalog-section ~ .footer-transition .deco-logo.on-dark {
        top: 25px !important;
        z-index: 200 !important;
    }
    
    .catalog-section ~ .footer .footer-content {
        margin-top: 80px !important;
    }
}
</style>
{% endblock %}

{% block meta %}
{% if landing and landing.meta_description %}
<meta name="description" content="{{ landing.meta_description }}">
{% elif page_description %}
<meta name="description" content="{{ page_description }}">
{% endif %}
{% if landing and landing.meta_keywords %}
<meta name="keywords" content="{{ landing.meta_keywords }}">
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <section class="catalog-section">
        <div class="catalog-header">
            <h1 class="section-title">{% if page_title %}{{ page_title }}{% else %}Каталог жилых комплексов{% endif %}</h1>
            <p class="section-subtitle">{% if page_description %}{{ page_description }}{% else %}Все доступные предложения{% endif %}</p>

            <div class="catalog-tabs">
                <a href="{% url 'main:newbuild_index' %}" class="catalog-tab {% if dataset_type == 'newbuild' %}active{% endif %}">Новостройки</a>
                <a href="{% url 'main:secondary_index' %}" class="catalog-tab alt {% if dataset_type == 'secondary' %}active{% endif %}">Вторичная недвижимость</a>
            </div>
            <div class="view-toggle">
                <button type="button" class="view-btn" data-view="list">Списком</button>
                <button type="button" class="view-btn" data-view="map">Картой</button>
            </div>
            {% if landing_categories %}
            <div class="catalog-categories">
                {% for lc in landing_categories %}
                    <a href="{% url 'main:catalog_landing' lc.slug %}" class="catalog-category{% if landing and landing.slug == lc.slug %} active{% endif %}">{{ lc.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Хлебные крошки -->
        <div class="breadcrumbs">
            <a href="{% url 'main:home' %}" class="breadcrumb-link">Главная</a>
            <span class="breadcrumb-separator">•</span>
            <span class="breadcrumb-current">{% if dataset_type == 'secondary' %}Вторичная недвижимость{% else %}Каталог ЖК{% endif %}</span>
        </div>

        <!-- Фильтры -->
        <div class="filters-section">
            <form class="filters-form" id="filters-form">
                <div class="filters-row filters-row-grid fixed-grid">
                    <div class="filter-group">
                        <label for="city">Город</label>
                        <select name="city" id="city" class="filter-select">
                            <option value="">Любой</option>
                            {% for city_name in cities %}
                                <option value="{{ city_name }}" {% if filters.city == city_name %}selected{% endif %}>
                                    {{ city_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group hidden" id="district-group">
                        <label for="district">Район</label>
                        <select name="district" id="district" class="filter-select">
                            <option value="">Любой</option>
                        </select>
                    </div>

                    <div class="filter-group hidden" id="street-group">
                        <label for="street">Улица</label>
                        <select name="street" id="street" class="filter-select">
                            <option value="">Любая</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Укажите площадь дома, м²</label>
                        <div class="range-container">
                            <div class="range-display">
                                <span class="range-value">от <strong id="area-from-display">60</strong></span>
                                <span class="range-separator">—</span>
                                <span class="range-value">до <strong id="area-to-display">399</strong></span>
                            </div>
                            <div class="range-slider">
                                <input type="range" id="area-from-slider" class="range-slider-input" min="30" max="500" step="1" value="60">
                                <input type="range" id="area-to-slider" class="range-slider-input" min="30" max="500" step="1" value="399">
                                <div class="range-track">
                                    <div class="range-fill area-fill"></div>
                                </div>
                            </div>
                            <input type="hidden" name="area_from" id="area-from-hidden" value="{{ filters.area_from|default:'' }}">
                            <input type="hidden" name="area_to" id="area-to-hidden" value="{{ filters.area_to|default:'' }}">
                        </div>
                    </div>

                    <div class="filter-group">
                        <label>Цена, ₽</label>
                        <div class="range-container">
                            <div class="range-display">
                                <span class="range-value">от <strong id="price-from-display">1.0</strong> млн</span>
                                <span class="range-separator">—</span>
                                <span class="range-value">до <strong id="price-to-display">10.0</strong> млн</span>
                            </div>
                            <div class="range-slider">
                                <input type="range" id="price-from-slider" class="range-slider-input" min="1" max="10" step="0.1" value="1.0">
                                <input type="range" id="price-to-slider" class="range-slider-input" min="1" max="10" step="0.1" value="10.0">
                                <div class="range-track">
                                    <div class="range-fill price-fill"></div>
                                </div>
                            </div>
                            <input type="hidden" name="price_from" id="price-from-hidden" value="{{ filters.price_from|default:'' }}">
                            <input type="hidden" name="price_to" id="price-to-hidden" value="{{ filters.price_to|default:'' }}">
                        </div>
                    </div>

                    {% if dataset_type == 'secondary' %}
                    <div class="filter-group">
                        <label>Категория объекта</label>
                        <div class="button-filter chips">
                            <button type="button" class="filter-chip filter-chip-btn" data-value="" {% if not filters.stype %}data-active="true"{% endif %}>Все</button>
                            <button type="button" class="filter-chip filter-chip-btn" data-value="apartment" {% if filters.stype == 'apartment' %}data-active="true"{% endif %}>Квартиры</button>
                            <button type="button" class="filter-chip filter-chip-btn" data-value="cottage" {% if filters.stype == 'cottage' %}data-active="true"{% endif %}>Коттеджи</button>
                            <button type="button" class="filter-chip filter-chip-btn" data-value="townhouse" {% if filters.stype == 'townhouse' %}data-active="true"{% endif %}>Таунхаусы</button>
                            <button type="button" class="filter-chip filter-chip-btn" data-value="commercial" {% if filters.stype == 'commercial' %}data-active="true"{% endif %}>Коммерческие</button>
                        </div>
                        <input type="hidden" name="stype" id="stype-hidden" value="{{ filters.stype|default:'' }}">
                    </div>
                    {% else %}
                    <div class="filter-group">
                        <label>Укажите количество комнат</label>
                        <div class="button-filter">
                            <button type="button" class="filter-btn" data-value="" data-active="{% if not filters.rooms %}true{% else %}false{% endif %}">
                                Любое
                            </button>
                            {% for value, label in rooms_choices %}
                            <button type="button" class="filter-btn" data-value="{{ value }}" data-active="{% if filters.rooms == value %}true{% else %}false{% endif %}">
                                {{ label }}
                            </button>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="rooms" id="rooms-hidden" value="{{ filters.rooms|default:'' }}">
                    </div>
                    {% endif %}
                </div>

                <div class="filters-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Поиск
                    </button>
                    
                    <div class="results-count">
                        Найдено {{ page_obj.paginator.count }} домов
                    </div>
                    
                    <a href="{% if dataset_type == 'secondary' %}{% url 'main:secondary_index' %}{% else %}{% url 'main:catalog' %}{% endif %}" class="clear-filters" id="clear-filters">
                        <i class="fas fa-times"></i>
                        Очистить фильтр
                    </a>
                </div>
            </form>
        </div>

        <!-- Сортировка -->
        <div class="sorting-section">
            <div class="sorting-dropdown">
                <div class="sorting-options" id="sorting-options">
                    <div class="sorting-option" data-sort="price_asc">
                        <span>Дешевле</span>
                    </div>
                    <div class="sorting-option" data-sort="price_desc">
                        <span>Дороже</span>
                    </div>
                    <div class="sorting-option" data-sort="area_desc">
                        <span>С большей площадью</span>
                    </div>
                    <div class="sorting-option" data-sort="area_asc">
                        <span>С меньшей площадью</span>
                    </div>
                </div>
                <div class="sorting-active" id="sorting-active">
                    <i class="fas fa-sort"></i>
                    <span id="sorting-text">Дешевле</span>
                    <i class="fas fa-chevron-up"></i>
                </div>
            </div>
            <input type="hidden" name="sort" id="sort-hidden" value="{{ filters.sort|default:'price_asc' }}">
        </div>

        <!-- Результаты поиска -->
        {% if filters_applied %}
        <div class="search-results">
            <h3 class="search-title">Результаты поиска</h3>
        </div>
        {% endif %}

        <div id="map" style="width: 100%; height: 520px; display:none; border-radius:12px; overflow:hidden; margin-bottom:24px;"></div>
        <div class="catalog-grid" id="catalog-grid">
            {% for complex in complexes %}
            <div class="property-card-large" onclick="window.location.href='{% if dataset_type == 'secondary' %}{% url 'main:secondary_detail' complex.id %}{% else %}{% url 'main:detail' complex.id %}{% endif %}'" style="cursor: pointer;">
                <div class="card-images">
                    <div class="main-image">
                        {% with catalog_images=complex.get_catalog_images %}
                            {% if catalog_images.0.image %}
                                <img src="{{ catalog_images.0.image.url }}" alt="{{ complex.name }}">
                            {% else %}
                                <img src="/media/gallery/placeholders.png" alt="{{ complex.name }}">
                            {% endif %}
                        {% endwith %}
                        <div class="image-counter">1 из 4</div>
                        <div class="image-nav">
                            <button class="nav-btn prev"><i class="fas fa-chevron-left"></i></button>
                            <button class="nav-btn next"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="thumbnail-images">
                        {% with catalog_images=complex.get_catalog_images %}
                            <div class="thumbnail active">
                                {% if catalog_images.0.image %}
                                    <img src="{{ catalog_images.0.image.url }}" alt="{{ complex.name }}">
                                {% else %}
                                    <img src="/media/gallery/placeholders.png" alt="{{ complex.name }}">
                                {% endif %}
                            </div>
                            <div class="thumbnail">
                                {% if catalog_images.1.image %}
                                    <img src="{{ catalog_images.1.image.url }}" alt="{{ complex.name }}">
                                {% else %}
                                    <img src="/media/gallery/placeholders.png" alt="{{ complex.name }}">
                                {% endif %}
                            </div>
                            <div class="thumbnail">
                                {% if catalog_images.2.image %}
                                    <img src="{{ catalog_images.2.image.url }}" alt="{{ complex.name }}">
                                {% else %}
                                    <img src="/media/gallery/placeholders.png" alt="{{ complex.name }}">
                                {% endif %}
                            </div>
                            <div class="thumbnail more">
                                <span>+1</span>
                                {% if catalog_images.3.image %}
                                    <img src="{{ catalog_images.3.image.url }}" alt="{{ complex.name }}">
                                {% else %}
                                    <img src="/media/gallery/placeholders.png" alt="{{ complex.name }}">
                                {% endif %}
                            </div>
                        {% endwith %}
                    </div>
                </div>
                
                <div class="card-content-large">
                    <div class="card-header">
                        <div class="card-title-section">
                            <h3 class="card-title">{{ complex.name }}</h3>
                            <div class="card-subtitle">
                                {{ complex.total_apartments }} квартир от застройщика
                            </div>
                            <div class="completion-info">
                                {{ complex.completion_start }} - {{ complex.completion_end }}
                                {% if complex.has_completed %}
                                    <span class="completed-badge">Есть сданные</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-price-section">
                            <div class="main-price">
                                <span class="price-label">от</span>
                                <span class="price-value">{{ complex.price_from|floatformat:1 }}</span>
                                <span class="price-currency">млн ₽</span>
                            </div>
                        </div>
                    </div>
                    
                                     <div class="card-location-info">
                         <div class="location-text">
                             Россия - {{ complex.city }} - {{ complex.district }} - {{ complex.street }}
                         </div>
                     </div>

                     <div class="card-price-section" style="margin-top:8px;">
                         <div class="main-price">
                             <span class="price-label">от</span>
                             <span class="price-value">{{ complex.price_from|floatformat:1 }}</span>
                             <span class="price-currency">млн ₽</span>
                         </div>
                     </div>
                     
                     <div class="apartment-prices">
                         <div class="price-row">
                            <span class="room-type">Студия</span>
                            <span class="room-price">от {{ complex.studio_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
                        </div>
                        <div class="price-row">
                            <span class="room-type">1-комн.</span>
                            <span class="room-price">от {{ complex.one_room_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
                        </div>
                        <div class="price-row">
                            <span class="room-type">2-комн.</span>
                            <span class="room-price">от {{ complex.two_room_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
                        </div>
                        <div class="price-row">
                            <span class="room-type">3-комн.</span>
                            <span class="room-price">от {{ complex.three_room_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
                        </div>
                        <div class="price-row">
                            <span class="room-type">4-комн.+</span>
                            <span class="room-price">от {{ complex.four_room_price|default:complex.price_from|floatformat:1 }} млн ₽</span>
                        </div>
                    </div>
                    

                </div>
            </div>
            {% empty %}
            <div class="no-complexes">
                {% if filters_applied %}
                    <p>По вашему запросу ничего не найдено</p>
                    <p>Попробуйте изменить параметры поиска</p>
                {% else %}
                    <p>Жилые комплексы пока не добавлены</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <!-- Пагинация -->
        {% if paginator.num_pages >= 1 %}
        <div class="pagination-container">
            <div class="pagination-info">
                Страница {{ page_obj.number }} из {{ paginator.num_pages }}
            </div>
            <div class="pagination-controls">
                {% if page_obj.has_previous %}
                    <a class="pagination-btn" href="{% if dataset_type == 'secondary' %}{% url 'main:secondary_index' %}?page={{ page_obj.previous_page_number }}{% else %}{% url 'main:catalog' %}?page={{ page_obj.previous_page_number }}{% endif %}">
                        <i class="fas fa-chevron-left"></i> Назад
                    </a>
                {% endif %}
                
                <div class="pagination-numbers">
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <span class="pagination-number active">{{ num }}</span>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <a class="pagination-number" href="{% if dataset_type == 'secondary' %}{% url 'main:secondary_index' %}?page={{ num }}{% else %}{% url 'main:catalog' %}?page={{ num }}{% endif %}">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                </div>
                
                {% if page_obj.has_next %}
                    <a class="pagination-btn" href="{% if dataset_type == 'secondary' %}{% url 'main:secondary_index' %}?page={{ page_obj.next_page_number }}{% else %}{% url 'main:catalog' %}?page={{ page_obj.next_page_number }}{% endif %}">
                        Вперед <i class="fas fa-chevron-right"></i>
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        

    </section>
    
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<style>
.catalog-tabs { margin-top: 12px; display: flex; gap: 16px; justify-content: center; }
.catalog-tab { padding: 8px 16px; border-radius: 999px; background: var(--c21-light); color: var(--c21-dark); text-decoration: none; font-weight: 600; }
.catalog-tab.active { background: var(--c21-dark); color: var(--c21-gold); }
.catalog-tab.alt { background: var(--c21-light); color: var(--c21-dark); }
.catalog-tab.alt.active { background: var(--c21-dark); color: var(--c21-gold); }
.catalog-categories { margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.catalog-category { padding: 6px 12px; border: 1px solid var(--c21-mid); border-radius: 999px; text-decoration: none; color: var(--c21-dark); font-weight: 600; }
.catalog-category.active, .catalog-category:hover { border-color: var(--c21-gold); color: var(--c21-gold); }
.filter-chip { display:inline-block; padding:8px 14px; background: var(--c21-light); color: var(--c21-dark); border-radius: 999px; text-decoration: none; font-weight:600; }
.filter-chip.active, .filter-chip:hover { background: var(--c21-dark); color: var(--c21-gold); }
.view-toggle { margin-top: 12px; display:flex; gap:8px; justify-content:center; }
.view-btn { padding:6px 12px; border-radius:999px; border:1px solid var(--c21-mid); background:#fff; cursor:pointer; font-weight:600; }
.view-btn.active { background: var(--c21-dark); color: var(--c21-gold); border-color: var(--c21-dark); }
</style>

<script>
// Глобальные функции - должны быть определены первой
window.renderItems = function(data){
  const grid = document.getElementById('catalog-grid');
  const resultsCount = document.querySelector('.results-count');
  const isSecondary = '{{ dataset_type }}' === 'secondary';
  
  // Для вторичной недвижимости всегда показываем списком
  const currentView = isSecondary ? 'list' : (localStorage.getItem('catalog_view')||'list');
  
  if (currentView === 'map'){
    // карта
    if (isSecondary) {
      if (typeof renderMapPoints === 'function') {
        renderMapPoints(data.items||[], true);
      }
    } else {
      if (typeof renderMapPoints === 'function') {
        renderMapPoints(data.complexes||[], false);
      }
    }
  } else {
    // списком
    if (isSecondary) {
      if (!data.items || !data.items.length) {
        grid.innerHTML = '<div class="no-complexes"><p>По вашему запросу ничего не найдено</p></div>';
      } else {
        grid.innerHTML = data.items.map(item => {
          const imageUrl = item.image_url || '/media/gallery/placeholders.png';
          const image2 = item.image_2_url || '/media/gallery/placeholders.png';
          const image3 = item.image_3_url || '/media/gallery/placeholders.png';
          const image4 = item.image_4_url || '/media/gallery/placeholders.png';
          return `
          <div class="property-card-large" onclick="window.location.href='/secondary/${item.id}/'" style="cursor: pointer;">
            <div class="card-images">
              <div class="main-image">
                <img src="${imageUrl}" alt="${item.name}">
                <div class="image-counter">1 из 4</div>
                <div class="image-nav">
                  <button class="nav-btn prev"><i class="fas fa-chevron-left"></i></button>
                  <button class="nav-btn next"><i class="fas fa-chevron-right"></i></button>
                </div>
              </div>
              <div class="thumbnail-images">
                <div class="thumbnail active"><img src="${imageUrl}" alt="${item.name}"></div>
                <div class="thumbnail"><img src="${image2}" alt="${item.name}"></div>
                <div class="thumbnail"><img src="${image3}" alt="${item.name}"></div>
                <div class="thumbnail more"><span>+1</span><img src="${image4}" alt="${item.name}"></div>
              </div>
            </div>
            <div class="card-content-large">
              <div class="card-header">
                <div class="card-title-section"><h3 class="card-title">${item.name}</h3></div>
                <div class="card-price-section">
                  <div class="main-price"><span class="price-label">от</span><span class="price-value">${(item.price_from || 0).toFixed ? item.price_from.toFixed(1) : item.price_from}</span><span class="price-currency">млн ₽</span></div>
                </div>
              </div>
              <div class="card-location-info"><div class="location-text">Россия - ${item.city} - ${item.district || ''} - ${item.street || ''}</div></div>
            </div>
          </div>`;
        }).join('');
        if (typeof initImageCarousel === 'function') { initImageCarousel(); }
      }
    } else {
      const list = data.complexes || [];
      if (!list.length) {
        grid.innerHTML = '<div class="no-complexes"><p>По вашему запросу ничего не найдено</p></div>';
      } else {
        // Используем полноценный рендер с миниатюрами и ценами
        if (typeof updateCatalog === 'function') {
          updateCatalog(data);
        }
        // Инициализируем карусель изображений после обновления разметки
        if (typeof initImageCarousel === 'function') { initImageCarousel(); }
      }
    }
  }
  // Обновляем пагинацию под список
  if (typeof updatePagination === 'function') {
    updatePagination(data);
  }
  if (resultsCount) {
    const total = (typeof data.total_count !== 'undefined') ? data.total_count : (data.total_count ?? data.total ?? 0);
    if (total) resultsCount.textContent = `Найдено ${total} домов`;
  }
}

// Глобальная функция applyFilters
window.applyFilters = function() {
    // Собираем данные формы
    const formData = new FormData(document.getElementById('filters-form'));
    const params = new URLSearchParams();
    
    // Добавляем параметры фильтров
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    // Показываем индикатор загрузки
    const grid = document.getElementById('catalog-grid');
    grid.innerHTML = '<div class="loading">Поиск...</div>';
    
    // Определяем правильный API URL в зависимости от типа данных
    const isSecondary = '{{ dataset_type }}' === 'secondary';
    const apiUrl = isSecondary ? '/api/secondary/' : '/api/catalog/';
    
    // Загружаем данные через API с фильтрами
    fetch(`${apiUrl}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            window.currentPage = 1;
            if (isSecondary) {
                renderItems(data);
            } else {
                updateCatalog(data);
                updatePagination(data);
                updateResultsCount(data.total_count);
            }
            
            // Показываем заголовок результатов поиска
            const searchResults = document.querySelector('.search-results');
            if (!searchResults) {
                const resultsDiv = document.createElement('div');
                resultsDiv.className = 'search-results';
                resultsDiv.innerHTML = '<h3 class="search-title">Результаты поиска</h3>';
                grid.parentNode.insertBefore(resultsDiv, grid);
            }
            
            // Обновляем URL без параметров
            const baseUrl = isSecondary ? '/secondary/' : '/catalog/';
            window.history.pushState({}, '', baseUrl);
        })
        .catch(error => {
            console.error('Ошибка поиска:', error);
            grid.innerHTML = '<div class="error">Ошибка поиска</div>';
        });
}

// Глобальная функция loadPage
window.loadPage = function(page) {
    if (page === window.currentPage) return;
    
    // Собираем текущие фильтры
    const formData = new FormData(document.getElementById('filters-form'));
    const params = new URLSearchParams();
    
    // Добавляем параметры фильтров
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    // Добавляем номер страницы
    params.append('page', page);
    
    // Показываем индикатор загрузки
    const grid = document.getElementById('catalog-grid');
    grid.innerHTML = '<div class="loading">Загрузка...</div>';
    
    // Определяем правильный API URL в зависимости от типа данных
    const isSecondary = '{{ dataset_type }}' === 'secondary';
    const apiUrl = isSecondary ? '/api/secondary/' : '/api/catalog/';
    
    // Загружаем данные через API
    fetch(`${apiUrl}?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            window.currentPage = data.current_page;
            if (isSecondary) {
                renderItems(data);
            } else {
                updateCatalog(data);
                updatePagination(data);
                updateResultsCount(data.total_count);
            }
            // Обновляем URL без параметров
            const baseUrl = isSecondary ? '/secondary/' : '/catalog/';
            window.history.pushState({}, '', baseUrl);
        })
        .catch(error => {
            console.error('Ошибка загрузки:', error);
            grid.innerHTML = '<div class="error">Ошибка загрузки данных</div>';
        });
}

// Глобальная функция updateCatalog
window.updateCatalog = function(data) {
    const grid = document.getElementById('catalog-grid');
    
    if (data.complexes.length === 0) {
        grid.innerHTML = '<div class="no-complexes"><p>По вашему запросу ничего не найдено</p><p>Попробуйте изменить параметры поиска</p></div>';
        return;
    }
    
    let html = '';
    data.complexes.forEach(complex => {
        const imageUrl = complex.image_url || '/media/gallery/placeholders.png';
        const image2 = complex.image_2_url || '/media/gallery/placeholders.png';
        const image3 = complex.image_3_url || '/media/gallery/placeholders.png';
        const image4 = complex.image_4_url || '/media/gallery/placeholders.png';
        
        html += `
            <div class="property-card-large" onclick="window.location.href='/complex/${complex.id}/'" style="cursor: pointer;">
                <div class="card-images">
                    <div class="main-image">
                        <img src="${imageUrl}" alt="${complex.name}">
                        <div class="image-counter">1 из 4</div>
                        <div class="image-nav">
                            <button class="nav-btn prev"><i class="fas fa-chevron-left"></i></button>
                            <button class="nav-btn next"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="thumbnail-images">
                        <div class="thumbnail active">
                            <img src="${imageUrl}" alt="${complex.name}">
                        </div>
                        <div class="thumbnail">
                            <img src="${image2}" alt="${complex.name}">
                        </div>
                        <div class="thumbnail">
                            <img src="${image3}" alt="${complex.name}">
                        </div>
                        <div class="thumbnail more">
                            <span>+1</span>
                            <img src="${image4}" alt="${complex.name}">
                        </div>
                    </div>
                </div>
                
                <div class="card-content-large">
                    <div class="card-header">
                        <div class="card-title-section">
                            <h3 class="card-title">${complex.name}</h3>
                            <div class="card-subtitle">
                                ${complex.total_apartments || 100} квартир от застройщика
                            </div>
                            <div class="completion-info">
                                ${complex.completion_start || '3 кв. 2024'} - ${complex.completion_end || '4 кв. 2025'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-location-info">
                        <div class="location-text">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${complex.location} ${complex.commute_time}</span>
                        </div>
                    </div>

                    <div class="card-price-section" style="margin-top:8px;">
                        <div class="main-price">
                            <span class="price-label">от</span>
                            <span class="price-value">${(complex.price_from || 0).toFixed ? complex.price_from.toFixed(1) : (complex.price_display ? complex.price_display.replace('от ', '').replace(' млн Р', '') : '')}</span>
                            <span class="price-currency">млн Р</span>
                        </div>
                    </div>
                    
                    <div class="apartment-prices">
                        <div class="price-row">
                            <span class="room-type">Студия</span>
                            <span class="room-price">от ${complex.studio_price || (complex.price_from * 0.8).toFixed(1)} млн Р</span>
                        </div>
                        <div class="price-row">
                            <span class="room-type">1-комн.</span>
                            <span class="room-price">от ${complex.one_room_price || complex.price_from} млн Р</span>
                        </div>
                        <div class="price-row">
                            <span class="room-type">2-комн.</span>
                            <span class="room-price">от ${complex.two_room_price || (complex.price_from * 1.25).toFixed(1)} млн Р</span>
                        </div>
                        <div class="price-row">
                            <span class="room-type">3-комн.</span>
                            <span class="room-price">от ${complex.three_room_price || (complex.price_from * 1.5).toFixed(1)} млн Р</span>
                        </div>
                        <div class="price-row">
                            <span class="room-type">4-комн. +</span>
                            <span class="room-price">от ${complex.four_room_price || (complex.price_from * 2).toFixed(1)} млн Р</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    grid.innerHTML = html;
}

// Глобальная функция updateResultsCount
window.updateResultsCount = function(count) {
    const resultsCount = document.querySelector('.results-count');
    if (resultsCount) {
        resultsCount.textContent = `Найдено ${count} домов`;
    }
}

// Глобальная функция updatePagination
window.updatePagination = function(data) {
    const container = document.querySelector('.pagination-container');
    if (!container) return;
    
    const info = container.querySelector('.pagination-info');
    const controls = container.querySelector('.pagination-controls');
    
    info.textContent = `Страница ${data.current_page} из ${data.total_pages}`;
    
    let controlsHtml = '';
    
    if (data.has_previous) {
        controlsHtml += `
            <button class="pagination-btn" onclick="loadPage(${data.current_page - 1})">
                <i class="fas fa-chevron-left"></i> Назад
            </button>
        `;
    }
    
    controlsHtml += '<div class="pagination-numbers">';
    for (let i = 1; i <= data.total_pages; i++) {
        if (i === data.current_page) {
            controlsHtml += `<span class="pagination-number active">${i}</span>`;
        } else if (i > data.current_page - 3 && i < data.current_page + 3) {
            controlsHtml += `<button class="pagination-number" onclick="loadPage(${i})">${i}</button>`;
        }
    }
    controlsHtml += '</div>';
    
    if (data.has_next) {
        controlsHtml += `
            <button class="pagination-btn" onclick="loadPage(${data.current_page + 1})">
                Вперед <i class="fas fa-chevron-right"></i>
            </button>
        `;
    }
    
    controls.innerHTML = controlsHtml;
}

// Глобальная функция initImageCarousel
window.initImageCarousel = function() {
    const propertyCards = document.querySelectorAll('.property-card-large');
    
    propertyCards.forEach(card => {
        const mainImage = card.querySelector('.main-image img');
        const thumbnails = card.querySelectorAll('.thumbnail');
        const imageCounter = card.querySelector('.image-counter');
        const prevBtn = card.querySelector('.nav-btn.prev');
        const nextBtn = card.querySelector('.nav-btn.next');
        
        let currentImageIndex = 0;
        const totalImages = thumbnails.length;
        
        // Функция для обновления главного изображения
        function updateMainImage(index) {
            const thumbnail = thumbnails[index];
            const thumbnailImg = thumbnail.querySelector('img');
            
            if (thumbnailImg) {
                mainImage.src = thumbnailImg.src;
                mainImage.alt = thumbnailImg.alt;
                
                // Обновляем счетчик
                imageCounter.textContent = `${index + 1} из ${totalImages}`;
                
                // Обновляем активную миниатюру
                thumbnails.forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === index);
                });
                
                currentImageIndex = index;
            }
        }
        
        // Обработчики кликов по миниатюрам
        thumbnails.forEach((thumbnail, index) => {
            thumbnail.addEventListener('click', function(e) {
                e.stopPropagation(); // Предотвращаем всплытие события
                updateMainImage(index);
            });
        });
        
        // Обработчики для кнопок навигации
        if (prevBtn) {
            prevBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const newIndex = currentImageIndex > 0 ? currentImageIndex - 1 : totalImages - 1;
                updateMainImage(newIndex);
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const newIndex = currentImageIndex < totalImages - 1 ? currentImageIndex + 1 : 0;
                updateMainImage(newIndex);
            });
        }
        
        // Обработчик клика по главному изображению для перехода к следующему
        mainImage.addEventListener('click', function(e) {
            e.stopPropagation();
            const newIndex = currentImageIndex < totalImages - 1 ? currentImageIndex + 1 : 0;
            updateMainImage(newIndex);
        });
    });
}

// Инициализация глобальных переменных
window.currentPage = {{ page_obj.number }};

// Глобальная функция fetchData
window.fetchData = async function(){
  const form = document.getElementById('filters-form');
  const grid = document.getElementById('catalog-grid');
  const isSecondary = '{{ dataset_type }}' === 'secondary';
  const apiUrl = isSecondary ? '/api/secondary/' : '/api/catalog/';
  
  if (!form || !grid) return;
  if ((localStorage.getItem('catalog_view')||'list') !== 'map') {
    grid.innerHTML = '<div class="loading">Поиск...</div>';
  }
  const qs = window.serialize();
  // Отменяем предыдущий запрос и помечаем текущий как последний
  try {
    if (window.activeController) { window.activeController.abort(); }
    const controller = new AbortController();
    window.activeController = controller;
    const requestId = ++window.latestRequestId;
    const res = await fetch(apiUrl + (qs ? ('?' + qs) : ''), { signal: controller.signal });
    const data = await res.json();
    // Если это не самый свежий ответ — игнорируем
    if (requestId !== window.latestRequestId) return;
    renderItems(data);
  } catch(e){
    if (grid) grid.innerHTML = '<div class="error">Ошибка загрузки</div>';
    console.error(e);
  }
}

// Глобальная функция initMap
window.initMap = function(){
  const mapEl = document.getElementById('map');
  if (!mapEl) return;
  
  window.map = L.map('map', { attributionControl: false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(window.map);
  window.markersLayer = L.layerGroup().addTo(window.map);
  window.map.setView([54.7388, 55.9721], 11); // Уфа по умолчанию
}

// Глобальная функция serialize
window.serialize = function() {
  const form = document.getElementById('filters-form');
  if (!form) return '';
  
  const fd = new FormData(form);
  const params = new URLSearchParams();
  for (const [k, v] of fd.entries()) {
    if (v !== '') params.append(k, v);
  }
  const sort = document.getElementById('sort-hidden');
  if (sort && sort.value) params.set('sort', sort.value);
  return params.toString();
}

// Глобальная функция renderMapPoints
window.renderMapPoints = function(list, isSec){
  if (!window.map) return;
  window.markersLayer.clearLayers();
  const bounds = [];
  list.forEach(item => {
    const lat = item.lat, lng = item.lng;
    if (lat && lng) {
      const marker = L.marker([lat, lng]).addTo(window.markersLayer);
      const price = (item.price_from || 0).toFixed ? item.price_from.toFixed(1) : item.price_from;
      const link = isSec ? `/secondary/${item.id}/` : `/complex/${item.id}/`;
      marker.bindPopup(`<b>${item.name}</b><br/>от ${price} млн ₽<br/><a href="${link}">Подробнее</a>`);
      bounds.push([lat, lng]);
    }
  });
  if (bounds.length) window.map.fitBounds(bounds, { padding:[20,20] });
}

// Глобальная функция setView
window.setView = function(view){
  const grid = document.getElementById('catalog-grid');
  const mapEl = document.getElementById('map');
  const toggleBtns = document.querySelectorAll('.view-btn');
  const isSecondary = '{{ dataset_type }}' === 'secondary';
  
  // Не позволяем переключиться на карту для вторичной недвижимости
  if (isSecondary && view === 'map') {
    return;
  }
  
  toggleBtns.forEach(b => b.classList.toggle('active', b.getAttribute('data-view')===view));
  if (view === 'map') {
    grid.style.display = 'none';
    mapEl.style.display = 'block';
    if (!window.map) initMap();
    fetchData();
  } else {
    mapEl.style.display = 'none';
    grid.style.display = '';
    fetchData();
  }
  
  // Сохраняем в localStorage только для новостроек
  if (!isSecondary) {
    localStorage.setItem('catalog_view', view);
  }
}

// Инициализация глобальных переменных для AJAX
window.activeController = null;
window.latestRequestId = 0;
window.map = null;
window.markersLayer = null;

// Range Slider функциональность
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация range sliders
    initRangeSlider('area-from-slider', 'area-to-slider', 'area-from-display', 'area-to-display', 'area-from-hidden', 'area-to-hidden', 'area-fill');
    initRangeSlider('price-from-slider', 'price-to-slider', 'price-from-display', 'price-to-display', 'price-from-hidden', 'price-to-hidden', 'price-fill');
    
    // Обработка отправки формы фильтров (для всех типов недвижимости)
    const filtersForm = document.getElementById('filters-form');
    if (filtersForm) {
        filtersForm.addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });
    }
    
    // Обработка выбора города
    const citySelect = document.getElementById('city');
    const districtGroup = document.getElementById('district-group');
    const streetGroup = document.getElementById('street-group');
    const districtSelect = document.getElementById('district');
    const streetSelect = document.getElementById('street');
    
    // Инициализация: показываем поля района и улицы, если город уже выбран
    if (citySelect.value) {
        districtGroup.classList.remove('hidden');
        streetGroup.classList.remove('hidden');
    }
    
    citySelect.addEventListener('change', function() {
        const selectedCity = this.value;
        
        if (selectedCity) {
            // Загружаем районы для выбранного города
            fetch(`/api/districts/?city=${selectedCity}`)
                .then(response => response.json())
                .then(data => {
                    districtSelect.innerHTML = '<option value="">Любой</option>';
                    data.districts.forEach(district => {
                        districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
                    });
                    
                    // Показываем группу районов
                    districtGroup.classList.remove('hidden');
                });
            
            // Загружаем улицы для выбранного города
            fetch(`/api/streets/?city=${selectedCity}`)
                .then(response => response.json())
                .then(data => {
                    streetSelect.innerHTML = '<option value="">Любая</option>';
                    data.streets.forEach(street => {
                        streetSelect.innerHTML += `<option value="${street}">${street}</option>`;
                    });
                    
                    // Показываем группу улиц
                    streetGroup.classList.remove('hidden');
                });
        } else {
            // Сбрасываем значения
            districtSelect.innerHTML = '<option value="">Любой</option>';
            streetSelect.innerHTML = '<option value="">Любая</option>';
            
            // Скрываем группы через CSS класс
            districtGroup.classList.add('hidden');
            streetGroup.classList.add('hidden');
        }
    });
    

    
    // Обработка кнопок фильтра количества комнат
    const filterBtns = document.querySelectorAll('.filter-btn');
    const roomsHidden = document.getElementById('rooms-hidden');
    
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Убираем активное состояние у всех кнопок
            filterBtns.forEach(b => {
                b.setAttribute('data-active', 'false');
                b.classList.remove('active');
            });
            
            // Устанавливаем активное состояние для нажатой кнопки
            this.setAttribute('data-active', 'true');
            this.classList.add('active');
            
            // Обновляем скрытое поле
            if (roomsHidden) {
                roomsHidden.value = this.getAttribute('data-value');
            }
            
            // Мгновенный запуск поиска без перезагрузки страницы
            const form = document.getElementById('filters-form');
            if (form) {
                form.dispatchEvent(new Event('submit', { cancelable: true }));
            }
        });
    });
    
    // Обработка сортировки
    const sortingActive = document.getElementById('sorting-active');
    const sortingOptions = document.getElementById('sorting-options');
    const sortingDropdown = document.querySelector('.sorting-dropdown');
    const sortHidden = document.getElementById('sort-hidden');
    const sortingText = document.getElementById('sorting-text');
    
    sortingActive.addEventListener('click', function() {
        sortingDropdown.classList.toggle('active');
        sortingOptions.classList.toggle('active');
    });
    
    // Закрытие сортировки при клике вне её
    document.addEventListener('click', function(e) {
        if (!sortingDropdown.contains(e.target)) {
            sortingDropdown.classList.remove('active');
            sortingOptions.classList.remove('active');
        }
    });
    
    // Обработка выбора сортировки
    const sortingOptionBtns = document.querySelectorAll('.sorting-option');
    sortingOptionBtns.forEach(option => {
        option.addEventListener('click', function() {
            const sortValue = this.getAttribute('data-sort');
            const sortText = this.querySelector('span').textContent;
            
            // Обновляем скрытое поле
            sortHidden.value = sortValue;
            
            // Обновляем текст в активной кнопке
            sortingText.textContent = sortText;
            
            // Убираем активное состояние у всех опций
            sortingOptionBtns.forEach(o => o.classList.remove('active'));
            
            // Устанавливаем активное состояние для выбранной опции
            this.classList.add('active');
            
            // Закрываем dropdown
            sortingDropdown.classList.remove('active');
            sortingOptions.classList.remove('active');
        });
    });
    
    // Обработка кликов по display полям для ручного ввода
    document.querySelectorAll('.range-display').forEach(display => {
        display.addEventListener('click', function() {
            const container = this.closest('.range-container');
            const fromDisplay = container.querySelector('.range-value strong:first-of-type');
            const toDisplay = container.querySelector('.range-value strong:last-of-type');
            
            // Создаем временные input поля для ручного ввода
            const fromInput = document.createElement('input');
            fromInput.type = 'number';
            fromInput.className = 'temp-input';
            fromInput.value = fromDisplay.textContent;
            fromInput.style.cssText = 'width: 50px; padding: 3px; border: 1px solid #0066cc; border-radius: 3px; margin-right: 6px; font-size: 12px;';
            
            const toInput = document.createElement('input');
            toInput.type = 'number';
            toInput.className = 'temp-input';
            toInput.value = toDisplay.textContent;
            toInput.style.cssText = 'width: 50px; padding: 3px; border: 1px solid #0066cc; border-radius: 3px; margin-left: 6px; font-size: 12px;';
            
            // Заменяем display на input поля
            fromDisplay.parentNode.replaceChild(fromInput, fromDisplay);
            toDisplay.parentNode.replaceChild(toInput, toDisplay);
            
            // Фокус на первое поле
            fromInput.focus();
            
            // Обработка завершения ввода
            function finishInput() {
                const fromValue = parseFloat(fromInput.value) || 0;
                const toValue = parseFloat(toInput.value) || 0;
                
                // Восстанавливаем display
                fromDisplay.textContent = fromValue;
                toDisplay.textContent = toValue;
                
                fromInput.parentNode.replaceChild(fromDisplay, fromInput);
                toInput.parentNode.replaceChild(toDisplay, toInput);
                
                // Обновляем slider значения
                const fromSlider = container.querySelector('input[type="range"]:first-of-type');
                const toSlider = container.querySelector('input[type="range"]:last-of-type');
                const fromHidden = container.querySelector('input[type="hidden"]:first-of-type');
                const toHidden = container.querySelector('input[type="hidden"]:last-of-type');
                
                fromSlider.value = fromValue;
                toSlider.value = toValue;
                fromHidden.value = fromValue;
                toHidden.value = toValue;
                
                // Обновляем fill
                updateRangeFill(fromSlider, toSlider, container.querySelector('.range-fill'));
            }
            
            // Обработчики событий
            fromInput.addEventListener('blur', finishInput);
            toInput.addEventListener('blur', finishInput);
            fromInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') finishInput();
            });
            toInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') finishInput();
            });
        });
    });
});

function initRangeSlider(fromSliderId, toSliderId, fromDisplayId, toDisplayId, fromHiddenId, toHiddenId, fillId) {
    const fromSlider = document.getElementById(fromSliderId);
    const toSlider = document.getElementById(toSliderId);
    const fromDisplay = document.getElementById(fromDisplayId);
    const toDisplay = document.getElementById(toDisplayId);
    const fromHidden = document.getElementById(fromHiddenId);
    const toHidden = document.getElementById(toHiddenId);
    const fill = document.querySelector('.' + fillId);
    
    if (!fromSlider || !toSlider) return;
    
    // Устанавливаем начальные значения (пустые значения не применяем как фильтр)
    if (fromHidden.value !== '' && toHidden.value !== '') {
        fromSlider.value = fromHidden.value;
        toSlider.value = toHidden.value;
    } else {
        fromSlider.value = fromSlider.min;
        toSlider.value = toSlider.max;
    }
    fromDisplay.textContent = fromSlider.value;
    toDisplay.textContent = toSlider.value;

    // Обновляем fill при загрузке
    updateRangeFill(fromSlider, toSlider, fill);
    
    // Обработчики событий
    fromSlider.addEventListener('input', function() {
        const fromValue = parseInt(this.value);
        const toValue = parseInt(toSlider.value);
        
        if (fromValue > toValue) {
            this.value = toValue;
            fromValue = toValue;
        }
        
        fromDisplay.textContent = fromValue;
        fromHidden.value = fromValue;
        updateRangeFill(fromSlider, toSlider, fill);
    });
    
    toSlider.addEventListener('input', function() {
        const fromValue = parseInt(fromSlider.value);
        const toValue = parseInt(this.value);
        
        if (toValue < fromValue) {
            this.value = fromValue;
            toValue = fromValue;
        }
        
        toDisplay.textContent = toValue;
        toHidden.value = toValue;
        updateRangeFill(fromSlider, toSlider, fill);
    });
}

function updateRangeFill(fromSlider, toSlider, fill) {
    if (!fill) return;
    
    const fromValue = parseInt(fromSlider.value);
    const toValue = parseInt(toSlider.value);
    const min = parseInt(fromSlider.min);
    const max = parseInt(fromSlider.max);
    
    const fromPercent = ((fromValue - min) / (max - min)) * 100;
    const toPercent = ((toValue - min) / (max - min)) * 100;
    
    // Учитываем отступы в 10px с каждой стороны
    const adjustedFromPercent = fromPercent * 0.8 + 10; // 80% от ширины + 10px отступ
    const adjustedToPercent = toPercent * 0.8 + 10;
    
    fill.style.left = adjustedFromPercent + '%';
    fill.style.width = (adjustedToPercent - adjustedFromPercent) + '%';
}



// Обработка чипов категорий вторички (выбор без авто-перехода)
(function(){
  const chipBtns = document.querySelectorAll('.filter-chip-btn');
  const stypeHidden = document.getElementById('stype-hidden');
  if (!chipBtns.length || !stypeHidden) return;
  chipBtns.forEach(btn => {
    btn.addEventListener('click', function(){
      chipBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      stypeHidden.value = this.getAttribute('data-value');
      // Мгновенный запуск поиска
      const form = document.getElementById('filters-form');
      if (form) form.dispatchEvent(new Event('submit', { cancelable: true }));
    });
    // Инициализация активного состояния из скрытого поля
    if (btn.getAttribute('data-value') === (stypeHidden.value || '')) {
      btn.classList.add('active');
    }
  });
})();

// Эффект тени для sticky шапки при прокрутке
window.addEventListener('scroll', function() {
    const header = document.querySelector('.main-header');
    if (window.scrollY > 10) {
        header.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
    } else {
        header.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.05)';
    }
});



// Инициализация карусели изображений при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    initImageCarousel();
});

// AJAX-загрузка без изменения URL
(function(){
  const form = document.getElementById('filters-form');
  const grid = document.getElementById('catalog-grid');
  const resultsCount = document.querySelector('.results-count');
  const isSecondary = '{{ dataset_type }}' === 'secondary';
  const apiUrl = isSecondary ? '/api/secondary/' : '/api/catalog/';
  const mapEl = document.getElementById('map');
  let map, markersLayer;
  let activeController = null;
  let latestRequestId = 0;

  // View toggle
  const toggleBtns = document.querySelectorAll('.view-btn');
  const savedView = localStorage.getItem('catalog_view') || 'list';
  
  // Отключаем кнопку карты для вторичной недвижимости
  if (isSecondary) {
    const mapBtn = document.querySelector('.view-btn[data-view="map"]');
    if (mapBtn) {
      mapBtn.disabled = true;
      mapBtn.style.opacity = '0.5';
      mapBtn.style.cursor = 'not-allowed';
      mapBtn.title = 'Карта недоступна для вторичной недвижимости';
    }
  }
  

  toggleBtns.forEach(b=>b.addEventListener('click', ()=>{
    // Не обрабатываем клик по кнопке карты для вторичной недвижимости
    if (isSecondary && b.getAttribute('data-view') === 'map') {
      return;
    }
    setView(b.getAttribute('data-view'));
  }));
  
  // Инициализация вида по умолчанию
  // Принудительно устанавливаем вид "списком" для вторичной недвижимости
  if (isSecondary) {
    setView('list');
  } else {
    setView(savedView);
  }



  if (form && !form.dataset.ajaxBound) {
    form.addEventListener('submit', function(e){ e.preventDefault(); window.fetchData(); });
    form.dataset.ajaxBound = '1';
  }

  document.getElementById('clear-filters')?.addEventListener('click', function(e){
    e.preventDefault();
    // reset native form controls
    form.reset();

    // reset area range
    const afs = document.getElementById('area-from-slider');
    const ats = document.getElementById('area-to-slider');
    const afd = document.getElementById('area-from-display');
    const atd = document.getElementById('area-to-display');
    const afh = document.getElementById('area-from-hidden');
    const ath = document.getElementById('area-to-hidden');
    if (afs && ats && afd && atd && afh && ath) {
      afs.value = afs.min;
      ats.value = ats.max;
      afd.textContent = afs.min;
      atd.textContent = ats.max;
      afh.value = '';
      ath.value = '';
      updateRangeFill(afs, ats, document.querySelector('.area-fill'));
    }

    // reset price range
    const pfs = document.getElementById('price-from-slider');
    const pts = document.getElementById('price-to-slider');
    const pfd = document.getElementById('price-from-display');
    const ptd = document.getElementById('price-to-display');
    const pfh = document.getElementById('price-from-hidden');
    const pth = document.getElementById('price-to-hidden');
    if (pfs && pts && pfd && ptd && pfh && pth) {
      pfs.value = pfs.min;
      pts.value = pts.max;
      pfd.textContent = pfs.min;
      ptd.textContent = pts.max;
      pfh.value = '';
      pth.value = '';
      updateRangeFill(pfs, pts, document.querySelector('.price-fill'));
    }

    // reset rooms filter (newbuild)
    const roomsHidden = document.getElementById('rooms-hidden');
    if (roomsHidden) roomsHidden.value = '';
    const roomBtns = document.querySelectorAll('.filter-btn');
    if (roomBtns && roomBtns.length) {
      roomBtns.forEach(b => { b.setAttribute('data-active','false'); b.classList.remove('active'); });
      const anyBtn = Array.from(roomBtns).find(b => (b.getAttribute('data-value') || '') === '');
      if (anyBtn) { anyBtn.setAttribute('data-active','true'); anyBtn.classList.add('active'); }
    }

    // reset secondary type chips
    const stypeHidden = document.getElementById('stype-hidden');
    if (stypeHidden) stypeHidden.value = '';
    const chipBtns = document.querySelectorAll('.filter-chip-btn');
    if (chipBtns && chipBtns.length) {
      chipBtns.forEach(b => b.classList.remove('active'));
      const allChip = Array.from(chipBtns).find(b => (b.getAttribute('data-value') || '') === '');
      if (allChip) allChip.classList.add('active');
    }

    // reset sorting
    const sortHidden = document.getElementById('sort-hidden');
    const sortingText = document.getElementById('sorting-text');
    if (sortHidden) sortHidden.value = 'price_asc';
    if (sortingText) sortingText.textContent = 'Дешевле';
    document.querySelectorAll('.sorting-option').forEach(o => o.classList.toggle('active', o.getAttribute('data-sort') === 'price_asc'));

    // fetch with cleared filters
    window.fetchData();
  });
})();

// Мгновенный сабмит при выборe фильтров — обрабатывается AJAX-слоем

// Современные анимации для фильтров
document.addEventListener('DOMContentLoaded', function() {
    // Анимация появления фильтров
    const filterGroups = document.querySelectorAll('.filter-group');
    filterGroups.forEach((group, index) => {
        group.style.opacity = '0';
        group.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            group.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
            group.style.opacity = '1';
            group.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Анимация для кнопок фильтра
    const filterBtns = document.querySelectorAll('.filter-btn');
    filterBtns.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px) scale(1.02)';
        });
        
        btn.addEventListener('mouseleave', function() {
            if (!this.getAttribute('data-active') === 'true') {
                this.style.transform = 'translateY(0) scale(1)';
            }
        });
    });
    
    // Анимация для select элементов
    const filterSelects = document.querySelectorAll('.filter-select');
    filterSelects.forEach(select => {
        select.addEventListener('focus', function() {
            this.parentElement.style.transform = 'translateY(-2px)';
        });
        
        select.addEventListener('blur', function() {
            this.parentElement.style.transform = 'translateY(0)';
        });
    });
    
    // Анимация для range sliders
    const rangeSliders = document.querySelectorAll('.range-slider-input');
    rangeSliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const container = this.closest('.range-container');
            container.style.transform = 'translateY(-1px) scale(1.01)';
            
            setTimeout(() => {
                container.style.transform = 'translateY(0) scale(1)';
            }, 150);
        });
    });
    
    // Анимация для кнопки очистки фильтров
    const clearFiltersBtn = document.querySelector('.clear-filters');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-3px) scale(1.02)';
        });
        
        clearFiltersBtn.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    }
    
    // Анимация для сортировки
    const sortingActive = document.querySelector('.sorting-active');
    if (sortingActive) {
        sortingActive.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.01)';
        });
        
        sortingActive.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    }
    
    // Плавная анимация для результатов поиска
    const resultsCount = document.querySelector('.results-count');
    if (resultsCount) {
        resultsCount.style.opacity = '0';
        resultsCount.style.transform = 'translateY(10px)';
        
        setTimeout(() => {
            resultsCount.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
            resultsCount.style.opacity = '1';
            resultsCount.style.transform = 'translateY(0)';
        }, 500);
    }
    
    // Анимация для секции фильтров при скролле
    const filtersSection = document.querySelector('.filters-section');
    if (filtersSection) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, { threshold: 0.1 });
        
        filtersSection.style.opacity = '0';
        filtersSection.style.transform = 'translateY(30px)';
        filtersSection.style.transition = 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
        
        observer.observe(filtersSection);
    }
});
</script>
{% endblock %} 
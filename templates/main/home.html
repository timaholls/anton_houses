{% extends 'base.html' %}

{% block title %}CENTURY 21 - Главная{% endblock %}


{% block content %}
<div class="container">
    <section class="hero-section">
        <h1 class="hero-title">Добро пожаловать<br><span class="hero-title-brand">CENTURY 21</span> <span class="hero-title-subline">мир в квадратах</span></h1>
        <p class="hero-subtitle">Найдите свой идеальный дом в лучших жилых комплексах</p>
        <div class="hero-ticker" aria-label="Информационная строка">
            <div class="ticker-track">
                <span class="ticker-item">тестовый текст ожидается...</span>
                <span class="ticker-item">тестовый текст ожидается...</span>
                <span class="ticker-item">тестовый текст ожидается...</span>
                <span class="ticker-item">тестовый текст ожидается...</span>
                <span class="ticker-item">тестовый текст ожидается...</span>
            </div>
        </div>
    </section>
    <style>
    .hero-section{
        position:relative;overflow:hidden;border-radius:16px;min-height:360px;margin:12px 0 22px 0;
        background: linear-gradient(0deg, rgba(37,37,38,.35), rgba(37,37,38,.35)), url('{{ PLACEHOLDER_IMAGE_URL }}') center/cover no-repeat;
        display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;
    }
    .hero-title{font-size:44px;line-height:1.15;margin:0 12px 8px 12px;color:#fff;font-weight:800;letter-spacing:.4px}
    .hero-title-brand{display:inline-block;font-size:52px;font-weight:900}
    .hero-title-subline{display:inline-block;margin-top:4px;font-size:22px}
    .hero-subtitle{font-size:18px;color:#f5f5f5;margin:0 12px 6px 12px;opacity:.95}

    /* Бегущая строка в едином стиле */
    .hero-ticker{width:min(920px, 92%);margin-top:10px;border-radius:999px;overflow:hidden;
        background: rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);backdrop-filter: blur(3px);
        box-shadow: 0 6px 18px rgba(0,0,0,.18);
    }
    .ticker-track{display:inline-block;white-space:nowrap;animation:heroTicker 18s linear infinite; padding:10px 0}
    .ticker-item{display:inline-block;color:#fff;font-weight:700;letter-spacing:.4px;padding:0 28px;opacity:.95}
    @keyframes heroTicker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

    @media (max-width: 900px){
        .hero-section{min-height:280px;border-radius:12px}
        .hero-title{font-size:30px}
        .hero-title-brand{font-size:34px}
        .hero-title-subline{font-size:15px}
        .hero-subtitle{font-size:16px}
        .hero-ticker{margin-top:8px}
        .ticker-item{padding:0 22px}
    }
    </style>

    {% if offers %}
    <section class="offers-section" id="offers">
        <div class="offers-header">
            <h2 class="section-title">Специальные предложения по ЖК</h2>
        </div>
        
        <!-- Карусель акций -->
        <div class="offers-carousel-container">
            <div class="offers-carousel" id="offersCarousel">
                <!-- Фиксированные 3 позиции для карточек -->
                <div class="offer-slide">
                    <div class="offer-card" id="offer-card-1">
                        {% if offers.0 %}
                        <a href="{% url 'main:offer_detail' offers.0.id %}" style="text-decoration: none; color: inherit; display: grid; grid-template-columns: 140px 1fr; gap: 12px; width: 100%;">
                            <div class="offer-media">
                                {% if offers.0.get_main_image and offers.0.get_main_image.image %}
                                    <img src="{{ offers.0.get_main_image.image.url }}" alt="{{ offers.0.title }}" loading="lazy" decoding="async">
                                {% else %}
                                    <img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ offers.0.title }}" loading="lazy" decoding="async">
                                {% endif %}
                            </div>
                            <div class="offer-content">
                                <div class="offer-head">
                                    <span class="offer-chip">{{ offers.0.residential_complex.name }}</span>
                                    <h3 class="offer-title">{{ offers.0.title }}</h3>
                                </div>
                                
                                <div class="offer-limited">
                                    <i class="far fa-clock"></i>
                                    <span>{% if offers.0.expires_at %}До {{ offers.0.expires_at|date:"d.m.Y" }}{% else %}Временное предложение{% endif %}</span>
                                </div>
                                
                                
                            </div>
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="offer-slide">
                    <div class="offer-card" id="offer-card-2">
                        {% if offers.1 %}
                        <a href="{% url 'main:offer_detail' offers.1.id %}" style="text-decoration: none; color: inherit; display: grid; grid-template-columns: 140px 1fr; gap: 12px; width: 100%;">
                            <div class="offer-media">
                                {% if offers.1.get_main_image and offers.1.get_main_image.image %}
                                    <img src="{{ offers.1.get_main_image.image.url }}" alt="{{ offers.1.title }}" loading="lazy" decoding="async">
                                {% else %}
                                    <img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ offers.1.title }}" loading="lazy" decoding="async">
                                {% endif %}
                            </div>
                            <div class="offer-content">
                                <div class="offer-head">
                                    <span class="offer-chip">{{ offers.1.residential_complex.name }}</span>
                                    <h3 class="offer-title">{{ offers.1.title }}</h3>
                                </div>
                                
                                <div class="offer-limited">
                                    <i class="far fa-clock"></i>
                                    <span>{% if offers.1.expires_at %}До {{ offers.1.expires_at|date:"d.m.Y" }}{% else %}Временное предложение{% endif %}</span>
                                </div>
                                
                                
                            </div>
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="offer-slide">
                    <div class="offer-card" id="offer-card-3">
                        {% if offers.2 %}
                        <a href="{% url 'main:offer_detail' offers.2.id %}" style="text-decoration: none; color: inherit; display: grid; grid-template-columns: 140px 1fr; gap: 12px; width: 100%;">
                            <div class="offer-media">
                                {% if offers.2.get_main_image and offers.2.get_main_image.image %}
                                    <img src="{{ offers.2.get_main_image.image.url }}" alt="{{ offers.2.title }}" loading="lazy" decoding="async">
                                {% else %}
                                    <img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ offers.2.title }}" loading="lazy" decoding="async">
                                {% endif %}
                            </div>
                            <div class="offer-content">
                                <div class="offer-head">
                                    <span class="offer-chip">{{ offers.2.residential_complex.name }}</span>
                                    <h3 class="offer-title">{{ offers.2.title }}</h3>
                                </div>
                                
                                <div class="offer-limited">
                                    <i class="far fa-clock"></i>
                                    <span>{% if offers.2.expires_at %}До {{ offers.2.expires_at|date:"d.m.Y" }}{% else %}Временное предложение{% endif %}</span>
                                </div>
                                
                                
                            </div>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Навигационные точки -->
            {% if offers|length > 3 %}
            <div class="carousel-dots">
                {% for i in "123456789"|make_list %}
                    {% if forloop.counter0|add:3 <= offers|length %}
                    <button type="button" class="carousel-dot {% if forloop.first %}active{% endif %}" data-page="{{ forloop.counter0 }}"></button>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <!-- Отладочная информация -->
        <div style="display: none;">
            <p>Количество акций: {{ offers|length }}</p>
            {% for o in offers %}
            <p>Акция {{ forloop.counter }}: {{ o.title }} ({{ o.residential_complex.name }})</p>
            {% endfor %}
        </div>
        
        <!-- Скрытые данные для JavaScript -->
        <script type="application/json" id="offers-data">
        [
            {% for o in offers %}
            {
                "id": {{ o.id }},
                "title": "{{ o.title|escapejs }}",
                "complex_name": "{{ o.residential_complex.name|escapejs }}",
                "description": "{{ o.description|escapejs }}",
                "expires_at": "{% if o.expires_at %}{{ o.expires_at|date:'d.m.Y' }}{% else %}Временное предложение{% endif %}",
                "image_url": "{% if o.get_main_image and o.get_main_image.image %}{{ o.get_main_image.image.url }}{% else %}/media/gallery/placeholders.png{% endif %}",
                "detail_url": "{% url 'main:offer_detail' o.id %}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
        </script>
        
        <!-- Кнопка "Посмотреть все акции" -->
        <div class="offers-more-section">
            <a href="{% url 'main:all_offers' %}" class="btn btn-primary btn-large">
                <span>Посмотреть все акции</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        <style>
        .offers-section{margin:28px 0 4px 0}
        .offers-header{text-align:center;margin-bottom:20px}
        
        /* Карусель акций */
        .offers-carousel-container{position:relative;margin:0 auto;max-width:1200px}
        .offers-carousel{display:flex;border-radius:16px;position:relative}
        .offer-slide{flex:0 0 33.333%;min-width:0;padding:0 8px}
        .offer-card{width:100%;display:grid;grid-template-columns:140px 1fr;gap:12px;background:#fff;border:1px solid #efe7ce;border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);transition:box-shadow .3s ease, transform .3s ease, border-color .3s ease;text-decoration:none;color:inherit;height:180px;opacity:1;transition:opacity .5s ease}
        .offer-card:hover{box-shadow:0 12px 28px rgba(0,0,0,.15);transform:translateY(-3px);border-color:var(--c21-gold)}
        .offer-card.fade-out{opacity:0}
        .offer-card.fade-in{opacity:1}
        .offer-media{position:relative;border-radius:8px;overflow:hidden;aspect-ratio:4/3;min-height:80px}
        .offer-media img{width:100%;height:100%;object-fit:cover;display:block}
        .offer-badge-hot{position:absolute;left:6px;top:6px;z-index:2;background:var(--c21-gold);color:var(--c21-dark);padding:3px 6px;border-radius:999px;font-weight:800;display:inline-flex;gap:3px;align-items:center;font-size:10px;box-shadow:0 3px 8px rgba(190,175,135,.4)}
        .offer-badge-hot i{font-size:10px}
        .offer-content{display:flex;flex-direction:column;justify-content:space-between;min-height:80px}
        .offer-head{display:flex;align-items:flex-start;gap:6px;flex-wrap:wrap;margin-bottom:3px}
        .offer-chip{display:inline-block;background:var(--c21-dark);color:var(--c21-gold);padding:2px 6px;border-radius:999px;font-weight:700;font-size:10px;white-space:nowrap}
        .offer-title{margin:0;font-size:14px;font-weight:800;color:#222;line-height:1.2;word-wrap:break-word;hyphens:auto}
        .offer-limited{display:flex;align-items:center;gap:4px;color:#7b6a3e;background:#faf7ee;border:1px solid #efe7ce;border-radius:6px;padding:4px 6px;margin-top:3px;font-weight:600;font-size:10px;width:fit-content}
        .offer-limited i{color:var(--c21-gold);font-size:10px}
        
        /* Навигационные точки */
        .carousel-dots{display:flex;justify-content:center;gap:8px;margin-top:20px}
        .carousel-dot{width:12px;height:12px;border-radius:50%;border:none;background:#ddd;cursor:pointer;transition:all .3s ease}
        .carousel-dot.active{background:var(--c21-gold);transform:scale(1.2)}
        .carousel-dot:hover{background:var(--c21-gold);opacity:.7}
        
        
         
         /* Секция кнопки "Посмотреть все акции" */
         .offers-more-section {
             text-align: center;
             margin: 32px 0 36px 0; /* верхний и нижний отступ */
         }
        </style>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const offersDataElement = document.getElementById('offers-data');
                if (!offersDataElement) {
                    console.error('Offers data element not found');
                    return;
                }
                const offersData = JSON.parse(offersDataElement.textContent);
                console.log('[offers] data loaded', offersData.length);
                if (!offersData || offersData.length === 0) {
                    console.log('No offers data available');
                    return;
                }
                const dotsContainer = document.querySelector('.carousel-dots');
                let carouselDots = document.querySelectorAll('.carousel-dot');
                const offerCards = [
                    document.getElementById('offer-card-1'),
                    document.getElementById('offer-card-2'),
                    document.getElementById('offer-card-3')
                ];
                let currentPage = 0;
                const offersPerPage = 3;
                const totalPages = Math.ceil(offersData.length / offersPerPage);
                console.log('[offers] init', { totalOffers: offersData.length, totalPages, offersPerPage });
                if (dotsContainer) {
                    let dotsMarkup = '';
                    for (let i = 0; i < totalPages; i += 1) {
                        dotsMarkup += `<button type="button" class="carousel-dot${i === 0 ? ' active' : ''}" data-page="${i}"></button>`;
                    }
                    dotsContainer.innerHTML = dotsMarkup;
                    carouselDots = dotsContainer.querySelectorAll('.carousel-dot');
                    console.log('[offers] dots rendered', carouselDots.length);
                }
                function updateOfferCards(page) {
                    const startIndex = page * offersPerPage;
                    offerCards.forEach((card, index) => {
                        if (!card) return;
                        const offerIndex = startIndex + index;
                        if (offerIndex < offersData.length) {
                            const offer = offersData[offerIndex];
                            card.innerHTML = `
                                <a href="${offer.detail_url}" style="text-decoration: none; color: inherit; display: grid; grid-template-columns: 140px 1fr; gap: 12px; width: 100%;">
                                    <div class="offer-media">
                                        <img src="${offer.image_url}" alt="${offer.title}" loading="lazy" decoding="async">
                                    </div>
                                    <div class="offer-content">
                                        <div class="offer-head">
                                            <span class="offer-chip">${offer.complex_name}</span>
                                            <h3 class="offer-title">${offer.title}</h3>
                                        </div>
                                        <div class="offer-limited">
                                            <i class="far fa-clock"></i>
                                            <span>До ${offer.expires_at}</span>
                                        </div>
                                    </div>
                                </a>
                            `;
                        } else {
                            card.style.display = 'none';
                        }
                    });
                }
                function updateActiveDot(page) {
                    carouselDots.forEach((dot, index) => {
                        if (index === page) {
                            dot.classList.add('active');
                        } else {
                            dot.classList.remove('active');
                        }
                    });
                }
                if (dotsContainer) {
                    dotsContainer.addEventListener('click', function(event) {
                        const target = event.target;
                        if (!(target instanceof Element)) return;
                        if (target.classList.contains('carousel-dot')) {
                            event.preventDefault();
                            const indexAttr = target.getAttribute('data-page');
                            const index = indexAttr ? parseInt(indexAttr, 10) : Array.prototype.indexOf.call(dotsContainer.querySelectorAll('.carousel-dot'), target);
                            if (!Number.isNaN(index)) {
                                console.log('[offers] dot click', { index });
                                currentPage = index;
                                updateOfferCards(currentPage);
                                updateActiveDot(currentPage);
                            }
                        }
                    });
                }

                // На мобильных: при достижении края загружаем следующую/предыдущую страницу
                if (window.innerWidth < 992) {
                    const scroller = document.querySelector('.offers-carousel');
                    if (scroller) {
                        let isPaging = false; // защита от дребезга
                        scroller.addEventListener('scroll', function() {
                            if (isPaging) return;
                            const nearRight = scroller.scrollLeft + scroller.clientWidth >= scroller.scrollWidth - 3;
                            const nearLeft = scroller.scrollLeft <= 3;
                            if (nearRight && currentPage < totalPages - 1) {
                                isPaging = true;
                                currentPage += 1;
                                // начинаем новую страницу с первой карточки, без авто-долистывания
                                updateOfferCards(currentPage);
                                updateActiveDot(currentPage);
                                scroller.classList.add('no-snap');
                                scroller.scrollLeft = 0;
                                setTimeout(() => scroller.classList.remove('no-snap'), 50);
                                setTimeout(() => { isPaging = false; }, 120);
                            } else if (nearLeft && currentPage > 0) {
                                isPaging = true;
                                currentPage -= 1;
                                // начинаем страницу с первой карточки
                                updateOfferCards(currentPage);
                                updateActiveDot(currentPage);
                                scroller.classList.add('no-snap');
                                scroller.scrollLeft = 0;
                                setTimeout(() => scroller.classList.remove('no-snap'), 50);
                                setTimeout(() => { isPaging = false; }, 120);
                            }
                        });
                    }
                }
                function autoSlide() {
                    if (totalPages > 1 && window.innerWidth >= 992) {
                        currentPage = (currentPage + 1) % totalPages;
                        updateOfferCards(currentPage);
                        updateActiveDot(currentPage);
                    }
                }
                updateOfferCards(0);
                updateActiveDot(0);
                if (totalPages > 1 && window.innerWidth >= 992) {
                    setInterval(autoSlide, 8000);
                }
            } catch (error) {
                console.error('Error initializing offers carousel:', error);
            }
        });
        </script>
    </section>
    {% endif %}

    <section class="catalog-section">
        <div class="catalog-header">
            <h2 class="section-title">9 лучших предложений для вас</h2>
        </div>

        <style>
        /* Улучшенный грид карточек */
        .home-grid{display:grid;grid-template-columns:repeat(3,minmax(260px,1fr));gap:18px}
        
        /* Карточка */
        .home-property-card{background:#fff;border:1px solid #eee;border-radius:16px;overflow:hidden;text-decoration:none;color:inherit;box-shadow:0 8px 24px rgba(0,0,0,.06);transition:transform .2s ease, box-shadow .2s ease}
        .home-property-card:hover{transform:translateY(-4px);box-shadow:0 14px 30px rgba(0,0,0,.12)}
        /* Ровные превью */
        .home-card-image{position:relative;aspect-ratio:16/10;overflow:hidden}
        .home-card-image img{width:100%;height:100%;object-fit:cover;display:block}
        /* Контент */
        .home-card-content{padding:12px 14px 14px 14px}
        .home-card-title{margin:0 0 6px 0;font-size:18px;font-weight:800;color:#222}
        .home-card-location{display:flex;gap:8px;align-items:center;color:#666;font-size:13px}
        .home-location-text{background:#f6f6f6;border:1px solid #eee;padding:4px 8px;border-radius:999px}
        .home-commute-time{background:#faf7ee;border:1px solid #efe7ce;color:#7b6a3e;padding:4px 8px;border-radius:999px}
        .home-card-price{margin-top:10px}
        .home-price-text{font-weight:800;color:var(--c21-gold)}
        
        /* Галерея изображений для карточек ЖК */
        .home-card-image-gallery{position:relative;aspect-ratio:16/10;overflow:hidden}
        .home-card-image-gallery .gallery-image{width:100%;height:100%;object-fit:cover;display:block;transition:opacity 0.3s ease}
        .gallery-nav{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.6);color:white;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease;z-index:10;opacity:0}
        .home-card-image-gallery:hover .gallery-nav{opacity:1}
        .gallery-nav:hover{background:rgba(0,0,0,0.8);transform:translateY(-50%) scale(1.1)}
        .gallery-prev{left:10px}
        .gallery-next{right:10px}
        .gallery-dots{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:10}
        .gallery-dots .dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.5);cursor:pointer;transition:all 0.3s ease}
        .gallery-dots .dot.active{background:white;transform:scale(1.2)}
        .gallery-dots .dot:hover{background:rgba(255,255,255,0.8)}
        </style>

        <div class="home-grid">
            {% for complex in complexes %}
            <div class="home-property-card"> 
                <div class="home-card-image-gallery" onclick="window.location.href='{% url 'main:detail' complex.id %}'" style="cursor: pointer;">
                    {% if complex.development.photos %}
                        {% for photo in complex.development.photos %}
                            <img class="gallery-image" src="{{ photo }}" alt="{{ complex.development.name|default:'ЖК' }}" loading="lazy" decoding="async" sizes="(max-width: 900px) 100vw, 33vw" style="{% if not forloop.first %}display: none;{% endif %}">
                        {% endfor %}
                        {% if complex.development.photos|length > 1 %}
                            <button class="gallery-nav gallery-prev" onclick="event.stopPropagation(); changeImage(this, -1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="gallery-nav gallery-next" onclick="event.stopPropagation(); changeImage(this, 1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <div class="gallery-dots">
                                {% for photo in complex.development.photos %}
                                    <span class="dot {% if forloop.first %}active{% endif %}" onclick="event.stopPropagation(); setImage(this, {{ forloop.counter0 }})"></span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% else %}
                        <img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ complex.development.name|default:'ЖК' }}" loading="lazy" decoding="async">
                    {% endif %}
                </div>
                
                <div class="home-card-content" onclick="window.location.href='{% url 'main:detail' complex.id %}'" style="cursor: pointer;">
                    <div class="home-card-header">
                        <h3 class="home-card-title">{{ complex.development.name|default:'ЖК' }}</h3>
                    </div>
                    
                    <div class="home-card-price">
                        <span class="home-price-text">{{ complex.development.price_range|default:'Цена не указана' }}</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-complexes">
                <p>Жилые комплексы пока не добавлены</p>
            </div>
            {% endfor %}
        </div>

        <div class="catalog-footer">
            <a href="{% url 'main:catalog' %}" class="btn btn-primary btn-large">
                Перейти в каталог ЖК
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </section>

    {% if home_articles %}
    <section class="catalog-section">
        <div class="catalog-header">
            <h2 class="section-title">Полезные статьи</h2>
            <p class="section-subtitle">Отобранные материалы</p>
        </div>

        <div class="home-grid">
            {% for a in home_articles %}
            <a class="home-property-card" href="{{ a.get_absolute_url }}">
                <div class="home-card-image">
                    {% if a.get_main_image and a.get_main_image.image %}
                        <img src="{{ a.get_main_image.image.url }}" alt="{{ a.title }}">
                    {% else %}
                        <img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ a.title }}">
                    {% endif %}
                </div>
                <div class="home-card-content">
                    <div class="home-card-header">
                        <h3 class="home-card-title">{{ a.title }}</h3>
                        <div class="home-card-location">
                            <span class="home-location-text">{{ a.get_category_display }}</span>
                            <span class="home-commute-time">{{ a.published_date }}</span>
                        </div>
                    </div>
                    <div class="home-card-price">
                        <span class="home-price-text">{{ a.excerpt|striptags|truncatechars:90 }}</span>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        <div class="catalog-footer">
            <a href="{% url 'main:articles' %}" class="btn btn-primary btn-large">Все статьи <i class="fas fa-arrow-right"></i></a>
        </div>
    </section>
    {% endif %}

    <!-- Блок "О компании" -->
    {% if company_info %}
    <section class="about-section">
        <div class="about-header">
            <span class="about-tab">О компании</span>
            <h2 class="about-title">Мы специализируемся на продаже квартир в лучших жилых комплексах</h2>
        </div>
        
        <div class="about-content">
            <div class="about-image">
                {% if company_gallery %}
                <!-- Слайд-шоу галереи -->
                <div class="company-gallery-slider">
                    <div class="slider-container">
                        {% for gallery_item in company_gallery %}
                        <div class="slide {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.counter0 }}">
                            <img src="{{ gallery_item.image }}" alt="{{ gallery_item.title }}">
                            {% if gallery_item.description %}
                            <div class="slide-caption">
                                <h4>{{ gallery_item.title }}</h4>
                                <p>{{ gallery_item.description }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Навигационные точки -->
                    {% if company_gallery|length > 1 %}
                    <div class="slider-dots">
                        {% for gallery_item in company_gallery %}
                        <button class="dot {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.counter0 }}"></button>
                        {% endfor %}
                    </div>
                    
                    <!-- Кнопки навигации -->
                    <button class="slider-btn prev-btn" aria-label="Предыдущее изображение">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="slider-btn next-btn" aria-label="Следующее изображение">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    {% endif %}
                </div>
                {% else %}
                <!-- Фото основателя как fallback -->
                {% if company_info.main_image %}
                <img src="{{ company_info.main_image }}" alt="{{ company_info.founder_name }}">
                {% else %}
                <img src="{{ PLACEHOLDER_IMAGE_URL }}" alt="{{ company_info.founder_name }}">
                {% endif %}
                {% endif %}
            </div>
            
            <div class="about-text">
                <blockquote class="about-quote">
                    {{ company_info.quote }}
                </blockquote>
                
                <div class="about-signature">
                    <div class="signature-line">{{ company_info.founder_name }}</div>
                    <div class="founder-info">
                        <span class="founder-title">{{ company_info.founder_position }}</span>
                        <span class="company-name">{{ company_info.company_name }}</span>
                    </div>
                </div>

                <div class="about-actions">
                    <a href="{% url 'main:team' %}" class="btn">
                        Наша команда
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Карта головного офиса -->
    <section class="office-map-section" id="office-map">
        <div class="map-header">
            <h2 class="section-title">Наш головной офис</h2>
            <p class="section-subtitle">Приходите к нам за консультацией</p>
        </div>
        
        <div class="office-map-container">
            <div class="office-info-card">
                <div class="office-details">
                    {% if head_office %}
                    <h3>{{ head_office.name }}</h3>
                    <div class="office-contact">
                        <div class="contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ head_office.city }}, {{ head_office.address }}</span>
                        </div>
                        {% if head_office.phone %}
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <a href="tel:{{ head_office.phone|cut:' '|cut:'-'|cut:'('|cut:')' }}">{{ head_office.phone }}</a>
                        </div>
                        {% endif %}
                        {% if head_office.schedule %}
                        <div class="contact-item">
                            <i class="fas fa-clock"></i>
                            <span>{{ head_office.schedule }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <h3>CENTURY 21</h3>
                    <div class="office-contact">
                        <div class="contact-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>г. Уфа, ул. Ленина, 1</span>
                        </div>
                        <div class="contact-item">
                            <i class="fas fa-phone"></i>
                            <a href="tel:+73472019478">+7 347 201-94-78</a>
                        </div>
                    </div>
                    {% endif %}
                    <a href="{% url 'main:offices' %}" class="btn btn-outline">
                        <i class="fas fa-building"></i>
                        Все офисы продаж
                    </a>
                </div>
            </div>
            
            <div class="map-wrapper">
                <div id="home-office-map" style="width: 100%; height: 400px; border-radius: 12px; overflow: hidden;"></div>
                <script>
                document.addEventListener('DOMContentLoaded', function(){
                    try{
                        {% if head_office and head_office.latitude and head_office.longitude %}
                        const lat = {{ head_office.latitude }};
                        const lng = {{ head_office.longitude }};
                        const map = L.map('home-office-map', { 
                            attributionControl: false,
                            zoomControl: true,
                            scrollWheelZoom: true
                        }).setView([lat, lng], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap'
                        }).addTo(map);
                        const marker = L.marker([lat, lng]).addTo(map);
                        marker.bindPopup(`
                            <div style="text-align: center; padding: 8px;">
                                <h4 style="margin: 0 0 8px 0; color: #333;">{{ head_office.name }}</h4>
                                <p style="margin: 0 0 8px 0; color: #666;">{{ head_office.city }}, {{ head_office.address }}</p>
                                {% if head_office.phone %}
                                <a href="tel:{{ head_office.phone|cut:' '|cut:'-'|cut:'('|cut:')' }}" style="color: #bcaf87; text-decoration: none; font-weight: 600;">
                                    <i class="fas fa-phone"></i> {{ head_office.phone }}
                                </a>
                                {% endif %}
                            </div>
                        `);
                        marker.openPopup();
                        {% else %}
                        console.log('No head office coordinates available');
                        {% endif %}
                    }catch(e){ 
                        console.error('Map initialization error:', e);
                    }
                });
                </script>
            </div>
        </div>
    </section>

</div>

<style>
/* Стили для слайд-шоу галереи компании */
.company-gallery-slider {
    position: relative;
    width: 100%;
    height: 480px;
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    margin-left: 20px;
}

.slider-container {
    position: relative;
    width: 100%;
    height: 100%;
}

.slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.8s ease-in-out;
    display: flex;
    align-items: center;
    justify-content: center;
}

.slide.active {
    opacity: 1;
}

.slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 24px;
}

.slide-caption {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    color: white;
    padding: 20px;
    text-align: center;
}

.slide-caption h4 {
    margin: 0 0 8px 0;
    font-size: 1.2rem;
    font-weight: 700;
}

.slide-caption p {
    margin: 0;
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Навигационные точки */
.slider-dots {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    z-index: 10;
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.5);
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
}

.dot.active {
    background: var(--c21-gold);
    border-color: var(--c21-gold);
}

.dot:hover {
    background: rgba(255,255,255,0.3);
}

/* Кнопки навигации */
.slider-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.5);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10;
}

.slider-btn:hover {
    background: var(--c21-gold);
    color: var(--c21-dark);
}

.prev-btn {
    left: 20px;
}

.next-btn {
    right: 20px;
}

/* Адаптивность для слайд-шоу */
 
</style>

<script>
// Навигация теперь через обычные ссылки <a>

// Эффект тени для sticky шапки при прокрутке
window.addEventListener('scroll', function() {
    const header = document.querySelector('.main-header');
    if (window.scrollY > 10) {
        header.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
    } else {
        header.style.boxShadow = '0 1px 3px rgba(0, 0, 0, 0.05)';
    }
});



// Дополнительные эффекты для блока "О компании"
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация слайд-шоу галереи
    const slider = document.querySelector('.company-gallery-slider');
    if (slider) {
        const slides = slider.querySelectorAll('.slide');
        const dots = slider.querySelectorAll('.dot');
        const prevBtn = slider.querySelector('.prev-btn');
        const nextBtn = slider.querySelector('.next-btn');
        
        let currentSlide = 0;
        let slideInterval;
        
        function showSlide(index) {
            // Скрываем все слайды
            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            
            // Показываем текущий слайд
            slides[index].classList.add('active');
            dots[index].classList.add('active');
            
            currentSlide = index;
        }
        
        function nextSlide() {
            const nextIndex = (currentSlide + 1) % slides.length;
            showSlide(nextIndex);
        }
        
        function prevSlide() {
            const prevIndex = (currentSlide - 1 + slides.length) % slides.length;
            showSlide(prevIndex);
        }
        
        function startAutoSlide() {
            slideInterval = setInterval(nextSlide, 5000); // 5 секунд
        }
        
        function stopAutoSlide() {
            clearInterval(slideInterval);
        }
        
        // Обработчики для кнопок
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                stopAutoSlide();
                nextSlide();
                startAutoSlide();
            });
        }
        
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                stopAutoSlide();
                prevSlide();
                startAutoSlide();
            });
        }
        
        // Обработчики для точек
        dots.forEach((dot, index) => {
            dot.addEventListener('click', function() {
                stopAutoSlide();
                showSlide(index);
                startAutoSlide();
            });
        });
        
        // Остановка автопереключения при наведении
        slider.addEventListener('mouseenter', stopAutoSlide);
        slider.addEventListener('mouseleave', startAutoSlide);
        
        // Запускаем автопереключение
        if (slides.length > 1) {
            startAutoSlide();
        }
    }
    
    const aboutSection = document.querySelector('.about-section');
    const aboutImage = document.querySelector('.about-image');
    const aboutQuote = document.querySelector('.about-quote');
    
    if (aboutSection && aboutImage && aboutQuote) {
        let isTypewriterActive = false;
        
        // Анимация появления цитаты при наведении на изображение
        aboutImage.addEventListener('mouseenter', function() {
            if (!isTypewriterActive) {
                aboutQuote.style.transform = 'scale(1.02)';
                aboutQuote.style.transition = 'transform 0.3s ease';
            }
        });
        
        aboutImage.addEventListener('mouseleave', function() {
            if (!isTypewriterActive) {
                aboutQuote.style.transform = 'scale(1)';
            }
        });
        
        // Эффект печатной машинки для цитаты
        const quoteText = aboutQuote.textContent.trim();
        aboutQuote.textContent = '';
        let i = 0;
        
        function typeWriter() {
            if (i < quoteText.length) {
                aboutQuote.textContent += quoteText.charAt(i);
                i++;
                setTimeout(typeWriter, 30);
            } else {
                // Завершаем анимацию печатной машинки
                isTypewriterActive = false;
                // Восстанавливаем возможность hover эффектов
                aboutQuote.style.transition = 'transform 0.3s ease';
            }
        }
        
        // Запускаем анимацию печатной машинки при появлении в области видимости
        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting && !isTypewriterActive) {
                    isTypewriterActive = true;
                    // Фиксируем изображение во время анимации печатной машинки
                    aboutImage.style.transform = 'perspective(1000px) rotateY(-5deg)';
                    aboutImage.style.transition = 'transform 0.3s ease';
                    
                    setTimeout(typeWriter, 1000);
                    observer.unobserve(entry.target);
                }
            });
        });
        
        observer.observe(aboutSection);
        
        // Отключен эффект параллакса при прокрутке: изображение не «следит» за скроллом
        window.addEventListener('scroll', function() {
            // без действий — фиксированное изображение
        });
    }
    

});


// Функции для галереи фото в карточках ЖК
window.changeImage = function(button, direction) {
    const gallery = button.parentElement;
    const images = gallery.querySelectorAll('.gallery-image');
    const dots = gallery.querySelectorAll('.dot');
    let currentIndex = 0;
    
    // Находим текущий индекс
    images.forEach((img, i) => {
        if (img.style.display === 'block') {
            currentIndex = i;
        }
    });
    
    // Вычисляем новый индекс
    let newIndex = currentIndex + direction;
    if (newIndex < 0) newIndex = images.length - 1;
    if (newIndex >= images.length) newIndex = 0;
    
    // Переключаем изображения
    images[currentIndex].style.display = 'none';
    images[newIndex].style.display = 'block';
    
    // Переключаем точки
    dots[currentIndex].classList.remove('active');
    dots[newIndex].classList.add('active');
}

window.setImage = function(dot, index) {
    const gallery = dot.parentElement.parentElement;
    const images = gallery.querySelectorAll('.gallery-image');
    const dots = gallery.querySelectorAll('.dot');
    
    // Скрываем все изображения
    images.forEach(img => img.style.display = 'none');
    // Показываем выбранное
    images[index].style.display = 'block';
    
    // Обновляем точки
    dots.forEach(d => d.classList.remove('active'));
    dots[index].classList.add('active');
}
</script>

<style>
/* Стили для секции карты офиса */
.office-map-section {
    margin: 40px 0;
    padding: 0;
    position: relative;
    z-index: 1;
}

.map-header {
    text-align: center;
    margin-bottom: 32px;
}

.office-map-container {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 32px;
    align-items: start;
    position: relative;
    z-index: 1;
}

.office-info-card {
    background: #f8f9fa;
    border-radius: 16px;
    padding: 32px;
    height: fit-content;
}

.office-info-card h3 {
    color: var(--c21-dark);
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 20px;
}

.office-contact {
    margin-bottom: 24px;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    font-size: 16px;
}

.contact-item i {
    color: var(--c21-gold);
    font-size: 18px;
    width: 20px;
}

.contact-item a {
    color: var(--c21-dark);
    text-decoration: none;
    font-weight: 600;
}

.contact-item a:hover {
    color: var(--c21-gold);
}

.map-wrapper {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

 
</style>
{% endblock %}
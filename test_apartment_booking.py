#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä
–ó–∞–ø—É—Å–∫: python3 test_apartment_booking.py
"""

import os
import sys
import json
import requests
from datetime import datetime
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BASE_URL = "http://localhost:8000"  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
TEST_EMAIL = "test@example.com"
TEST_NAME = "–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
TEST_PHONE = "+7 (999) 123-45-67"

def test_apartment_booking_api():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä"""
    print("üè† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä...")
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    booking_data = {
        'apartment_id': '507f1f77bcf86cd799439011',  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID –∫–≤–∞—Ä—Ç–∏—Ä—ã
        'complex_id': '507f1f77bcf86cd799439012',   # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID –ñ–ö
        'client_name': TEST_NAME,
        'client_phone': TEST_PHONE
    }
    
    try:
        # –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        print("üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
        response = requests.post(
            f"{BASE_URL}/api/book-apartment/",
            json=booking_data,
            headers={'Content-Type': 'application/json'}
        )
        
        if response.status_code == 200:
            result = response.json()
            if result.get('success'):
                print(f"‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ: {result.get('message')}")
                booking_id = result.get('booking_id')
                
                # –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                print("üìä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π...")
                stats_response = requests.get(f"{BASE_URL}/api/booking-stats/")
                
                if stats_response.status_code == 200:
                    stats_result = stats_response.json()
                    if stats_result.get('success'):
                        stats = stats_result.get('stats', {})
                        print(f"‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞:")
                        print(f"   - –í—Å–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: {stats.get('total_bookings', 0)}")
                        print(f"   - –û–∂–∏–¥–∞—é—Ç –∑–≤–æ–Ω–∫–∞: {stats.get('pending_bookings', 0)}")
                        print(f"   - –°–≤—è–∑–∞–ª–∏—Å—å: {stats.get('contacted_bookings', 0)}")
                        print(f"   - –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω—ã: {stats.get('booked_bookings', 0)}")
                        print(f"   - –û—Ç–º–µ–Ω–µ–Ω—ã: {stats.get('cancelled_bookings', 0)}")
                        
                        recent_bookings = stats_result.get('recent_bookings', [])
                        if recent_bookings:
                            print(f"üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:")
                            for booking in recent_bookings[:3]:
                                print(f"   - {booking.get('client_name')} ({booking.get('client_phone')}) - {booking.get('complex_name')}")
                    else:
                        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {stats_result.get('error')}")
                else:
                    print(f"‚ùå –û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {stats_response.status_code}")
                
                # –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å booking_id)
                if booking_id:
                    print("üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...")
                    update_data = {'status': 'contacted'}
                    update_response = requests.post(
                        f"{BASE_URL}/api/booking/{booking_id}/update-status/",
                        json=update_data,
                        headers={'Content-Type': 'application/json'}
                    )
                    
                    if update_response.status_code == 200:
                        update_result = update_response.json()
                        if update_result.get('success'):
                            print(f"‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω: {update_result.get('message')}")
                        else:
                            print(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {update_result.get('error')}")
                    else:
                        print(f"‚ùå –û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: {update_response.status_code}")
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {result.get('error')}")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ HTTP –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {response.status_code}")
            print(f"–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: {response.text}")
            
    except requests.exceptions.ConnectionError:
        print("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.")
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")


def test_apartment_detail_page():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã"""
    print("\nüè† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã...")
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ ID (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ)
    test_complex_id = "507f1f77bcf86cd799439012"
    test_apartment_id = "507f1f77bcf86cd799439011"
    
    try:
        response = requests.get(f"{BASE_URL}/apartment/{test_complex_id}/{test_apartment_id}/")
        
        if response.status_code == 200:
            print("‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã –¥–æ—Å—Ç—É–ø–Ω–∞")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ HTML
            html_content = response.text
            if 'apartment-detail-section' in html_content:
                print("‚úÖ –ù–∞–π–¥–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã")
            if 'booking-modal' in html_content:
                print("‚úÖ –ù–∞–π–¥–µ–Ω–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
            if 'book-apartment-btn' in html_content:
                print("‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è")
            if 'apartment-gallery' in html_content:
                print("‚úÖ –ù–∞–π–¥–µ–Ω–∞ –≥–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π")
            if 'apartment-characteristics' in html_content:
                print("‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã")
                
        elif response.status_code == 404:
            print("‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (404). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID –∫–≤–∞—Ä—Ç–∏—Ä—ã –∏ –ñ–ö.")
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ HTTP: {response.status_code}")
            
    except requests.exceptions.ConnectionError:
        print("‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.")
    except Exception as e:
        print(f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")


def test_mongodb_connection():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB"""
    print("\nüóÑÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB...")
    
    try:
        from pymongo import MongoClient
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        mongo_uri = os.getenv('MONGO_URI', 'mongodb://root:Kfleirb_17@176.98.177.188:27017/admin')
        db_name = os.getenv('DB_NAME', 'houses')
        
        client = MongoClient(mongo_uri)
        db = client[db_name]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        client.admin.command('ping')
        print("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB —É—Å–ø–µ—à–Ω–æ")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
        bookings_collection = db['apartment_bookings']
        total_bookings = bookings_collection.count_documents({})
        print(f"üìä –í—Å–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –≤ –±–∞–∑–µ: {total_bookings}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é –ñ–ö
        complexes_collection = db['unified_houses_3']
        total_complexes = complexes_collection.count_documents({})
        print(f"üè¢ –í—Å–µ–≥–æ –ñ–ö –≤ –±–∞–∑–µ: {total_complexes}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–ª–µ–∫—Ü–∏—é —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        employees_collection = db['employees']
        total_employees = employees_collection.count_documents({})
        print(f"üë• –í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –±–∞–∑–µ: {total_employees}")
        
        client.close()
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB: {e}")


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä")
    print(f"üì° –ë–∞–∑–æ–≤—ã–π URL: {BASE_URL}")
    print(f"üë§ –¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç: {TEST_NAME} ({TEST_PHONE})")
    print("=" * 60)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
    test_mongodb_connection()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º API –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    test_apartment_booking_api()
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–≤–∞—Ä—Ç–∏—Ä—ã
    test_apartment_detail_page()
    
    print("\n" + "=" * 60)
    print("‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("\nüí° –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
    print("1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω")
    print("2. –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ ID –∫–≤–∞—Ä—Ç–∏—Ä –∏ –ñ–ö –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ")
    print("3. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ñ–ö –≤ –±—Ä–∞—É–∑–µ—Ä–µ")
    print("4. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∫–≤–∞—Ä—Ç–∏—Ä—ã")
    print("5. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å'")
    print("6. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ")
    print("7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ MongoDB")
    print("\nüìù –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ apartment_bookings:")
    print("- apartment_id: ObjectId –∫–≤–∞—Ä—Ç–∏—Ä—ã")
    print("- complex_id: ObjectId –ñ–ö")
    print("- complex_name: –ù–∞–∑–≤–∞–Ω–∏–µ –ñ–ö")
    print("- client_name: –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞")
    print("- client_phone: –¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞")
    print("- apartment_details: –î–µ—Ç–∞–ª–∏ –∫–≤–∞—Ä—Ç–∏—Ä—ã")
    print("- agent_name: –ò–º—è –∞–≥–µ–Ω—Ç–∞")
    print("- status: –°—Ç–∞—Ç—É—Å (pending, contacted, booked, cancelled)")
    print("- created_at: –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è")
    print("- updated_at: –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è")


if __name__ == '__main__':
    main()
